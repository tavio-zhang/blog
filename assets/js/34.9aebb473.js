(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{393:function(t,s,a){"use strict";a.r(s);var e=a(8),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("在 ClickHouse 的生态中，MergeTree 家族引擎是绝对的核心支柱，撑起了 90% 以上的生产级 OLAP 场景。与传统数据库“一种引擎走天下”的设计不同，MergeTree 家族通过“基础引擎 + 场景化衍生”的架构，为不同数据处理需求提供了精准优化的解决方案。")]),t._v(" "),s("h2",{attrs:{id:"一、先搞懂-mergetree-家族的核心设计理念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、先搞懂-mergetree-家族的核心设计理念"}},[t._v("#")]),t._v(" 一、先搞懂：MergeTree 家族的核心设计理念")]),t._v(" "),s("p",[t._v("MergeTree 家族引擎专为高数据摄取率和海量数据存储分析设计，其核心优势源于三大底层设计，所有衍生引擎都继承并强化了这些特性：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("列式存储")]),t._v("：每列独立存储，查询时仅读取所需列，大幅降低 I/O 开销，尤其适配 OLAP 场景的聚合分析需求；")]),t._v(" "),s("li",[s("strong",[t._v("异步合并机制")]),t._v("：数据写入时先生成小数据块（Part），后台进程异步将小 Part 合并为大 Part，优化存储结构和查询性能；")]),t._v(" "),s("li",[s("strong",[t._v("灵活的索引与分区")]),t._v("：支持稀疏主键索引（每 8192 行一个索引标记）和自定义分区键，实现快速数据定位和分区裁剪，提升查询效率。")])]),t._v(" "),s("p",[t._v("核心定位：以“追加写”为基础，通过后台异步优化实现高性能读写，不支持实时事务和高频单行更新，所有衍生引擎均围绕“解决特定场景下的数据分析痛点”展开。")]),t._v(" "),s("h2",{attrs:{id:"二、mergetree-全家桶核心成员详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、mergetree-全家桶核心成员详解"}},[t._v("#")]),t._v(" 二、MergeTree 全家桶核心成员详解")]),t._v(" "),s("p",[t._v("MergeTree 家族以 "),s("code",[t._v("MergeTree")]),t._v(" 为基础，衍生出 "),s("code",[t._v("ReplacingMergeTree")]),t._v("、"),s("code",[t._v("SummingMergeTree")]),t._v(" 等多个子引擎，同时提供 "),s("code",[t._v("Replicated*")]),t._v(" 系列副本引擎保障高可用。下面逐一拆解各成员的核心能力。")]),t._v(" "),s("h3",{attrs:{id:"_1-基础核心-mergetree-所有场景的基石"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-基础核心-mergetree-所有场景的基石"}},[t._v("#")]),t._v(" 1. 基础核心：MergeTree —— 所有场景的基石")]),t._v(" "),s("p",[t._v("作为家族的“根引擎”，MergeTree 是 ClickHouse 最通用、最基础的引擎，提供了海量数据存储分析的核心能力，也是所有衍生引擎的实现基础。")]),t._v(" "),s("h4",{attrs:{id:"核心特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("支持自定义排序键（ORDER BY）：数据按排序键物理排序，优化压缩效率和查询跳过逻辑；")]),t._v(" "),s("li",[t._v("支持分区键（PARTITION BY）：常用日期字段分区（如 toYYYYMM(date)），实现快速分区删除和查询裁剪；")]),t._v(" "),s("li",[t._v("支持 TTL 规则：可设置数据生命周期，自动删除过期数据或迁移至低成本存储；")]),t._v(" "),s("li",[t._v("支持稀疏索引和二级跳过索引：快速定位数据块，减少无效 I/O；")]),t._v(" "),s("li",[t._v("批量写入优化：适配高吞吐追加写，不支持高频单行更新/删除。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例"}},[t._v("#")]),t._v(" 创建语法示例")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" user_behavior_log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  user_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  event_date "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  action_type String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  duration UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  device_id String\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 排序键：优先按日期，再按用户ID")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 按月分区")]),t._v("\nTTL event_date "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTERVAL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DAY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELETE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 数据保留90天，过期自动删除")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("h4",{attrs:{id:"适用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("p",[t._v("无特殊处理需求的通用 OLAP 场景，例如：")]),t._v(" "),s("ul",[s("li",[t._v("用户行为日志分析、业务监控数据存储；")]),t._v(" "),s("li",[t._v("自助报表分析、多维度钻取查询；")]),t._v(" "),s("li",[t._v("数据量较大、写入吞吐高，且无需去重或聚合的场景。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("p",[t._v("不支持实时去重和更新，若数据存在重复，需在查询时通过 "),s("code",[t._v("DISTINCT")]),t._v(" 或聚合函数处理；不提供高可用保障，生产环境需结合副本引擎使用。")]),t._v(" "),s("h3",{attrs:{id:"_2-去重更新-replacingmergetree-解决重复数据问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-去重更新-replacingmergetree-解决重复数据问题"}},[t._v("#")]),t._v(" 2. 去重更新：ReplacingMergeTree —— 解决重复数据问题")]),t._v(" "),s("p",[t._v("继承 MergeTree 基础能力，核心扩展“自动去重”功能，通过后台合并过程删除主键相同的重复行，保留最新版本数据。")]),t._v(" "),s("h4",{attrs:{id:"核心特性-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性-2"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("按排序键去重：仅对同一分区内排序键相同的行去重，分区间或分片间重复数据不处理；")]),t._v(" "),s("li",[t._v("保留最新数据：合并时保留写入时间最晚（或指定版本列最大）的行；")]),t._v(" "),s("li",[t._v("去重异步性：去重仅在后台合并时触发，未合并的 Part 中仍可能存在重复数据。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-2"}},[t._v("#")]),t._v(" 创建语法示例")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" user_profile "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  user_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  user_name String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  phone String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  update_time "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DateTime")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 版本列：标记数据更新时间")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" UInt8\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ReplacingMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 指定update_time为版本列，保留最新值")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" user_id  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 按user_id去重")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"适用场景-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-2"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("数据存在重复写入的场景（如上游系统重试机制导致的重复）；")]),t._v(" "),s("li",[t._v("需要“最终一致性”更新的场景（如用户资料更新，只需保留最新状态）；")]),t._v(" "),s("li",[t._v("不要求实时去重，可接受异步合并后去重的场景。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-2"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("ul",[s("li",[t._v("查询时需配合 "),s("code",[t._v("argMax")]),t._v(" 函数确保获取最新数据，例如 "),s("code",[t._v("SELECT user_id, argMax(user_name, update_time) FROM user_profile GROUP BY user_id")]),t._v("；")]),t._v(" "),s("li",[t._v("非聚合列（如用户昵称）在去重时可能保留任意值，需通过版本列严格控制；")]),t._v(" "),s("li",[t._v("不支持真正的“删除”操作，可通过写入相同排序键、标记状态为无效的方式实现逻辑删除。")])]),t._v(" "),s("h3",{attrs:{id:"_3-预聚合-summingmergetree-提升聚合查询性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-预聚合-summingmergetree-提升聚合查询性能"}},[t._v("#")]),t._v(" 3. 预聚合：SummingMergeTree —— 提升聚合查询性能")]),t._v(" "),s("p",[t._v("核心能力是在后台合并时，自动对排序键相同的行进行聚合求和，将多行合并为一行，大幅减少存储量并提升聚合查询速度。")]),t._v(" "),s("h4",{attrs:{id:"核心特性-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性-3"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("自动求和聚合：仅对数值类型列求和，非数值列保留第一行数据；")]),t._v(" "),s("li",[t._v("按排序键聚合：同一分区内排序键相同的行才会被聚合；")]),t._v(" "),s("li",[t._v("聚合异步性：聚合仅在合并时触发，未合并 Part 需查询时实时聚合。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-3"}},[t._v("#")]),t._v(" 创建语法示例")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" order_stat "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  merchant_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  order_date "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  order_amount Float64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 数值列：求和目标")]),t._v("\n  order_count UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 数值列：求和目标")]),t._v("\n  region String\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SummingMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("merchant_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" order_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 按商家+日期聚合")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"适用场景-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-3"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("需要按固定维度聚合统计的场景（如商家每日订单金额、用户每日行为次数）；")]),t._v(" "),s("li",[t._v("聚合查询频繁，且只需关注总数/总和，无需保留明细的场景；")]),t._v(" "),s("li",[t._v("数据写入后不会再更新，或更新频率极低的场景（如历史订单统计）。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-3"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("p",[t._v("非数值列无法聚合，需确保排序键设计覆盖所有聚合维度；若需查询实时数据，需配合 "),s("code",[t._v("SUM")]),t._v(" 函数和 "),s("code",[t._v("GROUP BY")]),t._v(" 语句，避免未合并数据导致的结果偏差。")]),t._v(" "),s("h3",{attrs:{id:"_4-复杂聚合-aggregatingmergetree-自定义聚合逻辑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-复杂聚合-aggregatingmergetree-自定义聚合逻辑"}},[t._v("#")]),t._v(" 4. 复杂聚合：AggregatingMergeTree —— 自定义聚合逻辑")]),t._v(" "),s("p",[t._v("相比 SummingMergeTree 仅支持求和，AggregatingMergeTree 支持自定义聚合函数（如计数、去重计数、平均值等），通过存储聚合函数的中间状态，实现更灵活的预聚合能力。")]),t._v(" "),s("h4",{attrs:{id:"核心特性-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性-4"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("支持多种聚合函数：需使用 "),s("code",[t._v("AggregateFunction")]),t._v(" 数据类型存储中间状态；")]),t._v(" "),s("li",[t._v("自定义聚合逻辑：可通过 "),s("code",[t._v("uniq")]),t._v("（去重计数）、"),s("code",[t._v("avg")]),t._v("（平均值）等函数实现复杂统计；")]),t._v(" "),s("li",[t._v("常用于物化视图：配合物化视图实现增量数据的实时聚合。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-4"}},[t._v("#")]),t._v(" 创建语法示例")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 基础表：存储原始行为数据")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" user_view_log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  user_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  page_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  view_time "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DateTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  stay_duration UInt32\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" MergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("page_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" toDate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 物化视图：基于AggregatingMergeTree实现页面访问统计")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" MATERIALIZED "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VIEW")]),t._v(" page_view_stat \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AggregatingMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("page_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" view_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n  page_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  toDate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" view_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  countState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" total_view"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 总访问次数（聚合中间状态）")]),t._v("\n  uniqState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" unique_user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 独立访客数（去重计数）")]),t._v("\n  avgState"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stay_duration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" avg_stay  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 平均停留时长")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" user_view_log\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GROUP")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" page_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" toDate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("view_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br")])]),s("h4",{attrs:{id:"适用场景-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-4"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("需要复杂聚合统计的场景（如独立访客数 UV、平均访问时长）；")]),t._v(" "),s("li",[t._v("增量数据聚合：通过物化视图实时同步原始数据并完成聚合；")]),t._v(" "),s("li",[t._v("大数据量下的聚合查询优化：减少查询时的实时计算压力。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-4"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("p",[t._v("查询时需使用对应的 "),s("code",[t._v("xxxMerge")]),t._v(" 函数解析中间状态（如 "),s("code",[t._v("countMerge(total_view)")]),t._v("）；聚合函数的中间状态无法直接查看，需通过物化视图或查询函数解析；不支持聚合后的数据更新，若原始数据有误，需重建物化视图。")]),t._v(" "),s("h3",{attrs:{id:"_5-状态折叠-collapsingmergetree-versionedcollapsingmergetree-处理状态变更"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-状态折叠-collapsingmergetree-versionedcollapsingmergetree-处理状态变更"}},[t._v("#")]),t._v(" 5. 状态折叠：CollapsingMergeTree & VersionedCollapsingMergeTree —— 处理状态变更")]),t._v(" "),s("p",[t._v("专为“状态变更型数据”设计，通过 "),s("code",[t._v("sign")]),t._v(" 列（1 表示新增/激活，-1 表示删除/失效）标记数据状态，后台合并时自动“折叠”（删除）状态互补的行，保留最新有效状态。")]),t._v(" "),s("h4",{attrs:{id:"核心差异"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心差异"}},[t._v("#")]),t._v(" 核心差异")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("CollapsingMergeTree")]),t._v("：需严格保证数据写入顺序，状态变更行必须紧跟原始行，否则无法正确折叠；")]),t._v(" "),s("li",[s("strong",[t._v("VersionedCollapsingMergeTree")]),t._v("：在 CollapsingMergeTree 基础上增加版本列，支持乱序写入，多线程插入更友好，是更推荐的版本。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-versionedcollapsingmergetree"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-versionedcollapsingmergetree"}},[t._v("#")]),t._v(" 创建语法示例（VersionedCollapsingMergeTree）")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" order_status_log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  order_id UInt64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("status")]),t._v(" String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 订单状态：待支付、已支付、已取消")]),t._v("\n  update_time "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DateTime")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  sign Int8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 状态标记：1=新增/更新，-1=删除/失效")]),t._v("\n  version UInt32  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 版本列：确保乱序写入时正确折叠")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" VersionedCollapsingMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sign"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" version"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" order_id\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("update_time"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("h4",{attrs:{id:"适用场景-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-5"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("需要记录状态变更历史并保留最新状态的场景（如订单状态变更、用户会员等级变更）；")]),t._v(" "),s("li",[t._v("消费 CDC 数据（如 Debezium 同步的数据库变更日志）；")]),t._v(" "),s("li",[t._v("需要清理过期状态数据，减少存储量的场景。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-5"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("p",[t._v("必须严格维护 "),s("code",[t._v("sign")]),t._v(" 列和版本列的一致性；查询时需配合 "),s("code",[t._v("FINAL")]),t._v(" 关键字确保状态完全折叠（但会降低查询性能）；不支持部分字段的状态更新，需整体替换行数据。")]),t._v(" "),s("h3",{attrs:{id:"_6-稀疏更新-coalescingmergetree-填充缺失值"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-稀疏更新-coalescingmergetree-填充缺失值"}},[t._v("#")]),t._v(" 6. 稀疏更新：CoalescingMergeTree —— 填充缺失值")]),t._v(" "),s("p",[t._v("MergeTree 家族的新增成员（ClickHouse 25.6+），核心能力是在后台合并时自动保留每列的最新非空值，适用于处理稀疏更新数据（如 IoT 设备的碎片化状态上报）。")]),t._v(" "),s("h4",{attrs:{id:"核心特性-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性-5"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("填充缺失值：合并时对同一排序键的行，每列保留最新的非空值；")]),t._v(" "),s("li",[t._v("避免全量覆盖：无需像 ReplacingMergeTree 那样覆盖整行，仅补充非空字段；")]),t._v(" "),s("li",[t._v("适配高吞吐稀疏更新：如 IoT 设备的碎片化状态上报（电池电量、位置、温度等字段分批上报）。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-5"}},[t._v("#")]),t._v(" 创建语法示例")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" electric_vehicle_state "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  vin String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 车辆识别码")]),t._v("\n  last_update DateTime64 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DEFAULT")]),t._v(" now64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 最后更新时间")]),t._v("\n  battery_level Nullable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UInt8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 电池电量（可能为空）")]),t._v("\n  lat Nullable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Float64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 纬度（可能为空）")]),t._v("\n  lon Nullable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Float64"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 经度（可能为空）")]),t._v("\n  firmware_version Nullable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 固件版本（可能为空）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CoalescingMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" vin\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("last_update"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("h4",{attrs:{id:"适用场景-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-6"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("IoT 设备状态监控：设备分系统、分时段上报碎片化数据；")]),t._v(" "),s("li",[t._v("稀疏更新场景：仅需补充部分字段的最新值，无需全量更新；")]),t._v(" "),s("li",[t._v("需要保留完整实体状态的场景（如车辆实时状态汇总）。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-6"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("p",[t._v("需配合 "),s("code",[t._v("argMax")]),t._v(" 函数查询最新状态；仅支持 ClickHouse 25.6 及以上版本；不支持删除操作，需通过写入空值+最新时间戳实现字段失效。")]),t._v(" "),s("h3",{attrs:{id:"_7-高可用保障-replicated-mergetree-副本引擎"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-高可用保障-replicated-mergetree-副本引擎"}},[t._v("#")]),t._v(" 7. 高可用保障：Replicated*MergeTree —— 副本引擎")]),t._v(" "),s("p",[t._v("上述所有引擎均有对应的 "),s("code",[t._v("Replicated*")]),t._v(" 副本版本（如 ReplicatedMergeTree、ReplicatedReplacingMergeTree），核心是在基础引擎能力上增加数据复制功能，实现高可用、故障转移和负载均衡。")]),t._v(" "),s("h4",{attrs:{id:"核心特性-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#核心特性-6"}},[t._v("#")]),t._v(" 核心特性")]),t._v(" "),s("ul",[s("li",[t._v("数据多副本同步：依赖 ZooKeeper 或 ClickHouse Keeper 协调副本数据同步；")]),t._v(" "),s("li",[t._v("故障转移：单个节点宕机时，查询可自动切换到其他副本；")]),t._v(" "),s("li",[t._v("写入幂等性：支持重复写入重试，避免网络问题导致的数据丢失；")]),t._v(" "),s("li",[t._v("完全继承基础引擎能力：副本功能与基础引擎的去重、聚合等能力不冲突。")])]),t._v(" "),s("h4",{attrs:{id:"创建语法示例-replicatedmergetree"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建语法示例-replicatedmergetree"}},[t._v("#")]),t._v(" 创建语法示例（ReplicatedMergeTree）")]),t._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TABLE")]),t._v(" user_log_replicated "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  user_id UInt32"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  event_date "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("action")]),t._v(" String"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  duration UInt32\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENGINE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ReplicatedMergeTree"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/clickhouse/tables/{shard}/user_log_replicated'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- ZooKeeper路径（按分片区分）")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{replica}'")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 副本标识（每个节点唯一）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PARTITION")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" toYYYYMM"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("event_date"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h4",{attrs:{id:"适用场景-7"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-7"}},[t._v("#")]),t._v(" 适用场景")]),t._v(" "),s("ul",[s("li",[t._v("生产环境的核心业务表：需要高可用性，避免单点故障；")]),t._v(" "),s("li",[t._v("数据可靠性要求高的场景：如交易数据、核心监控数据；")]),t._v(" "),s("li",[t._v("分布式集群部署：配合分片实现大规模数据存储和并行查询。")])]),t._v(" "),s("h4",{attrs:{id:"注意事项-7"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意事项-7"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),s("ul",[s("li",[t._v("依赖 ZooKeeper/ClickHouse Keeper：需提前部署并配置正确；")]),t._v(" "),s("li",[t._v("副本数量建议 2-3 个：过多副本会增加写入延迟和存储成本；")]),t._v(" "),s("li",[t._v("避免小批量高频写入：会导致副本同步压力增大，建议批量写入（每批 > 1000 行）。")])]),t._v(" "),s("h2",{attrs:{id:"三、mergetree-全家桶选型决策指南"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、mergetree-全家桶选型决策指南"}},[t._v("#")]),t._v(" 三、MergeTree 全家桶选型决策指南")]),t._v(" "),s("p",[t._v("选型的核心是“匹配业务场景”—— 先明确数据处理需求（是否去重、是否聚合、是否需要高可用），再对应选择合适的引擎。以下是分场景的选型建议和对比表格。")]),t._v(" "),s("h3",{attrs:{id:"_1-核心引擎对比表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-核心引擎对比表"}},[t._v("#")]),t._v(" 1. 核心引擎对比表")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("引擎类型")]),t._v(" "),s("th",[t._v("核心能力")]),t._v(" "),s("th",[t._v("适用场景")]),t._v(" "),s("th",[t._v("优点")]),t._v(" "),s("th",[t._v("缺点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("MergeTree")]),t._v(" "),s("td",[t._v("基础读写、分区、排序")]),t._v(" "),s("td",[t._v("通用 OLAP 分析、日志存储")]),t._v(" "),s("td",[t._v("性能均衡、适用范围广、配置简单")]),t._v(" "),s("td",[t._v("不支持去重、更新；无高可用")])]),t._v(" "),s("tr",[s("td",[t._v("ReplacingMergeTree")]),t._v(" "),s("td",[t._v("异步去重、保留最新数据")]),t._v(" "),s("td",[t._v("数据去重、用户状态更新")]),t._v(" "),s("td",[t._v("自动去重、简化应用层逻辑")]),t._v(" "),s("td",[t._v("去重异步；分区间不生效；需配合函数查询")])]),t._v(" "),s("tr",[s("td",[t._v("SummingMergeTree")]),t._v(" "),s("td",[t._v("异步求和聚合")]),t._v(" "),s("td",[t._v("固定维度统计（金额、次数）")]),t._v(" "),s("td",[t._v("减少存储、提升聚合查询速度")]),t._v(" "),s("td",[t._v("仅支持求和；非数值列保留不确定")])]),t._v(" "),s("tr",[s("td",[t._v("AggregatingMergeTree")]),t._v(" "),s("td",[t._v("自定义复杂聚合（存储中间状态）")]),t._v(" "),s("td",[t._v("复杂统计（UV、平均时长）、增量聚合")]),t._v(" "),s("td",[t._v("聚合逻辑灵活、适配多种统计需求、减轻查询计算压力")]),t._v(" "),s("td",[t._v("需配合物化视图使用；中间状态不可直接查看；原始数据错误需重建视图")])]),t._v(" "),s("tr",[s("td",[t._v("VersionedCollapsingMergeTree")]),t._v(" "),s("td",[t._v("状态变更折叠、支持乱序写入")]),t._v(" "),s("td",[t._v("订单状态跟踪、CDC数据消费、状态历史管理")]),t._v(" "),s("td",[t._v("自动清理过期状态、支持多线程乱序写入、适配状态变更场景")]),t._v(" "),s("td",[t._v("需维护sign和version列；查询需加FINAL影响性能；不支持部分字段更新")])]),t._v(" "),s("tr",[s("td",[t._v("CoalescingMergeTree")]),t._v(" "),s("td",[t._v("稀疏更新填充、保留列最新非空值")]),t._v(" "),s("td",[t._v("IoT设备碎片化上报、部分字段补充更新")]),t._v(" "),s("td",[t._v("无需全量覆盖更新、适配高吞吐稀疏写入、保留完整实体状态")]),t._v(" "),s("td",[t._v("仅支持ClickHouse 25.6+；需配合argMax查询；不支持删除操作")])]),t._v(" "),s("tr",[s("td",[t._v("Replicated*MergeTree")]),t._v(" "),s("td",[t._v("数据多副本同步、高可用保障")]),t._v(" "),s("td",[t._v("生产核心业务表、高可靠性要求场景、分布式集群")]),t._v(" "),s("td",[t._v("支持故障转移、数据不丢失、负载均衡、继承基础引擎全部能力")]),t._v(" "),s("td",[t._v("依赖ZooKeeper/Keeper；增加写入延迟；多副本提升存储成本")])])])]),t._v(" "),s("h3",{attrs:{id:"_2-分场景选型决策路径"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-分场景选型决策路径"}},[t._v("#")]),t._v(" 2. 分场景选型决策路径")]),t._v(" "),s("p",[t._v("结合业务核心需求，按以下路径可快速锁定合适引擎，避免无效选型：")]),t._v(" "),s("h4",{attrs:{id:"_1-基础判断-是否需要高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-基础判断-是否需要高可用"}},[t._v("#")]),t._v(" （1）基础判断：是否需要高可用？")]),t._v(" "),s("p",[t._v("若是生产环境核心表、数据可靠性要求高，直接选择对应 "),s("code",[t._v("Replicated*")]),t._v(" 副本引擎（如基础场景选 ReplicatedMergeTree，去重场景选 ReplicatedReplacingMergeTree）；非核心测试表或单机部署场景，选择非副本基础引擎即可。")]),t._v(" "),s("h4",{attrs:{id:"_2-核心需求-数据处理方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-核心需求-数据处理方式"}},[t._v("#")]),t._v(" （2）核心需求：数据处理方式")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("无特殊处理（仅存储+分析）")]),t._v("：直接选 MergeTree，适配绝大多数通用 OLAP 场景（日志分析、报表查询等）；")]),t._v(" "),s("li",[s("strong",[t._v("存在重复数据，需保留最新")]),t._v("：选 ReplacingMergeTree，注意需通过版本列控制数据新旧，查询配合 argMax 函数；")]),t._v(" "),s("li",[s("strong",[t._v("需按固定维度聚合统计（求和为主）")]),t._v("：选 SummingMergeTree，适合订单金额汇总、用户行为次数统计等场景；")]),t._v(" "),s("li",[s("strong",[t._v("复杂聚合需求（UV、平均时长等）")]),t._v("：选 AggregatingMergeTree + 物化视图，通过自定义聚合函数实现灵活统计；")]),t._v(" "),s("li",[s("strong",[t._v("数据存在状态变更（新增/失效）")]),t._v("：选 VersionedCollapsingMergeTree（推荐），无需严格控制写入顺序，适配 CDC 同步、订单状态变更等场景；")]),t._v(" "),s("li",[s("strong",[t._v("稀疏更新（部分字段分批上报）")]),t._v("：若使用 ClickHouse 25.6+，选 CoalescingMergeTree，避免全量更新，适配 IoT 设备状态监控场景。")])]),t._v(" "),s("h3",{attrs:{id:"_3-选型避坑指南"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-选型避坑指南"}},[t._v("#")]),t._v(" 3. 选型避坑指南")]),t._v(" "),s("p",[t._v("实际选型中，需规避以下常见误区，确保引擎适配业务实际需求：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("不要过度追求“功能全面”")]),t._v("：例如无需去重场景强行使用 ReplacingMergeTree，会增加后台合并压力，降低性能；")]),t._v(" "),s("li",[s("strong",[t._v("明确异步机制的局限性")]),t._v("：所有衍生引擎的去重、聚合、折叠均为异步触发，不可依赖其实现实时一致性（如实时订单状态查询需谨慎）；")]),t._v(" "),s("li",[s("strong",[t._v("排序键设计是核心")]),t._v("：所有衍生引擎的去重、聚合、折叠均基于排序键，需确保排序键覆盖核心维度（如去重场景包含唯一标识，聚合场景包含统计维度）；")]),t._v(" "),s("li",[s("strong",[t._v("副本不是越多越好")]),t._v("：2-3 个副本即可满足高可用需求，过多副本会显著增加写入延迟和存储成本；")]),t._v(" "),s("li",[s("strong",[t._v("小批量高频写入需优化")]),t._v("：尤其对于副本引擎，小批量高频写入会导致大量 Part 生成，增加同步压力，建议合并为批量写入（每批 > 1000 行）。")])]),t._v(" "),s("h2",{attrs:{id:"四、总结-核心选型原则与实践建议"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、总结-核心选型原则与实践建议"}},[t._v("#")]),t._v(" 四、总结：核心选型原则与实践建议")]),t._v(" "),s("p",[t._v("MergeTree 家族引擎的选型核心是“场景匹配”，而非“功能堆砌”。实践中可遵循以下原则：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("从简单到复杂")]),t._v("：优先使用基础 MergeTree，仅在存在明确痛点（重复、聚合、状态变更）时，再选择对应衍生引擎；")]),t._v(" "),s("li",[s("strong",[t._v("明确一致性要求")]),t._v("：若需实时一致性（如实时交易查询），ClickHouse 并非最优选择，需结合业务场景考虑其他数据库，或接受异步一致性并通过查询函数兜底；")]),t._v(" "),s("li",[s("strong",[t._v("结合集群架构")]),t._v("：分布式部署场景，需同步考虑分片（Sharding）与副本（Replicated）设计，引擎选择需适配分片策略（如按用户 ID 分片时，去重需注意分片间重复数据）；")]),t._v(" "),s("li",[s("strong",[t._v("优先测试验证")]),t._v("：不同业务的数据量、写入频率、查询模式差异较大，选型后需通过压测验证性能（写入吞吐、查询延迟），确保满足业务指标。")])]),t._v(" "),s("p",[t._v("最终，MergeTree 全家桶的核心价值在于“精准适配”—— 通过不同引擎的特性组合，既能支撑海量数据的高吞吐写入和高效分析，又能通过场景化优化降低应用层复杂度。掌握其核心设计理念和选型逻辑，才能真正发挥 ClickHouse 在 OLAP 场景的性能优势。")])])}),[],!1,null,null,null);s.default=r.exports}}]);