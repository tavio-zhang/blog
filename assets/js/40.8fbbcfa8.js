(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{395:function(_,s,v){"use strict";v.r(s);var a=v(8),r=Object(a.a)({},(function(){var _=this,s=_._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[s("p",[_._v("在分布式搜索引擎领域，Elasticsearch（简称ES）以其近实时性、高吞吐量和分布式特性脱颖而出。")]),_._v(" "),s("h2",{attrs:{id:"一、数据写入-多阶段协同的可靠性保障"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、数据写入-多阶段协同的可靠性保障"}},[_._v("#")]),_._v(" 一、数据写入：多阶段协同的可靠性保障")]),_._v(" "),s("p",[_._v('ES的写入并非简单的"存盘"操作，而是一套包含校验、路由、缓冲、索引及持久化的复杂流程。其核心目标是：在保证高写入性能的同时，确保数据不丢失且最终可查询。')]),_._v(" "),s("h3",{attrs:{id:"_1-文档校验-数据入口的第一道关卡"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-文档校验-数据入口的第一道关卡"}},[_._v("#")]),_._v(" 1. 文档校验：数据入口的第一道关卡")]),_._v(" "),s("p",[_._v("客户端发送的数据需先封装为JSON文档，并指定目标索引。ES接收请求后，首先执行"),s("strong",[_._v("文档校验")]),_._v("，确保数据符合索引的映射规则（Mapping）。")]),_._v(" "),s("ul",[s("li",[s("strong",[_._v("映射规则校验")]),_._v("：索引的Mapping定义了字段类型（如"),s("code",[_._v("price")]),_._v("为"),s("code",[_._v("double")]),_._v("）、分词器（如"),s("code",[_._v("name")]),_._v("使用"),s("code",[_._v("ik_max_word")]),_._v("）等规则。若文档字段与Mapping冲突（例如"),s("code",[_._v("price")]),_._v('传入字符串"2aasfsa"），ES会直接返回错误。')])]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v('  // 错误示例：price字段类型不匹配\n  POST /goods/_doc/3\n  {\n    "name": "iphone13",\n    "price": "2aasfsa"  // 错误：Mapping中price为double，此处为字符串\n  }\n  // 响应：400 Bad Request，提示类型不匹配\n')])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br"),s("span",{staticClass:"line-number"},[_._v("2")]),s("br"),s("span",{staticClass:"line-number"},[_._v("3")]),s("br"),s("span",{staticClass:"line-number"},[_._v("4")]),s("br"),s("span",{staticClass:"line-number"},[_._v("5")]),s("br"),s("span",{staticClass:"line-number"},[_._v("6")]),s("br"),s("span",{staticClass:"line-number"},[_._v("7")]),s("br")])]),s("ul",[s("li",[s("strong",[_._v("动态映射（Dynamic Mapping）")]),_._v("：若文档包含Mapping中未定义的字段（如新增"),s("code",[_._v('type: "phone"')]),_._v("），ES会自动推断字段类型并添加到Mapping中（可通过"),s("code",[_._v("dynamic")]),_._v("参数控制此行为，如"),s("code",[_._v("strict")]),_._v("模式禁止动态添加）。")])]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v('  // 动态映射示例：自动添加type字段\n  POST /goods/_doc/2\n  {\n    "name": "iphone13",\n    "price": 22,\n    "type": "phone"  // Mapping中未定义，自动推断为text类型\n  }\n')])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br"),s("span",{staticClass:"line-number"},[_._v("2")]),s("br"),s("span",{staticClass:"line-number"},[_._v("3")]),s("br"),s("span",{staticClass:"line-number"},[_._v("4")]),s("br"),s("span",{staticClass:"line-number"},[_._v("5")]),s("br"),s("span",{staticClass:"line-number"},[_._v("6")]),s("br"),s("span",{staticClass:"line-number"},[_._v("7")]),s("br")])]),s("h3",{attrs:{id:"_2-分片路由-确定数据的-归宿"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-分片路由-确定数据的-归宿"}},[_._v("#")]),_._v(' 2. 分片路由：确定数据的"归宿"')]),_._v(" "),s("p",[_._v("ES是分布式架构，一个索引由多个主分片（Primary Shard）和副本分片（Replica Shard）组成。文档必须明确写入哪个主分片，这一过程通过"),s("strong",[_._v("路由算法")]),_._v("实现：")]),_._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[_._v("shard = hash(routing) % number_of_primary_shards\n")])]),_._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[_._v("1")]),s("br")])]),s("ul",[s("li",[s("strong",[_._v("路由键（routing）")]),_._v("：默认使用文档ID（"),s("code",[_._v("_id")]),_._v("），也可手动指定（如按用户ID路由，确保同一用户数据落在同一分片，优化关联查询）。")]),_._v(" "),s("li",[s("strong",[_._v("主分片数量（number_of_primary_shards）")]),_._v("：索引创建时指定，后续不可修改（需重建索引调整）。")])]),_._v(" "),s("p",[s("strong",[_._v("示例")]),_._v("：若"),s("code",[_._v("goods")]),_._v("索引有3个主分片，文档ID=1的"),s("code",[_._v("hash(_id)=3")]),_._v("，则"),s("code",[_._v("3%3=0")]),_._v("，文档将写入0号主分片。")]),_._v(" "),s("h3",{attrs:{id:"_3-写入缓冲区与translog-临时存储与可靠性保障"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-写入缓冲区与translog-临时存储与可靠性保障"}},[_._v("#")]),_._v(" 3. 写入缓冲区与Translog：临时存储与可靠性保障")]),_._v(" "),s("p",[_._v("文档路由到目标主分片后，不会直接写入磁盘，而是先进入"),s("strong",[_._v("内存缓冲区（In-Memory Buffer）")]),_._v("，同时一条操作记录会被写入"),s("strong",[_._v("Translog（事务日志）")]),_._v("。")]),_._v(" "),s("ul",[s("li",[s("strong",[_._v("内存缓冲区")]),_._v('：临时存储待索引文档，减少磁盘IO频率，提升写入速度。此时文档处于"不可查询"状态。')]),_._v(" "),s("li",[s("strong",[_._v("Translog")]),_._v("：记录所有未持久化到磁盘的操作，是数据可靠性的核心保障。Translog默认实时刷写到磁盘（通过"),s("code",[_._v("index.translog.durability")]),_._v("控制，"),s("code",[_._v("request")]),_._v("模式确保请求返回前刷盘），即使节点宕机，重启后可通过Translog恢复缓冲区数据，避免丢失。")])]),_._v(" "),s("h3",{attrs:{id:"_4-refresh-让数据-可查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-refresh-让数据-可查询"}},[_._v("#")]),_._v(' 4. Refresh：让数据"可查询"')]),_._v(" "),s("p",[_._v("ES通过"),s("strong",[_._v("Refresh操作")]),_._v("将内存缓冲区的数据转换为可查询状态，默认每1秒自动执行一次（可通过"),s("code",[_._v("index.refresh_interval")]),_._v("配置，如"),s("code",[_._v("-1")]),_._v("禁用自动刷新，适合批量写入场景）。")]),_._v(" "),s("ul",[s("li",[s("strong",[_._v("过程")]),_._v("：内存缓冲区的数据被写入"),s("strong",[_._v("Lucene分段（Segment）")]),_._v(" 并生成倒排索引（关键词到文档ID的映射，如"),s("code",[_._v("iphone -> [2, 3, 12]")]),_._v("），随后内存缓冲区清空。")]),_._v(" "),s("li",[s("strong",[_._v("特性")]),_._v("：分段生成后文档即可被查询（近实时性的核心），但此时分段仍存储在内存中，未持久化到磁盘。")])]),_._v(" "),s("h3",{attrs:{id:"_5-flush-数据永久化到磁盘"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-flush-数据永久化到磁盘"}},[_._v("#")]),_._v(" 5. Flush：数据永久化到磁盘")]),_._v(" "),s("p",[_._v("当Translog达到一定大小（默认512MB，可通过"),s("code",[_._v("index.translog.flush_threshold_size")]),_._v("调整）或间隔30分钟（可配置），ES会执行"),s("strong",[_._v("Flush操作")]),_._v("，将内存中的分段永久写入磁盘：")]),_._v(" "),s("ul",[s("li",[_._v("内存中的分段被刷写到磁盘（通过"),s("code",[_._v("fsync")]),_._v("确保物理写入）。")]),_._v(" "),s("li",[_._v("清空Translog（已持久化的数据无需再记录）。")])]),_._v(" "),s("p",[_._v("Flush操作可手动触发（"),s("code",[_._v("POST /索引名/_flush")]),_._v("），但频繁触发会影响性能，建议依赖自动机制。")]),_._v(" "),s("h3",{attrs:{id:"_6-副本同步-数据冗余与高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-副本同步-数据冗余与高可用"}},[_._v("#")]),_._v(" 6. 副本同步：数据冗余与高可用")]),_._v(" "),s("p",[_._v("主分片完成写入后，会将文档同步到其对应的"),s("strong",[_._v("副本分片")]),_._v('（Replica Shard）。只有当主分片和所有副本分片都确认写入完成后，ES才会向客户端返回"成功"响应（可通过'),s("code",[_._v("wait_for_active_shards")]),_._v("控制等待的副本数量）。")]),_._v(" "),s("ul",[s("li",[_._v("副本分片的作用：提供数据冗余（主分片故障时可升级为新主分片）、分担查询压力（查询请求可路由到副本）。")])]),_._v(" "),s("h2",{attrs:{id:"二、数据查询-快速定位目标文档的流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、数据查询-快速定位目标文档的流程"}},[_._v("#")]),_._v(" 二、数据查询：快速定位目标文档的流程")]),_._v(" "),s("p",[_._v("ES的查询核心是从海量文档中快速匹配目标，流程可分为"),s("strong",[_._v("请求分发、分片内匹配、结果聚合")]),_._v("三个阶段。")]),_._v(" "),s("h3",{attrs:{id:"_1-请求分发-协调节点的-调度中心-角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-请求分发-协调节点的-调度中心-角色"}},[_._v("#")]),_._v(' 1. 请求分发：协调节点的"调度中心"角色')]),_._v(" "),s("p",[_._v("客户端的查询请求首先由"),s("strong",[_._v("协调节点（Coordinating Node）")]),_._v(" 接收，其核心任务是协调查询流程：")]),_._v(" "),s("ul",[s("li",[_._v("解析查询语句（如"),s("code",[_._v("name: iphone")]),_._v("），确定目标索引。")]),_._v(" "),s("li",[_._v("根据索引的分片分布（主分片+副本分片），选择参与查询的分片（默认采用轮询机制在主/副本间负载均衡）。")]),_._v(" "),s("li",[_._v("将查询请求分发到选定的分片。")])]),_._v(" "),s("h3",{attrs:{id:"_2-分片内匹配-倒排索引的高效检索"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-分片内匹配-倒排索引的高效检索"}},[_._v("#")]),_._v(" 2. 分片内匹配：倒排索引的高效检索")]),_._v(" "),s("p",[_._v("被选中的分片接收到请求后，执行"),s("strong",[_._v("分片内查询")]),_._v("：")]),_._v(" "),s("ul",[s("li",[_._v("将ES查询语句转换为Lucene可执行的查询（如"),s("code",[_._v("TermQuery")]),_._v("）。")]),_._v(" "),s("li",[_._v("遍历分片内的所有Lucene分段，利用倒排索引快速匹配包含目标关键词的文档ID。")]),_._v(" "),s("li",[_._v("对匹配的文档进行"),s("strong",[_._v("相关性评分")]),_._v("（基于TF/IDF、字段权重等算法），按评分排序后，返回前N条文档的ID和评分（不返回完整文档，减少数据传输量）。")])]),_._v(" "),s("h3",{attrs:{id:"_3-结果聚合-协调节点的-整合工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-结果聚合-协调节点的-整合工作"}},[_._v("#")]),_._v(' 3. 结果聚合：协调节点的"整合工作"')]),_._v(" "),s("p",[_._v("协调节点收集所有分片返回的（文档ID+评分）后，执行最终处理：")]),_._v(" "),s("ul",[s("li",[_._v("对所有文档ID按评分重新排序，筛选出全局前N条（如分页查询中的"),s("code",[_._v("from")]),_._v("和"),s("code",[_._v("size")]),_._v("参数）。")]),_._v(" "),s("li",[_._v("向对应的分片请求这些文档的完整数据（通过文档ID精准获取）。")]),_._v(" "),s("li",[_._v("将完整文档整理为JSON格式，返回给客户端。")])]),_._v(" "),s("h2",{attrs:{id:"三、总结-近实时与高可用的设计本质"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、总结-近实时与高可用的设计本质"}},[_._v("#")]),_._v(" 三、总结：近实时与高可用的设计本质")]),_._v(" "),s("p",[_._v("ES的写入与查询流程深刻体现了其设计哲学：")]),_._v(" "),s("ul",[s("li",[s("strong",[_._v("近实时性")]),_._v("：通过Refresh机制（1秒间隔）平衡写入性能与查询延迟，数据并非实时可见，但延迟可控。")]),_._v(" "),s("li",[s("strong",[_._v("可靠性")]),_._v("：Translog确保数据不丢失，副本分片提供冗余，Flush保障数据永久化。")]),_._v(" "),s("li",[s("strong",[_._v("分布式效率")]),_._v("：分片路由实现数据均匀分布，查询时分片并行处理+协调节点聚合，支撑海量数据的高效检索。")])])])}),[],!1,null,null,null);s.default=r.exports}}]);