(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{394:function(s,e,r){"use strict";r.r(e);var a=r(8),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("在 Elasticsearch的日常应用中，分页查询是高频需求——无论是用户浏览商品列表、后台系统查看数据记录，还是数据分析中的批量提取，都离不开分页。但随着数据量增长，当用户翻到几十甚至上百页后，查询响应会急剧变慢，甚至出现集群崩溃风险。")]),s._v(" "),e("h2",{attrs:{id:"一、深度分页-为什么会成为性能陷阱"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、深度分页-为什么会成为性能陷阱"}},[s._v("#")]),s._v(" 一、深度分页：为什么会成为性能陷阱？")]),s._v(" "),e("h3",{attrs:{id:"_1-1-什么是深度分页"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是深度分页"}},[s._v("#")]),s._v(" 1.1 什么是深度分页？")]),s._v(" "),e("p",[s._v("通常我们将「页码较深的分页查询」称为深度分页。例如，用户查询第 100 页数据（"),e("code",[s._v("from=990，size=10")]),s._v("），或直接跳转到第 500 页，都属于深度分页场景。此时，ES 的查询性能会显著下降，甚至触发内置保护机制。")]),s._v(" "),e("h3",{attrs:{id:"_1-2-from-size-浅分页的-甜蜜陷阱"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-from-size-浅分页的-甜蜜陷阱"}},[s._v("#")]),s._v(" 1.2 from+size：浅分页的“甜蜜陷阱”")]),s._v(" "),e("p",[s._v("日常开发中，我们习惯用 "),e("code",[s._v("from+size")]),s._v(" 实现分页，语法简单直观：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n  "query": { "match_all": {} },\n  "from": 10,  // 跳过前10条\n  "size": 20   // 返回20条\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("这种方式在浅分页（如前 10 页）或数据量较小时表现良好，但在深度分页场景下会暴露严重问题。")]),s._v(" "),e("h3",{attrs:{id:"_1-3-分布式架构下的聚合陷阱"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-分布式架构下的聚合陷阱"}},[s._v("#")]),s._v(" 1.3 分布式架构下的聚合陷阱")]),s._v(" "),e("p",[s._v("ES 是分布式存储，索引数据分散在多个分片上。当使用 "),e("code",[s._v("from+size")]),s._v(" 时，查询流程如下：")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("分片查询")]),s._v("：每个分片需返回 "),e("code",[s._v("from+size")]),s._v(" 条数据（而非 "),e("code",[s._v("size")]),s._v(" 条）。例如 "),e("code",[s._v("from=9000，size=20")]),s._v(" 时，每个分片需返回 9020 条数据；")]),s._v(" "),e("li",[e("strong",[s._v("协调节点聚合")]),s._v("：协调节点收集所有分片的 "),e("code",[s._v("9020")]),s._v(" 条数据，在内存中合并、排序，最终截取第 9000~9020 条返回。")])]),s._v(" "),e("p",[s._v("随着 "),e("code",[s._v("from")]),s._v(" 增大，每个分片返回的数据量剧增，导致：")]),s._v(" "),e("ul",[e("li",[s._v("网络传输量暴增（如 3 个分片时，"),e("code",[s._v("from=10w")]),s._v(" 需传输 3*(10w+size) 条数据）；")]),s._v(" "),e("li",[s._v("协调节点内存消耗飙升，排序耗时指数级增长；")]),s._v(" "),e("li",[s._v("接口 P90 响应时间大幅延长（90% 的请求响应变慢）。")])]),s._v(" "),e("h3",{attrs:{id:"_1-4-官方的-保命机制-max-result-window"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-官方的-保命机制-max-result-window"}},[s._v("#")]),s._v(" 1.4 官方的“保命机制”：max_result_window")]),s._v(" "),e("p",[s._v("为避免深度分页拖垮集群，ES 默认设置 "),e("code",[s._v("max_result_window=10000")]),s._v("（可通过索引设置修改）。当 "),e("code",[s._v("from+size")]),s._v(" 超过该值时，ES 会直接报错：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('{\n  "error": {\n    "root_cause": [\n      { "type": "query_phase_execution_exception", "reason": "Result window is too large..." }\n    ]\n  }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("这意味着，即使你想“硬扛”深度分页，ES 也会主动限制。")]),s._v(" "),e("h2",{attrs:{id:"二、深度分页解决方案全解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、深度分页解决方案全解析"}},[s._v("#")]),s._v(" 二、深度分页解决方案全解析")]),s._v(" "),e("p",[s._v("针对深度分页问题，ES 提供了三种方案，各有适用场景。")]),s._v(" "),e("h3",{attrs:{id:"方案一-from-size-浅分页-业务限制法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案一-from-size-浅分页-业务限制法"}},[s._v("#")]),s._v(" 方案一：from+size 浅分页（业务限制法）")]),s._v(" "),e("p",[e("strong",[s._v("核心思路")]),s._v("：从业务层面限制分页深度，避免触发 "),e("code",[s._v("max_result_window")]),s._v(" 和性能问题。")]),s._v(" "),e("h4",{attrs:{id:"适用场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#适用场景"}},[s._v("#")]),s._v(" 适用场景")]),s._v(" "),e("ul",[e("li",[s._v("数据量较小（总数据量 < 10w）；")]),s._v(" "),e("li",[s._v("需支持跳页（如用户直接点击第 5 页）；")]),s._v(" "),e("li",[s._v("对实时性要求高（如最新数据查询）。")])]),s._v(" "),e("h4",{attrs:{id:"实现方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现方式"}},[s._v("#")]),s._v(" 实现方式")]),s._v(" "),e("ol",[e("li",[s._v("保留 "),e("code",[s._v("from+size")]),s._v(" 语法，但限制最大页码（如仅允许查询前 100 页）；")]),s._v(" "),e("li",[s._v("前端展示时截断总条数（避免用户尝试翻到过深页码）。")])]),s._v(" "),e("p",[e("strong",[s._v("代码示例")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// Java 后端：限制 from 不超过 990（即第 100 页，size=10）\nint maxFrom = 990;\nint from = (page - 1) * size;\nif (from > maxFrom) {\n    throw new RuntimeException("最多支持查询前 100 页");\n}\n\nSearchRequest esRequest = new SearchRequest(indexName);\nSearchSourceBuilder sourceBuilder = new SearchSourceBuilder();\nsourceBuilder.query(QueryBuilders.matchAllQuery())\n             .sort("id", SortOrder.ASC)\n             .from(from)\n             .size(size);\nesRequest.source(sourceBuilder);\n\n// 前端：截断总条数，避免显示过深页码\nthis.total = response.total > 1000 ? 1000 : response.total; \n// 假设 size=10，1000 对应 100 页\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h4",{attrs:{id:"优缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优缺点"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("优点")]),s._v("：实现简单，支持跳页，实时性好；")]),s._v(" "),e("li",[e("strong",[s._v("缺点")]),s._v("：无法支持深度分页（如超过 100 页），依赖业务限制。")])]),s._v(" "),e("h3",{attrs:{id:"方案二-scroll-api-快照分页法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案二-scroll-api-快照分页法"}},[s._v("#")]),s._v(" 方案二：Scroll API（快照分页法）")]),s._v(" "),e("p",[e("strong",[s._v("核心思路")]),s._v("：创建数据快照，通过 "),e("code",[s._v("scroll_id")]),s._v(" 分批获取数据，避免重复计算。")]),s._v(" "),e("h4",{attrs:{id:"适用场景-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-2"}},[s._v("#")]),s._v(" 适用场景")]),s._v(" "),e("ul",[e("li",[s._v("批量数据导出（如导出 10w 条历史数据）；")]),s._v(" "),e("li",[s._v("全量数据遍历（如数据迁移、索引重建）；")]),s._v(" "),e("li",[s._v("不要求实时性，且无需跳页（仅支持顺序分页）。")])]),s._v(" "),e("h4",{attrs:{id:"实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现原理"}},[s._v("#")]),s._v(" 实现原理")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("创建快照")]),s._v("：首次查询时，ES 在所有分片上创建数据快照（查询时的静态数据，新增/修改的数据不会被包含），并返回 "),e("code",[s._v("scroll_id")]),s._v("；")]),s._v(" "),e("li",[e("strong",[s._v("分批获取")]),s._v("：后续分页通过 "),e("code",[s._v("scroll_id")]),s._v(" 从快照中获取下一页数据，"),e("code",[s._v("scroll_id")]),s._v(" 有效期可设置（如 1 分钟）；")]),s._v(" "),e("li",[e("strong",[s._v("清理资源")]),s._v("：查询结束后需主动清理 "),e("code",[s._v("scroll_id")]),s._v("，避免占用集群内存。")])]),s._v(" "),e("h4",{attrs:{id:"代码示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代码示例"}},[s._v("#")]),s._v(" 代码示例")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 1. 初始化 Scroll（设置快照有效期为 1 分钟）\nScroll scroll = new Scroll(TimeValue.timeValueMinutes(1));\nSearchRequest request = new SearchRequest(indexName);\nrequest.scroll(scroll);\n\n// 2. 首次查询，生成 scroll_id\nSearchSourceBuilder sourceBuilder = new SearchSourceBuilder();\nsourceBuilder.query(QueryBuilders.matchAllQuery())\n             .sort("id", SortOrder.ASC)\n             .size(100); // 每次返回 100 条\nrequest.source(sourceBuilder);\n\nSearchResponse response = esClient.search(request, RequestOptions.DEFAULT);\nString scrollId = response.getScrollId();\nSearchHit[] hits = response.getHits().getHits();\n\n// 3. 循环获取下一页\nList<HKAddressDTO> result = new ArrayList<>();\nwhile (hits != null && hits.length > 0) {\n    // 处理当前页数据\n    for (SearchHit hit : hits) {\n        result.add(JSON.parseObject(hit.getSourceAsString(), HKAddressDTO.class));\n    }\n    \n    // 用 scroll_id 获取下一页\n    SearchScrollRequest scrollRequest = new SearchScrollRequest(scrollId);\n    scrollRequest.scroll(scroll); // 重置有效期\n    response = esClient.scroll(scrollRequest, RequestOptions.DEFAULT);\n    scrollId = response.getScrollId();\n    hits = response.getHits().getHits();\n}\n\n// 4. 清理 scroll_id（关键！避免内存泄漏）\nClearScrollRequest clearRequest = new ClearScrollRequest();\nclearRequest.addScrollId(scrollId);\nesClient.clearScroll(clearRequest, RequestOptions.DEFAULT);\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br")])]),e("h4",{attrs:{id:"优缺点-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-2"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("优点")]),s._v("：支持海量数据分页，性能稳定（基于快照，无需重复计算）；")]),s._v(" "),e("li",[e("strong",[s._v("缺点")]),s._v("：\n"),e("ul",[e("li",[s._v("数据非实时（快照创建后的数据变更不生效）；")]),s._v(" "),e("li",[s._v("不支持跳页（只能顺序往后翻）；")]),s._v(" "),e("li",[e("code",[s._v("scroll_id")]),s._v(" 占用内存，需及时清理，否则可能导致节点宕机。")])])])]),s._v(" "),e("h3",{attrs:{id:"方案三-search-after-实时游标分页法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案三-search-after-实时游标分页法"}},[s._v("#")]),s._v(" 方案三：Search After（实时游标分页法）")]),s._v(" "),e("p",[e("strong",[s._v("核心思路")]),s._v("：基于上一页最后一条数据的排序值（游标）定位下一页，彻底摆脱 "),e("code",[s._v("from")]),s._v(" 的限制，是 ES 5+ 推荐的深度分页方案。")]),s._v(" "),e("h4",{attrs:{id:"适用场景-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#适用场景-3"}},[s._v("#")]),s._v(" 适用场景")]),s._v(" "),e("ul",[e("li",[s._v("深度分页且需实时性（如用户无限滚动加载数据）；")]),s._v(" "),e("li",[s._v("仅需顺序分页（不支持跳页，但可实现前后翻页）；")]),s._v(" "),e("li",[s._v("数据量极大（超过 10w 甚至 100w）。")])]),s._v(" "),e("h4",{attrs:{id:"实现原理-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现原理-2"}},[s._v("#")]),s._v(" 实现原理")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("排序字段要求")]),s._v("：必须指定"),e("strong",[s._v("唯一且稳定")]),s._v("的排序字段（如主键 "),e("code",[s._v("id")]),s._v("），避免排序冲突导致分页错乱；")]),s._v(" "),e("li",[e("strong",[s._v("游标定位")]),s._v("：首次查询时，记录最后一条数据的 "),e("code",[s._v("sort")]),s._v(" 值（游标）；下一页查询时，通过 "),e("code",[s._v("search_after")]),s._v(" 参数传入该游标，ES 直接从游标位置往后查询；")]),s._v(" "),e("li",[e("strong",[s._v("分布式协调")]),s._v("：每个分片独立维护有序数据，协调节点将 "),e("code",[s._v("search_after")]),s._v(" 条件下发到分片，分片仅返回排序值大于游标的前 "),e("code",[s._v("size")]),s._v(" 条数据，大幅减少传输和计算量。")])]),s._v(" "),e("h4",{attrs:{id:"代码示例-基础版-仅往后翻页"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#代码示例-基础版-仅往后翻页"}},[s._v("#")]),s._v(" 代码示例（基础版：仅往后翻页）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('List<HKAddressDTO> queryBySearchAfter(Object[] lastSortValue, int size) {\n    SearchRequest request = new SearchRequest(indexName);\n    SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();\n    \n    // 1. 构建查询（必须指定唯一排序字段）\n    sourceBuilder.query(QueryBuilders.matchAllQuery())\n                 .sort("id", SortOrder.ASC); // 以 id 正序排序\n    \n    // 2. 非首次查询时，设置上一页的最后一个游标\n    if (lastSortValue != null && lastSortValue.length > 0) {\n        sourceBuilder.searchAfter(lastSortValue);\n    }\n    \n    // 3. 设置每页大小\n    sourceBuilder.size(size);\n    request.source(sourceBuilder);\n    \n    // 4. 执行查询并处理结果\n    SearchResponse response = esClient.search(request, RequestOptions.DEFAULT);\n    SearchHit[] hits = response.getHits().getHits();\n    List<HKAddressDTO> result = new ArrayList<>();\n    Object[] currentLastSortValue = null;\n    \n    for (SearchHit hit : hits) {\n        result.add(JSON.parseObject(hit.getSourceAsString(), HKAddressDTO.class));\n        currentLastSortValue = hit.getSortValues(); // 更新当前页最后一个游标\n    }\n    \n    // 返回数据和当前页最后一个游标（供下一页使用）\n    return result;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h4",{attrs:{id:"进阶-实现往前翻页"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#进阶-实现往前翻页"}},[s._v("#")]),s._v(" 进阶：实现往前翻页")]),s._v(" "),e("p",[s._v("Search After 本身不支持跳页，但可通过“保存首尾游标 + 反向排序”实现往前翻页：")]),s._v(" "),e("ol",[e("li",[e("strong",[s._v("保存游标")]),s._v("：每次查询时，记录当前页第一条和最后一条数据的 "),e("code",[s._v("sort")]),s._v(" 值（如 "),e("code",[s._v("firstSort")]),s._v(" 和 "),e("code",[s._v("lastSort")]),s._v("）；")]),s._v(" "),e("li",[e("strong",[s._v("往前翻页")]),s._v("：当用户点击“上一页”时，以 "),e("code",[s._v("firstSort")]),s._v(" 为游标，使用"),e("strong",[s._v("反向排序")]),s._v("查询 "),e("code",[s._v("size")]),s._v(" 条数据。")])]),s._v(" "),e("p",[e("strong",[s._v("示例")]),s._v("："),e("br"),s._v("\n当前页数据排序值为 "),e("code",[s._v("[20, 21, ..., 30]")]),s._v("（正序），往前翻页时：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 反向排序（id 倒序），以当前页第一条的 sort 值为游标\nsourceBuilder.query(QueryBuilders.matchAllQuery())\n             .sort("id", SortOrder.DESC) // 倒序\n             .searchAfter(firstSortValue); // firstSortValue = 20\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("查询结果为 "),e("code",[s._v("[19, 18, ..., 10]")]),s._v("，反转后即为上一页数据 "),e("code",[s._v("[10, 11, ..., 19]")]),s._v("。")]),s._v(" "),e("h4",{attrs:{id:"优缺点-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-3"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("优点")]),s._v("：\n"),e("ul",[e("li",[s._v("无 "),e("code",[s._v("max_result_window")]),s._v(" 限制，支持无限深度分页；")]),s._v(" "),e("li",[s._v("基于实时数据（非快照），数据最新；")]),s._v(" "),e("li",[s._v("性能优异（仅传输当前页所需数据）；")])])]),s._v(" "),e("li",[e("strong",[s._v("缺点")]),s._v("：\n"),e("ul",[e("li",[s._v("不支持直接跳页（需顺序翻）；")]),s._v(" "),e("li",[s._v("依赖排序字段的唯一性和稳定性；")]),s._v(" "),e("li",[s._v("往前翻页需额外开发逻辑（保存首尾游标）。")])])])]),s._v(" "),e("h2",{attrs:{id:"三、方案对比与选择建议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、方案对比与选择建议"}},[s._v("#")]),s._v(" 三、方案对比与选择建议")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("方案")]),s._v(" "),e("th",[s._v("适用场景")]),s._v(" "),e("th",[s._v("支持跳页")]),s._v(" "),e("th",[s._v("实时性")]),s._v(" "),e("th",[s._v("性能（深度分页）")]),s._v(" "),e("th",[s._v("限制")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("from+size")]),s._v(" "),e("td",[s._v("浅分页、需跳页")]),s._v(" "),e("td",[s._v("是")]),s._v(" "),e("td",[s._v("实时")]),s._v(" "),e("td",[s._v("差（随深度下降）")]),s._v(" "),e("td",[s._v("受 max_result_window 限制")])]),s._v(" "),e("tr",[e("td",[s._v("Scroll API")]),s._v(" "),e("td",[s._v("批量导出、全量遍历")]),s._v(" "),e("td",[s._v("否")]),s._v(" "),e("td",[s._v("快照")]),s._v(" "),e("td",[s._v("优")]),s._v(" "),e("td",[s._v("占用内存，需清理 scroll_id")])]),s._v(" "),e("tr",[e("td",[s._v("Search After")]),s._v(" "),e("td",[s._v("深度分页、实时性要求高")]),s._v(" "),e("td",[s._v("否（可顺序翻）")]),s._v(" "),e("td",[s._v("实时")]),s._v(" "),e("td",[s._v("优")]),s._v(" "),e("td",[s._v("依赖唯一排序字段")])])])]),s._v(" "),e("p",[e("strong",[s._v("选择建议")]),s._v("：")]),s._v(" "),e("ul",[e("li",[s._v("后台管理系统（需跳页，数据量小）→ "),e("code",[s._v("from+size")]),s._v(" + 页码限制；")]),s._v(" "),e("li",[s._v("数据导出/全量同步 → "),e("code",[s._v("Scroll API")]),s._v("；")]),s._v(" "),e("li",[s._v("移动端无限滚动、海量数据分页 → "),e("code",[s._v("Search After")]),s._v("。")])]),s._v(" "),e("h2",{attrs:{id:"四、总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、总结"}},[s._v("#")]),s._v(" 四、总结")]),s._v(" "),e("p",[s._v("ES 深度分页的核心矛盾是分布式架构下的聚合成本。"),e("code",[s._v("from+size")]),s._v(" 适合简单场景但受限于深度，"),e("code",[s._v("Scroll API")]),s._v(" 适合批量处理但牺牲实时性，"),e("code",[s._v("Search After")]),s._v(" 则是平衡实时性和深度分页的最优解。")])])}),[],!1,null,null,null);e.default=t.exports}}]);