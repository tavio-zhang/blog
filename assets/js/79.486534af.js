(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{435:function(t,s,a){"use strict";a.r(s);var n=a(8),r=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"spring事务传播机制深度解析-原理、特性与实战"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring事务传播机制深度解析-原理、特性与实战"}},[t._v("#")]),t._v(" Spring事务传播机制深度解析：原理、特性与实战")]),t._v(" "),s("p",[t._v("在Spring开发中，事务管理是保障数据一致性的核心手段，而“事务传播机制”则是多事务方法嵌套调用时的核心规则——它决定了嵌套场景下，内部事务如何与外部事务协同工作（是加入外部事务、创建新事务，还是挂起外部事务）。")]),t._v(" "),s("h2",{attrs:{id:"一、核心认知-什么是spring事务传播"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、核心认知-什么是spring事务传播"}},[t._v("#")]),t._v(" 一、核心认知：什么是Spring事务传播？")]),t._v(" "),s("h3",{attrs:{id:"_1-1-定义"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-定义"}},[t._v("#")]),t._v(" 1.1 定义")]),t._v(" "),s("p",[t._v("Spring事务传播机制，指的是"),s("strong",[t._v("当一个事务方法（被@Transactional注解标记）调用另一个事务方法时，Spring如何管理这两个方法的事务边界")]),t._v("。具体来说，它定义了：")]),t._v(" "),s("ul",[s("li",[t._v("内部事务是否需要创建新的事务；")]),t._v(" "),s("li",[t._v("内部事务是否需要加入外部事务（即与外部事务共用一个事务）；")]),t._v(" "),s("li",[t._v("当外部事务回滚/提交时，对内部事务的影响；")]),t._v(" "),s("li",[t._v("当内部事务抛出异常时，对外部事务的影响。")])]),t._v(" "),s("h3",{attrs:{id:"_1-2-为什么需要事务传播"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-为什么需要事务传播"}},[t._v("#")]),t._v(" 1.2 为什么需要事务传播？")]),t._v(" "),s("p",[t._v("实际开发中，事务方法的嵌套调用极为常见，不同业务场景对事务的协同要求不同。例如：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("场景1：下单流程")]),t._v("：下单方法（外部事务）调用扣库存方法（内部事务）。要求：下单失败则扣库存必须回滚，扣库存失败则下单也必须回滚（两者共用一个事务）；")]),t._v(" "),s("li",[s("strong",[t._v("场景2：下单记日志")]),t._v("：下单方法（外部事务）调用记录操作日志方法（内部事务）。要求：下单失败时日志不能回滚（日志需要独立保存），日志记录失败不影响下单流程；")]),t._v(" "),s("li",[s("strong",[t._v("场景3：批量数据处理")]),t._v("：批量导入方法（外部事务）调用单条导入方法（内部事务）。要求：单条导入失败时，仅回滚该条数据的导入，不影响其他数据和外部事务。")])]),t._v(" "),s("p",[t._v("如果没有灵活的事务传播机制，仅靠“单一事务”无法满足这些复杂场景的需求。Spring的7种事务传播行为，正是为了解决不同嵌套场景下的事务协同问题。")]),t._v(" "),s("h2",{attrs:{id:"二、基础铺垫-spring事务的核心前提"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、基础铺垫-spring事务的核心前提"}},[t._v("#")]),t._v(" 二、基础铺垫：Spring事务的核心前提")]),t._v(" "),s("p",[t._v("在深入传播机制前，需先明确Spring事务的几个核心前提，避免后续理解偏差：")]),t._v(" "),s("h3",{attrs:{id:"_2-1-事务的核心特性-acid"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-事务的核心特性-acid"}},[t._v("#")]),t._v(" 2.1 事务的核心特性（ACID）")]),t._v(" "),s("p",[t._v("事务的原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）是传播机制的基础——传播机制的本质是在嵌套场景下保障ACID特性的灵活适配。")]),t._v(" "),s("h3",{attrs:{id:"_2-2-声明式事务的基础使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-声明式事务的基础使用"}},[t._v("#")]),t._v(" 2.2 声明式事务的基础使用")]),t._v(" "),s("p",[t._v("Spring事务传播机制基于“声明式事务”（@Transactional注解）生效，核心配置如下：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事务传播行为（默认REQUIRED）")]),t._v("\n    isolation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Isolation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("DEFAULT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 事务隔离级别")]),t._v("\n    rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发回滚的异常类型")]),t._v("\n    readOnly "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("                    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 是否为只读事务")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("businessMethod")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务逻辑")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("其中，"),s("code",[t._v("propagation")]),t._v("属性指定事务传播行为，是本文的核心。")]),t._v(" "),s("h3",{attrs:{id:"_2-3-事务的核心边界"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-事务的核心边界"}},[t._v("#")]),t._v(" 2.3 事务的核心边界")]),t._v(" "),s("p",[t._v("Spring事务的边界由“事务管理器”（PlatformTransactionManager）控制：")]),t._v(" "),s("ul",[s("li",[t._v("事务开始：进入@Transactional标记的方法时，事务管理器创建事务（开启数据库连接，设置自动提交为false）；")]),t._v(" "),s("li",[t._v("事务提交：方法正常执行完成后，事务管理器提交事务（执行commit）；")]),t._v(" "),s("li",[t._v("事务回滚：方法抛出异常（且异常符合rollbackFor配置）时，事务管理器回滚事务（执行rollback）。")])]),t._v(" "),s("p",[t._v("事务传播机制的核心，就是修改这一“边界规则”在嵌套场景下的表现。")]),t._v(" "),s("h2",{attrs:{id:"三、核心解析-7种spring事务传播行为"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、核心解析-7种spring事务传播行为"}},[t._v("#")]),t._v(" 三、核心解析：7种Spring事务传播行为")]),t._v(" "),s("p",[t._v("Spring定义了7种事务传播行为，封装在"),s("code",[t._v("org.springframework.transaction.annotation.Propagation")]),t._v("枚举类中。我们按“是否依赖外部事务”分为3大类，逐一解析每种传播行为的特性、适用场景和执行逻辑。")]),t._v(" "),s("h3",{attrs:{id:"_3-1-第一类-依赖外部事务-默认场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-第一类-依赖外部事务-默认场景"}},[t._v("#")]),t._v(" 3.1 第一类：依赖外部事务（默认场景）")]),t._v(" "),s("p",[t._v("此类传播行为的核心特点是：内部事务优先依赖外部事务，只有当外部事务不存在时，才会创建新事务。包含2种传播行为：REQUIRED、SUPPORTS。")]),t._v(" "),s("h4",{attrs:{id:"_3-1-1-required-默认传播行为"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-required-默认传播行为"}},[t._v("#")]),t._v(" 3.1.1 REQUIRED（默认传播行为）")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：如果当前存在外部事务，则内部事务加入外部事务（共用一个事务）；如果当前没有外部事务，则创建新的事务。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Support a current transaction, create a new one if none exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：\n"),s("ol",[s("li",[t._v("外部方法有事务：内部方法与外部方法共用一个事务，事务的提交/回滚由外部方法控制；")]),t._v(" "),s("li",[t._v("外部方法无事务：内部方法创建新的独立事务，自己控制提交/回滚。")])])]),t._v(" "),s("li",[s("strong",[t._v("回滚规则")]),t._v("：\n"),s("ul",[s("li",[t._v("内部方法抛出异常（符合回滚规则）：无论外部方法是否捕获，都会导致整个事务回滚；")]),t._v(" "),s("li",[t._v("外部方法抛出异常：内部方法的操作也会随外部事务一起回滚。")])])]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：最常用，适用于“内部事务与外部事务强关联”的场景（如下单扣库存、转账等）。")]),t._v(" "),s("li",[s("strong",[t._v("实战示例")]),t._v("：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 外部方法（有事务）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Order")]),t._v(" order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 保存订单")]),t._v("\n    orderDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 调用内部方法（扣库存）")]),t._v("\n    stockService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deductStock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getProductId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getQuantity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内部方法（REQUIRED传播行为）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deductStock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Stock")]),t._v(" stock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" stockDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getQuantity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"库存不足"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    stock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setQuantity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getQuantity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    stockDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("p",[t._v("执行结果分析：")]),t._v(" "),s("ul",[s("li",[t._v("扣库存抛出“库存不足”异常：createOrder和deductStock共用一个事务，整个事务回滚，订单不会被保存；")]),t._v(" "),s("li",[t._v("保存订单成功，但外部方法后续抛出异常：扣库存操作也会随外部事务回滚，库存恢复原样。")])]),t._v(" "),s("h4",{attrs:{id:"_3-1-2-supports"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-supports"}},[t._v("#")]),t._v(" 3.1.2 SUPPORTS")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：如果当前存在外部事务，则内部事务加入外部事务；如果当前没有外部事务，则内部事务以“非事务方式”执行（不创建新事务）。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Support a current transaction, execute non-transactionally if none exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：\n"),s("ol",[s("li",[t._v("外部有事务：加入外部事务，遵循外部事务的提交/回滚规则；")]),t._v(" "),s("li",[t._v("外部无事务：以普通方法执行，无事务保障（操作直接提交到数据库）。")])])]),t._v(" "),s("li",[s("strong",[t._v("回滚规则")]),t._v("：\n"),s("ul",[s("li",[t._v("外部有事务时：内部方法的异常会导致整个事务回滚；")]),t._v(" "),s("li",[t._v("外部无事务时：内部方法的异常不会触发回滚（操作已直接提交）。")])])]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“可选事务”的场景（如查询操作，有事务则加入，无则正常执行）。")]),t._v(" "),s("li",[s("strong",[t._v("注意")]),t._v("：SUPPORTS是“被动依赖”外部事务，本身不主动创建事务，需谨慎使用（避免非事务场景下的数据一致性问题）。")])]),t._v(" "),s("h3",{attrs:{id:"_3-2-第二类-不依赖外部事务-强制创建新事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-第二类-不依赖外部事务-强制创建新事务"}},[t._v("#")]),t._v(" 3.2 第二类：不依赖外部事务（强制创建新事务）")]),t._v(" "),s("p",[t._v("此类传播行为的核心特点是：无论外部是否存在事务，内部事务都会强制创建新的独立事务，与外部事务完全隔离。包含2种传播行为：REQUIRES_NEW、NOT_SUPPORTED。")]),t._v(" "),s("h4",{attrs:{id:"_3-2-1-requires-new"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-1-requires-new"}},[t._v("#")]),t._v(" 3.2.1 REQUIRES_NEW")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：无论当前是否存在外部事务，内部事务都会创建一个全新的独立事务；如果外部存在事务，则先将外部事务挂起，待内部事务执行完成后，再恢复外部事务。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Create a new transaction, and suspend the current transaction if one exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：\n"),s("ol",[s("li",[t._v("外部有事务：挂起外部事务 → 创建内部新事务 → 内部事务执行完成（提交/回滚） → 恢复外部事务继续执行；")]),t._v(" "),s("li",[t._v("外部无事务：直接创建新事务，自己控制提交/回滚。")])])]),t._v(" "),s("li",[s("strong",[t._v("回滚规则")]),t._v("：\n"),s("ul",[s("li",[t._v("内部事务的提交/回滚与外部事务完全独立：内部事务失败回滚，不影响外部事务；外部事务失败回滚，也不影响内部事务；")]),t._v(" "),s("li",[t._v("若内部事务抛出异常，外部事务若未捕获，外部事务会回滚；但内部事务的操作已独立提交/回滚，不受影响。")])])]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“内部事务需要独立存在”的场景（如操作日志、审计记录等，即使主业务失败，日志也需保留）。")]),t._v(" "),s("li",[s("strong",[t._v("实战示例")]),t._v("：改造下单记日志场景：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 外部方法（下单，有事务）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createOrder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Order")]),t._v(" order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 保存订单")]),t._v("\n        orderDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 调用内部方法（记日志，REQUIRES_NEW）")]),t._v("\n        logService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("recordOrderLog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"创建订单"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 模拟下单失败")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"下单失败"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"下单异常："')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内部方法（记日志，REQUIRES_NEW）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRES_NEW")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("recordOrderLog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" orderId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" content"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderLog")]),t._v(" log "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("OrderLog")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setOrderId")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("orderId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setContent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("content"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    logDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br")])]),s("p",[t._v("执行结果分析：")]),t._v(" "),s("ul",[s("li",[t._v("下单方法抛出异常，外部事务回滚，订单不会被保存；")]),t._v(" "),s("li",[t._v("记日志方法使用REQUIRES_NEW，创建了独立事务，即使外部事务回滚，日志仍会被成功保存（符合“日志独立保留”的需求）。")])]),t._v(" "),s("h4",{attrs:{id:"_3-2-2-not-supported"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-2-not-supported"}},[t._v("#")]),t._v(" 3.2.2 NOT_SUPPORTED")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：内部事务以“非事务方式”执行；如果当前存在外部事务，则先将外部事务挂起，待内部方法执行完成后，再恢复外部事务。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Execute non-transactionally, suspend the current transaction if one exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：\n"),s("ol",[s("li",[t._v("外部有事务：挂起外部事务 → 内部方法以非事务方式执行（操作直接提交） → 恢复外部事务；")]),t._v(" "),s("li",[t._v("外部无事务：直接以非事务方式执行。")])])]),t._v(" "),s("li",[s("strong",[t._v("回滚规则")]),t._v("：内部方法的操作不会受任何事务回滚影响（因为本身无事务）；外部事务的回滚也不会影响内部方法的已提交操作。")]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“不需要事务”的场景（如查询大量数据、执行耗时的非核心操作，避免事务长时间占用资源）。")]),t._v(" "),s("li",[s("strong",[t._v("注意")]),t._v("：NOT_SUPPORTED会主动挂起外部事务，可能导致外部事务的锁资源长时间占用，需谨慎使用。")])]),t._v(" "),s("h3",{attrs:{id:"_3-3-第三类-禁止事务-不允许存在事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-第三类-禁止事务-不允许存在事务"}},[t._v("#")]),t._v(" 3.3 第三类：禁止事务（不允许存在事务）")]),t._v(" "),s("p",[t._v("此类传播行为的核心特点是：明确禁止事务环境，若存在外部事务则直接抛出异常。包含2种传播行为：MANDATORY、NEVER。")]),t._v(" "),s("h4",{attrs:{id:"_3-3-1-mandatory"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-mandatory"}},[t._v("#")]),t._v(" 3.3.1 MANDATORY")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：内部事务必须在外部事务的环境中执行（即当前必须存在外部事务）；如果当前没有外部事务，则直接抛出异常（IllegalTransactionStateException）。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Support a current transaction, throw an exception if none exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：仅当外部存在事务时，内部事务加入外部事务；否则直接抛异常，不执行任何业务逻辑。")]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“内部方法必须依赖外部事务”的场景（如核心业务的子操作，必须在主事务中执行，不允许独立执行）。")]),t._v(" "),s("li",[s("strong",[t._v("实战示例")]),t._v("：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内部方法（必须依赖外部事务）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MANDATORY")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deductStock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" productId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),t._v(" quantity"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 扣库存逻辑")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试：无外部事务调用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("testWithoutOuterTransaction")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用deductStock，会直接抛出IllegalTransactionStateException")]),t._v("\n    stockService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("deductStock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1L")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br")])]),s("h4",{attrs:{id:"_3-3-2-never"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-never"}},[t._v("#")]),t._v(" 3.3.2 NEVER")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：内部事务必须在“非事务环境”中执行；如果当前存在外部事务，则直接抛出异常（IllegalTransactionStateException）。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Execute non-transactionally, throw an exception if a transaction exists.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：仅当外部无事务时，以非事务方式执行；若外部有事务，直接抛异常。")]),t._v(" "),s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“明确禁止事务”的场景（如某些只读操作，不允许在事务中执行，避免事务开销）。")])]),t._v(" "),s("h3",{attrs:{id:"_3-4-第四类-嵌套事务-依赖外部事务-有独立回滚点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-第四类-嵌套事务-依赖外部事务-有独立回滚点"}},[t._v("#")]),t._v(" 3.4 第四类：嵌套事务（依赖外部事务，有独立回滚点）")]),t._v(" "),s("p",[t._v("此类传播行为是Spring对JDBC保存点（Savepoint）的封装，核心特点是：内部事务嵌套在外部事务中，有独立的回滚点，内部事务回滚时不会影响外部事务的整体提交。仅包含1种传播行为：NESTED。")]),t._v(" "),s("h4",{attrs:{id:"_3-4-1-nested"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-1-nested"}},[t._v("#")]),t._v(" 3.4.1 NESTED")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("核心定义")]),t._v("：如果当前存在外部事务，则内部事务作为外部事务的“嵌套事务”执行（创建保存点）；如果当前没有外部事务，则创建新的独立事务（与REQUIRED一致）。")]),t._v(" "),s("li",[s("strong",[t._v("英文释义")]),t._v("：Execute within a nested transaction if a current transaction exists, behave like REQUIRED otherwise.")]),t._v(" "),s("li",[s("strong",[t._v("执行逻辑")]),t._v("：\n"),s("ol",[s("li",[t._v("外部有事务：在外部事务中创建保存点 → 内部事务执行 → 内部事务失败时，仅回滚到保存点（不影响外部事务之前的操作）；外部事务失败时，会回滚包括嵌套事务在内的所有操作；")]),t._v(" "),s("li",[t._v("外部无事务：与REQUIRED一致，创建新事务。")])])]),t._v(" "),s("li",[s("strong",[t._v("回滚规则")]),t._v("：\n"),s("ul",[s("li",[t._v("内部事务回滚：仅回滚自身操作，外部事务可继续执行；")]),t._v(" "),s("li",[t._v("外部事务回滚：内部事务的操作也会被回滚；")]),t._v(" "),s("li",[t._v("内部事务提交：不会立即提交到数据库，需等待外部事务最终提交（嵌套事务依赖外部事务的提交）。")])])]),t._v(" "),s("li",[s("strong",[t._v("与REQUIRES_NEW的核心区别")]),t._v("：")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("特性")]),t._v(" "),s("th",[t._v("NESTED（嵌套事务）")]),t._v(" "),s("th",[t._v("REQUIRES_NEW（新事务）")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("事务独立性")]),t._v(" "),s("td",[t._v("依赖外部事务，无独立事务（共用一个事务）")]),t._v(" "),s("td",[t._v("完全独立，创建全新事务")])]),t._v(" "),s("tr",[s("td",[t._v("提交时机")]),t._v(" "),s("td",[t._v("依赖外部事务提交（自身提交无效）")]),t._v(" "),s("td",[t._v("自身独立提交，不依赖外部")])]),t._v(" "),s("tr",[s("td",[t._v("回滚范围")]),t._v(" "),s("td",[t._v("仅回滚到保存点，不影响外部事务之前操作")]),t._v(" "),s("td",[t._v("回滚自身事务，与外部事务无关")])]),t._v(" "),s("tr",[s("td",[t._v("底层实现")]),t._v(" "),s("td",[t._v("基于JDBC保存点（Savepoint）")]),t._v(" "),s("td",[t._v("基于事务挂起（Suspend）机制")])])])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("适用场景")]),t._v("：适用于“批量操作”或“部分回滚”的场景（如批量导入数据，单条数据导入失败时，仅回滚该条数据，不影响其他数据和外部事务）。")]),t._v(" "),s("li",[s("strong",[t._v("实战示例")]),t._v("：批量导入用户数据：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 外部方法（批量导入，有事务）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REQUIRED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("batchImportUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" userList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" userList"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 调用内部方法（嵌套事务，NESTED）")]),t._v("\n            userService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("importSingleUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 捕获内部异常，仅记录日志，不影响其他用户导入")]),t._v("\n            log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"导入用户{}失败：{}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内部方法（单条导入，NESTED）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Transactional")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("propagation "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Propagation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NESTED")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rollbackFor "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("importSingleUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("userDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("existsByUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RuntimeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"用户名已存在"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    userDao"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("save")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br")])]),s("p",[t._v("执行结果分析：")]),t._v(" "),s("ul",[s("li",[t._v("若某条用户数据导入失败（用户名已存在），importSingleUser会回滚到保存点，仅该条数据的操作被回滚；")]),t._v(" "),s("li",[t._v("外部方法捕获异常后，继续导入其他用户，最终外部事务提交，所有导入成功的用户数据会被保存；")]),t._v(" "),s("li",[t._v("若外部方法中途抛出异常（如系统异常），则所有导入操作（包括成功的）都会被回滚。")])]),t._v(" "),s("h3",{attrs:{id:"_3-5-7种传播行为核心对比表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-7种传播行为核心对比表"}},[t._v("#")]),t._v(" 3.5 7种传播行为核心对比表")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("传播行为")]),t._v(" "),s("th",[t._v("外部有事务")]),t._v(" "),s("th",[t._v("外部无事务")]),t._v(" "),s("th",[t._v("核心特点")]),t._v(" "),s("th",[t._v("适用场景")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("REQUIRED（默认）")]),t._v(" "),s("td",[t._v("加入外部事务")]),t._v(" "),s("td",[t._v("创建新事务")]),t._v(" "),s("td",[t._v("强依赖外部事务，荣辱与共")]),t._v(" "),s("td",[t._v("下单扣库存、转账等核心业务")])]),t._v(" "),s("tr",[s("td",[t._v("SUPPORTS")]),t._v(" "),s("td",[t._v("加入外部事务")]),t._v(" "),s("td",[t._v("非事务执行")]),t._v(" "),s("td",[t._v("可选事务，被动依赖")]),t._v(" "),s("td",[t._v("可选事务的查询操作")])]),t._v(" "),s("tr",[s("td",[t._v("REQUIRES_NEW")]),t._v(" "),s("td",[t._v("挂起外部，创建新事务")]),t._v(" "),s("td",[t._v("创建新事务")]),t._v(" "),s("td",[t._v("完全独立，事务隔离")]),t._v(" "),s("td",[t._v("操作日志、审计记录等独立业务")])]),t._v(" "),s("tr",[s("td",[t._v("NOT_SUPPORTED")]),t._v(" "),s("td",[t._v("挂起外部，非事务执行")]),t._v(" "),s("td",[t._v("非事务执行")]),t._v(" "),s("td",[t._v("禁止事务，主动挂起")]),t._v(" "),s("td",[t._v("耗时非核心操作、大量查询")])]),t._v(" "),s("tr",[s("td",[t._v("MANDATORY")]),t._v(" "),s("td",[t._v("加入外部事务")]),t._v(" "),s("td",[t._v("抛异常")]),t._v(" "),s("td",[t._v("必须依赖外部事务")]),t._v(" "),s("td",[t._v("核心业务子操作，不允许独立执行")])]),t._v(" "),s("tr",[s("td",[t._v("NEVER")]),t._v(" "),s("td",[t._v("抛异常")]),t._v(" "),s("td",[t._v("非事务执行")]),t._v(" "),s("td",[t._v("禁止事务，无事务则执行")]),t._v(" "),s("td",[t._v("明确禁止事务的只读操作")])]),t._v(" "),s("tr",[s("td",[t._v("NESTED")]),t._v(" "),s("td",[t._v("嵌套执行（保存点）")]),t._v(" "),s("td",[t._v("创建新事务")]),t._v(" "),s("td",[t._v("依赖外部，独立回滚点")]),t._v(" "),s("td",[t._v("批量操作、部分回滚场景")])])])]),t._v(" "),s("h2",{attrs:{id:"四、底层原理-spring事务传播如何实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、底层原理-spring事务传播如何实现"}},[t._v("#")]),t._v(" 四、底层原理：Spring事务传播如何实现？")]),t._v(" "),s("p",[t._v("Spring事务传播机制的底层依赖“事务管理器”（PlatformTransactionManager）和“事务同步管理器”（TransactionSynchronizationManager），核心是通过“事务状态”（TransactionStatus）的管理实现传播行为的控制。")]),t._v(" "),s("h3",{attrs:{id:"_4-1-核心组件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-核心组件"}},[t._v("#")]),t._v(" 4.1 核心组件")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("PlatformTransactionManager")]),t._v("：事务管理器核心接口，定义了getTransaction（获取事务）、commit（提交）、rollback（回滚）方法，不同数据源（JDBC、JPA、MyBatis）有对应的实现（如DataSourceTransactionManager）；")]),t._v(" "),s("li",[s("strong",[t._v("TransactionSynchronizationManager")]),t._v("：线程本地变量（ThreadLocal）的封装，用于存储当前线程的事务状态（是否存在事务、事务保存点等），确保事务传播的线程安全；")]),t._v(" "),s("li",[s("strong",[t._v("TransactionStatus")]),t._v("：封装事务的当前状态（是否为新事务、是否有保存点、是否已完成等），是事务传播的核心状态载体；")]),t._v(" "),s("li",[s("strong",[t._v("TransactionInterceptor")]),t._v("：AOP拦截器，负责在事务方法执行前后拦截，调用事务管理器实现事务的开启、提交、回滚，是传播行为触发的入口。")])]),t._v(" "),s("h3",{attrs:{id:"_4-2-核心执行流程-以requires-new为例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-核心执行流程-以requires-new为例"}},[t._v("#")]),t._v(" 4.2 核心执行流程（以REQUIRES_NEW为例）")]),t._v(" "),s("div",{staticClass:"language-mermaid line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-mermaid"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("graph")]),t._v(" TD\n    A"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[外部事务方法执行]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--")]),t._v(" 1.开启外部事务 "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" B"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[调用内部REQUIRES_NEW方法]")]),t._v("\n    B "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--")]),t._v(" 2.TransactionInterceptor拦截 "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" C"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[TransactionSynchronizationManager获取当前事务状态]")]),t._v("\n    C "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--")]),t._v(" 3.发现存在外部事务，挂起外部事务 "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" D"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[4.创建新的事务状态（新事务）]")]),t._v("\n    D "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--")]),t._v(" 5.执行内部方法业务逻辑 "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" E"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("{内部方法执行结果}")]),t._v("\n    E "),s("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[s("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[t._v("--")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token label property"}},[t._v("成功")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")])]),t._v(" F"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[提交新事务]")]),t._v("\n    E "),s("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[s("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[t._v("--")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token label property"}},[t._v("失败")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")])]),t._v(" G"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[回滚新事务]")]),t._v("\n    F "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" H"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[恢复挂起的外部事务]")]),t._v("\n    G "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" H\n    H "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--")]),t._v(" 6.继续执行外部事务 "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")]),t._v(" I"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("{外部事务执行结果}")]),t._v("\n    I "),s("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[s("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[t._v("--")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token label property"}},[t._v("成功")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")])]),t._v(" J"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[提交外部事务]")]),t._v("\n    I "),s("span",{pre:!0,attrs:{class:"token inter-arrow-label"}},[s("span",{pre:!0,attrs:{class:"token arrow-head arrow operator"}},[t._v("--")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token label property"}},[t._v("失败")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token arrow operator"}},[t._v("--\x3e")])]),t._v(" K"),s("span",{pre:!0,attrs:{class:"token text string"}},[t._v("[回滚外部事务]")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br")])]),s("h3",{attrs:{id:"_4-3-关键源码片段-事务状态获取"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-关键源码片段-事务状态获取"}},[t._v("#")]),t._v(" 4.3 关键源码片段（事务状态获取）")]),t._v(" "),s("p",[t._v("TransactionSynchronizationManager通过ThreadLocal存储事务状态，核心源码如下：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("abstract")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionSynchronizationManager")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存储当前线程的事务资源（如数据库连接）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadLocal")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" resources "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NamedThreadLocal")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Transactional resources"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 存储当前线程的事务状态")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("final")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadLocal")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" transactionStatus "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" \n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("NamedThreadLocal")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Transaction status"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 获取当前线程的事务资源")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResourceMap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Map")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" map "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" resources"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("map "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collections")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("unmodifiableMap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collections")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("emptyMap")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 设置事务状态")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTransactionStatus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TransactionStatus")]),t._v(" status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        transactionStatus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("status"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...其他方法")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br")])]),s("p",[t._v("当执行事务方法时，TransactionInterceptor会通过TransactionSynchronizationManager获取当前线程的事务状态，再根据传播行为决定是创建新事务、加入外部事务还是挂起外部事务。")]),t._v(" "),s("h2",{attrs:{id:"五、实战避坑-事务传播常见问题与解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、实战避坑-事务传播常见问题与解决方案"}},[t._v("#")]),t._v(" 五、实战避坑：事务传播常见问题与解决方案")]),t._v(" "),s("p",[t._v("实际开发中，事务传播机制的使用容易出现各种问题，以下是最常见的3类问题及解决方案：")]),t._v(" "),s("h3",{attrs:{id:"_5-1-问题1-嵌套事务不生效-传播行为未触发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-问题1-嵌套事务不生效-传播行为未触发"}},[t._v("#")]),t._v(" 5.1 问题1：嵌套事务不生效（传播行为未触发）")]),t._v(" "),s("p",[s("strong",[t._v("现象")]),t._v("：内部事务方法的传播行为配置后不生效（如REQUIRES_NEW未创建新事务，NESTED未产生保存点）。")]),t._v(" "),s("p",[s("strong",[t._v("常见原因")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("内部方法是“自调用”（同一类中方法调用）：A类的a()方法调用本类的b()方法（b()有@Transactional），此时AOP无法拦截，事务注解失效；")]),t._v(" "),s("li",[t._v("事务方法不是public修饰：@Transactional仅对public方法生效，private、protected方法的事务注解会被忽略；")]),t._v(" "),s("li",[t._v("未配置事务管理器：SpringBoot需引入spring-boot-starter-jdbc/data-jpa等依赖，自动配置事务管理器；若自定义数据源，需手动配置TransactionManager；")]),t._v(" "),s("li",[t._v("异常被内部捕获：内部方法抛出的异常被catch捕获，未向上传播，导致事务回滚规则未触发。")])]),t._v(" "),s("p",[s("strong",[t._v("解决方案")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("避免自调用：将内部事务方法抽取到独立的Service类中；")]),t._v(" "),s("li",[t._v("确保事务方法是public修饰；")]),t._v(" "),s("li",[t._v("检查事务管理器配置：SpringBoot可通过@EnableTransactionManagement开启事务管理（默认已开启）；")]),t._v(" "),s("li",[t._v("异常必须向上传播：内部方法抛出的异常不要捕获，或捕获后重新抛出（throw e）。")])]),t._v(" "),s("h3",{attrs:{id:"_5-2-问题2-回滚范围不符合预期"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-问题2-回滚范围不符合预期"}},[t._v("#")]),t._v(" 5.2 问题2：回滚范围不符合预期")]),t._v(" "),s("p",[s("strong",[t._v("现象")]),t._v("：期望内部事务回滚不影响外部事务，但实际外部事务也回滚；或期望外部事务回滚带动内部事务回滚，但实际内部事务未回滚。")]),t._v(" "),s("p",[s("strong",[t._v("常见原因")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("传播行为选择错误：如需要独立事务却用了REQUIRED，需要嵌套回滚却用了REQUIRES_NEW；")]),t._v(" "),s("li",[t._v("rollbackFor配置错误：默认情况下，Spring仅对“未检查异常”（RuntimeException及其子类）回滚，对“已检查异常”（如IOException）不回滚；若内部方法抛出已检查异常，未配置rollbackFor=Exception.class，会导致事务不回滚；")]),t._v(" "),s("li",[t._v("NESTED传播行为未生效：NESTED依赖JDBC保存点，需确保数据库支持保存点（如MySQL 5.0+、Oracle均支持），且事务隔离级别不是READ_UNCOMMITTED。")])]),t._v(" "),s("p",[s("strong",[t._v("解决方案")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("根据业务场景选择正确的传播行为（参考3.5节对比表）；")]),t._v(" "),s("li",[t._v("显式配置rollbackFor=Exception.class，确保所有异常都能触发回滚；")]),t._v(" "),s("li",[t._v("使用NESTED时，检查数据库是否支持保存点，调整事务隔离级别为DEFAULT（Spring默认，即数据库默认隔离级别）。")])]),t._v(" "),s("h3",{attrs:{id:"_5-3-问题3-事务挂起导致的资源泄漏"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-问题3-事务挂起导致的资源泄漏"}},[t._v("#")]),t._v(" 5.3 问题3：事务挂起导致的资源泄漏")]),t._v(" "),s("p",[s("strong",[t._v("现象")]),t._v("：使用REQUIRES_NEW或NOT_SUPPORTED时，出现数据库连接泄漏、锁资源长时间占用。")]),t._v(" "),s("p",[s("strong",[t._v("常见原因")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("内部事务执行时间过长：挂起外部事务后，内部事务长时间占用数据库连接，导致外部事务的连接资源无法释放；")]),t._v(" "),s("li",[t._v("异常未处理导致挂起的事务未恢复：内部事务抛出异常后，未正确处理，导致挂起的外部事务无法恢复，连接资源泄漏。")])]),t._v(" "),s("p",[s("strong",[t._v("解决方案")]),t._v("：")]),t._v(" "),s("ol",[s("li",[t._v("优化内部事务逻辑，缩短执行时间；")]),t._v(" "),s("li",[t._v("确保异常正确传播和处理：即使内部事务失败，也要保证挂起的外部事务能正常恢复；")]),t._v(" "),s("li",[t._v("避免频繁使用REQUIRES_NEW：仅在必要场景使用，减少事务挂起的开销。")])]),t._v(" "),s("h2",{attrs:{id:"六、总结-事务传播的核心选型原则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六、总结-事务传播的核心选型原则"}},[t._v("#")]),t._v(" 六、总结：事务传播的核心选型原则")]),t._v(" "),s("p",[t._v("Spring事务传播机制的核心是“根据业务场景选择合适的传播行为”，以下是核心选型原则，帮你快速决策：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("核心业务强关联")]),t._v("：选REQUIRED（默认），确保内部和外部事务荣辱与共；")]),t._v(" "),s("li",[s("strong",[t._v("内部业务需独立")]),t._v("：选REQUIRES_NEW，确保内部事务不受外部影响（如日志）；")]),t._v(" "),s("li",[s("strong",[t._v("批量操作部分回滚")]),t._v("：选NESTED，通过保存点实现局部回滚；")]),t._v(" "),s("li",[s("strong",[t._v("必须依赖外部事务")]),t._v("：选MANDATORY，禁止独立执行；")]),t._v(" "),s("li",[s("strong",[t._v("禁止事务执行")]),t._v("：选NEVER或NOT_SUPPORTED，根据是否允许外部事务存在选择；")]),t._v(" "),s("li",[s("strong",[t._v("可选事务场景")]),t._v("：选SUPPORTS，被动依赖外部事务。")])]),t._v(" "),s("p",[t._v("最后需要强调：事务传播机制是Spring事务管理的高级特性，使用时需结合业务场景谨慎选择，避免过度设计。实际开发中，优先使用默认的REQUIRES_NEW，仅在有明确需求时才选择其他传播行为，同时注意规避“自调用”“异常捕获”等常见坑点，确保事务生效且符合预期。")])])}),[],!1,null,null,null);s.default=r.exports}}]);