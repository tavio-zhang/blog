(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{441:function(t,s,a){"use strict";a.r(s);var n=a(8),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"spring-cloud-sentinel-深度解析-原理、特性与实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#spring-cloud-sentinel-深度解析-原理、特性与实践"}},[t._v("#")]),t._v(" Spring Cloud Sentinel 深度解析：原理、特性与实践")]),t._v(" "),s("p",[t._v("在微服务架构中，服务稳定性是核心诉求之一。随着服务规模扩大、调用链路复杂化，流量峰值、下游服务故障、资源耗尽等问题极易导致服务雪崩。Spring Cloud Sentinel 作为阿里开源的流量治理组件，以“流量为切入点”，提供了流量控制、熔断降级、系统自适应保护、热点参数限流等全链路流量治理能力，完美适配 Spring Cloud 生态，成为微服务稳定性保障的核心方案。")]),t._v(" "),s("h2",{attrs:{id:"一、核心定位与技术依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、核心定位与技术依赖"}},[t._v("#")]),t._v(" 一、核心定位与技术依赖")]),t._v(" "),s("h3",{attrs:{id:"_1-1-核心定位"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-核心定位"}},[t._v("#")]),t._v(" 1.1 核心定位")]),t._v(" "),s("p",[t._v("Spring Cloud Sentinel 是一款 "),s("strong",[t._v("分布式系统流量治理组件")]),t._v("，核心目标是通过流量控制、熔断降级等手段，保障微服务架构的高可用性。其核心价值在于：")]),t._v(" "),s("ul",[s("li",[t._v("全链路流量治理：覆盖从接入层、网关层到服务层的全链路流量控制，支持多种流量治理规则（流量控制、熔断降级、热点限流等）；")]),t._v(" "),s("li",[t._v("实时监控与告警：提供秒级实时监控能力，精准感知流量变化、异常状态，并支持多种告警渠道（短信、邮件、钉钉等）；")]),t._v(" "),s("li",[t._v("灵活的扩展机制：支持自定义规则数据源、自定义流量控制算法、自定义告警逻辑等，适配多样化业务场景；")]),t._v(" "),s("li",[t._v("轻量级高性能：核心库无依赖、体积小，基于Netty实现异步非阻塞通信，单机可支撑百万级QPS，性能损耗极低；")]),t._v(" "),s("li",[t._v("Spring Cloud 无缝整合：原生支持 Spring Boot/Spring Cloud 自动配置，兼容 Feign、Gateway、Dubbo 等主流组件。")])]),t._v(" "),s("h3",{attrs:{id:"_1-2-底层技术依赖与架构分层"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-底层技术依赖与架构分层"}},[t._v("#")]),t._v(" 1.2 底层技术依赖与架构分层")]),t._v(" "),s("p",[t._v("Spring Cloud Sentinel 基于 Sentinel 核心库扩展实现，核心依赖链为："),s("strong",[t._v("Spring Cloud Sentinel → Sentinel Core（核心库） → Netty（通信）/SLF4J（日志） → 第三方数据源（Nacos/Apollo/Redis）")]),t._v("。其架构分为三层，各层职责清晰：")]),t._v(" "),s("ol",[s("li",[t._v("核心层（Sentinel Core）：最底层核心模块，包含流量控制、熔断降级的核心算法实现（如令牌桶、漏桶、滑动窗口）、资源抽象、规则管理、实时统计等核心能力，不依赖任何框架，可独立集成；")]),t._v(" "),s("li",[t._v("适配层（Spring Cloud Adapter）：Spring Cloud 生态的适配模块，提供 Spring Boot 自动配置、Feign/Spring Cloud Gateway/Dubbo 等组件的集成支持，将核心层能力封装为 Spring 生态友好的 API；")]),t._v(" "),s("li",[t._v("扩展层（Dashboard & 数据源）：包含 Sentinel Dashboard（可视化控制台）和规则数据源扩展，支持规则的动态配置与持久化，以及实时监控数据展示、告警配置等。")])]),t._v(" "),s("p",[t._v("核心架构分层图（文字描述）："),s("br"),t._v("接入层（Feign/Gateway/Dubbo）→ 适配层（Spring Cloud Adapter）→ 核心层（Sentinel Core）；扩展层（Dashboard + 动态数据源）与核心层交互，提供规则配置与监控能力。")]),t._v(" "),s("h2",{attrs:{id:"二、核心架构与核心组件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、核心架构与核心组件"}},[t._v("#")]),t._v(" 二、核心架构与核心组件")]),t._v(" "),s("p",[t._v("Spring Cloud Sentinel 的核心架构围绕“资源定义-规则配置-流量治理-监控统计”的全链路展开，核心组件包括资源（Resource）、规则（Rule）、上下文（Context）、节点（Node）、ProcessorSlot 链、Dashboard 等，各组件协同完成流量治理的全流程。")]),t._v(" "),s("h3",{attrs:{id:"_2-1-核心组件详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-核心组件详解"}},[t._v("#")]),t._v(" 2.1 核心组件详解")]),t._v(" "),s("h4",{attrs:{id:"_2-1-1-资源-resource-流量治理的核心对象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-资源-resource-流量治理的核心对象"}},[t._v("#")]),t._v(" 2.1.1 资源（Resource）：流量治理的核心对象")]),t._v(" "),s("p",[t._v("资源是 Sentinel 流量治理的核心对象，代表需要保护的业务逻辑或服务接口，任何需要进行流量控制、熔断降级的部分都可定义为资源。常见的资源类型包括：")]),t._v(" "),s("ul",[s("li",[t._v("HTTP 接口：如 Spring MVC 接口、Feign 调用接口；")]),t._v(" "),s("li",[t._v("RPC 方法：如 Dubbo 服务接口；")]),t._v(" "),s("li",[t._v("自定义业务逻辑：如数据库操作、缓存查询等关键代码块。")])]),t._v(" "),s("p",[t._v("Sentinel 支持两种资源定义方式：")]),t._v(" "),s("ol",[s("li",[t._v("注解式埋点（推荐）：通过 @SentinelResource 注解快速定义资源，无需侵入业务代码，示例：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 定义资源名为 "getUserById"，降级方法为 fallbackMethod')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RestController")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/user"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@GetMapping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/{id}"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@SentinelResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getUserById"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fallback "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getUserByIdFallback"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDTO")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@PathVariable")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务逻辑：调用用户服务获取用户信息")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" userService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 降级方法（参数、返回值需与原方法一致）")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDTO")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserByIdFallback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Throwable")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"获取用户信息失败，触发降级"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("代码式埋点：通过 SphU（Sentinel 核心 API）手动包裹业务逻辑，侵入性较强，适用于自定义场景：")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDTO")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Long")]),t._v(" id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 定义资源，entry() 方法返回 Entry 对象，代表资源的调用入口")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Entry")]),t._v(" entry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        entry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SphU")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getUserById"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 业务逻辑")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" userService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserById")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 流量控制/熔断降级触发时的处理逻辑")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Result")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fail")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"获取用户信息被限流/降级"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 4. 释放资源")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("entry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            entry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("核心点：资源名是 Sentinel 识别资源的唯一标识，规则配置需与资源名一一对应；注解式埋点通过 Spring AOP 实现，底层仍会转换为核心 API 的调用。")]),t._v(" "),s("h4",{attrs:{id:"_2-1-2-规则-rule-流量治理的配置契约"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-规则-rule-流量治理的配置契约"}},[t._v("#")]),t._v(" 2.1.2 规则（Rule）：流量治理的配置契约")]),t._v(" "),s("p",[t._v("规则是 Sentinel 流量治理的配置契约，定义了“如何对资源进行流量控制/熔断降级”。Sentinel 支持多种规则类型，覆盖全链路流量治理场景：")]),t._v(" "),s("ul",[s("li",[t._v("流量控制规则（FlowRule）：控制资源的 QPS 或并发线程数，避免流量峰值超过资源承载能力；")]),t._v(" "),s("li",[t._v("熔断降级规则（DegradeRule）：当资源调用失败率/响应时间达到阈值时，触发熔断，避免故障扩散；")]),t._v(" "),s("li",[t._v("热点参数限流规则（ParamFlowRule）：对资源的热点参数（如高频访问的用户 ID、商品 ID）进行精准限流；")]),t._v(" "),s("li",[t._v("系统自适应保护规则（SystemRule）：基于系统整体负载（CPU、内存、磁盘 IO）动态调整流量，避免系统过载；")]),t._v(" "),s("li",[t._v("授权规则（AuthorityRule）：基于来源（如服务名、IP）进行黑白名单控制，限制非法来源的访问。")])]),t._v(" "),s("p",[t._v("规则的核心属性包括：资源名（resource）、规则类型（grade）、阈值（threshold）、生效模式（clusterMode，单机/集群）等。规则可通过 Sentinel Dashboard 动态配置，或通过代码硬编码、配置文件、Nacos/Apollo 等动态数据源配置。")]),t._v(" "),s("p",[t._v("示例：流量控制规则配置（yaml 格式）")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sentinel")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("datasource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自定义数据源名称")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("flow-ds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rules\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DEFAULT_GROUP\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 规则类型：flow（流量控制）")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule-type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flow\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 应用名称（与 Dashboard 交互的标识）")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("application")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("h4",{attrs:{id:"_2-1-3-上下文-context-调用链路的抽象"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-上下文-context-调用链路的抽象"}},[t._v("#")]),t._v(" 2.1.3 上下文（Context）：调用链路的抽象")]),t._v(" "),s("p",[t._v("Context 是 Sentinel 对“一次完整调用链路”的抽象，包含了当前调用的资源、来源、入口节点等信息。每个资源调用都会关联一个 Context，Context 的核心作用：")]),t._v(" "),s("ul",[s("li",[t._v("串联调用链路：将一次请求中的多个资源调用串联起来，形成完整的调用链路，支持链路级别的流量控制；")]),t._v(" "),s("li",[t._v("存储调用元数据：记录当前调用的来源（origin，如调用方服务名）、入口资源（entranceNode）、当前资源（curEntry）等信息；")]),t._v(" "),s("li",[t._v("隔离调用环境：不同的 Context 相互隔离，避免调用链路间的干扰。")])]),t._v(" "),s("p",[t._v("Context 的创建与销毁：默认情况下，Sentinel 会为每个 HTTP 请求创建一个 Context（通过 Web 拦截器实现），请求结束后自动销毁；自定义场景可通过 ContextUtil 手动创建：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建 Context，参数：contextName（上下文名称）、origin（调用来源）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ContextUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("enter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user-service-context"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"order-service"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 资源调用")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Entry")]),t._v(" entry "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SphU")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"getUserById"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 业务逻辑")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        entry"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" e"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 限流/降级处理")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 销毁 Context")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ContextUtil")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("h4",{attrs:{id:"_2-1-4-节点-node-实时统计的核心载体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-4-节点-node-实时统计的核心载体"}},[t._v("#")]),t._v(" 2.1.4 节点（Node）：实时统计的核心载体")]),t._v(" "),s("p",[t._v("Node 是 Sentinel 中用于存储资源调用统计数据（如 QPS、响应时间、失败率）的核心载体，所有流量治理规则的判断都基于 Node 的统计数据。Sentinel 定义了多种 Node 类型，构成层次化的统计模型：")]),t._v(" "),s("ul",[s("li",[t._v("DefaultNode：默认节点，对应单个资源在当前 Context 下的统计数据，每个资源-Context 组合对应一个 DefaultNode；")]),t._v(" "),s("li",[t._v("ClusterNode：集群节点，对应单个资源在全系统中的聚合统计数据（跨 Context），每个资源对应一个 ClusterNode；")]),t._v(" "),s("li",[t._v("EntranceNode：入口节点，对应 Context 的入口资源统计数据，用于链路级别的流量控制；")]),t._v(" "),s("li",[t._v("StatisticNode：统计节点基类，实现了 QPS、响应时间、失败率等核心统计逻辑，其他 Node 类型均继承自 StatisticNode。")])]),t._v(" "),s("p",[t._v("核心统计逻辑：基于滑动窗口算法实现，每个 Node 内部维护多个滑动窗口（默认窗口大小 1s，分为 10 个桶，每个桶 100ms），实时收集每个桶的调用数据（请求数、成功数、失败数、响应时间），通过聚合窗口数据得到实时统计结果（如当前 QPS、1min 内平均响应时间）。")]),t._v(" "),s("h4",{attrs:{id:"_2-1-5-processorslot-链-流量治理的核心链路"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-5-processorslot-链-流量治理的核心链路"}},[t._v("#")]),t._v(" 2.1.5 ProcessorSlot 链：流量治理的核心链路")]),t._v(" "),s("p",[t._v("ProcessorSlot 链是 Sentinel 实现流量治理的核心机制，本质是一条责任链，每个 ProcessorSlot 负责一项具体的功能（如规则校验、统计数据收集、日志记录等）。当资源被调用时，请求会依次经过 ProcessorSlot 链的每个 Slot，完成全流程的流量治理。")]),t._v(" "),s("p",[t._v("默认 ProcessorSlot 链顺序（从前往后）：")]),t._v(" "),s("ol",[s("li",[t._v("NodeSelectorSlot：节点选择槽，负责创建并维护 DefaultNode 与 Context 的关联关系，为每个资源-Context 组合分配唯一的 DefaultNode；")]),t._v(" "),s("li",[t._v("ClusterBuilderSlot：集群构建槽，负责创建并维护 ClusterNode，聚合同一资源的全系统统计数据；")]),t._v(" "),s("li",[t._v("LogSlot：日志槽，负责记录资源调用的日志信息（如限流/降级触发日志）；")]),t._v(" "),s("li",[t._v("StatisticSlot：统计槽，核心槽位，负责收集资源调用的实时统计数据（QPS、响应时间等），并将数据写入对应的 Node；")]),t._v(" "),s("li",[t._v("AuthoritySlot：授权槽，负责校验授权规则（黑白名单），拦截非法来源的访问；")]),t._v(" "),s("li",[t._v("ParamFlowSlot：热点参数限流槽，负责校验热点参数限流规则，对高频参数进行精准限流；")]),t._v(" "),s("li",[t._v("FlowSlot：流量控制槽，负责校验流量控制规则，根据统计数据判断是否需要限流；")]),t._v(" "),s("li",[t._v("DegradeSlot：熔断降级槽，负责校验熔断降级规则，根据统计数据判断是否需要熔断。")])]),t._v(" "),s("p",[t._v("核心点：ProcessorSlot 链的顺序决定了功能的执行顺序，统计数据收集（StatisticSlot）必须在规则校验（FlowSlot、DegradeSlot 等）之前，确保规则判断基于实时统计数据；开发者可通过自定义 ProcessorSlot 扩展责任链功能。")]),t._v(" "),s("h4",{attrs:{id:"_2-1-6-sentinel-dashboard-可视化控制台"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-6-sentinel-dashboard-可视化控制台"}},[t._v("#")]),t._v(" 2.1.6 Sentinel Dashboard：可视化控制台")]),t._v(" "),s("p",[t._v("Sentinel Dashboard 是 Sentinel 的可视化管理控制台，基于 Spring Boot 开发，提供规则配置、实时监控、告警管理、链路追踪等核心功能，核心作用：")]),t._v(" "),s("ul",[s("li",[t._v("规则管理：支持可视化配置所有类型的规则，支持规则的新增、编辑、删除、推送；")]),t._v(" "),s("li",[t._v("实时监控：展示应用的整体 QPS、响应时间、限流/降级次数，以及单个资源的详细统计数据；")]),t._v(" "),s("li",[t._v("链路追踪：展示应用的调用链路拓扑，清晰呈现资源间的依赖关系；")]),t._v(" "),s("li",[t._v("告警管理：配置告警规则（如 QPS 超过阈值、失败率过高），支持多种告警渠道（钉钉、邮件、短信）；")]),t._v(" "),s("li",[t._v("机器管理：管理接入的应用实例，支持实例的健康状态监控。")])]),t._v(" "),s("p",[t._v("Dashboard 与应用实例的交互机制：应用实例启动后主动向 Dashboard 注册，通过 HTTP 协议上报实时监控数据；Dashboard 通过 HTTP 协议向应用实例推送规则配置。")]),t._v(" "),s("h2",{attrs:{id:"三、spring-cloud-sentinel-工作流程底层解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、spring-cloud-sentinel-工作流程底层解析"}},[t._v("#")]),t._v(" 三、Spring Cloud Sentinel 工作流程底层解析")]),t._v(" "),s("p",[t._v("结合上述核心组件，Spring Cloud Sentinel 的完整工作流程可分为 8 个关键步骤，从资源调用触发到规则校验、统计监控，形成闭环的流量治理链路：")]),t._v(" "),s("h3",{attrs:{id:"步骤-1-资源定义与埋点初始化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-1-资源定义与埋点初始化"}},[t._v("#")]),t._v(" 步骤 1：资源定义与埋点初始化")]),t._v(" "),s("p",[t._v("应用启动时，Sentinel 会扫描 @SentinelResource 注解（或解析代码式埋点），完成资源的初始化：")]),t._v(" "),s("ul",[s("li",[t._v("注解式埋点：通过 Spring AOP 生成代理类，在目标方法执行前后插入 Sentinel 核心 API（SphU.entry() 和 entry.exit()）的调用逻辑；")]),t._v(" "),s("li",[t._v("资源元数据注册：将资源名、降级方法、blockHandler 方法等元数据注册到 Sentinel 核心库的资源注册表中。")])]),t._v(" "),s("h3",{attrs:{id:"步骤-2-请求触发资源调用-创建-context"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-2-请求触发资源调用-创建-context"}},[t._v("#")]),t._v(" 步骤 2：请求触发资源调用，创建 Context")]),t._v(" "),s("p",[t._v("当客户端发送请求触发资源调用时（如访问 @SentinelResource 注解的接口），Sentinel 首先通过 ContextUtil 创建 Context：")]),t._v(" "),s("ul",[s("li",[t._v("默认场景（HTTP 请求）：Web 拦截器自动创建 Context，Context 名称为应用名称，调用来源（origin）可通过请求头或自定义逻辑设置；")]),t._v(" "),s("li",[t._v("自定义场景：通过 ContextUtil.enter() 手动创建 Context，指定 Context 名称和调用来源。")])]),t._v(" "),s("h3",{attrs:{id:"步骤-3-创建-entry-触发-processorslot-链"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-3-创建-entry-触发-processorslot-链"}},[t._v("#")]),t._v(" 步骤 3：创建 Entry，触发 ProcessorSlot 链")]),t._v(" "),s("p",[t._v("通过 SphU.entry() 方法创建 Entry 对象，Entry 代表当前资源的调用入口，创建过程中会触发 ProcessorSlot 链的初始化与执行：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Sentinel 核心 API 入口逻辑（简化）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Entry")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" resourceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BlockException")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 获取资源元数据")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResourceWrapper")]),t._v(" resource "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StringResourceWrapper")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resourceName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("EntryType")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OUT")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 创建 Entry，触发 ProcessorSlot 链执行")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Env")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sph"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("OBJECTS0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("Entry 创建成功后，请求进入 ProcessorSlot 链的流转过程。")]),t._v(" "),s("h3",{attrs:{id:"步骤-4-processorslot-链执行-节点选择与集群构建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-4-processorslot-链执行-节点选择与集群构建"}},[t._v("#")]),t._v(" 步骤 4：ProcessorSlot 链执行（节点选择与集群构建）")]),t._v(" "),s("p",[t._v("请求首先经过 NodeSelectorSlot 和 ClusterBuilderSlot：")]),t._v(" "),s("ul",[s("li",[t._v("NodeSelectorSlot：根据当前 Context 和资源，创建或获取对应的 DefaultNode，并将 Entry 与 DefaultNode 关联；")]),t._v(" "),s("li",[t._v("ClusterBuilderSlot：根据资源名，创建或获取对应的 ClusterNode，聚合该资源的全系统统计数据。")])]),t._v(" "),s("h3",{attrs:{id:"步骤-5-统计数据收集-statisticslot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-5-统计数据收集-statisticslot"}},[t._v("#")]),t._v(" 步骤 5：统计数据收集（StatisticSlot）")]),t._v(" "),s("p",[t._v("请求进入 StatisticSlot，该 Slot 是核心统计节点，负责收集资源调用的实时数据：")]),t._v(" "),s("ol",[s("li",[t._v("开始计时：记录请求开始时间，用于计算响应时间；")]),t._v(" "),s("li",[t._v("更新统计数据：将当前请求计入对应的 DefaultNode 和 ClusterNode 的滑动窗口中，更新 QPS 计数；")]),t._v(" "),s("li",[t._v("传递请求：将请求传递给下一个 Slot。")])]),t._v(" "),s("p",[t._v("核心统计逻辑（滑动窗口）：每个滑动窗口包含多个时间桶，每个时间桶存储 100ms 内的统计数据，StatisticSlot 会根据当前时间找到对应的时间桶，更新桶内的请求数、成功数等数据。")]),t._v(" "),s("h3",{attrs:{id:"步骤-6-规则校验-授权、热点限流、流量控制、熔断降级"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-6-规则校验-授权、热点限流、流量控制、熔断降级"}},[t._v("#")]),t._v(" 步骤 6：规则校验（授权、热点限流、流量控制、熔断降级）")]),t._v(" "),s("p",[t._v("请求依次经过 AuthoritySlot、ParamFlowSlot、FlowSlot、DegradeSlot，各 Slot 分别校验对应的规则：")]),t._v(" "),s("ol",[s("li",[t._v("AuthoritySlot：校验授权规则，若调用来源在黑名单中，抛出 AuthorityException，触发限流；")]),t._v(" "),s("li",[t._v("ParamFlowSlot：校验热点参数限流规则，提取请求中的热点参数（如用户 ID），根据统计数据判断是否超过阈值，若超过则抛出 ParamFlowException；")]),t._v(" "),s("li",[t._v("FlowSlot：校验流量控制规则，根据 ClusterNode/DefaultNode 的实时 QPS 或并发线程数，判断是否超过阈值，若超过则抛出 FlowException；")]),t._v(" "),s("li",[t._v("DegradeSlot：校验熔断降级规则，根据 ClusterNode 的失败率或平均响应时间，判断是否触发熔断，若触发则抛出 DegradeException。")])]),t._v(" "),s("p",[t._v("若任意 Slot 校验失败（抛出 BlockException 及其子类），则直接中断 ProcessorSlot 链，进入限流/降级处理逻辑；若所有规则校验通过，则执行后续的业务逻辑。")]),t._v(" "),s("h3",{attrs:{id:"步骤-7-业务逻辑执行与统计数据更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-7-业务逻辑执行与统计数据更新"}},[t._v("#")]),t._v(" 步骤 7：业务逻辑执行与统计数据更新")]),t._v(" "),s("p",[t._v("规则校验通过后，执行资源对应的业务逻辑：")]),t._v(" "),s("ul",[s("li",[t._v("业务逻辑执行成功：在 Entry.exit() 方法中，StatisticSlot 会更新成功数、响应时间等统计数据；")]),t._v(" "),s("li",[t._v("业务逻辑执行失败：捕获异常，StatisticSlot 会更新失败数统计数据，若配置了熔断降级规则，失败数会作为熔断判断的依据。")])]),t._v(" "),s("h3",{attrs:{id:"步骤-8-监控数据上报与-context-销毁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#步骤-8-监控数据上报与-context-销毁"}},[t._v("#")]),t._v(" 步骤 8：监控数据上报与 Context 销毁")]),t._v(" "),s("p",[t._v("业务逻辑执行完成后，Entry 被释放，Context 被销毁：")]),t._v(" "),s("ul",[s("li",[t._v("监控数据上报：应用实例定期（默认 1s）将 ClusterNode 的统计数据上报给 Sentinel Dashboard；")]),t._v(" "),s("li",[t._v("Context 销毁：释放 Context 占用的资源，避免内存泄漏。")])]),t._v(" "),s("h2",{attrs:{id:"四、关键特性底层实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、关键特性底层实现"}},[t._v("#")]),t._v(" 四、关键特性底层实现")]),t._v(" "),s("h3",{attrs:{id:"_4-1-流量控制-基于令牌桶-漏桶算法的流量管控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-流量控制-基于令牌桶-漏桶算法的流量管控"}},[t._v("#")]),t._v(" 4.1 流量控制：基于令牌桶/漏桶算法的流量管控")]),t._v(" "),s("p",[t._v("流量控制是 Sentinel 的核心特性，目的是限制资源的 QPS 或并发线程数，避免流量超过资源承载能力。其底层基于经典的限流算法实现，支持多种流量控制模式。")]),t._v(" "),s("h4",{attrs:{id:"_4-1-1-核心算法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-核心算法"}},[t._v("#")]),t._v(" 4.1.1 核心算法")]),t._v(" "),s("ul",[s("li",[t._v("令牌桶算法（默认）：系统以固定速率向令牌桶中放入令牌，请求到达时需要获取令牌才能执行，若令牌桶为空则拒绝请求。该算法支持突发流量（令牌桶有容量，可累积令牌），适用于大多数场景；")]),t._v(" "),s("li",[t._v("漏桶算法：请求进入漏桶后，以固定速率流出，若漏桶已满则拒绝请求。该算法可平滑流量，适用于需要严格控制流出速率的场景。")])]),t._v(" "),s("h4",{attrs:{id:"_4-1-2-流量控制模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-流量控制模式"}},[t._v("#")]),t._v(" 4.1.2 流量控制模式")]),t._v(" "),s("ul",[s("li",[t._v("直接模式：直接对当前资源进行限流，适用于保护当前资源本身；")]),t._v(" "),s("li",[t._v("关联模式：当关联的资源（如 /order/create）达到限流阈值时，对当前资源（如 /user/get）进行限流，适用于保护核心资源（如订单创建）不受非核心资源（如用户查询）的流量冲击；")]),t._v(" "),s("li",[t._v("链路模式：仅对指定调用链路的资源进行限流，适用于链路级别的流量控制（如仅限制从 /order/create 调用 /user/get 的流量）。")])]),t._v(" "),s("h4",{attrs:{id:"_4-1-3-底层实现逻辑-flowslot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-底层实现逻辑-flowslot"}},[t._v("#")]),t._v(" 4.1.3 底层实现逻辑（FlowSlot）")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 流量控制核心逻辑（简化，位于 FlowSlot 中）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Context")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResourceWrapper")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DefaultNode")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Throwable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 获取当前资源的所有流量控制规则")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FlowRule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" rules "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FlowRuleManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRulesOfResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rules "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" rules"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 无规则，直接放行")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 遍历规则，校验是否触发限流")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FlowRule")]),t._v(" rule "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" rules"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("passCheck")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发限流，抛出 FlowException")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("FlowException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLimitApp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 所有规则校验通过，放行")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br")])]),s("p",[t._v("rule.passCheck() 方法会根据规则的限流模式、算法类型，结合 Node 的实时统计数据（QPS/并发线程数）判断是否允许请求通过。")]),t._v(" "),s("h3",{attrs:{id:"_4-2-熔断降级-基于状态机的故障隔离"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-熔断降级-基于状态机的故障隔离"}},[t._v("#")]),t._v(" 4.2 熔断降级：基于状态机的故障隔离")]),t._v(" "),s("p",[t._v("熔断降级的核心目标是当下游资源出现故障（如高失败率、长响应时间）时，快速切断调用链路，避免故障扩散，待下游资源恢复后再恢复调用。Sentinel 熔断降级基于状态机模型实现，支持多种熔断策略。")]),t._v(" "),s("h4",{attrs:{id:"_4-2-1-熔断状态机"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-熔断状态机"}},[t._v("#")]),t._v(" 4.2.1 熔断状态机")]),t._v(" "),s("p",[t._v("Sentinel 熔断降级包含三个状态，状态之间通过规则阈值和时间触发转换：")]),t._v(" "),s("ul",[s("li",[t._v("关闭状态（CLOSED）：正常状态，允许请求调用资源，实时统计失败率/响应时间；当统计数据达到阈值时，转换为开启状态；")]),t._v(" "),s("li",[t._v("开启状态（OPEN）：熔断状态，拒绝所有请求，直接执行降级逻辑；经过熔断时长后，转换为半开启状态；")]),t._v(" "),s("li",[t._v("半开启状态（HALF_OPEN）：试探状态，允许少量请求（默认 5 个）调用资源；若这些请求的成功率达到阈值，转换为关闭状态；若失败率仍超过阈值，继续保持开启状态。")])]),t._v(" "),s("h4",{attrs:{id:"_4-2-2-熔断策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-熔断策略"}},[t._v("#")]),t._v(" 4.2.2 熔断策略")]),t._v(" "),s("ul",[s("li",[t._v("基于失败率：当资源的调用失败率（失败次数/总次数）超过阈值（默认 50%），且总调用次数超过最小请求数（默认 5）时，触发熔断；")]),t._v(" "),s("li",[t._v("基于平均响应时间：当资源的平均响应时间超过阈值（默认 500ms），且总调用次数超过最小请求数时，触发熔断；")]),t._v(" "),s("li",[t._v("基于异常数：当资源的调用异常数超过阈值，且总调用次数超过最小请求数时，触发熔断。")])]),t._v(" "),s("h4",{attrs:{id:"_4-2-3-底层实现逻辑-degradeslot"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3-底层实现逻辑-degradeslot"}},[t._v("#")]),t._v(" 4.2.3 底层实现逻辑（DegradeSlot）")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 熔断降级核心逻辑（简化，位于 DegradeSlot 中）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("entry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Context")]),t._v(" context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ResourceWrapper")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DefaultNode")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Object")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Throwable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 1. 获取当前资源的所有熔断降级规则")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DegradeRule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" rules "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DegradeRuleManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRulesOfResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rules "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" rules"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEmpty")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2. 遍历规则，校验是否触发熔断")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DegradeRule")]),t._v(" rule "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" rules"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("passCheck")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发熔断，抛出 DegradeException")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DegradeException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getResource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLimitApp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 3. 所有规则校验通过，放行")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fireEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" resourceWrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" prioritized"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br")])]),s("p",[t._v("rule.passCheck() 方法会根据规则的熔断策略，查询资源对应的熔断状态机，结合实时统计数据判断是否允许请求通过。")]),t._v(" "),s("h3",{attrs:{id:"_4-3-热点参数限流-基于参数维度的精准管控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-热点参数限流-基于参数维度的精准管控"}},[t._v("#")]),t._v(" 4.3 热点参数限流：基于参数维度的精准管控")]),t._v(" "),s("p",[t._v("热点参数限流是对“资源的热点参数”进行精准限流，适用于某一资源的部分参数访问频率极高的场景（如某商品 ID 被高频抢购、某用户 ID 高频查询）。其底层通过参数统计模型实现，支持对指定参数索引或参数值进行限流。")]),t._v(" "),s("h4",{attrs:{id:"_4-3-1-核心实现逻辑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-核心实现逻辑"}},[t._v("#")]),t._v(" 4.3.1 核心实现逻辑")]),t._v(" "),s("ol",[s("li",[t._v("参数提取：通过 ParamFlowSlot 提取请求中的参数（支持基本类型、字符串、数组等），根据规则指定的参数索引（如第 0 个参数）定位热点参数；")]),t._v(" "),s("li",[t._v("参数统计：为每个热点参数维护独立的滑动窗口统计数据，避免不同参数之间的干扰；")]),t._v(" "),s("li",[t._v("限流判断：根据规则的阈值（如 QPS 100），判断当前热点参数的访问频率是否超过阈值，若超过则触发限流。")])]),t._v(" "),s("h4",{attrs:{id:"_4-3-2-高级特性-参数例外项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-高级特性-参数例外项"}},[t._v("#")]),t._v(" 4.3.2 高级特性：参数例外项")]),t._v(" "),s("p",[t._v("支持为热点参数配置例外项，对特殊参数值设置不同的限流阈值（如对商品 ID=10086 设置更高的阈值，或直接放行），示例配置：")]),t._v(" "),s("div",{staticClass:"language-yaml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spring")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cloud")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sentinel")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("datasource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("param-flow-ds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nacos")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("server-addr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 127.0.0.1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8848")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sentinel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("param"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rules\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group-id")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DEFAULT_GROUP\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule-type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" param"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("flow\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" getUserById\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("grade")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1 表示 QPS 限流")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paramIdx")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 参数索引，0 表示第一个参数（id）")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("threshold")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认阈值：QPS 10")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exceptions")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 例外项")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("item")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10086")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 参数值为 10086")]),t._v("\n                  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("threshold")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 例外阈值：QPS 100")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("h3",{attrs:{id:"_4-4-系统自适应保护-基于系统负载的全局管控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-系统自适应保护-基于系统负载的全局管控"}},[t._v("#")]),t._v(" 4.4 系统自适应保护：基于系统负载的全局管控")]),t._v(" "),s("p",[t._v("系统自适应保护是从系统整体负载出发，动态调整流量准入策略，避免系统因 CPU、内存、磁盘 IO 等资源耗尽而崩溃。其底层基于系统负载指标（如 CPU 使用率、系统负载 average）实现，支持多种保护策略。")]),t._v(" "),s("h4",{attrs:{id:"_4-4-1-核心保护策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-核心保护策略"}},[t._v("#")]),t._v(" 4.4.1 核心保护策略")]),t._v(" "),s("ul",[s("li",[t._v("CPU 使用率保护：当 CPU 使用率超过阈值（默认 80%）时，触发流量控制；")]),t._v(" "),s("li",[t._v("系统负载保护：当系统 1min 负载 average 超过阈值（默认 3）时，触发流量控制（仅支持 Linux 系统）；")]),t._v(" "),s("li",[t._v("内存保护：当内存使用率超过阈值时，触发流量控制；")]),t._v(" "),s("li",[t._v("入口 QPS 保护：限制系统的总入口 QPS，避免总流量超过系统承载能力。")])]),t._v(" "),s("h4",{attrs:{id:"_4-4-2-底层实现逻辑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-底层实现逻辑"}},[t._v("#")]),t._v(" 4.4.2 底层实现逻辑")]),t._v(" "),s("p",[t._v("系统自适应保护规则由 SystemSlot 负责校验，核心逻辑是定期采集系统负载指标，当指标超过阈值时，通过“令牌桶算法”动态调整流量准入速率，逐步减少流量，直至系统负载恢复正常。")]),t._v(" "),s("h2",{attrs:{id:"五、实践优化与最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#五、实践优化与最佳实践"}},[t._v("#")]),t._v(" 五、实践优化与最佳实践")]),t._v(" "),s("h3",{attrs:{id:"_5-1-规则配置最佳实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-规则配置最佳实践"}},[t._v("#")]),t._v(" 5.1 规则配置最佳实践")]),t._v(" "),s("ul",[s("li",[t._v("资源命名规范：采用“业务模块-接口名”的格式（如 user-getUserById、order-createOrder），便于规则管理和监控；")]),t._v(" "),s("li",[t._v("规则粒度控制：核心资源（如订单创建、支付接口）采用更严格的限流阈值，非核心资源（如数据查询）可适当放宽；")]),t._v(" "),s("li",[t._v("动态数据源优先：使用 Nacos/Apollo 等动态数据源存储规则，避免硬编码，支持规则的实时更新与持久化；")]),t._v(" "),s("li",[t._v("熔断降级配置：核心资源建议同时配置失败率和平均响应时间熔断规则，确保故障快速隔离。")])]),t._v(" "),s("h3",{attrs:{id:"_5-2-性能优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-性能优化"}},[t._v("#")]),t._v(" 5.2 性能优化")]),t._v(" "),s("ul",[s("li",[t._v("关闭不必要的统计：对于非核心资源，可通过配置关闭详细的统计数据（如响应时间分布），减少内存占用；")]),t._v(" "),s("li",[t._v("合理设置滑动窗口参数：核心资源可缩小窗口桶数（如 5 个桶，每个桶 200ms），提升统计实时性；非核心资源可增大窗口桶数，减少计算开销；")]),t._v(" "),s("li",[t._v("避免过度埋点：仅对关键资源（核心接口、耗时操作）进行埋点，减少埋点对业务性能的影响；")]),t._v(" "),s("li",[t._v("集群限流优化：对于集群部署的应用，使用集群限流替代单机限流，避免因单机负载不均导致的整体雪崩。")])]),t._v(" "),s("h3",{attrs:{id:"_5-3-监控与告警配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-监控与告警配置"}},[t._v("#")]),t._v(" 5.3 监控与告警配置")]),t._v(" "),s("ul",[s("li",[t._v("核心资源告警：为核心资源配置告警规则（如 QPS 突增、失败率超过 10%），确保异常及时发现；")]),t._v(" "),s("li",[t._v("多渠道告警：结合业务场景配置多种告警渠道（钉钉群告警用于实时响应，邮件告警用于归档）；")]),t._v(" "),s("li",[t._v("监控数据持久化：通过 Sentinel 的 MetricExporter 扩展，将监控数据持久化到 Prometheus、Elasticsearch 等系统，支持长期分析。")])]),t._v(" "),s("h3",{attrs:{id:"_5-4-与-spring-cloud-生态组件集成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-与-spring-cloud-生态组件集成"}},[t._v("#")]),t._v(" 5.4 与 Spring Cloud 生态组件集成")]),t._v(" "),s("ul",[s("li",[t._v("与 Feign 集成：通过 @SentinelFeign 注解为 Feign 客户端启用 Sentinel 保护，实现服务间调用的限流与降级；")]),t._v(" "),s("li",[t._v("与 Spring Cloud Gateway 集成：通过 SentinelGatewayFilter 实现网关层的流量控制，支持路由级、接口级的限流；")]),t._v(" "),s("li",[t._v("与 Dubbo 集成：通过 Sentinel-Dubbo 适配器，为 Dubbo 服务提供者和消费者提供限流、降级能力；")]),t._v(" "),s("li",[t._v("与 Spring Security 集成：结合授权规则，实现基于用户角色的流量控制。")])]),t._v(" "),s("h2",{attrs:{id:"六、总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#六、总结"}},[t._v("#")]),t._v(" 六、总结")]),t._v(" "),s("p",[t._v("Spring Cloud Sentinel 以“流量为切入点”，通过核心库的 ProcessorSlot 责任链机制，实现了流量控制、熔断降级、热点参数限流、系统自适应保护等全链路流量治理能力，其轻量级、高性能的设计使其完美适配微服务架构的高并发场景。")]),t._v(" "),s("p",[t._v("从底层原理来看，Sentinel 的核心是“资源定义-规则配置-统计监控-规则校验”的闭环链路，通过滑动窗口算法实现实时统计，基于状态机和经典限流算法实现流量治理。理解这些核心机制，有助于开发者在实际应用中精准配置规则、快速定位问题，如限流不生效可能是资源名不匹配，熔断不触发可能是最小请求数未达到阈值等。")])])}),[],!1,null,null,null);s.default=e.exports}}]);