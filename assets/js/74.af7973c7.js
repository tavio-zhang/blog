(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{431:function(s,a,n){"use strict";n.r(a);var e=n(8),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("在高并发系统的稳定性保障体系中，限流是与熔断、降级并列的核心防护手段。当流量突破服务承载上限时，限流能精准“削峰填谷”，避免数据库雪崩、应用服务器过载，成为保障业务连续性的“最后一道防线”。")]),s._v(" "),a("p",[s._v("Redis 凭借"),a("strong",[s._v("原子操作特性、分布式一致性支持、毫秒级响应速度")]),s._v("，成为限流方案的首选技术栈——其性能可达单机 10 万+ QPS，远超数据库和应用本地限流的承载能力，广泛应用于秒杀抢购、API 网关、第三方接口调用等核心场景。")]),s._v(" "),a("h2",{attrs:{id:"一、限流核心认知-不止是-计数-更是流量治理的艺术"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、限流核心认知-不止是-计数-更是流量治理的艺术"}},[s._v("#")]),s._v(" 一、限流核心认知：不止是“计数”，更是流量治理的艺术")]),s._v(" "),a("h3",{attrs:{id:"_1-1-限流的本质目标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-限流的本质目标"}},[s._v("#")]),s._v(" 1.1 限流的本质目标")]),s._v(" "),a("p",[s._v("限流并非简单“拒绝请求”，而是通过科学的流量控制，实现三大核心目标：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("保护系统稳定性")]),s._v("：防止突发流量（如秒杀、爬虫攻击）压垮服务，确保核心业务可用；")]),s._v(" "),a("li",[a("strong",[s._v("保障用户体验")]),s._v("：避免因系统过载导致的全量响应超时，仅牺牲部分非核心请求；")]),s._v(" "),a("li",[a("strong",[s._v("合理利用资源")]),s._v("：使服务器 CPU、内存、网络等资源处于最优负载区间，避免浪费。")])]),s._v(" "),a("h3",{attrs:{id:"_1-2-限流的核心衡量指标"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-限流的核心衡量指标"}},[s._v("#")]),s._v(" 1.2 限流的核心衡量指标")]),s._v(" "),a("p",[s._v("设计限流方案前，需明确三个关键指标，避免无的放矢：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("限流粒度")]),s._v("：接口级（如 "),a("code",[s._v("/api/pay")]),s._v("）、用户级（如 "),a("code",[s._v("user:1001:/api/order")]),s._v("）、IP 级（如 "),a("code",[s._v("ip:192.168.1.1")]),s._v("）、商品级（如 "),a("code",[s._v("seckill:goods:10086")]),s._v("）；")]),s._v(" "),a("li",[a("strong",[s._v("时间窗口")]),s._v("：1 秒、10 秒、1 分钟、1 天（需匹配业务场景，如秒杀用 1 秒窗口，第三方 API 调用用 1 天窗口）；")]),s._v(" "),a("li",[a("strong",[s._v("限流阈值")]),s._v("：单位时间内允许的最大请求数（需通过压测确定，通常设为服务峰值承载能力的 80%，预留缓冲）。")])]),s._v(" "),a("h3",{attrs:{id:"_1-3-redis-限流的核心优势"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-redis-限流的核心优势"}},[s._v("#")]),s._v(" 1.3 Redis 限流的核心优势")]),s._v(" "),a("p",[s._v("相较于本地限流（如 Guava RateLimiter）、网关限流（如 Nginx），Redis 限流具备不可替代的优势：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("分布式一致性")]),s._v("：多节点、多服务部署时，能保证全局限流阈值统一（如多实例部署的应用，共同遵守“1 秒 100 次请求”规则）；")]),s._v(" "),a("li",[a("strong",[s._v("高性能")]),s._v("：内存操作 + 原子命令，响应时间 < 1ms，支持每秒 10 万+ 限流请求；")]),s._v(" "),a("li",[a("strong",[s._v("灵活性")]),s._v("：支持多种限流算法，可通过 Lua 脚本扩展自定义逻辑；")]),s._v(" "),a("li",[a("strong",[s._v("可扩展性")]),s._v("：结合 Redis Cluster 可横向扩展，突破单机性能瓶颈。")])]),s._v(" "),a("h2",{attrs:{id:"二、经典限流算法深度解析-原理-数学模型-适用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、经典限流算法深度解析-原理-数学模型-适用场景"}},[s._v("#")]),s._v(" 二、经典限流算法深度解析：原理+数学模型+适用场景")]),s._v(" "),a("p",[s._v("四种经典限流算法是 Redis 限流的基础，其核心差异在于“流量控制的灵活性”和“抗突发能力”。以下从数学模型、数据结构选择、底层逻辑三个维度，彻底讲透每种算法的设计思路。")]),s._v(" "),a("h3",{attrs:{id:"_2-1-固定窗口计数器-最简单的-计数限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-固定窗口计数器-最简单的-计数限流"}},[s._v("#")]),s._v(" 2.1 固定窗口计数器：最简单的“计数限流”")]),s._v(" "),a("h4",{attrs:{id:"核心原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心原理"}},[s._v("#")]),s._v(" 核心原理")]),s._v(" "),a("p",[s._v("将时间划分为固定长度的窗口（如 1 秒），用 Redis 的 "),a("code",[s._v("INCR")]),s._v(" 命令原子计数，窗口结束后计数器自动重置。数学模型可表示为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("count (t) ≤ threshold, 其中 t ∈ [k*window, (k+1)*window)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("count(t)")]),s._v("：时间 t 所在窗口的请求数；")]),s._v(" "),a("li",[a("code",[s._v("threshold")]),s._v("：窗口内最大请求数；")]),s._v(" "),a("li",[a("code",[s._v("window")]),s._v("：窗口时长。")])]),s._v(" "),a("h4",{attrs:{id:"数据结构选择"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据结构选择"}},[s._v("#")]),s._v(" 数据结构选择")]),s._v(" "),a("ul",[a("li",[s._v("采用 Redis String 类型存储计数器，key 为“限流粒度+窗口标识”（如 "),a("code",[s._v("limiter:fixed:/api/pay:1690000000")]),s._v("）；")]),s._v(" "),a("li",[s._v("利用 "),a("code",[s._v("EXPIRE")]),s._v(" 命令设置窗口过期时间，避免手动清理。")])]),s._v(" "),a("h4",{attrs:{id:"底层执行流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#底层执行流程"}},[s._v("#")]),s._v(" 底层执行流程")]),s._v(" "),a("ol",[a("li",[s._v("新请求到来时，计算当前窗口标识（如时间戳整除窗口时长："),a("code",[s._v("System.currentTimeMillis() / 1000")]),s._v("）；")]),s._v(" "),a("li",[s._v("拼接 Redis key："),a("code",[s._v("limiter:fixed:{key}:{windowId}")]),s._v("；")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("INCR")]),s._v(" 命令递增计数器，若为第一次递增则设置 "),a("code",[s._v("EXPIRE")]),s._v(" 过期时间；")]),s._v(" "),a("li",[s._v("若计数器值 > 阈值则限流，否则允许通过。")])]),s._v(" "),a("h4",{attrs:{id:"优缺点与适用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点与适用场景"}},[s._v("#")]),s._v(" 优缺点与适用场景")]),s._v(" "),a("ul",[a("li",[s._v("优点：实现最简单、Redis 操作最少（2 个命令）、性能最高（单机 QPS 可达 50 万+）；")]),s._v(" "),a("li",[s._v("缺点：存在"),a("strong",[s._v("临界问题")]),s._v("——窗口切换时可能出现“双倍流量”（如 0.9 秒到 1.1 秒跨两个窗口，共通过 2*threshold 次请求）；")]),s._v(" "),a("li",[s._v("适用场景：对流量平滑性要求低的场景（如普通接口限流、非核心业务防护）。")])]),s._v(" "),a("h3",{attrs:{id:"_2-2-滑动窗口计数器-解决临界问题的-精准限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-滑动窗口计数器-解决临界问题的-精准限流"}},[s._v("#")]),s._v(" 2.2 滑动窗口计数器：解决临界问题的“精准限流”")]),s._v(" "),a("h4",{attrs:{id:"核心原理-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心原理-2"}},[s._v("#")]),s._v(" 核心原理")]),s._v(" "),a("p",[s._v("将固定窗口拆分为 N 个连续的小窗口（如 1 秒拆分为 10 个 100ms 小窗口），通过滑动窗口的方式计算单位时间内的请求数。数学模型可表示为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("count (t) = Σ count (t-i*subWindow) ，其中 i=0 到 N-1，subWindow = window/N\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("subWindow")]),s._v("：小窗口时长；")]),s._v(" "),a("li",[s._v("N：小窗口数量（N 越大，流量控制越精准，但性能开销越高）。")])]),s._v(" "),a("h4",{attrs:{id:"数据结构选择-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据结构选择-2"}},[s._v("#")]),s._v(" 数据结构选择")]),s._v(" "),a("ul",[a("li",[s._v("采用 Redis ZSET 类型，score 为请求时间戳，value 为唯一标识（如 UUID）；")]),s._v(" "),a("li",[s._v("ZSET 天然支持按 score 范围删除和计数，完美适配滑动窗口的“删除过期请求+统计当前请求数”需求。")])]),s._v(" "),a("h4",{attrs:{id:"底层执行流程-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#底层执行流程-2"}},[s._v("#")]),s._v(" 底层执行流程")]),s._v(" "),a("ol",[a("li",[s._v("新请求到来时，获取当前时间戳 "),a("code",[s._v("currentTime")]),s._v("；")]),s._v(" "),a("li",[s._v("计算窗口起始时间："),a("code",[s._v("windowStartTime = currentTime - window*1000")]),s._v("；")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("ZREMRANGEBYSCORE")]),s._v(" 删除 ZSET 中 score < "),a("code",[s._v("windowStartTime")]),s._v(" 的过期请求；")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("ZCARD")]),s._v(" 统计当前窗口内的请求数，若 >= 阈值则限流；")]),s._v(" "),a("li",[s._v("若允许通过，执行 "),a("code",[s._v("ZADD")]),s._v(" 将当前请求的时间戳和 UUID 加入 ZSET；")]),s._v(" "),a("li",[s._v("设置 ZSET 过期时间为 "),a("code",[s._v("window+1")]),s._v(" 秒，避免垃圾数据堆积。")])]),s._v(" "),a("h4",{attrs:{id:"优缺点与适用场景-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点与适用场景-2"}},[s._v("#")]),s._v(" 优缺点与适用场景")]),s._v(" "),a("ul",[a("li",[s._v("优点：解决固定窗口的临界问题，流量控制精准，支持任意时间粒度的窗口；")]),s._v(" "),a("li",[s._v("缺点：Redis 操作较多（3 个命令），高并发下性能略低于固定窗口（单机 QPS 约 30 万+）；")]),s._v(" "),a("li",[s._v("适用场景：对流量平滑性有要求的核心场景（如电商商品详情页、支付接口限流）。")])]),s._v(" "),a("h3",{attrs:{id:"_2-3-漏桶算法-严格控制输出速率的-平稳限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-漏桶算法-严格控制输出速率的-平稳限流"}},[s._v("#")]),s._v(" 2.3 漏桶算法：严格控制输出速率的“平稳限流”")]),s._v(" "),a("h4",{attrs:{id:"核心原理-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心原理-3"}},[s._v("#")]),s._v(" 核心原理")]),s._v(" "),a("p",[s._v("将请求比作“水流”，漏桶的容量为最大并发等待数，漏桶的“漏水速率”为单位时间允许通过的请求数。数学模型可表示为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("inRate ≤ outRate, 且 queueSize ≤ capacity\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("inRate")]),s._v("：请求流入速率；")]),s._v(" "),a("li",[a("code",[s._v("outRate")]),s._v("：请求流出速率（服务承载速率）；")]),s._v(" "),a("li",[a("code",[s._v("queueSize")]),s._v("：当前排队请求数；")]),s._v(" "),a("li",[a("code",[s._v("capacity")]),s._v("：漏桶容量（最大排队数）。")])]),s._v(" "),a("h4",{attrs:{id:"数据结构选择-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据结构选择-3"}},[s._v("#")]),s._v(" 数据结构选择")]),s._v(" "),a("ul",[a("li",[s._v("采用 Redis LIST 类型作为漏桶，存储待处理的请求（可存入请求 ID、时间戳等元数据）；")]),s._v(" "),a("li",[s._v("结合 Redis 定时任务（或外部定时任务）实现“漏水”逻辑。")])]),s._v(" "),a("h4",{attrs:{id:"底层执行流程-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#底层执行流程-3"}},[s._v("#")]),s._v(" 底层执行流程")]),s._v(" "),a("ol",[a("li",[s._v("新请求到来时，执行 "),a("code",[s._v("LLEN")]),s._v(" 统计 LIST 长度，若 < 容量则执行 "),a("code",[s._v("RPUSH")]),s._v(" 入队；")]),s._v(" "),a("li",[s._v("定时任务按 "),a("code",[s._v("outRate")]),s._v(" 速率执行 "),a("code",[s._v("LPOP")]),s._v(" 出队，触发业务逻辑处理；")]),s._v(" "),a("li",[s._v("若 LIST 长度 >= 容量则限流，返回“请求过于频繁”。")])]),s._v(" "),a("h4",{attrs:{id:"优缺点与适用场景-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点与适用场景-3"}},[s._v("#")]),s._v(" 优缺点与适用场景")]),s._v(" "),a("ul",[a("li",[s._v("优点：严格控制请求输出速率，避免服务因突发流量过载，适用于下游服务性能有限的场景；")]),s._v(" "),a("li",[s._v("缺点：抗突发能力差（即使漏桶为空，突发流量也需排队），需额外维护定时任务；")]),s._v(" "),a("li",[s._v("适用场景：数据库写入限流、第三方 API 调用频率控制（如微信支付 API 每天限 1 万次）。")])]),s._v(" "),a("h3",{attrs:{id:"_2-4-令牌桶算法-平衡灵活性与抗突发的-最优解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-令牌桶算法-平衡灵活性与抗突发的-最优解"}},[s._v("#")]),s._v(" 2.4 令牌桶算法：平衡灵活性与抗突发的“最优解”")]),s._v(" "),a("h4",{attrs:{id:"核心原理-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#核心原理-4"}},[s._v("#")]),s._v(" 核心原理")]),s._v(" "),a("p",[s._v("系统按固定速率向令牌桶中放入令牌，桶的最大容量为阈值；新请求需获取 1 个令牌才能通过，无令牌则限流。数学模型可表示为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("tokenCount(t) = min(capacity, tokenCount(t0) + (t - t0)*refillRate)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ul",[a("li",[a("code",[s._v("tokenCount(t)")]),s._v("：时间 t 时的令牌数；")]),s._v(" "),a("li",[a("code",[s._v("capacity")]),s._v("：令牌桶容量；")]),s._v(" "),a("li",[a("code",[s._v("refillRate")]),s._v("：令牌填充速率（单位：个/秒）；")]),s._v(" "),a("li",[a("code",[s._v("t0")]),s._v("：上次填充令牌的时间。")])]),s._v(" "),a("h4",{attrs:{id:"数据结构选择-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据结构选择-4"}},[s._v("#")]),s._v(" 数据结构选择")]),s._v(" "),a("ul",[a("li",[s._v("采用 Redis HASH 类型存储令牌桶状态："),a("code",[s._v('{ "lastRefillTime": 上次填充时间戳, "tokenCount": 当前令牌数 }')]),s._v("；")]),s._v(" "),a("li",[s._v("HASH 支持原子更新多个字段，且存储紧凑，适合高频读写。")])]),s._v(" "),a("h4",{attrs:{id:"底层执行流程-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#底层执行流程-4"}},[s._v("#")]),s._v(" 底层执行流程")]),s._v(" "),a("ol",[a("li",[s._v("新请求到来时，获取当前时间戳 "),a("code",[s._v("currentTime")]),s._v("；")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("HGETALL")]),s._v(" 获取令牌桶状态，若不存在则初始化（"),a("code",[s._v("tokenCount=capacity")]),s._v("，"),a("code",[s._v("lastRefillTime=currentTime")]),s._v("）；")]),s._v(" "),a("li",[s._v("计算时间差 "),a("code",[s._v("timeDiff = currentTime - lastRefillTime")]),s._v("，补充令牌："),a("code",[s._v("addTokens = timeDiff * refillRate / 1000")]),s._v("，更新 "),a("code",[s._v("tokenCount = min(tokenCount + addTokens, capacity)")]),s._v("；")]),s._v(" "),a("li",[s._v("若 "),a("code",[s._v("tokenCount > 0")]),s._v(" 则令牌数减 1，允许通过；否则限流；")]),s._v(" "),a("li",[s._v("执行 "),a("code",[s._v("HMSET")]),s._v(" 更新令牌桶状态，设置过期时间避免垃圾数据。")])]),s._v(" "),a("h4",{attrs:{id:"优缺点与适用场景-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优缺点与适用场景-4"}},[s._v("#")]),s._v(" 优缺点与适用场景")]),s._v(" "),a("ul",[a("li",[s._v("优点：兼顾灵活性（固定填充速率）和抗突发（令牌预存），适配大多数高并发场景；")]),s._v(" "),a("li",[s._v("缺点：实现略复杂，需处理令牌填充的时间差计算；")]),s._v(" "),a("li",[s._v("适用场景：秒杀、抢购、首页核心接口等对流量平滑性和抗突发能力均有要求的场景。")])]),s._v(" "),a("h3",{attrs:{id:"四种算法核心对比-生产选型参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四种算法核心对比-生产选型参考"}},[s._v("#")]),s._v(" 四种算法核心对比（生产选型参考）")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("算法")]),s._v(" "),a("th",[s._v("数学模型复杂度")]),s._v(" "),a("th",[s._v("单机 QPS 上限")]),s._v(" "),a("th",[s._v("抗突发能力")]),s._v(" "),a("th",[s._v("流量平滑性")]),s._v(" "),a("th",[s._v("存储开销")]),s._v(" "),a("th",[s._v("适用场景")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("固定窗口计数器")]),s._v(" "),a("td",[s._v("低")]),s._v(" "),a("td",[s._v("50 万+")]),s._v(" "),a("td",[s._v("一般")]),s._v(" "),a("td",[s._v("差")]),s._v(" "),a("td",[s._v("极低")]),s._v(" "),a("td",[s._v("普通接口、非核心业务")])]),s._v(" "),a("tr",[a("td",[s._v("滑动窗口计数器")]),s._v(" "),a("td",[s._v("中")]),s._v(" "),a("td",[s._v("30 万+")]),s._v(" "),a("td",[s._v("一般")]),s._v(" "),a("td",[s._v("中")]),s._v(" "),a("td",[s._v("中")]),s._v(" "),a("td",[s._v("核心 API、商品详情页")])]),s._v(" "),a("tr",[a("td",[s._v("漏桶算法")]),s._v(" "),a("td",[s._v("中")]),s._v(" "),a("td",[s._v("20 万+")]),s._v(" "),a("td",[s._v("差")]),s._v(" "),a("td",[s._v("极高")]),s._v(" "),a("td",[s._v("中高")]),s._v(" "),a("td",[s._v("数据库写入、第三方 API 调用")])]),s._v(" "),a("tr",[a("td",[s._v("令牌桶算法")]),s._v(" "),a("td",[s._v("中高")]),s._v(" "),a("td",[s._v("25 万+")]),s._v(" "),a("td",[s._v("极高")]),s._v(" "),a("td",[s._v("中高")]),s._v(" "),a("td",[s._v("中")]),s._v(" "),a("td",[s._v("秒杀、抢购、高并发核心业务")])])])]),s._v(" "),a("h2",{attrs:{id:"三、redis-限流生产级实现-架构设计-代码落地"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、redis-限流生产级实现-架构设计-代码落地"}},[s._v("#")]),s._v(" 三、Redis 限流生产级实现：架构设计+代码落地")]),s._v(" "),a("h3",{attrs:{id:"_3-1-整体架构设计-可扩展、易集成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-整体架构设计-可扩展、易集成"}},[s._v("#")]),s._v(" 3.1 整体架构设计（可扩展、易集成）")]),s._v(" "),a("p",[s._v("为了适配不同业务场景，采用“工厂模式+注解驱动”的设计思路，核心架构如下：")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("限流算法工厂")]),s._v("：封装四种算法的实现，支持按类型动态选择；")]),s._v(" "),a("li",[a("strong",[s._v("自定义注解")]),s._v("：通过 "),a("code",[s._v("@RedisLimit")]),s._v(" 注解快速集成到接口，无需侵入业务代码；")]),s._v(" "),a("li",[a("strong",[s._v("Lua 脚本原子化")]),s._v("：所有算法均通过 Lua 脚本实现，避免竞态条件；")]),s._v(" "),a("li",[a("strong",[s._v("降级策略")]),s._v("：Redis 异常时降级为本地限流（Guava RateLimiter），保证服务可用性。")])]),s._v(" "),a("h3",{attrs:{id:"_3-2-前置准备-环境配置与依赖引入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-前置准备-环境配置与依赖引入"}},[s._v("#")]),s._v(" 3.2 前置准备：环境配置与依赖引入")]),s._v(" "),a("h4",{attrs:{id:"_1-maven-依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-maven-依赖"}},[s._v("#")]),s._v(" 1. Maven 依赖")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("\x3c!-- Spring Boot 核心依赖 --\x3e\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-web</artifactId>\n</dependency>\n\x3c!-- Redis 依赖 --\x3e\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-data-redis</artifactId>\n</dependency>\n\x3c!-- Redis 连接池 --\x3e\n<dependency>\n    <groupId>org.apache.commons</groupId>\n    <artifactId>commons-pool2</artifactId>\n</dependency>\n\x3c!-- Guava 本地限流（降级用） --\x3e\n<dependency>\n    <groupId>com.google.guava</groupId>\n    <artifactId>guava</artifactId>\n    <version>32.1.2-jre</version>\n</dependency>\n\x3c!-- AOP 依赖（注解驱动） --\x3e\n<dependency>\n    <groupId>org.springframework.boot</groupId>\n    <artifactId>spring-boot-starter-aop</artifactId>\n</dependency>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h4",{attrs:{id:"_2-redis-配置-application-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-配置-application-yml"}},[s._v("#")]),s._v(" 2. Redis 配置（application.yml）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("spring:\n  redis:\n    host: 127.0.0.1\n    port: 6379\n    password: # 生产环境必填\n    lettuce:\n      pool:\n        max-active: 64 # 最大连接数（按并发量调整）\n        max-idle: 32 # 最大空闲连接\n        min-idle: 8 # 最小空闲连接\n        max-wait: 3000ms # 连接等待时间\n    timeout: 2000ms # 连接超时时间\n  redis-limiter:\n    default-window-seconds: 1 # 默认窗口时长（秒）\n    default-threshold: 100 # 默认限流阈值\n    fallback-enabled: true # 启用降级策略\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h4",{attrs:{id:"_3-redistemplate-优化配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-redistemplate-优化配置"}},[s._v("#")]),s._v(" 3. RedisTemplate 优化配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.data.redis.connection.RedisConnectionFactory;\nimport org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;\nimport org.springframework.data.redis.serializer.StringRedisSerializer;\n\n@Configuration\npublic class RedisConfig {\n\n    @Bean\n    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {\n        RedisTemplate<String, Object> template = new RedisTemplate<>();\n        template.setConnectionFactory(factory);\n\n        // Key 序列化（String 序列化，避免乱码）\n        StringRedisSerializer stringSerializer = new StringRedisSerializer();\n        template.setKeySerializer(stringSerializer);\n        template.setHashKeySerializer(stringSerializer);\n\n        // Value 序列化（JSON 序列化，支持对象存储）\n        GenericJackson2JsonRedisSerializer jsonSerializer = new GenericJackson2JsonRedisSerializer();\n        template.setValueSerializer(jsonSerializer);\n        template.setHashValueSerializer(jsonSerializer);\n\n        // 开启事务支持（可选，根据业务需求）\n        template.setEnableTransactionSupport(true);\n        template.afterPropertiesSet();\n        return template;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h3",{attrs:{id:"_3-3-核心组件实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-核心组件实现"}},[s._v("#")]),s._v(" 3.3 核心组件实现")]),s._v(" "),a("h4",{attrs:{id:"_1-限流算法枚举-统一标识"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-限流算法枚举-统一标识"}},[s._v("#")]),s._v(" 1. 限流算法枚举（统一标识）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("public enum LimitAlgorithm {\n    FIXED_WINDOW,    // 固定窗口计数器\n    SLIDING_WINDOW,  // 滑动窗口计数器\n    LEAKY_BUCKET,    // 漏桶算法\n    TOKEN_BUCKET     // 令牌桶算法\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"_2-自定义注解-redislimit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-自定义注解-redislimit"}},[s._v("#")]),s._v(" 2. 自定义注解（@RedisLimit）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import java.lang.annotation.*;\n\n@Target({ElementType.METHOD})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface RedisLimit {\n    /**\n     * 限流键（支持 SpEL 表达式，如 "#userId + \':\' + \'/api/order\'"）\n     */\n    String key() default "";\n\n    /**\n     * 限流算法类型\n     */\n    LimitAlgorithm algorithm() default LimitAlgorithm.TOKEN_BUCKET;\n\n    /**\n     * 窗口时长（秒）\n     */\n    int windowSeconds() default 1;\n\n    /**\n     * 限流阈值（窗口内最大请求数）\n     */\n    int threshold() default 100;\n\n    /**\n     * 漏桶算法专用：桶容量\n     */\n    int bucketCapacity() default 10;\n\n    /**\n     * 漏桶/令牌桶专用：速率（个/秒）\n     */\n    int rate() default 5;\n\n    /**\n     * 限流提示信息\n     */\n    String message() default "请求过于频繁，请稍后再试";\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("h4",{attrs:{id:"_3-限流算法工厂与实现-lua-脚本原子化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-限流算法工厂与实现-lua-脚本原子化"}},[s._v("#")]),s._v(" 3. 限流算法工厂与实现（Lua 脚本原子化）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import org.springframework.data.redis.core.RedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.Resource;\nimport java.util.Collections;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.UUID;\nimport java.util.concurrent.TimeUnit;\n\n/**\n * Redis 限流算法工厂（封装四种核心算法）\n */\n@Component\npublic class RedisLimitFactory {\n\n    @Resource\n    private RedisTemplate<String, Object> redisTemplate;\n\n    // 固定窗口计数器 Lua 脚本（原子执行 INCR + EXPIRE + 阈值判断）\n    private static final String FIXED_WINDOW_SCRIPT = \"\"\"\n            local key = KEYS[1]\n            local windowSeconds = tonumber(ARGV[1])\n            local threshold = tonumber(ARGV[2])\n            \n            -- 原子递增计数器\n            local count = redis.call('incr', key)\n            -- 第一次递增时设置过期时间\n            if count == 1 then\n                redis.call('expire', key, windowSeconds)\n            end\n            -- 返回是否允许通过（1 允许，0 限流）\n            return count <= threshold and 1 or 0\n            \"\"\";\n\n    // 滑动窗口计数器 Lua 脚本\n    private static final String SLIDING_WINDOW_SCRIPT = \"\"\"\n            local key = KEYS[1]\n            local windowSeconds = tonumber(ARGV[1])\n            local threshold = tonumber(ARGV[2])\n            local currentTime = tonumber(ARGV[3])\n            local windowStartTime = currentTime - windowSeconds * 1000\n            \n            -- 删除过期的请求（时间戳 < 窗口起始时间）\n            redis.call('zremrangebyscore', key, 0, windowStartTime)\n            -- 统计当前窗口内的请求数\n            local count = redis.call('zcard', key)\n            if count >= threshold then\n                return 0 -- 限流\n            end\n            -- 加入当前请求（value 用 UUID 避免重复）\n            redis.call('zadd', key, currentTime, ARGV[4])\n            -- 设置过期时间（窗口时长 + 1 秒，避免垃圾数据）\n            redis.call('expire', key, windowSeconds + 1)\n            return 1 -- 允许通过\n            \"\"\";\n\n    // 令牌桶算法 Lua 脚本\n    private static final String TOKEN_BUCKET_SCRIPT = \"\"\"\n            local key = KEYS[1]\n            local capacity = tonumber(ARGV[1]) -- 桶容量\n            local refillRate = tonumber(ARGV[2]) -- 填充速率（个/秒）\n            local currentTime = tonumber(ARGV[3])\n            \n            -- 获取令牌桶状态，不存在则初始化\n            local bucket = redis.call('hgetall', key)\n            local lastRefillTime = currentTime\n            local tokenCount = capacity\n            if #bucket > 0 then\n                for i = 1, #bucket, 2 do\n                    if bucket[i] == 'lastRefillTime' then\n                        lastRefillTime = tonumber(bucket[i+1])\n                    elseif bucket[i] == 'tokenCount' then\n                        tokenCount = tonumber(bucket[i+1])\n                    end\n                end\n            end\n            \n            -- 计算应补充的令牌数\n            local timeDiff = currentTime - lastRefillTime\n            local addTokens = timeDiff * refillRate / 1000\n            if addTokens > 0 then\n                tokenCount = math.min(tokenCount + addTokens, capacity)\n                lastRefillTime = currentTime\n            end\n            \n            -- 尝试获取令牌\n            if tokenCount <= 0 then\n                return 0 -- 限流\n            end\n            tokenCount = tokenCount - 1\n            \n            -- 更新令牌桶状态\n            redis.call('hmset', key, 'lastRefillTime', lastRefillTime, 'tokenCount', tokenCount)\n            -- 设置过期时间（10 分钟，避免长期无请求的垃圾数据）\n            redis.call('expire', key, 600)\n            return 1 -- 允许通过\n            \"\"\";\n\n    // 漏桶算法 Lua 脚本\n    private static final String LEAKY_BUCKET_SCRIPT = \"\"\"\n            local key = KEYS[1]\n            local capacity = tonumber(ARGV[1]) -- 桶容量\n            local currentTime = tonumber(ARGV[2])\n            \n            -- 统计当前桶中请求数\n            local size = redis.call('llen', key)\n            if size >= capacity then\n                return 0 -- 桶满，限流\n            end\n            \n            -- 入桶（存储请求时间戳）\n            redis.call('rpush', key, currentTime)\n            -- 设置过期时间（5 分钟，避免请求处理完后残留）\n            redis.call('expire', key, 300)\n            return 1 -- 入桶成功\n            \"\"\";\n\n    /**\n     * 执行限流判断\n     */\n    public boolean doLimit(LimitAlgorithm algorithm, String key, int windowSeconds, int threshold,\n                           int bucketCapacity, int rate) {\n        try {\n            switch (algorithm) {\n                case FIXED_WINDOW:\n                    return fixedWindowLimit(key, windowSeconds, threshold);\n                case SLIDING_WINDOW:\n                    return slidingWindowLimit(key, windowSeconds, threshold);\n                case TOKEN_BUCKET:\n                    return tokenBucketLimit(key, bucketCapacity, rate);\n                case LEAKY_BUCKET:\n                    return leakyBucketLimit(key, bucketCapacity);\n                default:\n                    return false;\n            }\n        } catch (Exception e) {\n            // Redis 异常时，降级为本地限流（Guava RateLimiter）\n            return localFallbackLimit(rate);\n        }\n    }\n\n    /**\n     * 固定窗口计数器限流\n     */\n    private boolean fixedWindowLimit(String key, int windowSeconds, int threshold) {\n        String redisKey = buildRedisKey(key, LimitAlgorithm.FIXED_WINDOW);\n        DefaultRedisScript<Long> script = new DefaultRedisScript<>(FIXED_WINDOW_SCRIPT, Long.class);\n        Long result = redisTemplate.execute(script, Collections.singletonList(redisKey),\n                String.valueOf(windowSeconds), String.valueOf(threshold));\n        return result != null && result == 1;\n    }\n\n    /**\n     * 滑动窗口计数器限流\n     */\n    private boolean slidingWindowLimit(String key, int windowSeconds, int threshold) {\n        String redisKey = buildRedisKey(key, LimitAlgorithm.SLIDING_WINDOW);\n        long currentTime = System.currentTimeMillis();\n        String uuid = UUID.randomUUID().toString();\n        DefaultRedisScript<Long> script = new DefaultRedisScript<>(SLIDING_WINDOW_SCRIPT, Long.class);\n        Long result = redisTemplate.execute(script, Collections.singletonList(redisKey),\n                String.valueOf(windowSeconds), String.valueOf(threshold),\n                String.valueOf(currentTime), uuid);\n        return result != null && result == 1;\n    }\n\n    /**\n     * 令牌桶算法限流\n     */\n    private boolean tokenBucketLimit(String key, int capacity, int rate) {\n        String redisKey = buildRedisKey(key, LimitAlgorithm.TOKEN_BUCKET);\n        long currentTime = System.currentTimeMillis();\n        DefaultRedisScript<Long> script = new DefaultRedisScript<>(TOKEN_BUCKET_SCRIPT, Long.class);\n        Long result = redisTemplate.execute(script, Collections.singletonList(redisKey),\n                String.valueOf(capacity), String.valueOf(rate), String.valueOf(currentTime));\n        return result != null && result == 1;\n    }\n\n    /**\n     * 漏桶算法限流（入桶逻辑）\n     */\n    private boolean leakyBucketLimit(String key, int capacity) {\n        String redisKey = buildRedisKey(key, LimitAlgorithm.LEAKY_BUCKET);\n        long currentTime = System.currentTimeMillis();\n        DefaultRedisScript<Long> script = new DefaultRedisScript<>(LEAKY_BUCKET_SCRIPT, Long.class);\n        Long result = redisTemplate.execute(script, Collections.singletonList(redisKey),\n                String.valueOf(capacity), String.valueOf(currentTime));\n        return result != null && result == 1;\n    }\n\n    /**\n     * 本地降级限流（Guava RateLimiter）\n     */\n    private boolean localFallbackLimit(int rate) {\n        // 基于 Guava RateLimiter 实现本地限流，key 为速率（简化处理）\n        String localKey = \"local:limiter:\" + rate;\n        GuavaRateLimiterHolder holder = GuavaRateLimiterHolder.getInstance();\n        return holder.getRateLimiter(localKey, rate).tryAcquire();\n    }\n\n    /**\n     * 构建 Redis 键（避免冲突）\n     */\n    private String buildRedisKey(String key, LimitAlgorithm algorithm) {\n        return String.format(\"limiter:%s:%s\", algorithm.name().toLowerCase(), key);\n    }\n\n    /**\n     * Guava RateLimiter 单例持有者（避免重复创建）\n     */\n    private static class GuavaRateLimiterHolder {\n        private static final GuavaRateLimiterHolder INSTANCE = new GuavaRateLimiterHolder();\n        private final Map<String, com.google.common.util.concurrent.RateLimiter> rateLimiterMap = new HashMap<>();\n\n        private GuavaRateLimiterHolder() {}\n\n        public static GuavaRateLimiterHolder getInstance() {\n            return INSTANCE;\n        }\n\n        public com.google.common.util.concurrent.RateLimiter getRateLimiter(String key, int rate) {\n            return rateLimiterMap.computeIfAbsent(key, k -> com.google.common.util.concurrent.RateLimiter.create(rate));\n        }\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br"),a("span",{staticClass:"line-number"},[s._v("116")]),a("br"),a("span",{staticClass:"line-number"},[s._v("117")]),a("br"),a("span",{staticClass:"line-number"},[s._v("118")]),a("br"),a("span",{staticClass:"line-number"},[s._v("119")]),a("br"),a("span",{staticClass:"line-number"},[s._v("120")]),a("br"),a("span",{staticClass:"line-number"},[s._v("121")]),a("br"),a("span",{staticClass:"line-number"},[s._v("122")]),a("br"),a("span",{staticClass:"line-number"},[s._v("123")]),a("br"),a("span",{staticClass:"line-number"},[s._v("124")]),a("br"),a("span",{staticClass:"line-number"},[s._v("125")]),a("br"),a("span",{staticClass:"line-number"},[s._v("126")]),a("br"),a("span",{staticClass:"line-number"},[s._v("127")]),a("br"),a("span",{staticClass:"line-number"},[s._v("128")]),a("br"),a("span",{staticClass:"line-number"},[s._v("129")]),a("br"),a("span",{staticClass:"line-number"},[s._v("130")]),a("br"),a("span",{staticClass:"line-number"},[s._v("131")]),a("br"),a("span",{staticClass:"line-number"},[s._v("132")]),a("br"),a("span",{staticClass:"line-number"},[s._v("133")]),a("br"),a("span",{staticClass:"line-number"},[s._v("134")]),a("br"),a("span",{staticClass:"line-number"},[s._v("135")]),a("br"),a("span",{staticClass:"line-number"},[s._v("136")]),a("br"),a("span",{staticClass:"line-number"},[s._v("137")]),a("br"),a("span",{staticClass:"line-number"},[s._v("138")]),a("br"),a("span",{staticClass:"line-number"},[s._v("139")]),a("br"),a("span",{staticClass:"line-number"},[s._v("140")]),a("br"),a("span",{staticClass:"line-number"},[s._v("141")]),a("br"),a("span",{staticClass:"line-number"},[s._v("142")]),a("br"),a("span",{staticClass:"line-number"},[s._v("143")]),a("br"),a("span",{staticClass:"line-number"},[s._v("144")]),a("br"),a("span",{staticClass:"line-number"},[s._v("145")]),a("br"),a("span",{staticClass:"line-number"},[s._v("146")]),a("br"),a("span",{staticClass:"line-number"},[s._v("147")]),a("br"),a("span",{staticClass:"line-number"},[s._v("148")]),a("br"),a("span",{staticClass:"line-number"},[s._v("149")]),a("br"),a("span",{staticClass:"line-number"},[s._v("150")]),a("br"),a("span",{staticClass:"line-number"},[s._v("151")]),a("br"),a("span",{staticClass:"line-number"},[s._v("152")]),a("br"),a("span",{staticClass:"line-number"},[s._v("153")]),a("br"),a("span",{staticClass:"line-number"},[s._v("154")]),a("br"),a("span",{staticClass:"line-number"},[s._v("155")]),a("br"),a("span",{staticClass:"line-number"},[s._v("156")]),a("br"),a("span",{staticClass:"line-number"},[s._v("157")]),a("br"),a("span",{staticClass:"line-number"},[s._v("158")]),a("br"),a("span",{staticClass:"line-number"},[s._v("159")]),a("br"),a("span",{staticClass:"line-number"},[s._v("160")]),a("br"),a("span",{staticClass:"line-number"},[s._v("161")]),a("br"),a("span",{staticClass:"line-number"},[s._v("162")]),a("br"),a("span",{staticClass:"line-number"},[s._v("163")]),a("br"),a("span",{staticClass:"line-number"},[s._v("164")]),a("br"),a("span",{staticClass:"line-number"},[s._v("165")]),a("br"),a("span",{staticClass:"line-number"},[s._v("166")]),a("br"),a("span",{staticClass:"line-number"},[s._v("167")]),a("br"),a("span",{staticClass:"line-number"},[s._v("168")]),a("br"),a("span",{staticClass:"line-number"},[s._v("169")]),a("br"),a("span",{staticClass:"line-number"},[s._v("170")]),a("br"),a("span",{staticClass:"line-number"},[s._v("171")]),a("br"),a("span",{staticClass:"line-number"},[s._v("172")]),a("br"),a("span",{staticClass:"line-number"},[s._v("173")]),a("br"),a("span",{staticClass:"line-number"},[s._v("174")]),a("br"),a("span",{staticClass:"line-number"},[s._v("175")]),a("br"),a("span",{staticClass:"line-number"},[s._v("176")]),a("br"),a("span",{staticClass:"line-number"},[s._v("177")]),a("br"),a("span",{staticClass:"line-number"},[s._v("178")]),a("br"),a("span",{staticClass:"line-number"},[s._v("179")]),a("br"),a("span",{staticClass:"line-number"},[s._v("180")]),a("br"),a("span",{staticClass:"line-number"},[s._v("181")]),a("br"),a("span",{staticClass:"line-number"},[s._v("182")]),a("br"),a("span",{staticClass:"line-number"},[s._v("183")]),a("br"),a("span",{staticClass:"line-number"},[s._v("184")]),a("br"),a("span",{staticClass:"line-number"},[s._v("185")]),a("br"),a("span",{staticClass:"line-number"},[s._v("186")]),a("br"),a("span",{staticClass:"line-number"},[s._v("187")]),a("br"),a("span",{staticClass:"line-number"},[s._v("188")]),a("br"),a("span",{staticClass:"line-number"},[s._v("189")]),a("br"),a("span",{staticClass:"line-number"},[s._v("190")]),a("br"),a("span",{staticClass:"line-number"},[s._v("191")]),a("br"),a("span",{staticClass:"line-number"},[s._v("192")]),a("br"),a("span",{staticClass:"line-number"},[s._v("193")]),a("br"),a("span",{staticClass:"line-number"},[s._v("194")]),a("br"),a("span",{staticClass:"line-number"},[s._v("195")]),a("br"),a("span",{staticClass:"line-number"},[s._v("196")]),a("br"),a("span",{staticClass:"line-number"},[s._v("197")]),a("br"),a("span",{staticClass:"line-number"},[s._v("198")]),a("br"),a("span",{staticClass:"line-number"},[s._v("199")]),a("br"),a("span",{staticClass:"line-number"},[s._v("200")]),a("br"),a("span",{staticClass:"line-number"},[s._v("201")]),a("br"),a("span",{staticClass:"line-number"},[s._v("202")]),a("br"),a("span",{staticClass:"line-number"},[s._v("203")]),a("br"),a("span",{staticClass:"line-number"},[s._v("204")]),a("br"),a("span",{staticClass:"line-number"},[s._v("205")]),a("br"),a("span",{staticClass:"line-number"},[s._v("206")]),a("br"),a("span",{staticClass:"line-number"},[s._v("207")]),a("br"),a("span",{staticClass:"line-number"},[s._v("208")]),a("br"),a("span",{staticClass:"line-number"},[s._v("209")]),a("br"),a("span",{staticClass:"line-number"},[s._v("210")]),a("br"),a("span",{staticClass:"line-number"},[s._v("211")]),a("br"),a("span",{staticClass:"line-number"},[s._v("212")]),a("br"),a("span",{staticClass:"line-number"},[s._v("213")]),a("br"),a("span",{staticClass:"line-number"},[s._v("214")]),a("br"),a("span",{staticClass:"line-number"},[s._v("215")]),a("br"),a("span",{staticClass:"line-number"},[s._v("216")]),a("br"),a("span",{staticClass:"line-number"},[s._v("217")]),a("br"),a("span",{staticClass:"line-number"},[s._v("218")]),a("br"),a("span",{staticClass:"line-number"},[s._v("219")]),a("br"),a("span",{staticClass:"line-number"},[s._v("220")]),a("br"),a("span",{staticClass:"line-number"},[s._v("221")]),a("br"),a("span",{staticClass:"line-number"},[s._v("222")]),a("br"),a("span",{staticClass:"line-number"},[s._v("223")]),a("br"),a("span",{staticClass:"line-number"},[s._v("224")]),a("br"),a("span",{staticClass:"line-number"},[s._v("225")]),a("br"),a("span",{staticClass:"line-number"},[s._v("226")]),a("br"),a("span",{staticClass:"line-number"},[s._v("227")]),a("br")])]),a("h4",{attrs:{id:"_4-aop-切面-注解驱动执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-aop-切面-注解驱动执行"}},[s._v("#")]),s._v(" 4. AOP 切面（注解驱动执行）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import org.aspectj.lang.ProceedingJoinPoint;\nimport org.aspectj.lang.annotation.Around;\nimport org.aspectj.lang.annotation.Aspect;\nimport org.aspectj.lang.annotation.Pointcut;\nimport org.aspectj.lang.reflect.MethodSignature;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.core.DefaultParameterNameDiscoverer;\nimport org.springframework.expression.EvaluationContext;\nimport org.springframework.expression.Expression;\nimport org.springframework.expression.spel.standard.SpelExpressionParser;\nimport org.springframework.expression.spel.support.StandardEvaluationContext;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.Resource;\nimport java.lang.reflect.Method;\n\n@Aspect\n@Component\npublic class RedisLimitAspect {\n\n    @Resource\n    private RedisLimitFactory redisLimitFactory;\n\n    @Value("${spring.redis-limiter.fallback-enabled:true}")\n    private boolean fallbackEnabled;\n\n    // SpEL 解析器\n    private final SpelExpressionParser parser = new SpelExpressionParser();\n    private final DefaultParameterNameDiscoverer parameterNameDiscoverer = new DefaultParameterNameDiscoverer();\n\n    /**\n     * 切入点：标注 @RedisLimit 注解的方法\n     */\n    @Pointcut("@annotation(com.example.redis.limiter.RedisLimit)")\n    public void redisLimitPointcut() {}\n\n    /**\n     * 环绕通知：执行限流判断\n     */\n    @Around("redisLimitPointcut()")\n    public Object around(ProceedingJoinPoint joinPoint) throws Throwable {\n        MethodSignature signature = (MethodSignature) joinPoint.getSignature();\n        Method method = signature.getMethod();\n        RedisLimit annotation = method.getAnnotation(RedisLimit.class);\n\n        // 解析限流键（支持 SpEL 表达式）\n        String key = parseSpelKey(annotation.key(), method, joinPoint.getArgs());\n        // 若未指定 key，默认用 "类名:方法名"\n        if (key.isEmpty()) {\n            key = method.getDeclaringClass().getName() + ":" + method.getName();\n        }\n\n        // 执行限流判断\n        boolean allow = redisLimitFactory.doLimit(\n                annotation.algorithm(),\n                key,\n                annotation.windowSeconds(),\n                annotation.threshold(),\n                annotation.bucketCapacity(),\n                annotation.rate()\n        );\n\n        if (!allow) {\n            // 限流时抛出异常，由全局异常处理器捕获\n            throw new RuntimeException(annotation.message());\n        }\n\n        // 允许通过，执行原方法\n        return joinPoint.proceed();\n    }\n\n    /**\n     * 解析 SpEL 表达式，获取限流键\n     */\n    private String parseSpelKey(String spelKey, Method method, Object[] args) {\n        if (spelKey.isEmpty()) {\n            return "";\n        }\n\n        // 构建 SpEL 上下文\n        EvaluationContext context = new StandardEvaluationContext();\n        String[] parameterNames = parameterNameDiscoverer.getParameterNames(method);\n        if (parameterNames != null) {\n            for (int i = 0; i < parameterNames.length; i++) {\n                context.setVariable(parameterNames[i], args[i]);\n            }\n        }\n\n        // 解析 SpEL 表达式\n        Expression expression = parser.parseExpression(spelKey);\n        return expression.getValue(context, String.class);\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br")])]),a("h4",{attrs:{id:"_5-全局异常处理器-统一返回限流结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-全局异常处理器-统一返回限流结果"}},[s._v("#")]),s._v(" 5. 全局异常处理器（统一返回限流结果）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import org.springframework.http.HttpStatus;\nimport org.springframework.web.bind.annotation.ExceptionHandler;\nimport org.springframework.web.bind.annotation.ResponseStatus;\nimport org.springframework.web.bind.annotation.RestControllerAdvice;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\n@RestControllerAdvice\npublic class GlobalExceptionHandler {\n\n    @ExceptionHandler(RuntimeException.class)\n    @ResponseStatus(HttpStatus.TOO_MANY_REQUESTS)\n    public Map<String, Object> handleLimitException(RuntimeException e) {\n        Map<String, Object> result = new HashMap<>();\n        result.put("code", 429);\n        result.put("message", e.getMessage());\n        result.put("success", false);\n        return result;\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"_3-4-接口集成示例-注解驱动-零侵入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-接口集成示例-注解驱动-零侵入"}},[s._v("#")]),s._v(" 3.4 接口集成示例（注解驱动，零侵入）")]),s._v(" "),a("h4",{attrs:{id:"_1-普通接口限流-按接口粒度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-普通接口限流-按接口粒度"}},[s._v("#")]),s._v(" 1. 普通接口限流（按接口粒度）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class TestController {\n\n    /**\n     * 普通接口限流：1 秒内最多允许 100 次请求（令牌桶算法）\n     */\n    @GetMapping("/api/test")\n    @RedisLimit(\n            key = "/api/test",\n            algorithm = LimitAlgorithm.TOKEN_BUCKET,\n            windowSeconds = 1,\n            threshold = 100,\n            capacity = 100,\n            rate = 100,\n            message = "接口请求过于频繁，请稍后再试"\n    )\n    public String testLimit() {\n        return "请求成功";\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h4",{attrs:{id:"_2-用户粒度限流-按用户-id-接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-用户粒度限流-按用户-id-接口"}},[s._v("#")]),s._v(" 2. 用户粒度限流（按用户 ID + 接口）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class OrderController {\n\n    /**\n     * 用户粒度限流：每个用户 10 秒内最多允许 3 次下单（滑动窗口算法）\n     * 限流键：user:1001:/api/order/create（通过 SpEL 表达式解析 userId）\n     */\n    @GetMapping("/api/order/create")\n    @RedisLimit(\n            key = "\'user:\' + #userId + \':/api/order/create\'",\n            algorithm = LimitAlgorithm.SLIDING_WINDOW,\n            windowSeconds = 10,\n            threshold = 3,\n            message = "您下单过于频繁，请 10 秒后再试"\n    )\n    public String createOrder(@RequestParam Long userId) {\n        // 下单业务逻辑\n        return "下单成功";\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h4",{attrs:{id:"_3-秒杀场景限流-商品粒度-用户粒度双重防护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-秒杀场景限流-商品粒度-用户粒度双重防护"}},[s._v("#")]),s._v(" 3. 秒杀场景限流（商品粒度+用户粒度双重防护）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('import org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class SeckillController {\n\n    /**\n     * 秒杀限流：商品粒度（1 秒 100 次）+ 用户粒度（10 秒 1 次）\n     * 注：此处仅演示商品粒度，用户粒度可通过多注解或手动调用工厂实现\n     */\n    @GetMapping("/api/seckill/{goodsId}")\n    @RedisLimit(\n            key = "\'seckill:goods:\' + #goodsId",\n            algorithm = LimitAlgorithm.TOKEN_BUCKET,\n            windowSeconds = 1,\n            threshold = 100,\n            capacity = 100,\n            rate = 100,\n            message = "秒杀过于火爆，请稍后再试"\n    )\n    public String seckill(@PathVariable Long goodsId, @RequestParam Long userId) {\n        // 手动添加用户粒度限流（也可通过自定义组合注解优化）\n        String userKey = "user:" + userId + ":seckill:" + goodsId;\n        boolean userAllow = redisLimitFactory.doLimit(\n                LimitAlgorithm.FIXED_WINDOW,\n                userKey,\n                10, // 10 秒窗口\n                1,  // 1 次请求\n                0,  // 无关参数\n                0   // 无关参数\n        );\n        if (!userAllow) {\n            throw new RuntimeException("您已参与过该商品秒杀，请勿重复提交");\n        }\n\n        // 秒杀业务逻辑（扣减库存、创建订单）\n        return "秒杀成功";\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("h2",{attrs:{id:"四、生产级优化-高并发、高可用、可观测"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、生产级优化-高并发、高可用、可观测"}},[s._v("#")]),s._v(" 四、生产级优化：高并发、高可用、可观测")]),s._v(" "),a("h3",{attrs:{id:"_4-1-高并发优化-突破单机-redis-瓶颈"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-高并发优化-突破单机-redis-瓶颈"}},[s._v("#")]),s._v(" 4.1 高并发优化：突破单机 Redis 瓶颈")]),s._v(" "),a("h4",{attrs:{id:"_1-redis-cluster-分片策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis-cluster-分片策略"}},[s._v("#")]),s._v(" 1. Redis Cluster 分片策略")]),s._v(" "),a("ul",[a("li",[s._v("问题：单 Redis 节点的 QPS 上限约 10 万 ~ 100 万，秒杀等场景可能压垮节点；")]),s._v(" "),a("li",[s._v("解决方案：按限流键 "),a("code",[s._v("key")]),s._v(" 哈希分片，将不同 "),a("code",[s._v("key")]),s._v(" 的限流数据分散到 Redis Cluster 的多个节点；")]),s._v(" "),a("li",[s._v("实现：利用 Redis Cluster 的哈希槽机制，无需手动分片（Redis 自动将 "),a("code",[s._v("key")]),s._v(" 映射到对应哈希槽）；")]),s._v(" "),a("li",[s._v("注意：同一 "),a("code",[s._v("key")]),s._v(" 的限流数据会落在同一节点，保证计数准确。")])]),s._v(" "),a("h4",{attrs:{id:"_2-本地缓存预热-减少-redis-访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-本地缓存预热-减少-redis-访问"}},[s._v("#")]),s._v(" 2. 本地缓存预热（减少 Redis 访问）")]),s._v(" "),a("ul",[a("li",[s._v("问题：高频请求（如每秒 10 万+）会频繁访问 Redis，增加网络 IO 开销；")]),s._v(" "),a("li",[s._v("解决方案：在应用本地缓存“限流状态”，如本地缓存 100ms，期间不访问 Redis；")]),s._v(" "),a("li",[s._v("实现：在 "),a("code",[s._v("RedisLimitFactory")]),s._v(" 中加入本地缓存（如 Caffeine），缓存限流键的“是否已限流”状态；")]),s._v(" "),a("li",[s._v("注意：本地缓存时长需远小于 Redis 窗口时长（如 100ms vs 1 秒），避免数据不一致。")])]),s._v(" "),a("h4",{attrs:{id:"_3-lua-脚本优化-减少网络往返"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-lua-脚本优化-减少网络往返"}},[s._v("#")]),s._v(" 3. Lua 脚本优化（减少网络往返）")]),s._v(" "),a("ul",[a("li",[s._v("问题：分步执行 Redis 命令会增加网络往返次数，高并发下性能下降；")]),s._v(" "),a("li",[s._v("解决方案：所有算法均通过 Lua 脚本原子化执行，将多个命令合并为 1 次网络请求；")]),s._v(" "),a("li",[s._v("优化点：Lua 脚本避免复杂逻辑（如循环、条件判断过多），防止脚本超时（Redis 默认脚本超时时间 5 秒）。")])]),s._v(" "),a("h3",{attrs:{id:"_4-2-高可用优化-避免-redis-成为单点故障"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-高可用优化-避免-redis-成为单点故障"}},[s._v("#")]),s._v(" 4.2 高可用优化：避免 Redis 成为单点故障")]),s._v(" "),a("h4",{attrs:{id:"_1-降级策略完善"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-降级策略完善"}},[s._v("#")]),s._v(" 1. 降级策略完善")]),s._v(" "),a("ul",[a("li",[s._v("Redis 宕机/网络超时：降级为本地限流（Guava RateLimiter），保证服务基本可用；")]),s._v(" "),a("li",[s._v("降级开关：通过配置中心（如 Nacos）动态控制是否启用降级，便于故障恢复；")]),s._v(" "),a("li",[s._v("限流熔断：当 Redis 异常率超过阈值（如 50%），自动熔断 Redis 限流，切换为本地限流。")])]),s._v(" "),a("h4",{attrs:{id:"_2-redis-集群高可用部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-redis-集群高可用部署"}},[s._v("#")]),s._v(" 2. Redis 集群高可用部署")]),s._v(" "),a("ul",[a("li",[s._v("部署架构：Redis Cluster（3 主 3 从）+ 哨兵模式，确保节点故障时自动切换；")]),s._v(" "),a("li",[s._v("数据持久化：开启 RDB + AOF 混合持久化，避免 Redis 重启后限流数据丢失；")]),s._v(" "),a("li",[s._v("连接池优化：合理配置 Redis 连接池参数（最大连接数、空闲连接数），避免连接耗尽。")])]),s._v(" "),a("h4",{attrs:{id:"_3-限流键过期时间优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-限流键过期时间优化"}},[s._v("#")]),s._v(" 3. 限流键过期时间优化")]),s._v(" "),a("ul",[a("li",[s._v("问题：长期无请求的限流键会占用 Redis 存储；")]),s._v(" "),a("li",[s._v("解决方案：所有限流键均设置过期时间（如窗口时长 + 1 秒、10 分钟），避免垃圾数据堆积；")]),s._v(" "),a("li",[s._v("优化点：对大窗口限流（如 1 天），定期执行 "),a("code",[s._v("SCAN")]),s._v(" 命令清理过期键，避免过期键过多影响性能。")])]),s._v(" "),a("h3",{attrs:{id:"_4-3-可观测性优化-监控告警体系"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-可观测性优化-监控告警体系"}},[s._v("#")]),s._v(" 4.3 可观测性优化：监控告警体系")]),s._v(" "),a("h4",{attrs:{id:"_1-限流指标监控-接入-prometheus-grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-限流指标监控-接入-prometheus-grafana"}},[s._v("#")]),s._v(" 1. 限流指标监控（接入 Prometheus+Grafana）")]),s._v(" "),a("ul",[a("li",[s._v("核心指标：\n"),a("ul",[a("li",[s._v("限流总请求数、通过请求数、被拒绝请求数；")]),s._v(" "),a("li",[s._v("各限流键的 QPS、拒绝率；")]),s._v(" "),a("li",[s._v("Redis 限流响应时间、异常率；")])])]),s._v(" "),a("li",[s._v("实现：在 "),a("code",[s._v("RedisLimitFactory")]),s._v(" 中埋点，通过 Prometheus 客户端暴露指标，Grafana 配置仪表盘。")])]),s._v(" "),a("h4",{attrs:{id:"_2-告警配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-告警配置"}},[s._v("#")]),s._v(" 2. 告警配置")]),s._v(" "),a("ul",[a("li",[s._v("告警阈值：拒绝率 > 10%、Redis 异常率 > 5%、限流响应时间 > 5ms；")]),s._v(" "),a("li",[s._v("告警渠道：短信、邮件、钉钉/企业微信，确保及时响应。")])]),s._v(" "),a("h4",{attrs:{id:"_3-日志打印"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-日志打印"}},[s._v("#")]),s._v(" 3. 日志打印")]),s._v(" "),a("ul",[a("li",[s._v("打印内容：限流键、算法类型、是否通过、当前计数器/令牌数；")]),s._v(" "),a("li",[s._v("日志级别：正常通过的请求用 "),a("code",[s._v("INFO")]),s._v(" 级，被限流的请求用 "),a("code",[s._v("WARN")]),s._v(" 级，Redis 异常用 "),a("code",[s._v("ERROR")]),s._v(" 级；")]),s._v(" "),a("li",[s._v("采样打印：高并发场景下，对限流通过的请求进行采样打印（如 1% 采样率），避免日志刷屏。")])]),s._v(" "),a("h3",{attrs:{id:"_4-4-可扩展性优化-动态调整与多场景适配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-可扩展性优化-动态调整与多场景适配"}},[s._v("#")]),s._v(" 4.4 可扩展性优化：动态调整与多场景适配")]),s._v(" "),a("h4",{attrs:{id:"_1-动态阈值调整"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-动态阈值调整"}},[s._v("#")]),s._v(" 1. 动态阈值调整")]),s._v(" "),a("ul",[a("li",[s._v("问题：固定阈值无法适配流量波动（如促销期间需临时提高阈值）；")]),s._v(" "),a("li",[s._v("解决方案：将限流阈值存储到 Redis/配置中心，实时读取，支持动态调整；")]),s._v(" "),a("li",[s._v("实现：修改 "),a("code",[s._v("@RedisLimit")]),s._v(" 注解，支持阈值从配置中心获取（如 "),a("code",[s._v('threshold = "${limiter.threshold.api.test:100}"')]),s._v("）。")])]),s._v(" "),a("h4",{attrs:{id:"_2-多租户限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-多租户限流"}},[s._v("#")]),s._v(" 2. 多租户限流")]),s._v(" "),a("ul",[a("li",[s._v("问题：多租户系统中，需为不同租户配置不同限流阈值；")]),s._v(" "),a("li",[s._v("解决方案：限流键中加入租户标识（如 "),a("code",[s._v("tenant:1001:api:test")]),s._v("），为每个租户配置独立阈值；")]),s._v(" "),a("li",[s._v("实现：通过 SpEL 表达式解析租户 ID（如 "),a("code",[s._v("key = \"'tenant:' + #tenantId + ':' + '/api/test'\"")]),s._v("）。")])]),s._v(" "),a("h4",{attrs:{id:"_3-流量染色与灰度限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-流量染色与灰度限流"}},[s._v("#")]),s._v(" 3. 流量染色与灰度限流")]),s._v(" "),a("ul",[a("li",[s._v("场景：新功能灰度发布时，需对灰度流量单独限流；")]),s._v(" "),a("li",[s._v("解决方案：通过流量染色（如请求头 "),a("code",[s._v("X-Gray-Traffic: true")]),s._v("），解析染色标识后使用独立限流键；")]),s._v(" "),a("li",[s._v("实现：在 "),a("code",[s._v("RedisLimitAspect")]),s._v(" 中解析请求头，拼接灰度标识到限流键。")])]),s._v(" "),a("h2",{attrs:{id:"五、生产环境踩坑指南-10-个致命坑点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、生产环境踩坑指南-10-个致命坑点"}},[s._v("#")]),s._v(" 五、生产环境踩坑指南（10 个致命坑点）")]),s._v(" "),a("h3",{attrs:{id:"_5-1-坑-1-限流键冲突"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-坑-1-限流键冲突"}},[s._v("#")]),s._v(" 5.1 坑 1：限流键冲突")]),s._v(" "),a("ul",[a("li",[s._v("现象：不同业务的限流键重复（如都用 "),a("code",[s._v("test")]),s._v("），导致计数混乱；")]),s._v(" "),a("li",[s._v("原因：未给限流键加业务前缀；")]),s._v(" "),a("li",[s._v("解决方案：统一用 "),a("code",[s._v("limiter:{algorithm}:{biz}:{key}")]),s._v(" 格式，如 "),a("code",[s._v("limiter:token:seckill:goods:10086")]),s._v("。")])]),s._v(" "),a("h3",{attrs:{id:"_5-2-坑-2-临界问题导致限流失效"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-坑-2-临界问题导致限流失效"}},[s._v("#")]),s._v(" 5.2 坑 2：临界问题导致限流失效")]),s._v(" "),a("ul",[a("li",[s._v("现象：固定窗口算法在窗口切换时出现“双倍流量”，突破阈值；")]),s._v(" "),a("li",[s._v("原因：固定窗口的天生缺陷；")]),s._v(" "),a("li",[s._v("解决方案：对核心场景改用滑动窗口/令牌桶算法，或在窗口切换时增加缓冲（如窗口重叠 100ms）。")])]),s._v(" "),a("h3",{attrs:{id:"_5-3-坑-3-lua-脚本超时"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-坑-3-lua-脚本超时"}},[s._v("#")]),s._v(" 5.3 坑 3：Lua 脚本超时")]),s._v(" "),a("ul",[a("li",[s._v("现象：高并发下 Lua 脚本执行超时，Redis 抛出 "),a("code",[s._v("BUSY")]),s._v(" 错误；")]),s._v(" "),a("li",[s._v("原因：脚本逻辑复杂（如循环、大量 "),a("code",[s._v("ZREMRANGEBYSCORE")]),s._v(" 操作）；")]),s._v(" "),a("li",[s._v("解决方案：简化 Lua 脚本逻辑，避免循环；对滑动窗口算法，合理拆分小窗口数量（如 1 秒拆 10 个）。")])]),s._v(" "),a("h3",{attrs:{id:"_5-4-坑-4-redis-大-key-问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-坑-4-redis-大-key-问题"}},[s._v("#")]),s._v(" 5.4 坑 4：Redis 大 Key 问题")]),s._v(" "),a("ul",[a("li",[s._v("现象：滑动窗口算法的 ZSET 存储过多请求时间戳（如每秒 1 万次请求，1 秒窗口存 1 万个元素），成为大 Key；")]),s._v(" "),a("li",[s._v("原因：窗口时长过长、请求量过大；")]),s._v(" "),a("li",[s._v("解决方案：缩短窗口时长、增加小窗口数量；定期清理 ZSET 中的过期元素；对高频请求启用本地缓存预热。")])]),s._v(" "),a("h3",{attrs:{id:"_5-5-坑-5-分布式场景下全局一致性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-坑-5-分布式场景下全局一致性问题"}},[s._v("#")]),s._v(" 5.5 坑 5：分布式场景下全局一致性问题")]),s._v(" "),a("ul",[a("li",[s._v("现象：Redis Cluster 分片后，同一限流键落在不同节点，总请求数突破阈值；")]),s._v(" "),a("li",[s._v("原因：限流键哈希分片错误，同一 "),a("code",[s._v("key")]),s._v(" 被分配到不同节点；")]),s._v(" "),a("li",[s._v("解决方案：确保限流键的哈希计算一致（如使用 Redis Cluster 原生哈希槽机制）；对全局限流（如全系统 1 秒 1 万次），使用 Redis 主从架构（单节点计数）。")])]),s._v(" "),a("h3",{attrs:{id:"_5-6-坑-6-本地缓存与-redis-数据不一致"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-坑-6-本地缓存与-redis-数据不一致"}},[s._v("#")]),s._v(" 5.6 坑 6：本地缓存与 Redis 数据不一致")]),s._v(" "),a("ul",[a("li",[s._v("现象：本地缓存了“已限流”状态，Redis 计数器已重置，但本地仍拒绝请求；")]),s._v(" "),a("li",[s._v("原因：本地缓存时长过长；")]),s._v(" "),a("li",[s._v("解决方案：本地缓存时长设为 Redis 窗口时长的 1/10（如 1 秒窗口缓存 100ms）；缓存过期时间采用随机值，避免缓存雪崩。")])]),s._v(" "),a("h3",{attrs:{id:"_5-7-坑-7-漏桶算法的-漏水-任务阻塞"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-7-坑-7-漏桶算法的-漏水-任务阻塞"}},[s._v("#")]),s._v(" 5.7 坑 7：漏桶算法的“漏水”任务阻塞")]),s._v(" "),a("ul",[a("li",[s._v("现象：漏桶算法的定时任务阻塞，导致请求堆积在桶中，无法处理；")]),s._v(" "),a("li",[s._v("原因：定时任务执行时间过长（如处理请求的业务逻辑耗时久）；")]),s._v(" "),a("li",[s._v("解决方案：将“漏水”逻辑与业务逻辑解耦，通过消息队列异步处理请求；定时任务仅负责弹出请求，不处理业务逻辑。")])]),s._v(" "),a("h3",{attrs:{id:"_5-8-坑-8-令牌桶算法的时间差计算误差"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-8-坑-8-令牌桶算法的时间差计算误差"}},[s._v("#")]),s._v(" 5.8 坑 8：令牌桶算法的时间差计算误差")]),s._v(" "),a("ul",[a("li",[s._v("现象：高并发下，令牌桶的令牌填充速率与预期不符；")]),s._v(" "),a("li",[s._v("原因：时间差计算采用毫秒级，高并发下多次请求的时间差过小，导致令牌填充不及时；")]),s._v(" "),a("li",[s._v("解决方案：改用微秒级时间戳；优化令牌填充逻辑，允许批量填充令牌（如一次填充多个）。")])]),s._v(" "),a("h3",{attrs:{id:"_5-9-坑-9-redis-连接池参数不合理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-9-坑-9-redis-连接池参数不合理"}},[s._v("#")]),s._v(" 5.9 坑 9：Redis 连接池参数不合理")]),s._v(" "),a("ul",[a("li",[s._v("现象：高并发下，出现 "),a("code",[s._v("Could not get a resource from the pool")]),s._v(" 错误；")]),s._v(" "),a("li",[s._v("原因：最大连接数设置过小，无法满足并发需求；")]),s._v(" "),a("li",[s._v("解决方案：通过压测确定合理的最大连接数（如每秒 10 万次请求，最大连接数设为 64）；监控连接池状态，动态调整参数。")])]),s._v(" "),a("h3",{attrs:{id:"_5-10-坑-10-未处理-redis-主从切换导致的限流数据丢失"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-10-坑-10-未处理-redis-主从切换导致的限流数据丢失"}},[s._v("#")]),s._v(" 5.10 坑 10：未处理 Redis 主从切换导致的限流数据丢失")]),s._v(" "),a("ul",[a("li",[s._v("现象：Redis 主从切换后，限流计数器/令牌桶状态丢失，导致限流失效；")]),s._v(" "),a("li",[s._v("原因：主从复制是异步的，切换时从库可能未同步最新的限流数据；")]),s._v(" "),a("li",[s._v("解决方案：开启 Redis 持久化（RDB+AOF）；主从切换后，对限流键进行初始化（如令牌桶重置为初始容量）；对核心场景，采用 Redis Cluster 避免单主节点依赖。")])]),s._v(" "),a("h2",{attrs:{id:"六、行业最佳实践总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、行业最佳实践总结"}},[s._v("#")]),s._v(" 六、行业最佳实践总结")]),s._v(" "),a("h3",{attrs:{id:"_6-1-算法选型最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-算法选型最佳实践"}},[s._v("#")]),s._v(" 6.1 算法选型最佳实践")]),s._v(" "),a("ul",[a("li",[s._v("普通接口、非核心业务：固定窗口计数器（简单、高性能）；")]),s._v(" "),a("li",[s._v("核心 API、商品详情页：滑动窗口计数器（精准、无临界问题）；")]),s._v(" "),a("li",[s._v("数据库写入、第三方 API 调用：漏桶算法（严格控制输出速率）；")]),s._v(" "),a("li",[s._v("秒杀、抢购、高并发核心业务：令牌桶算法（抗突发、流量平滑）。")])]),s._v(" "),a("h3",{attrs:{id:"_6-2-限流策略组合最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-限流策略组合最佳实践"}},[s._v("#")]),s._v(" 6.2 限流策略组合最佳实践")]),s._v(" "),a("ul",[a("li",[s._v("多层限流：网关层（Nginx）限流 + 应用层（Redis）限流 + 本地限流（降级），形成防护体系；")]),s._v(" "),a("li",[s._v("多粒度限流：商品粒度 + 用户粒度 + IP 粒度，多重防护（如秒杀场景）；")]),s._v(" "),a("li",[s._v("流量削峰：结合消息队列，将突发流量缓存到队列，异步处理，与限流配合使用。")])]),s._v(" "),a("h3",{attrs:{id:"_6-3-阈值调优最佳实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-阈值调优最佳实践"}},[s._v("#")]),s._v(" 6.3 阈值调优最佳实践")]),s._v(" "),a("ul",[a("li",[s._v("压测确定基准：通过压测获取服务的最大承载 QPS，阈值设为基准的 80%；")]),s._v(" "),a("li",[s._v("动态调整：根据流量波动（如促销、节假日）动态调整阈值；")]),s._v(" "),a("li",[s._v("预留缓冲：为核心业务预留 20%~30% 的缓冲阈值，避免突发流量压垮服务。")])]),s._v(" "),a("h2",{attrs:{id:"七、总结与展望"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、总结与展望"}},[s._v("#")]),s._v(" 七、总结与展望")]),s._v(" "),a("p",[s._v("Redis 限流的核心价值，在于用高性能、分布式的方式实现流量的精细化治理，而非简单“拒绝请求”。其设计哲学是“先保系统稳定，再谈用户体验”——通过科学的算法选择、架构设计和优化手段，在流量洪峰来临时，确保核心业务可用、非核心业务降级，最终实现系统的稳定性与用户体验的平衡。")])])}),[],!1,null,null,null);a.default=t.exports}}]);