(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{390:function(s,t,a){"use strict";a.r(t);var e=a(8),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("在 ClickHouse 中，建表是整个数据架构的基石，而分区键（PARTITION BY）、排序键（ORDER BY）、主键（PRIMARY KEY）的设计，直接决定了后续查询性能、存储效率和运维成本。很多初学者甚至资深开发者，都会在这三个“键”的选择上踩坑——比如把主键当唯一约束用、分区键粒度太细导致元数据爆炸、排序键设计不合理让查询全表扫描。")]),s._v(" "),t("h2",{attrs:{id:"一、先厘清-三个-键-的核心作用与本质区别"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、先厘清-三个-键-的核心作用与本质区别"}},[s._v("#")]),s._v(" 一、先厘清：三个“键”的核心作用与本质区别")]),s._v(" "),t("p",[s._v("首先要明确：ClickHouse 的分区键、排序键、主键，和 MySQL、PostgreSQL 等传统关系型数据库的概念完全不同，切勿直接套用经验。三者的核心定位和作用如下：")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("参数")]),s._v(" "),t("th",[s._v("核心作用")]),s._v(" "),t("th",[s._v("本质特征")]),s._v(" "),t("th",[s._v("关键影响")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("分区键（PARTITION BY）")]),s._v(" "),t("td",[s._v("数据分片存储，实现“分区裁剪”")]),s._v(" "),t("td",[s._v("逻辑上的数据集划分，按分区独立管理数据（可独立删除、TTL）")]),s._v(" "),t("td",[s._v("查询时能否快速过滤无效数据；元数据管理成本")])]),s._v(" "),t("tr",[t("td",[s._v("排序键（ORDER BY）")]),s._v(" "),t("td",[s._v("决定数据在磁盘上的物理存储顺序")]),s._v(" "),t("td",[s._v("数据按排序键有序存储，支撑稀疏索引和查询跳过")]),s._v(" "),t("td",[s._v("查询扫描范围大小；数据压缩率；合并（Merge）效率")])]),s._v(" "),t("tr",[t("td",[s._v("主键（PRIMARY KEY）")]),s._v(" "),t("td",[s._v("构建稀疏索引，快速定位数据块")]),s._v(" "),t("td",[s._v("默认是排序键的前缀（可自定义），非唯一约束，仅用于索引定位")]),s._v(" "),t("td",[s._v("数据定位速度；索引存储开销")])])])]),s._v(" "),t("p",[s._v("核心结论："),t("strong",[s._v("分区键负责“大范围数据过滤”，排序键负责“小范围数据有序与跳过”，主键是排序键的“索引入口”")]),s._v("。三者协同决定了查询性能的上限。")]),s._v(" "),t("h2",{attrs:{id:"二、分区键-粒度是关键-别太细也别太粗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、分区键-粒度是关键-别太细也别太粗"}},[s._v("#")]),s._v(" 二、分区键：粒度是关键，别太细也别太粗")]),s._v(" "),t("p",[s._v("分区键的核心价值是“分区裁剪”——查询时如果带上分区键条件，ClickHouse 会直接跳过不相关的分区，只扫描目标分区数据，大幅减少I/O开销。但分区键的粒度设计是重中之重，过细或过粗都会踩坑。")]),s._v(" "),t("h3",{attrs:{id:"_1-选择原则-按-时间-业务维度-组合-控制单分区大小"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-选择原则-按-时间-业务维度-组合-控制单分区大小"}},[s._v("#")]),s._v(" 1. 选择原则：按“时间+业务维度”组合，控制单分区大小")]),s._v(" "),t("p",[s._v("最通用、最安全的选择是 "),t("strong",[s._v("“时间字段为主，业务维度为辅”")]),s._v("，同时满足“单分区大小10-100GB”“分区数量不超过1000”两个核心指标（ClickHouse 对元数据的管理效率在1000个分区以内最优）。")]),s._v(" "),t("p",[s._v("常见选择优先级：")]),s._v(" "),t("ol",[t("li",[s._v("高频场景：按日期/月份分区（适用于日志、监控、行为等时间序列数据）\n示例："),t("code",[s._v("PARTITION BY toYYYYMMDD(event_time)")]),s._v("（按天）、"),t("code",[s._v("PARTITION BY toYYYYMM(event_time)")]),s._v("（按月）")]),s._v(" "),t("li",[s._v("低频场景：按业务维度+时间分区（适用于数据量较小的业务表）\n示例："),t("code",[s._v("PARTITION BY (business_line, toYYYYMM(event_time))")]),s._v("（业务线+月）")]),s._v(" "),t("li",[s._v("特殊场景：固定分区（适用于小表、配置表）\n示例："),t("code",[s._v("PARTITION BY 1")]),s._v("（所有数据在一个分区）")])]),s._v(" "),t("h3",{attrs:{id:"_2-避坑指南-这3个错误千万别犯"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-避坑指南-这3个错误千万别犯"}},[s._v("#")]),s._v(" 2. 避坑指南：这3个错误千万别犯")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("坑1：分区粒度太细（如按小时分区）")]),s._v("\n后果：如果数据量较大，会导致分区数量暴增（一天24个分区，一年8760个），元数据管理压力大，合并（Merge）线程忙不过来，查询时扫描大量小分区反而变慢。\n避坑：只有当单小时数据量达到10GB以上，且查询需要按小时过滤时，才考虑按小时分区；否则优先按天/月。")]),s._v(" "),t("li",[t("strong",[s._v("坑2：分区粒度太粗（如按年分区）")]),s._v("\n后果：单分区数据量过大（可能达TB级），查询时无法有效裁剪，相当于全表扫描；且删除过期数据时（如删除1年前数据），单分区删除耗时久，影响集群性能。\n避坑：单分区大小超过100GB时，必须细化粒度（比如从按年改为按月）。")]),s._v(" "),t("li",[t("strong",[s._v("坑3：用高频离散字段当分区键（如user_id、device_id）")]),s._v("\n后果：每个分区只有少量数据（甚至单行），分区数量爆炸，元数据崩溃，查询性能极差。\n避坑：绝对禁止用高频离散字段单独当分区键；若需按用户维度过滤，优先放在排序键中。")])]),s._v(" "),t("h3",{attrs:{id:"_3-实战案例-不同数据量的分区键选择"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-实战案例-不同数据量的分区键选择"}},[s._v("#")]),s._v(" 3. 实战案例：不同数据量的分区键选择")]),s._v(" "),t("ul",[t("li",[s._v("案例1：用户行为日志（日均100GB）\n选择："),t("code",[s._v("PARTITION BY toYYYYMMDD(event_time)")]),s._v("（按天分区，单分区100GB左右，一年365个分区，符合要求）")]),s._v(" "),t("li",[s._v("案例2：设备监控数据（日均5GB）\n选择："),t("code",[s._v("PARTITION BY toYYYYMM(event_time)")]),s._v("（按月分区，单分区150GB左右，一年12个分区，管理成本低）")]),s._v(" "),t("li",[s._v("案例3：业务配置表（总数据10MB）\n选择："),t("code",[s._v("PARTITION BY 1")]),s._v("（单分区，无需裁剪，简化管理）")])]),s._v(" "),t("h2",{attrs:{id:"三、排序键-查询导向设计-把-高频过滤字段-放前面"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、排序键-查询导向设计-把-高频过滤字段-放前面"}},[s._v("#")]),s._v(" 三、排序键：查询导向设计，把“高频过滤字段”放前面")]),s._v(" "),t("p",[s._v("排序键是 ClickHouse 性能优化的核心——数据按排序键物理有序存储，一方面能提升压缩率（有序数据压缩比更高），另一方面能支撑“稀疏索引跳过”：查询时通过排序键的索引标记，直接跳过不满足条件的数据块，减少扫描范围。")]),s._v(" "),t("p",[s._v("关键原则："),t("strong",[s._v("排序键的设计必须“以查询为导向”，把高频过滤、分组、排序字段放在前面")]),s._v("，且字段数量不宜过多（建议不超过4个，过多会降低索引效率）。")]),s._v(" "),t("h3",{attrs:{id:"_1-选择原则-高频字段优先-前缀匹配优先"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-选择原则-高频字段优先-前缀匹配优先"}},[s._v("#")]),s._v(" 1. 选择原则：高频字段优先，前缀匹配优先")]),s._v(" "),t("p",[s._v("ClickHouse 的查询优化器对排序键的“前缀匹配”支持最好，因此排序键的字段顺序优先级为：")]),s._v(" "),t("ol",[t("li",[s._v("第一优先级：查询中最常用的 "),t("code",[s._v("WHERE")]),s._v(" 过滤字段（如 user_id、order_id、status）")]),s._v(" "),t("li",[s._v("第二优先级：查询中常用的 "),t("code",[s._v("GROUP BY")]),s._v(" 分组字段（如 business_line、region）")]),s._v(" "),t("li",[s._v("第三优先级：查询中常用的 "),t("code",[s._v("ORDER BY")]),s._v(" 排序字段（如 event_time、amount）")])]),s._v(" "),t("p",[s._v("示例：某电商订单表，高频查询场景是“按用户ID查询订单”“按订单状态+时间统计”，排序键设计为：\n"),t("code",[s._v("ORDER BY (user_id, status, create_time)")])]),s._v(" "),t("h3",{attrs:{id:"_2-避坑指南-这4个误区要避开"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-避坑指南-这4个误区要避开"}},[s._v("#")]),s._v(" 2. 避坑指南：这4个误区要避开")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("坑1：排序键字段过多（如5个以上）")]),s._v("\n后果：稀疏索引的粒度变粗，跳过效率降低；同时增加数据合并时的排序开销，影响写入性能。\n避坑：只保留前3-4个高频字段，低频字段不放入排序键。")]),s._v(" "),t("li",[t("strong",[s._v("坑2：排序键与查询过滤字段不匹配")]),s._v("\n后果：查询无法利用排序键的跳过功能，只能全分区扫描，性能极差。\n示例：排序键是 "),t("code",[s._v("(create_time, user_id)")]),s._v("，但高频查询是 "),t("code",[s._v("WHERE user_id = 123")]),s._v("（非前缀字段），无法触发跳过。\n避坑：调整排序键顺序为 "),t("code",[s._v("(user_id, create_time)")]),s._v("，确保高频过滤字段在排序键前缀。")]),s._v(" "),t("li",[t("strong",[s._v("坑3：把低基数字段放前面")]),s._v("\n后果：低基数字段（如 status，只有“待支付”“已支付”等几个值）的区分度低，排序后数据分布集中，跳过效率差。\n避坑：高基数字段（如 user_id、order_id）优先放在排序键前面，低基数字段放后面。")]),s._v(" "),t("li",[t("strong",[s._v("坑4：忽略数据压缩率")]),s._v("\n后果：无序数据或低重复度数据的压缩比极低，增加存储成本。\n避坑：时间字段、枚举字段等重复度高的字段，可适当放在排序键中，提升压缩率（如 create_time 放在高基数字段之后）。")])]),s._v(" "),t("h3",{attrs:{id:"_3-实战案例-不同查询场景的排序键设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-实战案例-不同查询场景的排序键设计"}},[s._v("#")]),s._v(" 3. 实战案例：不同查询场景的排序键设计")]),s._v(" "),t("ul",[t("li",[s._v("场景1：用户行为日志（高频查询：按用户ID+日期过滤）\n排序键："),t("code",[s._v("ORDER BY (user_id, event_time)")]),s._v("（高基数user_id在前，时间字段在后，兼顾过滤和压缩）")]),s._v(" "),t("li",[s._v("场景2：商品销售统计（高频查询：按商品ID+销售日期分组）\n排序键："),t("code",[s._v("ORDER BY (product_id, sale_date)")]),s._v("（商品ID过滤，销售日期分组，匹配查询逻辑）")]),s._v(" "),t("li",[s._v("场景3：实时监控指标（高频查询：按指标类型+时间排序）\n排序键："),t("code",[s._v("ORDER BY (metric_type, collect_time)")]),s._v("（指标类型过滤，时间排序，提升查询跳过效率）")])]),s._v(" "),t("h2",{attrs:{id:"四、主键-默认前缀即可-别当-唯一约束-用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#四、主键-默认前缀即可-别当-唯一约束-用"}},[s._v("#")]),s._v(" 四、主键：默认前缀即可，别当“唯一约束”用")]),s._v(" "),t("p",[s._v("ClickHouse 的主键和传统数据库的主键完全不同——它不具备“唯一约束”功能，仅用于构建“稀疏索引”，帮助快速定位数据块。默认情况下，主键是排序键的前缀（如果不指定主键，主键=排序键）。")]),s._v(" "),t("h3",{attrs:{id:"_1-选择原则-简化优先-复用排序键前缀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-选择原则-简化优先-复用排序键前缀"}},[s._v("#")]),s._v(" 1. 选择原则：简化优先，复用排序键前缀")]),s._v(" "),t("p",[s._v("大多数场景下，"),t("strong",[s._v("无需手动指定主键")]),s._v("，直接使用默认值（主键=排序键）即可。只有当排序键字段较多，且高频查询仅依赖前1-2个字段时，才需要手动指定主键（取排序键的前缀），减少索引存储开销。")]),s._v(" "),t("p",[s._v("示例：排序键是 "),t("code",[s._v("(user_id, status, create_time)")]),s._v("，高频查询仅依赖 "),t("code",[s._v("user_id")]),s._v(" 过滤，可手动指定主键：\n"),t("code",[s._v("PRIMARY KEY (user_id)")])]),s._v(" "),t("h3",{attrs:{id:"_2-避坑指南-这2个错误最致命"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-避坑指南-这2个错误最致命"}},[s._v("#")]),s._v(" 2. 避坑指南：这2个错误最致命")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("坑1：把主键当唯一约束用")]),s._v("\n后果：ClickHouse 不会检查主键的唯一性，插入重复主键的数据会直接存储，导致数据不一致。\n避坑：如果需要去重，应使用 "),t("code",[s._v("ReplacingMergeTree")]),s._v(" 引擎，通过排序键+版本列实现去重，而非依赖主键。")]),s._v(" "),t("li",[t("strong",[s._v("坑2：主键不是排序键的前缀")]),s._v("\n后果：ClickHouse 不支持主键非排序键前缀的设计，建表会直接报错。\n避坑：主键必须是排序键的子集且为前缀，例如排序键是 "),t("code",[s._v("(a,b,c)")]),s._v("，主键可设为 "),t("code",[s._v("(a)")]),s._v(" 或 "),t("code",[s._v("(a,b)")]),s._v("，但不能是 "),t("code",[s._v("(b,c)")]),s._v(" 或 "),t("code",[s._v("(a,c)")]),s._v("。")])]),s._v(" "),t("h2",{attrs:{id:"五、三者协同设计-实战建表案例拆解"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#五、三者协同设计-实战建表案例拆解"}},[s._v("#")]),s._v(" 五、三者协同设计：实战建表案例拆解")]),s._v(" "),t("p",[s._v("前面讲了单个键的选择，实际建表时需要三者协同。下面以“电商订单表”和“用户行为日志表”两个典型场景，完整拆解建表语句和设计思路。")]),s._v(" "),t("h3",{attrs:{id:"_1-场景1-电商订单表-mergetree-引擎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-场景1-电商订单表-mergetree-引擎"}},[s._v("#")]),s._v(" 1. 场景1：电商订单表（MergeTree 引擎）")]),s._v(" "),t("p",[s._v("核心需求：")]),s._v(" "),t("ul",[t("li",[s._v("数据量：日均50GB，按天分区单分区50GB（符合10-100GB要求）")]),s._v(" "),t("li",[s._v("高频查询：按用户ID查订单、按订单状态+日期统计、按订单ID查详情")]),s._v(" "),t("li",[s._v("运维需求：保留1年数据，按月删除过期分区")])]),s._v(" "),t("p",[s._v("建表语句：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" order_table "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  order_id UInt64 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'订单ID'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  user_id UInt64 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'用户ID'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v(" Enum8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pending'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'paid'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'shipped'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'completed'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'cancelled'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'订单状态'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  amount Float64 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'订单金额'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  create_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DateTime")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'创建时间'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  pay_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DateTime")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'支付时间'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  province String "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'省份'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" MergeTree"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PARTITION")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" toYYYYMMDD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("create_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 按天分区（单分区50GB，一年365个分区）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" create_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" order_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 排序键：高频过滤字段在前")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 主键取排序键前缀，减少索引开销")]),s._v("\nTTL create_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTERVAL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("365")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DAY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DELETE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 数据保留1年")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("设计思路：")]),s._v(" "),t("ul",[t("li",[s._v("分区键：按天分区，匹配订单数据的时间特性，便于按日期裁剪和删除过期数据；")]),s._v(" "),t("li",[s._v("排序键：user_id（高频过滤）→ status（高频统计）→ create_time（时间排序）→ order_id（唯一标识），完全匹配查询场景；")]),s._v(" "),t("li",[s._v("主键：仅保留user_id（高频过滤字段），减少稀疏索引的存储开销。")])]),s._v(" "),t("h3",{attrs:{id:"_2-场景2-用户行为日志表-replicatedmergetree-引擎-高可用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-场景2-用户行为日志表-replicatedmergetree-引擎-高可用"}},[s._v("#")]),s._v(" 2. 场景2：用户行为日志表（ReplicatedMergeTree 引擎，高可用）")]),s._v(" "),t("p",[s._v("核心需求：")]),s._v(" "),t("ul",[t("li",[s._v("数据量：日均100GB，按天分区单分区100GB；")]),s._v(" "),t("li",[s._v("高频查询：按用户ID+行为类型+日期过滤，统计用户行为次数；")]),s._v(" "),t("li",[s._v("运维需求：高可用（副本），保留90天数据。")])]),s._v(" "),t("p",[s._v("建表语句：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" user_behavior_log "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  user_id UInt64 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'用户ID'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  behavior_type Enum8"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'click'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'view'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'purchase'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'share'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'行为类型'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  event_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DateTime")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'行为时间'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  page String "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'页面'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  device_id String "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COMMENT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'设备ID'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ReplicatedMergeTree"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/clickhouse/tables/{shard}/user_behavior_log'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- ZooKeeper路径")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{replica}'")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 副本标识")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PARTITION")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" toYYYYMMDD"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("event_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 按天分区（单分区100GB，符合要求）")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user_id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" behavior_type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" event_time"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 排序键：匹配高频查询过滤逻辑")]),s._v("\nTTL event_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTERVAL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DAY")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DELETE")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 数据保留90天")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("设计思路：")]),s._v(" "),t("ul",[t("li",[s._v("分区键：按天分区，适配日志数据的时间序列特性，便于快速裁剪；")]),s._v(" "),t("li",[s._v("排序键：user_id（高频过滤）→ behavior_type（统计维度）→ event_time（时间排序），完全匹配查询场景，同时提升数据压缩率；")]),s._v(" "),t("li",[s._v("主键：使用默认值（=排序键），无需额外优化，简化配置；")]),s._v(" "),t("li",[s._v("引擎：ReplicatedMergeTree 保障高可用，适配生产环境需求。")])]),s._v(" "),t("h2",{attrs:{id:"六、总结-建表避坑核心口诀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#六、总结-建表避坑核心口诀"}},[s._v("#")]),s._v(" 六、总结：建表避坑核心口诀")]),s._v(" "),t("p",[s._v("最后用几句口诀总结核心要点，帮你快速记忆：")]),s._v(" "),t("ol",[t("li",[s._v("分区键：时间为主，粒度适中，10-100GB/区，分区数不超千；")]),s._v(" "),t("li",[s._v("排序键：查询导向，高频在前，前缀匹配，字段不超四；")]),s._v(" "),t("li",[s._v("主键：默认前缀，无需冗余，不做唯一，简化优先；")]),s._v(" "),t("li",[s._v("三协同：分区裁剪定范围，排序跳过缩粒度，主键索引提速度。")])]),s._v(" "),t("p",[s._v("其实 ClickHouse 建表的核心逻辑很简单——"),t("strong",[s._v("所有设计都围绕“减少查询扫描范围”展开")]),s._v("。只要记住“以查询为导向”，结合数据量和业务场景，就能避开大部分坑。如果建表后发现查询性能差，优先检查这三个键的设计，往往能事半功倍。")])])}),[],!1,null,null,null);t.default=n.exports}}]);