(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{421:function(s,a,n){"use strict";n.r(a);var e=n(8),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("在分布式系统开发中，我们经常会遇到需要「延时处理」的业务场景：")]),s._v(" "),a("ul",[a("li",[s._v("电商订单创建后，若15分钟内未支付则自动取消")]),s._v(" "),a("li",[s._v("外卖订单超时未接单，自动推送给其他骑手")]),s._v(" "),a("li",[s._v("会员到期前3天，发送续费提醒")]),s._v(" "),a("li",[s._v("任务失败后，间隔10分钟、30分钟、1小时自动重试")])]),s._v(" "),a("p",[s._v("传统实现方案多采用「定时任务轮询数据库」，但这种方式存在明显缺陷：")]),s._v(" "),a("ul",[a("li",[s._v("资源浪费：即使只需10分钟延时，也可能需要每分钟轮询一次，产生大量无效查询")]),s._v(" "),a("li",[s._v("精度不足：轮询间隔决定了最小延时单位，无法实现秒级精度")]),s._v(" "),a("li",[s._v("分布式复杂：多实例部署时需引入分布式锁避免重复执行，增加系统复杂度")])]),s._v(" "),a("p",[s._v("RabbitMQ提供了更优雅的延时消息解决方案，具备「解耦、高可靠、高精度」的特点。")]),s._v(" "),a("h2",{attrs:{id:"一、核心概念-死信与死信交换机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、核心概念-死信与死信交换机"}},[s._v("#")]),s._v(" 一、核心概念：死信与死信交换机")]),s._v(" "),a("p",[s._v("在了解RabbitMQ延时消息前，需先掌握「死信」和「死信交换机」的核心概念。")]),s._v(" "),a("h3",{attrs:{id:"_1-1-什么是死信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是死信"}},[s._v("#")]),s._v(" 1.1 什么是死信？")]),s._v(" "),a("p",[s._v("死信（Dead Letter）指无法被正常消费的消息。当消息满足以下三种情况之一时，会被RabbitMQ标记为死信：")]),s._v(" "),a("ol",[a("li",[a("p",[a("strong",[s._v("消息被消费者拒绝")]),a("br"),s._v("\n消费者通过"),a("code",[s._v("basicReject")]),s._v("或"),a("code",[s._v("basicNack")]),s._v("方法拒绝消费消息，且未设置"),a("code",[s._v("requeue=false")]),s._v("（不重新入队）。"),a("br"),s._v(" "),a("em",[s._v("例：订单处理时发现参数错误，拒绝消费并标记为死信，后续人工排查")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("消息TTL过期")]),a("br"),s._v("\nTTL（Time To Live）即消息存活时间，若消息在队列中超过设定时间仍未被消费，则变为死信。"),a("br"),s._v(" "),a("em",[s._v("例：设置TTL=15分钟的订单消息，15分钟未支付则触发取消逻辑")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("队列达到最大长度")]),a("br"),s._v("\n队列配置了"),a("code",[s._v("x-max-length")]),s._v("（最大消息数），当消息堆积超过上限时，新消息会挤掉旧消息（或直接成为死信，取决于配置）。"),a("br"),s._v(" "),a("em",[s._v("例：秒杀场景下，队列最多存储1000条消息，超出的消息直接进入死信队列等待降级处理")])])])]),s._v(" "),a("h3",{attrs:{id:"_1-2-什么是死信交换机"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-什么是死信交换机"}},[s._v("#")]),s._v(" 1.2 什么是死信交换机？")]),s._v(" "),a("p",[s._v("死信交换机（Dead Letter Exchange，DLX）是一种特殊的交换机，专门用于接收死信消息，并将其路由到指定的「死信队列」中。")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("本质")]),s._v("：一种兜底机制，避免死信消息丢失，同时隔离异常数据便于排查")]),s._v(" "),a("li",[a("strong",[s._v("工作流程")]),s._v("：普通队列 → 产生死信 → 死信交换机 → 死信队列 → 死信消费者")])]),s._v(" "),a("h2",{attrs:{id:"二、方案一-消息ttl-死信队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、方案一-消息ttl-死信队列"}},[s._v("#")]),s._v(" 二、方案一：消息TTL + 死信队列")]),s._v(" "),a("p",[s._v("利用「消息TTL过期后成为死信」的特性，结合死信交换机实现延时消息，是RabbitMQ最经典的延时方案。")]),s._v(" "),a("h3",{attrs:{id:"_2-1-核心原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-核心原理"}},[s._v("#")]),s._v(" 2.1 核心原理")]),s._v(" "),a("ol",[a("li",[s._v("声明一个「延时队列」（无消费者监听），并配置其绑定的死信交换机和路由键")]),s._v(" "),a("li",[s._v("生产者发送消息到延时队列，并设置消息TTL（延时时间）")]),s._v(" "),a("li",[s._v("消息在延时队列中等待TTL过期，自动成为死信")]),s._v(" "),a("li",[s._v("死信被投递到配置的死信交换机，再路由到死信队列")]),s._v(" "),a("li",[s._v("消费者监听死信队列，触发延时任务")])]),s._v(" "),a("p",[a("em",[s._v("关键：延时队列仅用于存储消息等待过期，真正执行逻辑的是死信队列的消费者")])]),s._v(" "),a("h3",{attrs:{id:"_2-2-完整实现步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-完整实现步骤"}},[s._v("#")]),s._v(" 2.2 完整实现步骤")]),s._v(" "),a("h4",{attrs:{id:"步骤1-声明组件-以spring-amqp为例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤1-声明组件-以spring-amqp为例"}},[s._v("#")]),s._v(" 步骤1：声明组件（以Spring AMQP为例）")]),s._v(" "),a("p",[s._v("需声明4个核心组件：普通交换机、延时队列、死信交换机、死信队列。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Configuration\npublic class TtlDlxConfig {\n\n    // 1. 普通交换机（用于发送消息到延时队列）\n    @Bean\n    public DirectExchange normalExchange() {\n        return new DirectExchange("normal.exchange");\n    }\n\n    // 2. 延时队列（无消费者，仅用于存储消息等待TTL过期）\n    @Bean\n    public Queue delayQueue() {\n        Map<String, Object> args = new HashMap<>();\n        // 配置死信交换机\n        args.put("x-dead-letter-exchange", "dlx.exchange");\n        // 配置死信路由键（需与死信队列绑定键一致）\n        args.put("x-dead-letter-routing-key", "dlx.key");\n        // 可选：设置队列最大长度（超出则新消息成为死信）\n        // args.put("x-max-length", 1000);\n        return QueueBuilder.durable("delay.queue")\n                .withArguments(args)\n                .build();\n    }\n\n    // 3. 绑定：普通交换机 → 延时队列\n    @Bean\n    public Binding delayBinding() {\n        return BindingBuilder.bind(delayQueue())\n                .to(normalExchange())\n                .with("delay.key");\n    }\n\n    // 4. 死信交换机\n    @Bean\n    public DirectExchange dlxExchange() {\n        return new DirectExchange("dlx.exchange");\n    }\n\n    // 5. 死信队列（消费者监听此队列）\n    @Bean\n    public Queue dlxQueue() {\n        return QueueBuilder.durable("dlx.queue").build();\n    }\n\n    // 6. 绑定：死信交换机 → 死信队列\n    @Bean\n    public Binding dlxBinding() {\n        return BindingBuilder.bind(dlxQueue())\n                .to(dlxExchange())\n                .with("dlx.key"); // 与延时队列配置的死信路由键一致\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br")])]),a("h4",{attrs:{id:"步骤2-发送延时消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤2-发送延时消息"}},[s._v("#")]),s._v(" 步骤2：发送延时消息")]),s._v(" "),a("p",[s._v("通过"),a("code",[s._v("setExpiration")]),s._v("设置消息TTL（单位：毫秒）：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Service\npublic class DelayMessageService {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    /**\n     * 发送延时消息\n     * @param content 消息内容\n     * @param delayMillis 延时时间（毫秒）\n     */\n    public void sendDelayMsg(String content, long delayMillis) {\n        Message message = MessageBuilder\n                .withBody(content.getBytes(StandardCharsets.UTF_8))\n                .setExpiration(String.valueOf(delayMillis)) // 设置TTL\n                .build();\n        // 发送到普通交换机，路由到延时队列\n        rabbitTemplate.convertAndSend("normal.exchange", "delay.key", message);\n        log.info("延时消息发送成功，内容：{}，延时：{}ms", content, delayMillis);\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h4",{attrs:{id:"步骤3-消费死信队列消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤3-消费死信队列消息"}},[s._v("#")]),s._v(" 步骤3：消费死信队列消息")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Component\npublic class DlxConsumer {\n\n    @RabbitListener(queues = "dlx.queue")\n    public void handleDlxMsg(String content) {\n        log.info("收到延时消息，执行逻辑：{}", content);\n        // 此处执行延时任务（如取消订单、发送提醒等）\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"_2-3-存在的问题-队列阻塞"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-存在的问题-队列阻塞"}},[s._v("#")]),s._v(" 2.3 存在的问题：队列阻塞")]),s._v(" "),a("p",[a("strong",[s._v("核心缺陷")]),s._v("：延时队列的FIFO（先进先出）特性会导致消息阻塞。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("场景举例："),a("br"),s._v("\n第一条消息设置TTL=30秒，第二条消息设置TTL=1秒。"),a("br"),s._v("\n由于队列按顺序存储，第一条消息未过期前，第二条消息即使已过期也无法被处理，必须等待第一条消息过期后才会被检测并投递到死信队列。")])]),s._v(" "),a("li",[a("p",[s._v("结论："),a("br"),s._v("\n此方案仅适用于「所有消息延时时间相同」的场景（如固定15分钟后取消订单），若需处理不同延时时间的消息，会导致精度问题。")])])]),s._v(" "),a("h2",{attrs:{id:"三、方案二-延时消息插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、方案二-延时消息插件"}},[s._v("#")]),s._v(" 三、方案二：延时消息插件")]),s._v(" "),a("p",[s._v("为解决TTL队列的阻塞问题，RabbitMQ提供了第三方插件"),a("code",[s._v("rabbitmq_delayed_message_exchange")]),s._v("，实现更灵活的延时消息。")]),s._v(" "),a("h3",{attrs:{id:"_3-1-插件介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-插件介绍"}},[s._v("#")]),s._v(" 3.1 插件介绍")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("本质")]),s._v("：一种特殊的交换机，接收消息后不会立即转发，而是根据消息的"),a("code",[s._v("x-delay")]),s._v("头信息，在指定时间后再转发到目标队列。")]),s._v(" "),a("li",[a("strong",[s._v("优势")]),s._v("：消息按延时时间排序，到点即转发，无阻塞问题，支持不同延时时间的消息。")]),s._v(" "),a("li",[a("strong",[s._v("安装方法")]),s._v("：\n"),a("ol",[a("li",[s._v("下载插件（需与RabbitMQ版本匹配）："),a("a",{attrs:{href:"https://www.rabbitmq.com/community-plugins.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网下载"),a("OutboundLink")],1)]),s._v(" "),a("li",[s._v("放入RabbitMQ的"),a("code",[s._v("plugins")]),s._v("目录")]),s._v(" "),a("li",[s._v("启用插件："),a("code",[s._v("rabbitmq-plugins enable rabbitmq_delayed_message_exchange")])]),s._v(" "),a("li",[s._v("重启RabbitMQ生效")])])])]),s._v(" "),a("h3",{attrs:{id:"_3-2-核心原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-核心原理"}},[s._v("#")]),s._v(" 3.2 核心原理")]),s._v(" "),a("ol",[a("li",[s._v("声明一个「延时交换机」（类型为"),a("code",[s._v("x-delayed-message")]),s._v("）")]),s._v(" "),a("li",[s._v("生产者发送消息时，通过"),a("code",[s._v("x-delay")]),s._v("头设置延时时间（毫秒）")]),s._v(" "),a("li",[s._v("延时交换机接收消息后，暂存消息并倒计时")]),s._v(" "),a("li",[s._v("延时时间到后，交换机将消息转发到绑定的目标队列")]),s._v(" "),a("li",[s._v("消费者监听目标队列，触发延时任务")])]),s._v(" "),a("h3",{attrs:{id:"_3-3-完整实现步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-完整实现步骤"}},[s._v("#")]),s._v(" 3.3 完整实现步骤")]),s._v(" "),a("h4",{attrs:{id:"步骤1-声明组件-以spring-amqp为例-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤1-声明组件-以spring-amqp为例-2"}},[s._v("#")]),s._v(" 步骤1：声明组件（以Spring AMQP为例）")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Configuration\npublic class DelayedPluginConfig {\n\n    // 1. 延时交换机（类型为x-delayed-message）\n    @Bean\n    public CustomExchange delayedExchange() {\n        Map<String, Object> args = new HashMap<>();\n        args.put("x-delayed-type", "direct"); // 指定交换机的路由类型（如direct、topic）\n        // 构造函数参数：交换机名称、类型、持久化、自动删除、参数\n        return new CustomExchange("delayed.exchange", "x-delayed-message", true, false, args);\n    }\n\n    // 2. 目标队列（消费者监听此队列）\n    @Bean\n    public Queue targetQueue() {\n        return QueueBuilder.durable("target.queue").build();\n    }\n\n    // 3. 绑定：延时交换机 → 目标队列\n    @Bean\n    public Binding delayedBinding() {\n        return BindingBuilder.bind(targetQueue())\n                .to(delayedExchange())\n                .with("delayed.key")\n                .noargs();\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h4",{attrs:{id:"步骤2-发送延时消息-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤2-发送延时消息-2"}},[s._v("#")]),s._v(" 步骤2：发送延时消息")]),s._v(" "),a("p",[s._v("通过"),a("code",[s._v("MessagePostProcessor")]),s._v("设置"),a("code",[s._v("x-delay")]),s._v("头：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Service\npublic class DelayedPluginService {\n\n    @Autowired\n    private RabbitTemplate rabbitTemplate;\n\n    /**\n     * 发送延时消息（基于插件）\n     * @param content 消息内容\n     * @param delayMillis 延时时间（毫秒）\n     */\n    public void sendDelayedMsg(String content, long delayMillis) {\n        rabbitTemplate.convertAndSend(\n                "delayed.exchange", \n                "delayed.key", \n                content, \n                new MessagePostProcessor() {\n                    @Override\n                    public Message postProcessMessage(Message message) {\n                        // 设置延时时间（x-delay头）\n                        message.getMessageProperties().setDelay((int) delayMillis);\n                        return message;\n                    }\n                }\n        );\n        log.info("插件延时消息发送成功，内容：{}，延时：{}ms", content, delayMillis);\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("h4",{attrs:{id:"步骤3-消费目标队列消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤3-消费目标队列消息"}},[s._v("#")]),s._v(" 步骤3：消费目标队列消息")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('@Component\npublic class TargetConsumer {\n\n    @RabbitListener(queues = "target.queue")\n    public void handleDelayedMsg(String content) {\n        log.info("收到插件延时消息，执行逻辑：{}", content);\n        // 此处执行延时任务\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"_3-4-优缺点分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-优缺点分析"}},[s._v("#")]),s._v(" 3.4 优缺点分析")]),s._v(" "),a("ul",[a("li",[a("p",[a("strong",[s._v("优点")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("支持不同延时时间的消息，无队列阻塞问题")]),s._v(" "),a("li",[s._v("延时精度高（依赖RabbitMQ节点时间，误差较小）")]),s._v(" "),a("li",[s._v("实现简单，无需配置死信相关组件")])])]),s._v(" "),a("li",[a("p",[a("strong",[s._v("缺点")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("消息持久化风险：延时期间消息存储在交换机中，未写入磁盘。若RabbitMQ节点宕机，未转发的消息会丢失（即使消息标记为持久化）。")]),s._v(" "),a("li",[s._v("依赖第三方插件：需额外安装和维护插件，增加部署复杂度。")])])])]),s._v(" "),a("h2",{attrs:{id:"四、方案对比与选型建议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、方案对比与选型建议"}},[s._v("#")]),s._v(" 四、方案对比与选型建议")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("特性")]),s._v(" "),a("th",[s._v("消息TTL + 死信队列")]),s._v(" "),a("th",[s._v("延时消息插件")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("适用场景")]),s._v(" "),a("td",[s._v("固定延时时间（如统一15分钟过期）")]),s._v(" "),a("td",[s._v("动态延时时间（如10s、30s、1h）")])]),s._v(" "),a("tr",[a("td",[s._v("阻塞问题")]),s._v(" "),a("td",[s._v("存在（FIFO特性导致）")]),s._v(" "),a("td",[s._v("无（按延时时间排序）")])]),s._v(" "),a("tr",[a("td",[s._v("消息可靠性")]),s._v(" "),a("td",[s._v("高（消息存储在队列，支持持久化）")]),s._v(" "),a("td",[s._v("中（延时期间存在内存，宕机丢失）")])]),s._v(" "),a("tr",[a("td",[s._v("部署复杂度")]),s._v(" "),a("td",[s._v("低（无需额外插件）")]),s._v(" "),a("td",[s._v("中（需安装插件）")])]),s._v(" "),a("tr",[a("td",[s._v("延时精度")]),s._v(" "),a("td",[s._v("低（受前序消息影响）")]),s._v(" "),a("td",[s._v("高（独立计时）")])])])]),s._v(" "),a("p",[a("strong",[s._v("选型建议")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("若业务场景中所有消息延时时间固定（如订单统一15分钟过期），优先选择「消息TTL+死信队列」，可靠性更高。")]),s._v(" "),a("li",[s._v("若需要处理动态延时时间（如不同任务不同重试间隔），且能接受轻微的可靠性风险，选择「延时消息插件」。")]),s._v(" "),a("li",[s._v("对消息可靠性要求极高的场景（如金融交易），可结合两者设计兜底方案（如插件+定时任务补偿）。")])]),s._v(" "),a("h2",{attrs:{id:"五、总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、总结"}},[s._v("#")]),s._v(" 五、总结")]),s._v(" "),a("p",[s._v("RabbitMQ通过「消息TTL+死信队列」和「延时消息插件」两种方案实现延时消息，解决了传统定时任务的资源浪费和精度问题。实际开发中需根据业务场景的「延时多样性」「可靠性要求」「部署复杂度」选择合适方案，同时注意规避队列阻塞、消息丢失等风险，确保延时任务稳定执行。")])])}),[],!1,null,null,null);a.default=t.exports}}]);