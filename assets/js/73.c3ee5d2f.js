(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{430:function(s,e,n){"use strict";n.r(e);var a=n(8),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("Redis 中的"),e("strong",[s._v("大 Key")]),s._v(" 和 "),e("strong",[s._v("热 Key")]),s._v(" 是高并发/大规模场景下的两大核心性能瓶颈，前者因“数据体积过大”导致内存、网络、操作阻塞问题，后者因“访问频率过高”引发单节点过载、服务不可用风险。两者可能单独出现，也可能叠加（如一个大 Key 同时是热 Key，危害呈指数级放大）。")]),s._v(" "),e("h2",{attrs:{id:"一、核心概念与本质区别"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、核心概念与本质区别"}},[s._v("#")]),s._v(" 一、核心概念与本质区别")]),s._v(" "),e("p",[s._v("先明确两者的核心差异，避免混淆：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("维度")]),s._v(" "),e("th",[s._v("大 Key（Big Key）")]),s._v(" "),e("th",[s._v("热 Key（Hot Key）")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("核心特征")]),s._v(" "),e("td",[s._v("数据体积/元素数量大（占用内存多）")]),s._v(" "),e("td",[s._v("访问频率极高（QPS 远高于普通 Key）")])]),s._v(" "),e("tr",[e("td",[s._v("判定标准")]),s._v(" "),e("td",[s._v("String：>10KB；Hash/ZSet/List：元素数>1000个")]),s._v(" "),e("td",[s._v("单 Key QPS > 1000（或占节点总 QPS 10% 以上）")])]),s._v(" "),e("tr",[e("td",[s._v("核心危害")]),s._v(" "),e("td",[s._v("内存倾斜、操作阻塞、传输缓慢")]),s._v(" "),e("td",[s._v("单节点过载、网卡打满、缓存击穿/雪崩")])]),s._v(" "),e("tr",[e("td",[s._v("影响范围")]),s._v(" "),e("td",[s._v("主要影响 Redis 存储/操作性能")]),s._v(" "),e("td",[s._v("主要影响 Redis 访问/网络性能")])]),s._v(" "),e("tr",[e("td",[s._v("典型场景")]),s._v(" "),e("td",[s._v("存储全量商品列表、用户全量订单、大文本内容")]),s._v(" "),e("td",[s._v("秒杀商品、首页热门数据、高频查询的配置 Key")])])])]),s._v(" "),e("h2",{attrs:{id:"二、大-key-问题深度解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、大-key-问题深度解析"}},[s._v("#")]),s._v(" 二、大 Key 问题深度解析")]),s._v(" "),e("h3",{attrs:{id:"_2-1-什么是大-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-什么是大-key"}},[s._v("#")]),s._v(" 2.1 什么是大 Key？")]),s._v(" "),e("p",[s._v("大 Key 不是指“Key 名称长”，而是指 "),e("strong",[s._v("Key 对应的 Value 数据体积过大，或集合类型（Hash/ZSet/List/Set）的元素数量过多")]),s._v("。行业通用判定阈值（可根据业务调整）：")]),s._v(" "),e("ul",[e("li",[s._v("String 类型：Value 大小 ≥ 10KB（核心业务建议 ≤ 5KB）；")]),s._v(" "),e("li",[s._v("集合类型：\n"),e("ul",[e("li",[s._v("Hash/ZSet/Set：元素数量 ≥ 1000 个（核心业务 ≤ 500 个）；")]),s._v(" "),e("li",[s._v("List：元素数量 ≥ 5000 个（或列表长度 ≥ 1000）。")])])])]),s._v(" "),e("p",[s._v("⚠️ 注意：即使单 Key 内存不大（如 5KB），但如果是百万级数量的此类 Key，也会累计成“大内存占用”，但不属于本文讨论的“大 Key”（属于“内存膨胀”问题）。")]),s._v(" "),e("h3",{attrs:{id:"_2-2-大-key-的核心危害-底层原理-业务影响"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-大-key-的核心危害-底层原理-业务影响"}},[s._v("#")]),s._v(" 2.2 大 Key 的核心危害（底层原理+业务影响）")]),s._v(" "),e("p",[s._v("Redis 是单线程事件循环模型，大 Key 操作会阻塞主线程，引发一系列连锁反应：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("危害类型")]),s._v(" "),e("th",[s._v("底层原理")]),s._v(" "),e("th",[s._v("业务影响示例")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("内存分布不均（集群倾斜）")]),s._v(" "),e("td",[s._v("大 Key 集中在某一节点，导致集群节点内存使用率差异＞50%，触发内存淘汰/宕机")]),s._v(" "),e("td",[s._v("节点 A 内存 90%，节点 B 内存 30%")])]),s._v(" "),e("tr",[e("td",[s._v("操作阻塞（DEL/EXPIRE）")]),s._v(" "),e("td",[s._v("单线程执行 DEL 大 Key 时，需遍历释放所有内存，阻塞毫秒级→秒级，期间无法处理其他请求")]),s._v(" "),e("td",[s._v("服务响应超时、接口 500 报错")])]),s._v(" "),e("tr",[e("td",[s._v("网络传输缓慢")]),s._v(" "),e("td",[s._v("大 Key 序列化/反序列化、网络传输耗时久，占用带宽")]),s._v(" "),e("td",[s._v("客户端读取超时、Redis 网卡瓶颈")])]),s._v(" "),e("tr",[e("td",[s._v("主从复制卡顿")]),s._v(" "),e("td",[s._v("大 Key 同步时占用大量网络/CPU，导致主从延迟＞秒级，数据一致性风险")]),s._v(" "),e("td",[s._v("从库数据滞后，故障切换时丢数据")])]),s._v(" "),e("tr",[e("td",[s._v("RDB/AOF 性能下降")]),s._v(" "),e("td",[s._v("Fork 子进程时，大 Key 拷贝耗时久；AOF 写入时，大 Key 操作日志体积大")]),s._v(" "),e("td",[s._v("备份耗时翻倍、AOF 文件膨胀")])]),s._v(" "),e("tr",[e("td",[s._v("扩容/迁移失败")]),s._v(" "),e("td",[s._v("集群扩容时，大 Key 迁移耗时超阈值，触发迁移超时/失败")]),s._v(" "),e("td",[s._v("集群扩容中断、服务不可用")])])])]),s._v(" "),e("h3",{attrs:{id:"_2-3-大-key-的识别方法-实战命令-工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-大-key-的识别方法-实战命令-工具"}},[s._v("#")]),s._v(" 2.3 大 Key 的识别方法（实战命令+工具）")]),s._v(" "),e("h4",{attrs:{id:"方法1-redis-原生命令-基础排查"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法1-redis-原生命令-基础排查"}},[s._v("#")]),s._v(" 方法1：Redis 原生命令（基础排查）")]),s._v(" "),e("h5",{attrs:{id:"_1-扫描大-key-redis-cli-bigkeys"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-扫描大-key-redis-cli-bigkeys"}},[s._v("#")]),s._v(" （1）扫描大 Key（redis-cli --bigkeys）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# 扫描所有 Key，统计各类型大 Key，输出汇总（耗时久，生产建议低峰期执行）\nredis-cli -h {host} -p {port} -a {password} --bigkeys\n\n# 输出示例（重点看“Biggest”部分）：\n# Scanning the entire keyspace to find biggest keys as well as\n# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec per 100 SCAN commands to reduce server load.\n# [00.00%] Biggest string key: "goods:detail:1001" (size: 25600 bytes)\n# [00.00%] Biggest hash key: "user:order:10086" (fields: 5000)\n# [00.00%] Biggest zset key: "rank:hot:goods" (elements: 8000)\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("⚠️ 注意："),e("code",[s._v("--bigkeys")]),s._v(" 仅统计“元素数最多”的集合 Key 和“体积最大”的 String Key，无法自定义阈值（比如只查＞10KB 的 String），且会遍历全量 Key，高并发时慎用（可加 "),e("code",[s._v("-i 0.1")]),s._v(" 降低扫描压力）。")]),s._v(" "),e("h5",{attrs:{id:"_2-精准查询-key-内存-memory-usage"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-精准查询-key-内存-memory-usage"}},[s._v("#")]),s._v(" （2）精准查询 Key 内存（MEMORY USAGE）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# 查询单个 Key 的内存占用（单位：字节，包含元数据）\nredis-cli MEMORY USAGE "goods:detail:1001"\n\n# 输出示例：25689（≈25KB，判定为大 Key）\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h4",{attrs:{id:"方法2-自定义-scan-脚本-精准筛选-生产推荐"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法2-自定义-scan-脚本-精准筛选-生产推荐"}},[s._v("#")]),s._v(" 方法2：自定义 Scan 脚本（精准筛选，生产推荐）")]),s._v(" "),e("p",[s._v("通过 "),e("code",[s._v("SCAN")]),s._v(" 遍历所有 Key，结合 "),e("code",[s._v("MEMORY USAGE")]),s._v("/"),e("code",[s._v("HLEN")]),s._v("/"),e("code",[s._v("ZCARD")]),s._v(" 等命令筛选符合阈值的大 Key，避免全量遍历阻塞：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('import redis\n\n# 连接 Redis\nr = redis.Redis(host="127.0.0.1", port=6379, password="xxx", decode_responses=True)\n\n# 大 Key 阈值\nSTRING_THRESHOLD = 10 * 1024  # 10KB\nHASH_THRESHOLD = 1000          # Hash 元素数阈值\n\n# 扫描 Key（游标遍历，避免阻塞）\ncursor = 0\nbig_keys = []\nwhile True:\n    cursor, keys = r.scan(cursor, count=1000)  # 每次扫描1000个Key\n    for key in keys:\n        # 获取 Key 类型\n        key_type = r.type(key)\n        if key_type == "string":\n            # String 类型：判断内存大小\n            mem = r.memory_usage(key)\n            if mem >= STRING_THRESHOLD:\n                big_keys.append({"key": key, "type": "string", "size": mem})\n        elif key_type == "hash":\n            # Hash 类型：判断元素数\n            hlen = r.hlen(key)\n            if hlen >= HASH_THRESHOLD:\n                big_keys.append({"key": key, "type": "hash", "fields": hlen})\n        # 可扩展 ZSet/List/Set 类型的判断\n    if cursor == 0:\n        break\n\n# 输出大 Key 列表\nprint("发现大 Key 数量：", len(big_keys))\nfor k in big_keys:\n    print(k)\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("h4",{attrs:{id:"方法3-第三方工具-可视化-高效"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法3-第三方工具-可视化-高效"}},[s._v("#")]),s._v(" 方法3：第三方工具（可视化+高效）")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("RedisInsight")]),s._v("（Redis 官方工具）：可视化查看 Key 内存、元素数，支持按大小/类型筛选大 Key；")]),s._v(" "),e("li",[e("strong",[s._v("RedisShake")]),s._v("（阿里开源）：离线解析 RDB 文件，快速定位大 Key（无需在线扫描，无性能影响）；")]),s._v(" "),e("li",[e("strong",[s._v("Prometheus + Grafana")]),s._v("：通过 "),e("code",[s._v("redis_key_size")]),s._v(" 指标（需部署 Redis Exporter），监控单 Key 内存变化，设置大 Key 告警阈值。")])]),s._v(" "),e("h3",{attrs:{id:"_2-4-大-key-的解决方案-按优先级排序"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-大-key-的解决方案-按优先级排序"}},[s._v("#")]),s._v(" 2.4 大 Key 的解决方案（按优先级排序）")]),s._v(" "),e("p",[s._v("核心思路："),e("strong",[s._v("拆分为主，压缩为辅，冷热分离兜底，操作异步化")]),s._v("。")]),s._v(" "),e("h4",{attrs:{id:"方案1-拆分大-key-根治方案-首选"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案1-拆分大-key-根治方案-首选"}},[s._v("#")]),s._v(" 方案1：拆分大 Key（根治方案，首选）")]),s._v(" "),e("p",[s._v("根据数据类型不同，拆分策略不同：")]),s._v(" "),e("h5",{attrs:{id:"_1-string-类型拆分-垂直拆分"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-string-类型拆分-垂直拆分"}},[s._v("#")]),s._v(" （1）String 类型拆分（垂直拆分）")]),s._v(" "),e("p",[s._v("将大文本/大对象拆分为多个小 String Key，比如：")]),s._v(" "),e("ul",[e("li",[s._v("原 Key："),e("code",[s._v("goods:detail:1001")]),s._v("（存储商品所有详情，20KB）；")]),s._v(" "),e("li",[s._v("拆分后：\n"),e("ul",[e("li",[e("code",[s._v("goods:name:1001")]),s._v("（商品名称，1KB）；")]),s._v(" "),e("li",[e("code",[s._v("goods:price:1001")]),s._v("（商品价格，0.5KB）；")]),s._v(" "),e("li",[e("code",[s._v("goods:desc:1001")]),s._v("（商品描述，15KB → 再拆分为 "),e("code",[s._v("goods:desc:1001:1")]),s._v("/"),e("code",[s._v("goods:desc:1001:2")]),s._v("）。")])])])]),s._v(" "),e("p",[s._v("代码示例（Java）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 拆分存储\npublic void saveGoodsDetail(Goods goods) {\n    // 基础信息拆分\n    redisTemplate.opsForValue().set("goods:name:" + goods.getId(), goods.getName());\n    redisTemplate.opsForValue().set("goods:price:" + goods.getId(), goods.getPrice().toString());\n    // 长描述拆分（按10KB拆分）\n    String desc = goods.getDesc();\n    int chunkSize = 10 * 1024; // 10KB/段\n    int chunks = (desc.length() + chunkSize - 1) / chunkSize;\n    for (int i = 0; i < chunks; i++) {\n        int start = i * chunkSize;\n        int end = Math.min((i + 1) * chunkSize, desc.length());\n        String chunk = desc.substring(start, end);\n        redisTemplate.opsForValue().set("goods:desc:" + goods.getId() + ":" + i, chunk);\n    }\n}\n\n// 合并读取\npublic Goods getGoodsDetail(Long id) {\n    Goods goods = new Goods();\n    goods.setId(id);\n    goods.setName((String) redisTemplate.opsForValue().get("goods:name:" + id));\n    goods.setPrice(new BigDecimal((String) redisTemplate.opsForValue().get("goods:price:" + id)));\n    // 合并描述\n    StringBuilder desc = new StringBuilder();\n    int i = 0;\n    while (true) {\n        String chunk = (String) redisTemplate.opsForValue().get("goods:desc:" + id + ":" + i);\n        if (chunk == null) break;\n        desc.append(chunk);\n        i++;\n    }\n    goods.setDesc(desc.toString());\n    return goods;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("h5",{attrs:{id:"_2-集合类型拆分-水平分片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-集合类型拆分-水平分片"}},[s._v("#")]),s._v(" （2）集合类型拆分（水平分片）")]),s._v(" "),e("p",[s._v("以 Hash 为例（存储用户10000条订单）：")]),s._v(" "),e("ul",[e("li",[s._v("原 Key："),e("code",[s._v("user:order:10086")]),s._v("（Hash，10000个字段）；")]),s._v(" "),e("li",[s._v("拆分后：按订单 ID 哈希分片，拆为10个小 Hash：\n"),e("ul",[e("li",[e("code",[s._v("user:order:10086:0")]),s._v("（订单 ID % 10 = 0）；")]),s._v(" "),e("li",[e("code",[s._v("user:order:10086:1")]),s._v("（订单 ID % 10 = 1）；")]),s._v(" "),e("li",[s._v("...")]),s._v(" "),e("li",[e("code",[s._v("user:order:10086:9")]),s._v("（订单 ID % 10 = 9）。")])])])]),s._v(" "),e("p",[s._v("代码示例（Java）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 分片存储订单\npublic void saveUserOrder(Long userId, Order order) {\n    // 按订单ID哈希分片（10个分片）\n    int shard = (int) (order.getId() % 10);\n    String shardKey = "user:order:" + userId + ":" + shard;\n    // 存储到对应分片Hash\n    redisTemplate.opsForHash().put(shardKey, order.getId().toString(), order);\n}\n\n// 分片查询订单\npublic Order getUserOrder(Long userId, Long orderId) {\n    int shard = (int) (orderId % 10);\n    String shardKey = "user:order:" + userId + ":" + shard;\n    return (Order) redisTemplate.opsForHash().get(shardKey, orderId.toString());\n}\n\n// 批量查询用户订单（遍历所有分片）\npublic List<Order> listUserOrders(Long userId) {\n    List<Order> orders = new ArrayList<>();\n    for (int shard = 0; shard < 10; shard++) {\n        String shardKey = "user:order:" + userId + ":" + shard;\n        // 用hscan分批遍历，避免hgetall阻塞\n        Cursor<Map.Entry<Object, Object>> cursor = redisTemplate.opsForHash().scan(\n            shardKey, ScanOptions.scanOptions().count(100).build()\n        );\n        while (cursor.hasNext()) {\n            Map.Entry<Object, Object> entry = cursor.next();\n            orders.add((Order) entry.getValue());\n        }\n    }\n    return orders;\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br")])]),e("h4",{attrs:{id:"方案2-数据压缩-临时优化-配合拆分"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案2-数据压缩-临时优化-配合拆分"}},[s._v("#")]),s._v(" 方案2：数据压缩（临时优化，配合拆分）")]),s._v(" "),e("p",[s._v("对无法拆分的 String 大 Key（如序列化后的对象），通过压缩降低体积：")]),s._v(" "),e("ul",[e("li",[s._v("压缩算法：Snappy（高性能）、GZIP（高压缩比，CPU 消耗高）；")]),s._v(" "),e("li",[s._v("适用场景：冷/温大 Key（访问频率低，可接受压缩/解压缩耗时）。")])]),s._v(" "),e("p",[s._v("代码示例（Java + Snappy）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import org.xerial.snappy.Snappy;\n\n// 压缩存储\npublic void saveBigString(String key, String value) throws IOException {\n    byte[] rawBytes = value.getBytes(StandardCharsets.UTF_8);\n    byte[] compressedBytes = Snappy.compress(rawBytes);\n    redisTemplate.opsForValue().set(key, compressedBytes);\n}\n\n// 解压缩读取\npublic String getBigString(String key) throws IOException {\n    byte[] compressedBytes = (byte[]) redisTemplate.opsForValue().get(key);\n    if (compressedBytes == null) return null;\n    byte[] rawBytes = Snappy.uncompress(compressedBytes);\n    return new String(rawBytes, StandardCharsets.UTF_8);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("h4",{attrs:{id:"方案3-冷热分离-大-key-降级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案3-冷热分离-大-key-降级"}},[s._v("#")]),s._v(" 方案3：冷热分离（大 Key 降级）")]),s._v(" "),e("p",[s._v("将大 Key 中的冷数据迁移到低成本存储（如 HBase、Elasticsearch、MySQL），Redis 仅保留热数据：")]),s._v(" "),e("ul",[e("li",[s._v("示例：用户订单大 Key 中，仅缓存近3个月的热订单（Redis），3个月前的冷订单存储到 HBase；")]),s._v(" "),e("li",[s._v("读取逻辑：先查 Redis 热数据，未命中则查 HBase 冷数据。")])]),s._v(" "),e("h4",{attrs:{id:"方案4-异步-分批操作-避免阻塞"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案4-异步-分批操作-避免阻塞"}},[s._v("#")]),s._v(" 方案4：异步/分批操作（避免阻塞）")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("删除大 Key")]),s._v("：用 "),e("code",[s._v("UNLINK")]),s._v(" 代替 "),e("code",[s._v("DEL")]),s._v("（Redis 4.0+ 支持），"),e("code",[s._v("UNLINK")]),s._v(" 异步释放内存，不阻塞主线程：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('  # 异步删除大 Key（推荐）\n  UNLINK "user:order:10086"\n  # 对比：DEL 会阻塞主线程\n  DEL "user:order:10086"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("遍历大集合")]),s._v("：用 "),e("code",[s._v("HSCAN/ZSCAN/LSCAN")]),s._v(" 代替 "),e("code",[s._v("HGETALL/ZRANGE/LRANGE 0 -1")]),s._v("，分批遍历（每次100条），避免一次性读取所有元素阻塞线程。")])]),s._v(" "),e("h4",{attrs:{id:"方案5-调整-redis-配置-兜底优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案5-调整-redis-配置-兜底优化"}},[s._v("#")]),s._v(" 方案5：调整 Redis 配置（兜底优化）")]),s._v(" "),e("ul",[e("li",[s._v("关闭大 Key 的过期时间：若大 Key 必须存在，尽量不设置 "),e("code",[s._v("EXPIRE")]),s._v("（过期删除会阻塞），改为业务层异步清理；")]),s._v(" "),e("li",[s._v("增大 "),e("code",[s._v("client-output-buffer-limit")]),s._v("：避免大 Key 传输时触发客户端输出缓冲区限制，断开连接（仅临时调整）。")])]),s._v(" "),e("h2",{attrs:{id:"三、热-key-问题深度解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、热-key-问题深度解析"}},[s._v("#")]),s._v(" 三、热 Key 问题深度解析")]),s._v(" "),e("h3",{attrs:{id:"_3-1-什么是热-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-什么是热-key"}},[s._v("#")]),s._v(" 3.1 什么是热 Key？")]),s._v(" "),e("p",[s._v("热 Key 是指"),e("strong",[s._v("单 Key 被高频次访问")]),s._v("，导致该 Key 所在的 Redis 节点成为“热点节点”，占用节点绝大部分 CPU、内存、网络资源。行业通用判定标准：")]),s._v(" "),e("ul",[e("li",[s._v("单 Key QPS ≥ 1000（核心业务建议 ≤ 500）；")]),s._v(" "),e("li",[s._v("单 Key 访问量占所在节点总访问量的 10% 以上；")]),s._v(" "),e("li",[s._v("热点持续时间 ≥ 10 秒（瞬时热点可忽略）。")])]),s._v(" "),e("p",[s._v("⚠️ 注意：热 Key 不一定是大 Key，但如果热 Key 同时是大 Key（如 10KB 的 String 热 Key），会同时引发“访问高频+传输缓慢”，危害翻倍。")]),s._v(" "),e("h3",{attrs:{id:"_3-2-热-key-的核心危害"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-热-key-的核心危害"}},[s._v("#")]),s._v(" 3.2 热 Key 的核心危害")]),s._v(" "),e("p",[s._v("热 Key 会直接压垮单个 Redis 节点，进而引发整个集群的性能问题：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("危害类型")]),s._v(" "),e("th",[s._v("底层原理")]),s._v(" "),e("th",[s._v("业务影响示例")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("单节点 CPU 满载")]),s._v(" "),e("td",[s._v("高频命令（GET/SET）占用节点 CPU 100%，无法处理其他请求")]),s._v(" "),e("td",[s._v("节点响应超时，服务雪崩")])]),s._v(" "),e("tr",[e("td",[s._v("网卡带宽打满")]),s._v(" "),e("td",[s._v("热 Key 高频传输，占用节点网卡 90% 以上带宽，其他 Key 传输被阻塞")]),s._v(" "),e("td",[s._v("网络延迟飙升，客户端连接超时")])]),s._v(" "),e("tr",[e("td",[s._v("集群负载不均")]),s._v(" "),e("td",[s._v("热 Key 固定在某一节点（Redis 集群按 Key 哈希分片），节点负载差异＞80%")]),s._v(" "),e("td",[s._v("节点宕机，集群故障切换")])]),s._v(" "),e("tr",[e("td",[s._v("缓存击穿/雪崩")]),s._v(" "),e("td",[s._v("热 Key 过期/失效时，大量请求穿透到数据库，压垮 DB")]),s._v(" "),e("td",[s._v("数据库宕机，服务不可用")])]),s._v(" "),e("tr",[e("td",[s._v("客户端连接数耗尽")]),s._v(" "),e("td",[s._v("高频访问导致客户端到热点节点的连接数达到上限，新连接被拒绝")]),s._v(" "),e("td",[s._v("接口报错“Could not get resource”")])])])]),s._v(" "),e("h3",{attrs:{id:"_3-3-热-key-的识别方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-热-key-的识别方法"}},[s._v("#")]),s._v(" 3.3 热 Key 的识别方法")]),s._v(" "),e("h4",{attrs:{id:"方法1-监控指标-生产首选"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法1-监控指标-生产首选"}},[s._v("#")]),s._v(" 方法1：监控指标（生产首选）")]),s._v(" "),e("p",[s._v("通过 Prometheus + Grafana + Redis Exporter 监控以下指标：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("redis_key_space_hits")]),s._v("：单 Key 命中次数（需开启 "),e("code",[s._v("redis-cli config set keyspace_events KEA")]),s._v("）；")]),s._v(" "),e("li",[e("code",[s._v("redis_command_stats")]),s._v("：统计 "),e("code",[s._v("GET/SET")]),s._v(" 等命令的执行次数，定位高频命令对应的 Key；")]),s._v(" "),e("li",[e("code",[s._v("redis_server_net_input_bytes")]),s._v("/"),e("code",[s._v("redis_server_net_output_bytes")]),s._v("：单节点网络流量，定位热点节点。")])]),s._v(" "),e("h4",{attrs:{id:"方法2-redis-原生命令-快速排查"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法2-redis-原生命令-快速排查"}},[s._v("#")]),s._v(" 方法2：Redis 原生命令（快速排查）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('# 查看命令执行统计（按执行次数排序）\nredis-cli INFO commandstats | grep -E "cmdstat_|calls" | sort -k2 -nr\n\n# 输出示例（GET 命令执行100万次，远高于其他命令）：\n# cmdstat_get:calls=1000000,usec=500000,usec_per_call=0.50\n# cmdstat_set:calls=100000,usec=100000,usec_per_call=1.00\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h4",{attrs:{id:"方法3-客户端埋点-精准定位"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方法3-客户端埋点-精准定位"}},[s._v("#")]),s._v(" 方法3：客户端埋点（精准定位）")]),s._v(" "),e("p",[s._v("在业务代码中统计每个 Key 的访问次数，超过阈值则标记为热 Key：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('@Service\npublic class HotKeyMonitorService {\n    // 访问次数计数器（本地缓存，定时清理）\n    private final Map<String, AtomicInteger> keyCounter = new ConcurrentHashMap<>();\n    // 热 Key 阈值（QPS ≥ 1000）\n    private static final int HOT_KEY_THRESHOLD = 1000;\n    // 统计周期（10秒）\n    private static final long STAT_PERIOD = 10 * 1000;\n\n    // 初始化定时任务：每10秒检测热 Key\n    @PostConstruct\n    public void initMonitor() {\n        ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();\n        executor.scheduleAtFixedRate(this::detectHotKey, 0, STAT_PERIOD, TimeUnit.MILLISECONDS);\n    }\n\n    // 记录 Key 访问\n    public void recordKeyAccess(String key) {\n        keyCounter.computeIfAbsent(key, k -> new AtomicInteger(0)).incrementAndGet();\n    }\n\n    // 检测热 Key\n    private void detectHotKey() {\n        List<String> hotKeys = new ArrayList<>();\n        long qpsThreshold = HOT_KEY_THRESHOLD;\n        for (Map.Entry<String, AtomicInteger> entry : keyCounter.entrySet()) {\n            int count = entry.getValue().get();\n            long qps = count / (STAT_PERIOD / 1000);\n            if (qps >= qpsThreshold) {\n                hotKeys.add(entry.getKey() + " (QPS: " + qps + ")");\n            }\n            // 重置计数器\n            entry.getValue().set(0);\n        }\n        if (!hotKeys.isEmpty()) {\n            log.warn("检测到热 Key：{}", String.join(", ", hotKeys));\n        }\n    }\n}\n\n// 业务层集成埋点\n@Service\npublic class GoodsService {\n    @Autowired\n    private HotKeyMonitorService hotKeyMonitorService;\n\n    public Goods getGoodsById(Long id) {\n        String key = "goods:id:" + id;\n        // 记录 Key 访问\n        hotKeyMonitorService.recordKeyAccess(key);\n        // 后续查询逻辑...\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br")])]),e("h3",{attrs:{id:"_3-4-热-key-的解决方案-按优先级排序"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-热-key-的解决方案-按优先级排序"}},[s._v("#")]),s._v(" 3.4 热 Key 的解决方案（按优先级排序）")]),s._v(" "),e("p",[s._v("核心思路："),e("strong",[s._v("分散访问压力，降低热点节点负载，避免单点依赖")]),s._v("。")]),s._v(" "),e("h4",{attrs:{id:"方案1-本地缓存-caffeine-多级缓存-首选"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案1-本地缓存-caffeine-多级缓存-首选"}},[s._v("#")]),s._v(" 方案1：本地缓存（Caffeine）+ 多级缓存（首选）")]),s._v(" "),e("p",[s._v("在应用层（JVM）增加本地缓存（如 Caffeine），缓存热 Key 数据，减少对 Redis 的直接访问：")]),s._v(" "),e("ul",[e("li",[s._v("逻辑：请求先查本地缓存 → 未命中查 Redis → 未命中查 DB → 更新 Redis + 本地缓存；")]),s._v(" "),e("li",[s._v("优势：本地缓存访问耗时＜1ms，可承接 90% 以上的热 Key 请求；")]),s._v(" "),e("li",[s._v("注意：本地缓存需设置短过期时间（2~5分钟），并通过消息队列同步更新（避免数据不一致）。")])]),s._v(" "),e("p",[s._v("代码示例（Java + Caffeine）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 配置本地缓存\n@Configuration\npublic class CaffeineConfig {\n    @Bean\n    public Cache<String, Object> localHotKeyCache() {\n        return Caffeine.newBuilder()\n                .maximumSize(1000) // 缓存1000个热 Key\n                .expireAfterWrite(3, TimeUnit.MINUTES) // 3分钟过期\n                .recordStats() // 开启统计\n                .build();\n    }\n}\n\n// 业务层集成本地缓存\n@Service\npublic class GoodsService {\n    @Autowired\n    private Cache<String, Object> localHotKeyCache;\n    @Autowired\n    private RedisTemplate<String, Object> redisTemplate;\n    @Autowired\n    private GoodsMapper goodsMapper;\n\n    public Goods getGoodsById(Long id) {\n        String key = "goods:id:" + id;\n        // 1. 查本地缓存\n        Goods goods = (Goods) localHotKeyCache.getIfPresent(key);\n        if (goods != null) {\n            return goods;\n        }\n        // 2. 查 Redis\n        goods = (Goods) redisTemplate.opsForValue().get(key);\n        if (goods != null) {\n            // 更新本地缓存\n            localHotKeyCache.put(key, goods);\n            return goods;\n        }\n        // 3. 查 DB\n        goods = goodsMapper.selectById(id);\n        if (goods != null) {\n            // 更新 Redis + 本地缓存\n            redisTemplate.opsForValue().set(key, goods, 30, TimeUnit.MINUTES);\n            localHotKeyCache.put(key, goods);\n        }\n        return goods;\n    }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br")])]),e("h4",{attrs:{id:"方案2-热-key-分散-哈希分片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案2-热-key-分散-哈希分片"}},[s._v("#")]),s._v(" 方案2：热 Key 分散（哈希分片）")]),s._v(" "),e("p",[s._v("将单个热 Key 拆分为多个“子热 Key”，分散到不同 Redis 节点，降低单节点压力：")]),s._v(" "),e("ul",[e("li",[s._v("示例：热 Key "),e("code",[s._v("goods:hot:1001")]),s._v(" → 拆分为 "),e("code",[s._v("goods:hot:1001:0")]),s._v(" ~ "),e("code",[s._v("goods:hot:1001:9")]),s._v("；")]),s._v(" "),e("li",[s._v("写入：将数据同步写入所有子 Key；")]),s._v(" "),e("li",[s._v("读取：客户端随机访问一个子 Key（如 "),e("code",[s._v("Random.nextInt(10)")]),s._v("）。")])]),s._v(" "),e("p",[s._v("代码示例（Java）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// 写入：同步到所有子 Key\npublic void saveHotGoods(Goods goods) {\n    String baseKey = "goods:hot:" + goods.getId();\n    // 写入10个子 Key\n    for (int i = 0; i < 10; i++) {\n        String subKey = baseKey + ":" + i;\n        redisTemplate.opsForValue().set(subKey, goods, 30, TimeUnit.MINUTES);\n    }\n}\n\n// 读取：随机访问一个子 Key\npublic Goods getHotGoods(Long id) {\n    String baseKey = "goods:hot:" + id;\n    // 随机选一个子 Key\n    int random = new Random().nextInt(10);\n    String subKey = baseKey + ":" + random;\n    return (Goods) redisTemplate.opsForValue().get(subKey);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h4",{attrs:{id:"方案3-读写分离-主从复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案3-读写分离-主从复制"}},[s._v("#")]),s._v(" 方案3：读写分离 + 主从复制")]),s._v(" "),e("p",[s._v("将热 Key 的读请求分流到从节点，主节点仅处理写请求：")]),s._v(" "),e("ul",[e("li",[s._v("配置：Redis 主从架构（1主N从），客户端读请求随机分发到从节点；")]),s._v(" "),e("li",[s._v("优势：分散读压力，主节点专注写操作；")]),s._v(" "),e("li",[s._v("注意：主从延迟需控制在 100ms 内，避免读旧数据。")])]),s._v(" "),e("h4",{attrs:{id:"方案4-熔断限流-兜底保护"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案4-熔断限流-兜底保护"}},[s._v("#")]),s._v(" 方案4：熔断限流（兜底保护）")]),s._v(" "),e("p",[s._v("通过 Sentinel/Hystrix 对热 Key 访问限流，避免压垮 Redis/DB：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// Sentinel 限流配置（热 Key 访问 QPS 上限 5000）\n@SentinelResource(\n    value = "hotKey:goods",\n    blockHandler = "hotKeyBlockHandler"\n)\npublic Goods getHotGoods(Long id) {\n    // 热 Key 查询逻辑...\n}\n\n// 限流兜底方法\npublic Goods hotKeyBlockHandler(Long id, BlockException e) {\n    log.warn("热 Key 访问限流，id:{}", id);\n    return new Goods().setName("系统繁忙，请稍后再试");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("h4",{attrs:{id:"方案5-预加载-永不过期"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#方案5-预加载-永不过期"}},[s._v("#")]),s._v(" 方案5：预加载 + 永不过期")]),s._v(" "),e("p",[s._v("对热 Key 提前加载到 Redis，且不设置过期时间（逻辑永不过期）：")]),s._v(" "),e("ul",[e("li",[s._v("预加载：系统启动/低峰期主动加载热 Key 到 Redis；")]),s._v(" "),e("li",[s._v("永不过期：后台异步线程定期更新热 Key 数据，避免过期；")]),s._v(" "),e("li",[s._v("优势：避免热 Key 过期引发的缓存击穿。")])]),s._v(" "),e("h2",{attrs:{id:"四、大-key-热-key-叠加问题-最高风险"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、大-key-热-key-叠加问题-最高风险"}},[s._v("#")]),s._v(" 四、大 Key + 热 Key 叠加问题（最高风险）")]),s._v(" "),e("p",[s._v("如果一个 Key 既是大 Key 又是热 Key（如 20KB 的 String 热 Key，QPS 2000），会同时引发：")]),s._v(" "),e("ul",[e("li",[s._v("大 Key 问题：传输缓慢、内存倾斜；")]),s._v(" "),e("li",[s._v("热 Key 问题：单节点 CPU/网卡满载。")])]),s._v(" "),e("h3",{attrs:{id:"解决方案-组合策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方案-组合策略"}},[s._v("#")]),s._v(" 解决方案：组合策略")]),s._v(" "),e("ol",[e("li",[s._v("先拆分大 Key（拆为多个小 Key）；")]),s._v(" "),e("li",[s._v("对拆分后的小 Key 做本地缓存 + 哈希分散；")]),s._v(" "),e("li",[s._v("限流兜底 + 主从读写分离；")]),s._v(" "),e("li",[s._v("冷热分离：仅缓存热数据，冷数据迁移到其他存储。")])]),s._v(" "),e("h2",{attrs:{id:"五、最佳实践总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五、最佳实践总结"}},[s._v("#")]),s._v(" 五、最佳实践总结")]),s._v(" "),e("h3",{attrs:{id:"_5-1-预防策略-核心"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-预防策略-核心"}},[s._v("#")]),s._v(" 5.1 预防策略（核心）")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("Key 设计规范")]),s._v("：\n"),e("ul",[e("li",[s._v("单个 String Key ≤ 5KB，集合 Key 元素数 ≤ 500；")]),s._v(" "),e("li",[s._v("避免用 Hash/List 存储全量数据，按业务维度拆分；")])])]),s._v(" "),e("li",[e("strong",[s._v("监控告警")]),s._v("：\n"),e("ul",[e("li",[s._v("大 Key：设置内存阈值告警（如 String ≥ 10KB 告警）；")]),s._v(" "),e("li",[s._v("热 Key：设置 QPS 阈值告警（如单 Key QPS ≥ 1000 告警）；")])])]),s._v(" "),e("li",[e("strong",[s._v("压测验证")]),s._v("：上线前对大 Key/热 Key 做压测，验证拆分/分流效果。")])]),s._v(" "),e("h3",{attrs:{id:"_5-2-治理策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-治理策略"}},[s._v("#")]),s._v(" 5.2 治理策略")]),s._v(" "),e("ul",[e("li",[s._v("大 Key：优先拆分，其次压缩，最后冷热分离；")]),s._v(" "),e("li",[s._v("热 Key：优先本地缓存，其次哈希分散，最后限流兜底；")]),s._v(" "),e("li",[s._v("操作大 Key：用 "),e("code",[s._v("UNLINK")]),s._v("/"),e("code",[s._v("SCAN")]),s._v(" 代替 "),e("code",[s._v("DEL")]),s._v("/"),e("code",[s._v("HGETALL")]),s._v("，避免阻塞；")]),s._v(" "),e("li",[s._v("热 Key 数据：尽量简化（只缓存核心字段），降低传输成本。")])]),s._v(" "),e("h3",{attrs:{id:"_5-3-应急策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-应急策略"}},[s._v("#")]),s._v(" 5.3 应急策略")]),s._v(" "),e("ul",[e("li",[s._v("大 Key 阻塞：临时下线大 Key 所在节点，用 "),e("code",[s._v("UNLINK")]),s._v(" 异步删除；")]),s._v(" "),e("li",[s._v("热 Key 过载：临时开启本地缓存兜底，降低 Redis 访问频率；")]),s._v(" "),e("li",[s._v("集群倾斜：手动迁移大 Key/热 Key 到负载较低的节点。")])]),s._v(" "),e("h2",{attrs:{id:"六、核心区别与对比表"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六、核心区别与对比表"}},[s._v("#")]),s._v(" 六、核心区别与对比表")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("对比维度")]),s._v(" "),e("th",[s._v("大 Key")]),s._v(" "),e("th",[s._v("热 Key")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("核心问题")]),s._v(" "),e("td",[s._v("数据体积大，操作/传输成本高")]),s._v(" "),e("td",[s._v("访问频率高，单节点负载高")])]),s._v(" "),e("tr",[e("td",[s._v("识别难点")]),s._v(" "),e("td",[s._v("需扫描全量 Key，耗时久")]),s._v(" "),e("td",[s._v("需统计访问次数，需埋点/监控")])]),s._v(" "),e("tr",[e("td",[s._v("根治方案")]),s._v(" "),e("td",[s._v("拆分 Key（垂直/水平）")]),s._v(" "),e("td",[s._v("分散访问（本地缓存/哈希分片）")])]),s._v(" "),e("tr",[e("td",[s._v("临时方案")]),s._v(" "),e("td",[s._v("压缩、异步删除")]),s._v(" "),e("td",[s._v("限流、读写分离")])]),s._v(" "),e("tr",[e("td",[s._v("监控指标")]),s._v(" "),e("td",[s._v("单 Key 内存、集合元素数")]),s._v(" "),e("td",[s._v("单 Key QPS、节点 CPU/网卡使用率")])]),s._v(" "),e("tr",[e("td",[s._v("典型错误")]),s._v(" "),e("td",[s._v("用 HGETALL 遍历大 Hash")]),s._v(" "),e("td",[s._v("所有请求直接访问同一个热 Key")])])])]),s._v(" "),e("p",[s._v("通过以上方案，可有效解决 Redis 大 Key 和热 Key 问题，核心是"),e("strong",[s._v("提前预防、精准识别、分层治理")]),s._v("，避免单点问题扩散为集群级故障。")])])}),[],!1,null,null,null);e.default=t.exports}}]);