<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Cloud Sentinel 深度解析 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/84.f5a347be.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/48.7d4f854a.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/55.27ff3cca.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/60.800afb74.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/79.486534af.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/83.72b7d6a4.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/f19195/" class="sidebar-link">Spring Boot 自动配置</a></li><li><a href="/pages/1c21ce/" class="sidebar-link">Spring Boot Bean 生命周期</a></li><li><a href="/pages/48cf22/" class="sidebar-link">Spring事务传播机制</a></li><li><a href="/pages/20d41f/" class="sidebar-link">Spring Cloud Nacos 深度解析</a></li><li><a href="/pages/622399/" class="sidebar-link">Spring Cloud OpenFeign 深度解析</a></li><li><a href="/pages/b6abda/" class="sidebar-link">Spring Cloud Gateway 底层原理</a></li><li><a href="/pages/61e1cc/" class="sidebar-link">Spring Cloud Seata 深度解析</a></li><li><a href="/pages/3f9c50/" aria-current="page" class="active sidebar-link">Spring Cloud Sentinel 深度解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#一、核心定位与技术依赖" class="sidebar-link">一、核心定位与技术依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_1-1-核心定位" class="sidebar-link">1.1 核心定位</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_1-2-底层技术依赖与架构分层" class="sidebar-link">1.2 底层技术依赖与架构分层</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#二、核心架构与核心组件" class="sidebar-link">二、核心架构与核心组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_2-1-核心组件详解" class="sidebar-link">2.1 核心组件详解</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-1-资源-resource-流量治理的核心对象" class="sidebar-link">2.1.1 资源（Resource）：流量治理的核心对象</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-2-规则-rule-流量治理的配置契约" class="sidebar-link">2.1.2 规则（Rule）：流量治理的配置契约</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-3-上下文-context-调用链路的抽象" class="sidebar-link">2.1.3 上下文（Context）：调用链路的抽象</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-4-节点-node-实时统计的核心载体" class="sidebar-link">2.1.4 节点（Node）：实时统计的核心载体</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-5-processorslot-链-流量治理的核心链路" class="sidebar-link">2.1.5 ProcessorSlot 链：流量治理的核心链路</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_2-1-6-sentinel-dashboard-可视化控制台" class="sidebar-link">2.1.6 Sentinel Dashboard：可视化控制台</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#三、spring-cloud-sentinel-工作流程底层解析" class="sidebar-link">三、Spring Cloud Sentinel 工作流程底层解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-1-资源定义与埋点初始化" class="sidebar-link">步骤 1：资源定义与埋点初始化</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-2-请求触发资源调用-创建-context" class="sidebar-link">步骤 2：请求触发资源调用，创建 Context</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-3-创建-entry-触发-processorslot-链" class="sidebar-link">步骤 3：创建 Entry，触发 ProcessorSlot 链</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-4-processorslot-链执行-节点选择与集群构建" class="sidebar-link">步骤 4：ProcessorSlot 链执行（节点选择与集群构建）</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-5-统计数据收集-statisticslot" class="sidebar-link">步骤 5：统计数据收集（StatisticSlot）</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-6-规则校验-授权、热点限流、流量控制、熔断降级" class="sidebar-link">步骤 6：规则校验（授权、热点限流、流量控制、熔断降级）</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-7-业务逻辑执行与统计数据更新" class="sidebar-link">步骤 7：业务逻辑执行与统计数据更新</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#步骤-8-监控数据上报与-context-销毁" class="sidebar-link">步骤 8：监控数据上报与 Context 销毁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#四、关键特性底层实现" class="sidebar-link">四、关键特性底层实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_4-1-流量控制-基于令牌桶-漏桶算法的流量管控" class="sidebar-link">4.1 流量控制：基于令牌桶/漏桶算法的流量管控</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-1-1-核心算法" class="sidebar-link">4.1.1 核心算法</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-1-2-流量控制模式" class="sidebar-link">4.1.2 流量控制模式</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-1-3-底层实现逻辑-flowslot" class="sidebar-link">4.1.3 底层实现逻辑（FlowSlot）</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_4-2-熔断降级-基于状态机的故障隔离" class="sidebar-link">4.2 熔断降级：基于状态机的故障隔离</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-2-1-熔断状态机" class="sidebar-link">4.2.1 熔断状态机</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-2-2-熔断策略" class="sidebar-link">4.2.2 熔断策略</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-2-3-底层实现逻辑-degradeslot" class="sidebar-link">4.2.3 底层实现逻辑（DegradeSlot）</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_4-3-热点参数限流-基于参数维度的精准管控" class="sidebar-link">4.3 热点参数限流：基于参数维度的精准管控</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-3-1-核心实现逻辑" class="sidebar-link">4.3.1 核心实现逻辑</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-3-2-高级特性-参数例外项" class="sidebar-link">4.3.2 高级特性：参数例外项</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_4-4-系统自适应保护-基于系统负载的全局管控" class="sidebar-link">4.4 系统自适应保护：基于系统负载的全局管控</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-4-1-核心保护策略" class="sidebar-link">4.4.1 核心保护策略</a></li><li class="sidebar-sub-header level4"><a href="/pages/3f9c50/#_4-4-2-底层实现逻辑" class="sidebar-link">4.4.2 底层实现逻辑</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#五、实践优化与最佳实践" class="sidebar-link">五、实践优化与最佳实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_5-1-规则配置最佳实践" class="sidebar-link">5.1 规则配置最佳实践</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_5-2-性能优化" class="sidebar-link">5.2 性能优化</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_5-3-监控与告警配置" class="sidebar-link">5.3 监控与告警配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/3f9c50/#_5-4-与-spring-cloud-生态组件集成" class="sidebar-link">5.4 与 Spring Cloud 生态组件集成</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/3f9c50/#六、总结" class="sidebar-link">六、总结</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/node/spring/#《Spring》笔记" data-v-06225672>《Spring》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Spring Cloud Sentinel 深度解析<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="spring-cloud-sentinel-深度解析-原理、特性与实践"><a href="#spring-cloud-sentinel-深度解析-原理、特性与实践" class="header-anchor">#</a> Spring Cloud Sentinel 深度解析：原理、特性与实践</h1> <p>在微服务架构中，服务稳定性是核心诉求之一。随着服务规模扩大、调用链路复杂化，流量峰值、下游服务故障、资源耗尽等问题极易导致服务雪崩。Spring Cloud Sentinel 作为阿里开源的流量治理组件，以“流量为切入点”，提供了流量控制、熔断降级、系统自适应保护、热点参数限流等全链路流量治理能力，完美适配 Spring Cloud 生态，成为微服务稳定性保障的核心方案。</p> <h2 id="一、核心定位与技术依赖"><a href="#一、核心定位与技术依赖" class="header-anchor">#</a> 一、核心定位与技术依赖</h2> <h3 id="_1-1-核心定位"><a href="#_1-1-核心定位" class="header-anchor">#</a> 1.1 核心定位</h3> <p>Spring Cloud Sentinel 是一款 <strong>分布式系统流量治理组件</strong>，核心目标是通过流量控制、熔断降级等手段，保障微服务架构的高可用性。其核心价值在于：</p> <ul><li>全链路流量治理：覆盖从接入层、网关层到服务层的全链路流量控制，支持多种流量治理规则（流量控制、熔断降级、热点限流等）；</li> <li>实时监控与告警：提供秒级实时监控能力，精准感知流量变化、异常状态，并支持多种告警渠道（短信、邮件、钉钉等）；</li> <li>灵活的扩展机制：支持自定义规则数据源、自定义流量控制算法、自定义告警逻辑等，适配多样化业务场景；</li> <li>轻量级高性能：核心库无依赖、体积小，基于Netty实现异步非阻塞通信，单机可支撑百万级QPS，性能损耗极低；</li> <li>Spring Cloud 无缝整合：原生支持 Spring Boot/Spring Cloud 自动配置，兼容 Feign、Gateway、Dubbo 等主流组件。</li></ul> <h3 id="_1-2-底层技术依赖与架构分层"><a href="#_1-2-底层技术依赖与架构分层" class="header-anchor">#</a> 1.2 底层技术依赖与架构分层</h3> <p>Spring Cloud Sentinel 基于 Sentinel 核心库扩展实现，核心依赖链为：<strong>Spring Cloud Sentinel → Sentinel Core（核心库） → Netty（通信）/SLF4J（日志） → 第三方数据源（Nacos/Apollo/Redis）</strong>。其架构分为三层，各层职责清晰：</p> <ol><li>核心层（Sentinel Core）：最底层核心模块，包含流量控制、熔断降级的核心算法实现（如令牌桶、漏桶、滑动窗口）、资源抽象、规则管理、实时统计等核心能力，不依赖任何框架，可独立集成；</li> <li>适配层（Spring Cloud Adapter）：Spring Cloud 生态的适配模块，提供 Spring Boot 自动配置、Feign/Spring Cloud Gateway/Dubbo 等组件的集成支持，将核心层能力封装为 Spring 生态友好的 API；</li> <li>扩展层（Dashboard &amp; 数据源）：包含 Sentinel Dashboard（可视化控制台）和规则数据源扩展，支持规则的动态配置与持久化，以及实时监控数据展示、告警配置等。</li></ol> <p>核心架构分层图（文字描述）：<br>接入层（Feign/Gateway/Dubbo）→ 适配层（Spring Cloud Adapter）→ 核心层（Sentinel Core）；扩展层（Dashboard + 动态数据源）与核心层交互，提供规则配置与监控能力。</p> <h2 id="二、核心架构与核心组件"><a href="#二、核心架构与核心组件" class="header-anchor">#</a> 二、核心架构与核心组件</h2> <p>Spring Cloud Sentinel 的核心架构围绕“资源定义-规则配置-流量治理-监控统计”的全链路展开，核心组件包括资源（Resource）、规则（Rule）、上下文（Context）、节点（Node）、ProcessorSlot 链、Dashboard 等，各组件协同完成流量治理的全流程。</p> <h3 id="_2-1-核心组件详解"><a href="#_2-1-核心组件详解" class="header-anchor">#</a> 2.1 核心组件详解</h3> <h4 id="_2-1-1-资源-resource-流量治理的核心对象"><a href="#_2-1-1-资源-resource-流量治理的核心对象" class="header-anchor">#</a> 2.1.1 资源（Resource）：流量治理的核心对象</h4> <p>资源是 Sentinel 流量治理的核心对象，代表需要保护的业务逻辑或服务接口，任何需要进行流量控制、熔断降级的部分都可定义为资源。常见的资源类型包括：</p> <ul><li>HTTP 接口：如 Spring MVC 接口、Feign 调用接口；</li> <li>RPC 方法：如 Dubbo 服务接口；</li> <li>自定义业务逻辑：如数据库操作、缓存查询等关键代码块。</li></ul> <p>Sentinel 支持两种资源定义方式：</p> <ol><li>注解式埋点（推荐）：通过 @SentinelResource 注解快速定义资源，无需侵入业务代码，示例：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 定义资源名为 &quot;getUserById&quot;，降级方法为 fallbackMethod</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token string">&quot;getUserByIdFallback&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 业务逻辑：调用用户服务获取用户信息</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 降级方法（参数、返回值需与原方法一致）</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserByIdFallback</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;获取用户信息失败，触发降级&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>代码式埋点：通过 SphU（Sentinel 核心 API）手动包裹业务逻辑，侵入性较强，适用于自定义场景：</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserDTO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 定义资源，entry() 方法返回 Entry 对象，代表资源的调用入口</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 业务逻辑</span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. 流量控制/熔断降级触发时的处理逻辑</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;获取用户信息被限流/降级&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4. 释放资源</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>核心点：资源名是 Sentinel 识别资源的唯一标识，规则配置需与资源名一一对应；注解式埋点通过 Spring AOP 实现，底层仍会转换为核心 API 的调用。</p> <h4 id="_2-1-2-规则-rule-流量治理的配置契约"><a href="#_2-1-2-规则-rule-流量治理的配置契约" class="header-anchor">#</a> 2.1.2 规则（Rule）：流量治理的配置契约</h4> <p>规则是 Sentinel 流量治理的配置契约，定义了“如何对资源进行流量控制/熔断降级”。Sentinel 支持多种规则类型，覆盖全链路流量治理场景：</p> <ul><li>流量控制规则（FlowRule）：控制资源的 QPS 或并发线程数，避免流量峰值超过资源承载能力；</li> <li>熔断降级规则（DegradeRule）：当资源调用失败率/响应时间达到阈值时，触发熔断，避免故障扩散；</li> <li>热点参数限流规则（ParamFlowRule）：对资源的热点参数（如高频访问的用户 ID、商品 ID）进行精准限流；</li> <li>系统自适应保护规则（SystemRule）：基于系统整体负载（CPU、内存、磁盘 IO）动态调整流量，避免系统过载；</li> <li>授权规则（AuthorityRule）：基于来源（如服务名、IP）进行黑白名单控制，限制非法来源的访问。</li></ul> <p>规则的核心属性包括：资源名（resource）、规则类型（grade）、阈值（threshold）、生效模式（clusterMode，单机/集群）等。规则可通过 Sentinel Dashboard 动态配置，或通过代码硬编码、配置文件、Nacos/Apollo 等动态数据源配置。</p> <p>示例：流量控制规则配置（yaml 格式）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token comment"># 自定义数据源名称</span>
        <span class="token key atrule">flow-ds</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> sentinel<span class="token punctuation">-</span>flow<span class="token punctuation">-</span>rules
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token comment"># 规则类型：flow（流量控制）</span>
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow
      <span class="token comment"># 应用名称（与 Dashboard 交互的标识）</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_2-1-3-上下文-context-调用链路的抽象"><a href="#_2-1-3-上下文-context-调用链路的抽象" class="header-anchor">#</a> 2.1.3 上下文（Context）：调用链路的抽象</h4> <p>Context 是 Sentinel 对“一次完整调用链路”的抽象，包含了当前调用的资源、来源、入口节点等信息。每个资源调用都会关联一个 Context，Context 的核心作用：</p> <ul><li>串联调用链路：将一次请求中的多个资源调用串联起来，形成完整的调用链路，支持链路级别的流量控制；</li> <li>存储调用元数据：记录当前调用的来源（origin，如调用方服务名）、入口资源（entranceNode）、当前资源（curEntry）等信息；</li> <li>隔离调用环境：不同的 Context 相互隔离，避免调用链路间的干扰。</li></ul> <p>Context 的创建与销毁：默认情况下，Sentinel 会为每个 HTTP 请求创建一个 Context（通过 Web 拦截器实现），请求结束后自动销毁；自定义场景可通过 ContextUtil 手动创建：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建 Context，参数：contextName（上下文名称）、origin（调用来源）</span>
<span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">&quot;user-service-context&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;order-service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 资源调用</span>
    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;getUserById&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 业务逻辑</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 限流/降级处理</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 销毁 Context</span>
    <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_2-1-4-节点-node-实时统计的核心载体"><a href="#_2-1-4-节点-node-实时统计的核心载体" class="header-anchor">#</a> 2.1.4 节点（Node）：实时统计的核心载体</h4> <p>Node 是 Sentinel 中用于存储资源调用统计数据（如 QPS、响应时间、失败率）的核心载体，所有流量治理规则的判断都基于 Node 的统计数据。Sentinel 定义了多种 Node 类型，构成层次化的统计模型：</p> <ul><li>DefaultNode：默认节点，对应单个资源在当前 Context 下的统计数据，每个资源-Context 组合对应一个 DefaultNode；</li> <li>ClusterNode：集群节点，对应单个资源在全系统中的聚合统计数据（跨 Context），每个资源对应一个 ClusterNode；</li> <li>EntranceNode：入口节点，对应 Context 的入口资源统计数据，用于链路级别的流量控制；</li> <li>StatisticNode：统计节点基类，实现了 QPS、响应时间、失败率等核心统计逻辑，其他 Node 类型均继承自 StatisticNode。</li></ul> <p>核心统计逻辑：基于滑动窗口算法实现，每个 Node 内部维护多个滑动窗口（默认窗口大小 1s，分为 10 个桶，每个桶 100ms），实时收集每个桶的调用数据（请求数、成功数、失败数、响应时间），通过聚合窗口数据得到实时统计结果（如当前 QPS、1min 内平均响应时间）。</p> <h4 id="_2-1-5-processorslot-链-流量治理的核心链路"><a href="#_2-1-5-processorslot-链-流量治理的核心链路" class="header-anchor">#</a> 2.1.5 ProcessorSlot 链：流量治理的核心链路</h4> <p>ProcessorSlot 链是 Sentinel 实现流量治理的核心机制，本质是一条责任链，每个 ProcessorSlot 负责一项具体的功能（如规则校验、统计数据收集、日志记录等）。当资源被调用时，请求会依次经过 ProcessorSlot 链的每个 Slot，完成全流程的流量治理。</p> <p>默认 ProcessorSlot 链顺序（从前往后）：</p> <ol><li>NodeSelectorSlot：节点选择槽，负责创建并维护 DefaultNode 与 Context 的关联关系，为每个资源-Context 组合分配唯一的 DefaultNode；</li> <li>ClusterBuilderSlot：集群构建槽，负责创建并维护 ClusterNode，聚合同一资源的全系统统计数据；</li> <li>LogSlot：日志槽，负责记录资源调用的日志信息（如限流/降级触发日志）；</li> <li>StatisticSlot：统计槽，核心槽位，负责收集资源调用的实时统计数据（QPS、响应时间等），并将数据写入对应的 Node；</li> <li>AuthoritySlot：授权槽，负责校验授权规则（黑白名单），拦截非法来源的访问；</li> <li>ParamFlowSlot：热点参数限流槽，负责校验热点参数限流规则，对高频参数进行精准限流；</li> <li>FlowSlot：流量控制槽，负责校验流量控制规则，根据统计数据判断是否需要限流；</li> <li>DegradeSlot：熔断降级槽，负责校验熔断降级规则，根据统计数据判断是否需要熔断。</li></ol> <p>核心点：ProcessorSlot 链的顺序决定了功能的执行顺序，统计数据收集（StatisticSlot）必须在规则校验（FlowSlot、DegradeSlot 等）之前，确保规则判断基于实时统计数据；开发者可通过自定义 ProcessorSlot 扩展责任链功能。</p> <h4 id="_2-1-6-sentinel-dashboard-可视化控制台"><a href="#_2-1-6-sentinel-dashboard-可视化控制台" class="header-anchor">#</a> 2.1.6 Sentinel Dashboard：可视化控制台</h4> <p>Sentinel Dashboard 是 Sentinel 的可视化管理控制台，基于 Spring Boot 开发，提供规则配置、实时监控、告警管理、链路追踪等核心功能，核心作用：</p> <ul><li>规则管理：支持可视化配置所有类型的规则，支持规则的新增、编辑、删除、推送；</li> <li>实时监控：展示应用的整体 QPS、响应时间、限流/降级次数，以及单个资源的详细统计数据；</li> <li>链路追踪：展示应用的调用链路拓扑，清晰呈现资源间的依赖关系；</li> <li>告警管理：配置告警规则（如 QPS 超过阈值、失败率过高），支持多种告警渠道（钉钉、邮件、短信）；</li> <li>机器管理：管理接入的应用实例，支持实例的健康状态监控。</li></ul> <p>Dashboard 与应用实例的交互机制：应用实例启动后主动向 Dashboard 注册，通过 HTTP 协议上报实时监控数据；Dashboard 通过 HTTP 协议向应用实例推送规则配置。</p> <h2 id="三、spring-cloud-sentinel-工作流程底层解析"><a href="#三、spring-cloud-sentinel-工作流程底层解析" class="header-anchor">#</a> 三、Spring Cloud Sentinel 工作流程底层解析</h2> <p>结合上述核心组件，Spring Cloud Sentinel 的完整工作流程可分为 8 个关键步骤，从资源调用触发到规则校验、统计监控，形成闭环的流量治理链路：</p> <h3 id="步骤-1-资源定义与埋点初始化"><a href="#步骤-1-资源定义与埋点初始化" class="header-anchor">#</a> 步骤 1：资源定义与埋点初始化</h3> <p>应用启动时，Sentinel 会扫描 @SentinelResource 注解（或解析代码式埋点），完成资源的初始化：</p> <ul><li>注解式埋点：通过 Spring AOP 生成代理类，在目标方法执行前后插入 Sentinel 核心 API（SphU.entry() 和 entry.exit()）的调用逻辑；</li> <li>资源元数据注册：将资源名、降级方法、blockHandler 方法等元数据注册到 Sentinel 核心库的资源注册表中。</li></ul> <h3 id="步骤-2-请求触发资源调用-创建-context"><a href="#步骤-2-请求触发资源调用-创建-context" class="header-anchor">#</a> 步骤 2：请求触发资源调用，创建 Context</h3> <p>当客户端发送请求触发资源调用时（如访问 @SentinelResource 注解的接口），Sentinel 首先通过 ContextUtil 创建 Context：</p> <ul><li>默认场景（HTTP 请求）：Web 拦截器自动创建 Context，Context 名称为应用名称，调用来源（origin）可通过请求头或自定义逻辑设置；</li> <li>自定义场景：通过 ContextUtil.enter() 手动创建 Context，指定 Context 名称和调用来源。</li></ul> <h3 id="步骤-3-创建-entry-触发-processorslot-链"><a href="#步骤-3-创建-entry-触发-processorslot-链" class="header-anchor">#</a> 步骤 3：创建 Entry，触发 ProcessorSlot 链</h3> <p>通过 SphU.entry() 方法创建 Entry 对象，Entry 代表当前资源的调用入口，创建过程中会触发 ProcessorSlot 链的初始化与执行：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Sentinel 核心 API 入口逻辑（简化）</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Entry</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">String</span> resourceName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 获取资源元数据</span>
    <span class="token class-name">ResourceWrapper</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">OUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 创建 Entry，触发 ProcessorSlot 链执行</span>
    <span class="token keyword">return</span> <span class="token class-name">Env</span><span class="token punctuation">.</span>sph<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">OBJECTS0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Entry 创建成功后，请求进入 ProcessorSlot 链的流转过程。</p> <h3 id="步骤-4-processorslot-链执行-节点选择与集群构建"><a href="#步骤-4-processorslot-链执行-节点选择与集群构建" class="header-anchor">#</a> 步骤 4：ProcessorSlot 链执行（节点选择与集群构建）</h3> <p>请求首先经过 NodeSelectorSlot 和 ClusterBuilderSlot：</p> <ul><li>NodeSelectorSlot：根据当前 Context 和资源，创建或获取对应的 DefaultNode，并将 Entry 与 DefaultNode 关联；</li> <li>ClusterBuilderSlot：根据资源名，创建或获取对应的 ClusterNode，聚合该资源的全系统统计数据。</li></ul> <h3 id="步骤-5-统计数据收集-statisticslot"><a href="#步骤-5-统计数据收集-statisticslot" class="header-anchor">#</a> 步骤 5：统计数据收集（StatisticSlot）</h3> <p>请求进入 StatisticSlot，该 Slot 是核心统计节点，负责收集资源调用的实时数据：</p> <ol><li>开始计时：记录请求开始时间，用于计算响应时间；</li> <li>更新统计数据：将当前请求计入对应的 DefaultNode 和 ClusterNode 的滑动窗口中，更新 QPS 计数；</li> <li>传递请求：将请求传递给下一个 Slot。</li></ol> <p>核心统计逻辑（滑动窗口）：每个滑动窗口包含多个时间桶，每个时间桶存储 100ms 内的统计数据，StatisticSlot 会根据当前时间找到对应的时间桶，更新桶内的请求数、成功数等数据。</p> <h3 id="步骤-6-规则校验-授权、热点限流、流量控制、熔断降级"><a href="#步骤-6-规则校验-授权、热点限流、流量控制、熔断降级" class="header-anchor">#</a> 步骤 6：规则校验（授权、热点限流、流量控制、熔断降级）</h3> <p>请求依次经过 AuthoritySlot、ParamFlowSlot、FlowSlot、DegradeSlot，各 Slot 分别校验对应的规则：</p> <ol><li>AuthoritySlot：校验授权规则，若调用来源在黑名单中，抛出 AuthorityException，触发限流；</li> <li>ParamFlowSlot：校验热点参数限流规则，提取请求中的热点参数（如用户 ID），根据统计数据判断是否超过阈值，若超过则抛出 ParamFlowException；</li> <li>FlowSlot：校验流量控制规则，根据 ClusterNode/DefaultNode 的实时 QPS 或并发线程数，判断是否超过阈值，若超过则抛出 FlowException；</li> <li>DegradeSlot：校验熔断降级规则，根据 ClusterNode 的失败率或平均响应时间，判断是否触发熔断，若触发则抛出 DegradeException。</li></ol> <p>若任意 Slot 校验失败（抛出 BlockException 及其子类），则直接中断 ProcessorSlot 链，进入限流/降级处理逻辑；若所有规则校验通过，则执行后续的业务逻辑。</p> <h3 id="步骤-7-业务逻辑执行与统计数据更新"><a href="#步骤-7-业务逻辑执行与统计数据更新" class="header-anchor">#</a> 步骤 7：业务逻辑执行与统计数据更新</h3> <p>规则校验通过后，执行资源对应的业务逻辑：</p> <ul><li>业务逻辑执行成功：在 Entry.exit() 方法中，StatisticSlot 会更新成功数、响应时间等统计数据；</li> <li>业务逻辑执行失败：捕获异常，StatisticSlot 会更新失败数统计数据，若配置了熔断降级规则，失败数会作为熔断判断的依据。</li></ul> <h3 id="步骤-8-监控数据上报与-context-销毁"><a href="#步骤-8-监控数据上报与-context-销毁" class="header-anchor">#</a> 步骤 8：监控数据上报与 Context 销毁</h3> <p>业务逻辑执行完成后，Entry 被释放，Context 被销毁：</p> <ul><li>监控数据上报：应用实例定期（默认 1s）将 ClusterNode 的统计数据上报给 Sentinel Dashboard；</li> <li>Context 销毁：释放 Context 占用的资源，避免内存泄漏。</li></ul> <h2 id="四、关键特性底层实现"><a href="#四、关键特性底层实现" class="header-anchor">#</a> 四、关键特性底层实现</h2> <h3 id="_4-1-流量控制-基于令牌桶-漏桶算法的流量管控"><a href="#_4-1-流量控制-基于令牌桶-漏桶算法的流量管控" class="header-anchor">#</a> 4.1 流量控制：基于令牌桶/漏桶算法的流量管控</h3> <p>流量控制是 Sentinel 的核心特性，目的是限制资源的 QPS 或并发线程数，避免流量超过资源承载能力。其底层基于经典的限流算法实现，支持多种流量控制模式。</p> <h4 id="_4-1-1-核心算法"><a href="#_4-1-1-核心算法" class="header-anchor">#</a> 4.1.1 核心算法</h4> <ul><li>令牌桶算法（默认）：系统以固定速率向令牌桶中放入令牌，请求到达时需要获取令牌才能执行，若令牌桶为空则拒绝请求。该算法支持突发流量（令牌桶有容量，可累积令牌），适用于大多数场景；</li> <li>漏桶算法：请求进入漏桶后，以固定速率流出，若漏桶已满则拒绝请求。该算法可平滑流量，适用于需要严格控制流出速率的场景。</li></ul> <h4 id="_4-1-2-流量控制模式"><a href="#_4-1-2-流量控制模式" class="header-anchor">#</a> 4.1.2 流量控制模式</h4> <ul><li>直接模式：直接对当前资源进行限流，适用于保护当前资源本身；</li> <li>关联模式：当关联的资源（如 /order/create）达到限流阈值时，对当前资源（如 /user/get）进行限流，适用于保护核心资源（如订单创建）不受非核心资源（如用户查询）的流量冲击；</li> <li>链路模式：仅对指定调用链路的资源进行限流，适用于链路级别的流量控制（如仅限制从 /order/create 调用 /user/get 的流量）。</li></ul> <h4 id="_4-1-3-底层实现逻辑-flowslot"><a href="#_4-1-3-底层实现逻辑-flowslot" class="header-anchor">#</a> 4.1.3 底层实现逻辑（FlowSlot）</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 流量控制核心逻辑（简化，位于 FlowSlot 中）</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 获取当前资源的所有流量控制规则</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getRulesOfResource</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rules<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 无规则，直接放行</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 2. 遍历规则，校验是否触发限流</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 触发限流，抛出 FlowException</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 3. 所有规则校验通过，放行</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>rule.passCheck() 方法会根据规则的限流模式、算法类型，结合 Node 的实时统计数据（QPS/并发线程数）判断是否允许请求通过。</p> <h3 id="_4-2-熔断降级-基于状态机的故障隔离"><a href="#_4-2-熔断降级-基于状态机的故障隔离" class="header-anchor">#</a> 4.2 熔断降级：基于状态机的故障隔离</h3> <p>熔断降级的核心目标是当下游资源出现故障（如高失败率、长响应时间）时，快速切断调用链路，避免故障扩散，待下游资源恢复后再恢复调用。Sentinel 熔断降级基于状态机模型实现，支持多种熔断策略。</p> <h4 id="_4-2-1-熔断状态机"><a href="#_4-2-1-熔断状态机" class="header-anchor">#</a> 4.2.1 熔断状态机</h4> <p>Sentinel 熔断降级包含三个状态，状态之间通过规则阈值和时间触发转换：</p> <ul><li>关闭状态（CLOSED）：正常状态，允许请求调用资源，实时统计失败率/响应时间；当统计数据达到阈值时，转换为开启状态；</li> <li>开启状态（OPEN）：熔断状态，拒绝所有请求，直接执行降级逻辑；经过熔断时长后，转换为半开启状态；</li> <li>半开启状态（HALF_OPEN）：试探状态，允许少量请求（默认 5 个）调用资源；若这些请求的成功率达到阈值，转换为关闭状态；若失败率仍超过阈值，继续保持开启状态。</li></ul> <h4 id="_4-2-2-熔断策略"><a href="#_4-2-2-熔断策略" class="header-anchor">#</a> 4.2.2 熔断策略</h4> <ul><li>基于失败率：当资源的调用失败率（失败次数/总次数）超过阈值（默认 50%），且总调用次数超过最小请求数（默认 5）时，触发熔断；</li> <li>基于平均响应时间：当资源的平均响应时间超过阈值（默认 500ms），且总调用次数超过最小请求数时，触发熔断；</li> <li>基于异常数：当资源的调用异常数超过阈值，且总调用次数超过最小请求数时，触发熔断。</li></ul> <h4 id="_4-2-3-底层实现逻辑-degradeslot"><a href="#_4-2-3-底层实现逻辑-degradeslot" class="header-anchor">#</a> 4.2.3 底层实现逻辑（DegradeSlot）</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 熔断降级核心逻辑（简化，位于 DegradeSlot 中）</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 获取当前资源的所有熔断降级规则</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">getRulesOfResource</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> rules<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 2. 遍历规则，校验是否触发熔断</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DegradeRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span><span class="token function">passCheck</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 触发熔断，抛出 DegradeException</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DegradeException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 3. 所有规则校验通过，放行</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>rule.passCheck() 方法会根据规则的熔断策略，查询资源对应的熔断状态机，结合实时统计数据判断是否允许请求通过。</p> <h3 id="_4-3-热点参数限流-基于参数维度的精准管控"><a href="#_4-3-热点参数限流-基于参数维度的精准管控" class="header-anchor">#</a> 4.3 热点参数限流：基于参数维度的精准管控</h3> <p>热点参数限流是对“资源的热点参数”进行精准限流，适用于某一资源的部分参数访问频率极高的场景（如某商品 ID 被高频抢购、某用户 ID 高频查询）。其底层通过参数统计模型实现，支持对指定参数索引或参数值进行限流。</p> <h4 id="_4-3-1-核心实现逻辑"><a href="#_4-3-1-核心实现逻辑" class="header-anchor">#</a> 4.3.1 核心实现逻辑</h4> <ol><li>参数提取：通过 ParamFlowSlot 提取请求中的参数（支持基本类型、字符串、数组等），根据规则指定的参数索引（如第 0 个参数）定位热点参数；</li> <li>参数统计：为每个热点参数维护独立的滑动窗口统计数据，避免不同参数之间的干扰；</li> <li>限流判断：根据规则的阈值（如 QPS 100），判断当前热点参数的访问频率是否超过阈值，若超过则触发限流。</li></ol> <h4 id="_4-3-2-高级特性-参数例外项"><a href="#_4-3-2-高级特性-参数例外项" class="header-anchor">#</a> 4.3.2 高级特性：参数例外项</h4> <p>支持为热点参数配置例外项，对特殊参数值设置不同的限流阈值（如对商品 ID=10086 设置更高的阈值，或直接放行），示例配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">param-flow-ds</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> sentinel<span class="token punctuation">-</span>param<span class="token punctuation">-</span>flow<span class="token punctuation">-</span>rules
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> param<span class="token punctuation">-</span>flow
          <span class="token key atrule">rules</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">resource</span><span class="token punctuation">:</span> getUserById
              <span class="token key atrule">grade</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 1 表示 QPS 限流</span>
              <span class="token key atrule">paramIdx</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token comment"># 参数索引，0 表示第一个参数（id）</span>
              <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment"># 默认阈值：QPS 10</span>
              <span class="token key atrule">exceptions</span><span class="token punctuation">:</span> <span class="token comment"># 例外项</span>
                <span class="token punctuation">-</span> <span class="token key atrule">item</span><span class="token punctuation">:</span> <span class="token number">10086</span> <span class="token comment"># 参数值为 10086</span>
                  <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">100</span> <span class="token comment"># 例外阈值：QPS 100</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_4-4-系统自适应保护-基于系统负载的全局管控"><a href="#_4-4-系统自适应保护-基于系统负载的全局管控" class="header-anchor">#</a> 4.4 系统自适应保护：基于系统负载的全局管控</h3> <p>系统自适应保护是从系统整体负载出发，动态调整流量准入策略，避免系统因 CPU、内存、磁盘 IO 等资源耗尽而崩溃。其底层基于系统负载指标（如 CPU 使用率、系统负载 average）实现，支持多种保护策略。</p> <h4 id="_4-4-1-核心保护策略"><a href="#_4-4-1-核心保护策略" class="header-anchor">#</a> 4.4.1 核心保护策略</h4> <ul><li>CPU 使用率保护：当 CPU 使用率超过阈值（默认 80%）时，触发流量控制；</li> <li>系统负载保护：当系统 1min 负载 average 超过阈值（默认 3）时，触发流量控制（仅支持 Linux 系统）；</li> <li>内存保护：当内存使用率超过阈值时，触发流量控制；</li> <li>入口 QPS 保护：限制系统的总入口 QPS，避免总流量超过系统承载能力。</li></ul> <h4 id="_4-4-2-底层实现逻辑"><a href="#_4-4-2-底层实现逻辑" class="header-anchor">#</a> 4.4.2 底层实现逻辑</h4> <p>系统自适应保护规则由 SystemSlot 负责校验，核心逻辑是定期采集系统负载指标，当指标超过阈值时，通过“令牌桶算法”动态调整流量准入速率，逐步减少流量，直至系统负载恢复正常。</p> <h2 id="五、实践优化与最佳实践"><a href="#五、实践优化与最佳实践" class="header-anchor">#</a> 五、实践优化与最佳实践</h2> <h3 id="_5-1-规则配置最佳实践"><a href="#_5-1-规则配置最佳实践" class="header-anchor">#</a> 5.1 规则配置最佳实践</h3> <ul><li>资源命名规范：采用“业务模块-接口名”的格式（如 user-getUserById、order-createOrder），便于规则管理和监控；</li> <li>规则粒度控制：核心资源（如订单创建、支付接口）采用更严格的限流阈值，非核心资源（如数据查询）可适当放宽；</li> <li>动态数据源优先：使用 Nacos/Apollo 等动态数据源存储规则，避免硬编码，支持规则的实时更新与持久化；</li> <li>熔断降级配置：核心资源建议同时配置失败率和平均响应时间熔断规则，确保故障快速隔离。</li></ul> <h3 id="_5-2-性能优化"><a href="#_5-2-性能优化" class="header-anchor">#</a> 5.2 性能优化</h3> <ul><li>关闭不必要的统计：对于非核心资源，可通过配置关闭详细的统计数据（如响应时间分布），减少内存占用；</li> <li>合理设置滑动窗口参数：核心资源可缩小窗口桶数（如 5 个桶，每个桶 200ms），提升统计实时性；非核心资源可增大窗口桶数，减少计算开销；</li> <li>避免过度埋点：仅对关键资源（核心接口、耗时操作）进行埋点，减少埋点对业务性能的影响；</li> <li>集群限流优化：对于集群部署的应用，使用集群限流替代单机限流，避免因单机负载不均导致的整体雪崩。</li></ul> <h3 id="_5-3-监控与告警配置"><a href="#_5-3-监控与告警配置" class="header-anchor">#</a> 5.3 监控与告警配置</h3> <ul><li>核心资源告警：为核心资源配置告警规则（如 QPS 突增、失败率超过 10%），确保异常及时发现；</li> <li>多渠道告警：结合业务场景配置多种告警渠道（钉钉群告警用于实时响应，邮件告警用于归档）；</li> <li>监控数据持久化：通过 Sentinel 的 MetricExporter 扩展，将监控数据持久化到 Prometheus、Elasticsearch 等系统，支持长期分析。</li></ul> <h3 id="_5-4-与-spring-cloud-生态组件集成"><a href="#_5-4-与-spring-cloud-生态组件集成" class="header-anchor">#</a> 5.4 与 Spring Cloud 生态组件集成</h3> <ul><li>与 Feign 集成：通过 @SentinelFeign 注解为 Feign 客户端启用 Sentinel 保护，实现服务间调用的限流与降级；</li> <li>与 Spring Cloud Gateway 集成：通过 SentinelGatewayFilter 实现网关层的流量控制，支持路由级、接口级的限流；</li> <li>与 Dubbo 集成：通过 Sentinel-Dubbo 适配器，为 Dubbo 服务提供者和消费者提供限流、降级能力；</li> <li>与 Spring Security 集成：结合授权规则，实现基于用户角色的流量控制。</li></ul> <h2 id="六、总结"><a href="#六、总结" class="header-anchor">#</a> 六、总结</h2> <p>Spring Cloud Sentinel 以“流量为切入点”，通过核心库的 ProcessorSlot 责任链机制，实现了流量控制、熔断降级、热点参数限流、系统自适应保护等全链路流量治理能力，其轻量级、高性能的设计使其完美适配微服务架构的高并发场景。</p> <p>从底层原理来看，Sentinel 的核心是“资源定义-规则配置-统计监控-规则校验”的闭环链路，通过滑动窗口算法实现实时统计，基于状态机和经典限流算法实现流量治理。理解这些核心机制，有助于开发者在实际应用中精准配置规则、快速定位问题，如限流不生效可能是资源名不匹配，熔断不触发可能是最小请求数未达到阈值等。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《Spring》笔记/8.Spring Cloud Sentinel.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Spring%20Cloud%20Sentinel%20%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="标签">#Spring Cloud Sentinel 深度解析</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/61e1cc/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Spring Cloud Seata 深度解析</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/61e1cc/" class="prev">Spring Cloud Seata 深度解析</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/84.f5a347be.js" defer></script>
  </body>
</html>
