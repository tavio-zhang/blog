<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL查询优化 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/60.800afb74.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/48.7d4f854a.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/55.27ff3cca.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/79.486534af.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/83.72b7d6a4.js"><link rel="prefetch" href="/assets/js/84.f5a347be.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/929a6c/" class="sidebar-link">MySQL InnoDB</a></li><li><a href="/pages/4a8639/" class="sidebar-link">MySQL缓冲池与WAL机制</a></li><li><a href="/pages/976017/" class="sidebar-link">MySQL索引底层</a></li><li><a href="/pages/778452/" class="sidebar-link">MySQL事务与MVCC</a></li><li><a href="/pages/070a30/" class="sidebar-link">MySQL锁机制</a></li><li><a href="/pages/8b3524/" class="sidebar-link">MySQL Binlog</a></li><li><a href="/pages/75718e/" class="sidebar-link">MySQL崩溃恢复</a></li><li><a href="/pages/b99ebc/" aria-current="page" class="active sidebar-link">MySQL查询优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#一、先明确-查询优化器在sql执行流程中的定位" class="sidebar-link">一、先明确：查询优化器在SQL执行流程中的定位</a></li><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#二、查询优化器的核心工作-从逻辑查询树到物理执行计划" class="sidebar-link">二、查询优化器的核心工作：从逻辑查询树到物理执行计划</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_2-1-第一阶段-逻辑优化-重构查询逻辑-降低数据量" class="sidebar-link">2.1 第一阶段：逻辑优化——重构查询逻辑，降低数据量</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-1-谓词下推-predicate-pushdown" class="sidebar-link">2.1.1 谓词下推（Predicate Pushdown）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-2-连接重排-join-reordering" class="sidebar-link">2.1.2 连接重排（Join Reordering）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-3-常量折叠与常量传播-constant-folding-propagation" class="sidebar-link">2.1.3 常量折叠与常量传播（Constant Folding &amp; Propagation）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-4-消除冗余条件-redundant-condition-elimination" class="sidebar-link">2.1.4 消除冗余条件（Redundant Condition Elimination）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-5-子查询优化-subquery-optimization" class="sidebar-link">2.1.5 子查询优化（Subquery Optimization）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-1-6-聚合函数优化-aggregation-optimization" class="sidebar-link">2.1.6 聚合函数优化（Aggregation Optimization）</a></li><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_2-2-第二阶段-物理优化-选择最优执行方式与索引" class="sidebar-link">2.2 第二阶段：物理优化——选择最优执行方式与索引</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-2-1-核心任务1-索引选择-最关键的物理优化" class="sidebar-link">2.2.1 核心任务1：索引选择（最关键的物理优化）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-2-2-核心任务2-执行算法选择-连接、排序、聚合的算法" class="sidebar-link">2.2.2 核心任务2：执行算法选择（连接、排序、聚合的算法）</a></li><li class="sidebar-sub-header level5"><a href="/pages/b99ebc/#_1-连接算法选择-三种核心算法" class="sidebar-link">（1）连接算法选择（三种核心算法）</a></li><li class="sidebar-sub-header level5"><a href="/pages/b99ebc/#_2-排序算法选择-文件排序vs索引排序" class="sidebar-link">（2）排序算法选择（文件排序vs索引排序）</a></li><li class="sidebar-sub-header level5"><a href="/pages/b99ebc/#_3-聚合算法选择-松散索引扫描vs紧凑索引扫描" class="sidebar-link">（3）聚合算法选择（松散索引扫描vs紧凑索引扫描）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#三、关键支撑-执行计划的成本估算模型" class="sidebar-link">三、关键支撑：执行计划的成本估算模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_3-1-成本的核心构成-io成本-cpu成本" class="sidebar-link">3.1 成本的核心构成：IO成本 + CPU成本</a></li><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_3-2-成本估算的依据-统计信息-statistics" class="sidebar-link">3.2 成本估算的依据：统计信息（Statistics）</a></li><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_3-3-成本估算示例-全表扫描vs索引扫描" class="sidebar-link">3.3 成本估算示例：全表扫描vs索引扫描</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_1-全表扫描的成本估算" class="sidebar-link">（1）全表扫描的成本估算</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-索引扫描-idx-age-的成本估算" class="sidebar-link">（2）索引扫描（idx_age）的成本估算</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_3-优化器的选择" class="sidebar-link">（3）优化器的选择</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#四、如何查看与解读执行计划-实践核心" class="sidebar-link">四、如何查看与解读执行计划？（实践核心）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_4-1-执行计划的核心字段解读" class="sidebar-link">4.1 执行计划的核心字段解读</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_1-id-查询的执行顺序标识" class="sidebar-link">（1）id：查询的执行顺序标识</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_2-select-type-查询类型" class="sidebar-link">（2）select_type：查询类型</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_3-table-当前行对应的表名-或临时表标识" class="sidebar-link">（3）table：当前行对应的表名（或临时表标识）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_4-type-访问类型-最关键的性能指标" class="sidebar-link">（4）type：访问类型（最关键的性能指标）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_5-possible-keys-候选索引列表" class="sidebar-link">（5）possible_keys：候选索引列表</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_6-key-实际使用的索引" class="sidebar-link">（6）key：实际使用的索引</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_7-key-len-使用的索引长度-单位字节" class="sidebar-link">（7）key_len：使用的索引长度（单位字节）</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_8-ref-与索引匹配的列或常量" class="sidebar-link">（8）ref：与索引匹配的列或常量</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_9-rows-优化器估算的扫描行数" class="sidebar-link">（9）rows：优化器估算的扫描行数</a></li><li class="sidebar-sub-header level4"><a href="/pages/b99ebc/#_10-extra-额外执行信息-核心优化依据" class="sidebar-link">（10）Extra：额外执行信息（核心优化依据）</a></li><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_4-2-执行计划解读实例" class="sidebar-link">4.2 执行计划解读实例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#五、影响优化器决策的关键因素与优化建议" class="sidebar-link">五、影响优化器决策的关键因素与优化建议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_5-1-影响优化器决策的核心因素" class="sidebar-link">5.1 影响优化器决策的核心因素</a></li><li class="sidebar-sub-header level3"><a href="/pages/b99ebc/#_5-2-实践优化建议" class="sidebar-link">5.2 实践优化建议</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/b99ebc/#六、总结" class="sidebar-link">六、总结</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/mysql/#《MySQL》笔记" data-v-06225672>《MySQL》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-09-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">MySQL查询优化<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="深度解析mysql查询优化器-sql执行计划的生成逻辑"><a href="#深度解析mysql查询优化器-sql执行计划的生成逻辑" class="header-anchor">#</a> 深度解析MySQL查询优化器：SQL执行计划的生成逻辑</h1> <p>在MySQL的整个SQL执行链路中，查询优化器（Query Optimizer）是当之无愧的“大脑”——它负责将用户编写的SQL语句（尤其是复杂的查询语句）转化为高效的执行方案，这个方案就是<strong>执行计划（Execution Plan）</strong>。同样一条SQL，不同的执行方式可能带来天差地别的性能表现：比如简单的“查询用户订单”，可能走全表扫描耗时10秒，也可能走索引扫描耗时10毫秒，而这背后的决策全靠查询优化器。</p> <h2 id="一、先明确-查询优化器在sql执行流程中的定位"><a href="#一、先明确-查询优化器在sql执行流程中的定位" class="header-anchor">#</a> 一、先明确：查询优化器在SQL执行流程中的定位</h2> <p>在深入优化器之前，我们需要先梳理SQL从输入到结果返回的完整流程，明确查询优化器所处的核心环节。一条SQL的执行大致分为6个阶段：</p> <ol><li><strong>词法分析（Lexical Analysis）</strong>：将SQL语句拆分为一个个“词法单元”（如关键字SELECT、表名user、字段名id、运算符=等），识别每个单元的类型。例如，将“SELECT id, name FROM user WHERE age &gt; 20”拆分为“SELECT”（关键字）、“id”（字段）、“name”（字段）、“FROM”（关键字）、“user”（表名）等。</li> <li><strong>语法分析（Syntactic Analysis）</strong>：根据词法单元构建<strong>抽象语法树（AST）</strong>，验证SQL语法是否合法。例如，检查是否遗漏关键字FROM、是否有未闭合的括号等。若语法错误，直接返回错误信息（如“You have an error in your SQL syntax”）。</li> <li><strong>预处理（Preprocessing）</strong>：对AST进行语义校验和补充，生成<strong>逻辑查询树（Logical Query Tree）</strong>。核心操作包括：验证表/字段是否存在、验证用户权限、处理视图（将视图替换为对应的基表查询）、简化常量表达式（如将“1+2”直接计算为“3”）等。</li> <li><strong>查询优化（Query Optimization）</strong>：查询优化器的核心工作阶段。接收预处理后的逻辑查询树，通过一系列优化规则（逻辑优化+物理优化）生成多个可能的执行方案，再通过<strong>成本估算模型</strong>选择成本最低的方案，最终生成<strong>物理执行计划</strong>。</li> <li><strong>执行计划执行（Execution）</strong>：执行器（Executor）按照优化器生成的物理执行计划，调用存储引擎（如InnoDB）的接口执行查询，获取数据。</li> <li><strong>结果返回（Result Return）</strong>：将执行结果整理后返回给用户（若为SELECT查询），或返回执行状态（如INSERT/UPDATE的影响行数）。</li></ol> <p>可以看出，查询优化器是连接“SQL语义”与“高效执行”的桥梁——它不关心SQL的语法是否正确，只专注于“如何以最低成本执行查询”。其输出的“执行计划”，就是执行器的“操作手册”。</p> <h2 id="二、查询优化器的核心工作-从逻辑查询树到物理执行计划"><a href="#二、查询优化器的核心工作-从逻辑查询树到物理执行计划" class="header-anchor">#</a> 二、查询优化器的核心工作：从逻辑查询树到物理执行计划</h2> <p>查询优化的过程，本质是“将逻辑查询树转化为最优物理执行计划”的过程，分为两大核心阶段：<strong>逻辑优化</strong>（不涉及具体执行方式，仅优化查询的逻辑结构）和<strong>物理优化</strong>（结合存储引擎特性，选择具体的执行算法和索引）。两个阶段层层递进，最终生成可执行的物理执行计划。</p> <h3 id="_2-1-第一阶段-逻辑优化-重构查询逻辑-降低数据量"><a href="#_2-1-第一阶段-逻辑优化-重构查询逻辑-降低数据量" class="header-anchor">#</a> 2.1 第一阶段：逻辑优化——重构查询逻辑，降低数据量</h3> <p>逻辑优化的目标是“在不改变查询结果的前提下，通过重构逻辑查询树，减少后续执行过程中需要处理的数据量”。核心优化手段包括以下6类，每类都有明确的应用场景：</p> <h4 id="_2-1-1-谓词下推-predicate-pushdown"><a href="#_2-1-1-谓词下推-predicate-pushdown" class="header-anchor">#</a> 2.1.1 谓词下推（Predicate Pushdown）</h4> <p>将过滤条件（WHERE子句中的条件）尽可能“下推”到最接近数据源的地方（如基表扫描、索引查询阶段），提前过滤掉无用数据，减少后续连接或聚合的数据量。这是最常用、效果最显著的逻辑优化手段。</p> <p>示例：查询“用户表与订单表连接后，筛选年龄&gt;20的用户订单”。原始逻辑可能是“先连接两表，再过滤年龄&gt;20”；优化后逻辑是“先过滤用户表中年龄&gt;20的用户，再与订单表连接”——提前过滤掉大量不符合条件的用户，减少连接的数据量。</p> <p>对应SQL优化前后对比：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 优化前（逻辑上的原始查询，MySQL会自动优化）</span>
<span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> o<span class="token punctuation">.</span>order_no 
<span class="token keyword">FROM</span> <span class="token keyword">user</span> u 
<span class="token keyword">JOIN</span> <span class="token keyword">order</span> o <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>user_id 
<span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>age <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- 优化后（MySQL实际执行的逻辑）</span>
<span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> o<span class="token punctuation">.</span>order_no 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> u  <span class="token comment">-- 先过滤，再连接</span>
<span class="token keyword">JOIN</span> <span class="token keyword">order</span> o <span class="token keyword">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> o<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="_2-1-2-连接重排-join-reordering"><a href="#_2-1-2-连接重排-join-reordering" class="header-anchor">#</a> 2.1.2 连接重排（Join Reordering）</h4> <p>当查询涉及多表连接时，连接顺序对执行成本影响极大。MySQL的核心原则是“小表驱动大表”——用数据量小的表作为驱动表（外层循环），数据量大的表作为被驱动表（内层循环），减少内层循环的执行次数。</p> <p>示例：用户表（1000行）、订单表（100万行）、商品表（1万行）三表连接。优化器会自动选择“用户表（小表）→商品表（中表）→订单表（大表）”的连接顺序，而非随机顺序，大幅减少连接过程中的中间结果集大小。</p> <p>补充：MySQL对多表连接的优化能力有限，当连接表数量超过6张时，优化器可能无法遍历所有可能的连接顺序，此时可能需要手动调整表的顺序（但更推荐通过索引优化减少连接成本）。</p> <h4 id="_2-1-3-常量折叠与常量传播-constant-folding-propagation"><a href="#_2-1-3-常量折叠与常量传播-constant-folding-propagation" class="header-anchor">#</a> 2.1.3 常量折叠与常量传播（Constant Folding &amp; Propagation）</h4> <p>常量折叠：将查询中的常量表达式直接计算出结果，避免执行时重复计算。例如，将“WHERE age &gt; 18+2”优化为“WHERE age &gt; 20”，将“SELECT id<em>10 FROM user”中的“id</em>10”保留（需执行时计算，但常量部分已折叠）。</p> <p>常量传播：若查询中存在“列=常量”的条件，将该常量传播到其他依赖该列的条件中，进一步简化查询。例如，“SELECT * FROM user WHERE id=10 AND age &gt; (SELECT min_age FROM config WHERE user_id=id)”，优化后将“id=10”传播到子查询，得到“user_id=10”，子查询可直接定位结果。</p> <h4 id="_2-1-4-消除冗余条件-redundant-condition-elimination"><a href="#_2-1-4-消除冗余条件-redundant-condition-elimination" class="header-anchor">#</a> 2.1.4 消除冗余条件（Redundant Condition Elimination）</h4> <p>删除查询中重复或无效的过滤条件，简化逻辑。例如：</p> <ul><li>删除重复条件：“WHERE age &gt; 20 AND age &gt; 20”优化为“WHERE age &gt; 20”。</li> <li>删除永真/永假条件：“WHERE age &gt; 20 AND 1=1”优化为“WHERE age &gt; 20”；“WHERE age &gt; 20 AND 1=0”优化为“WHERE 1=0”（直接返回空结果，无需执行后续查询）。</li></ul> <h4 id="_2-1-5-子查询优化-subquery-optimization"><a href="#_2-1-5-子查询优化-subquery-optimization" class="header-anchor">#</a> 2.1.5 子查询优化（Subquery Optimization）</h4> <p>MySQL对非关联子查询（子查询不依赖外层表字段）和关联子查询的优化策略不同：</p> <ul><li>非关联子查询：将子查询结果缓存（如“SELECT * FROM user WHERE age &gt; (SELECT avg(age) FROM user)”），避免重复执行子查询。</li> <li>关联子查询：将其转化为JOIN查询（即“子查询扁平化”），因为JOIN的执行效率通常高于关联子查询的循环执行。例如，“SELECT * FROM user u WHERE EXISTS (SELECT 1 FROM order o WHERE o.user_id = u.id)”优化为“SELECT u.* FROM user u JOIN order o ON u.id = o.user_id GROUP BY u.id”。</li></ul> <h4 id="_2-1-6-聚合函数优化-aggregation-optimization"><a href="#_2-1-6-聚合函数优化-aggregation-optimization" class="header-anchor">#</a> 2.1.6 聚合函数优化（Aggregation Optimization）</h4> <p>对GROUP BY、DISTINCT等聚合操作进行优化，减少聚合的数据量：</p> <ul><li>DISTINCT优化：若DISTINCT与聚合函数结合（如“SELECT DISTINCT count(id) FROM user”），优化器会先聚合再去重（或反之），选择成本更低的方式；若DISTINCT查询可通过索引覆盖（即索引包含所有需要的字段），则直接通过索引去重，无需扫描全表。</li> <li>GROUP BY优化：若GROUP BY的字段存在索引，优化器会利用索引的有序性，避免额外的排序操作（即“Using index for group-by”，可通过EXPLAIN查看）。</li></ul> <h3 id="_2-2-第二阶段-物理优化-选择最优执行方式与索引"><a href="#_2-2-第二阶段-物理优化-选择最优执行方式与索引" class="header-anchor">#</a> 2.2 第二阶段：物理优化——选择最优执行方式与索引</h3> <p>逻辑优化完成后，得到的是“优化后的逻辑查询树”（明确了查询的逻辑步骤，如“先过滤用户表→再与订单表连接→最后聚合”），但未明确“每个步骤具体如何执行”（如过滤用户表时用全表扫描还是索引扫描？连接时用嵌套循环还是哈希连接？）。物理优化的核心就是“为逻辑查询树的每个节点选择具体的执行算法和索引”，生成多个物理执行计划，再通过成本估算选择最优方案。</p> <h4 id="_2-2-1-核心任务1-索引选择-最关键的物理优化"><a href="#_2-2-1-核心任务1-索引选择-最关键的物理优化" class="header-anchor">#</a> 2.2.1 核心任务1：索引选择（最关键的物理优化）</h4> <p>索引选择是物理优化的核心——优化器需要判断“是否使用索引”“使用哪个索引”，甚至“是否使用索引联合”。其决策依据是“索引能减少的数据扫描量”和“索引的维护成本”（如索引查找的IO成本、回表的成本等）。</p> <p>优化器的索引选择逻辑：</p> <ol><li>收集候选索引：针对查询的过滤条件（WHERE）、连接条件（JOIN ON）、排序字段（ORDER BY）、聚合字段（GROUP BY），收集所有可能适用的索引（如主键索引、二级索引、联合索引等）。</li> <li>评估索引有效性：排除无法过滤大量数据的索引（如区分度极低的索引，如“性别”字段的索引，过滤后仍有大量数据，使用索引的成本可能高于全表扫描）。</li> <li>计算索引使用成本：包括“索引查找成本”（从索引树中找到目标数据的IO成本）和“回表成本”（若索引为非覆盖索引，需要通过索引中的主键值查找全表数据的IO成本）。若为覆盖索引（索引包含所有查询需要的字段），则无回表成本，优先级最高。</li> <li>选择成本最低的索引：若存在多个有效索引，选择成本最低的；若所有索引的成本都高于全表扫描，则选择全表扫描。</li></ol> <p>示例：查询“SELECT id, name FROM user WHERE age &gt; 20 AND gender = 'male'”，用户表有两个索引：idx_age（age）、idx_age_gender（age, gender）。优化器会评估：idx_age_gender是联合索引，能同时匹配age和gender条件，过滤效果更好，且若索引包含id、name字段（覆盖索引），则无回表成本，因此会优先选择idx_age_gender，而非idx_age或全表扫描。</p> <h4 id="_2-2-2-核心任务2-执行算法选择-连接、排序、聚合的算法"><a href="#_2-2-2-核心任务2-执行算法选择-连接、排序、聚合的算法" class="header-anchor">#</a> 2.2.2 核心任务2：执行算法选择（连接、排序、聚合的算法）</h4> <p>针对逻辑查询树中的“连接”“排序”“聚合”等操作，优化器会选择具体的执行算法。不同算法适用于不同的数据量和数据分布，优化器根据统计信息选择最优算法。</p> <h5 id="_1-连接算法选择-三种核心算法"><a href="#_1-连接算法选择-三种核心算法" class="header-anchor">#</a> （1）连接算法选择（三种核心算法）</h5> <p>MySQL支持三种连接算法，优化器根据连接表的大小和索引情况选择：</p> <ul><li><strong>嵌套循环连接（Nested-Loop Join, NLJ）</strong>：
原理：外层循环遍历驱动表的每一行，内层循环根据连接条件在被驱动表中查找匹配的行（若被驱动表有索引，内层循环为索引查找；无索引则为全表扫描）。
适用场景：驱动表数据量小（1万行以内），被驱动表有有效索引。
优点：内存占用小，无需缓存大量数据；若被驱动表有索引，效率极高。
缺点：若被驱动表无索引，内层循环为全表扫描，效率极低（即“笛卡尔积”的低效场景）。</li> <li><strong>基于索引的嵌套循环连接（Index Nested-Loop Join, INLJ）</strong>：
原理：NLJ的优化版本——被驱动表的连接字段存在索引，内层循环直接通过索引查找匹配行，无需全表扫描。
适用场景：绝大多数有索引的两表连接场景（MySQL默认优先选择）。</li> <li><strong>哈希连接（Hash Join）</strong>：
原理：将驱动表的数据加载到内存，构建哈希表（以连接字段为key，数据行为value）；再遍历被驱动表的每一行，通过连接字段在哈希表中查找匹配的行。
适用场景：驱动表和被驱动表数据量都较大（10万行以上），且连接字段无索引（或索引区分度低）。
优点：比NLJ（无索引时）效率高得多，避免了内层循环的全表扫描。
缺点：内存占用大，若驱动表数据量超过内存，会使用磁盘哈希表，效率下降。
补充：MySQL 8.0才正式支持哈希连接，5.7及以下版本无此算法，只能用NLJ（无索引时效率极低）。</li> <li><strong>合并连接（Merge Join）</strong>：
原理：先将两个表的连接字段排序，再通过“双指针”遍历两个有序表，匹配连接字段相等的行。
适用场景：两个表的连接字段都已排序（如通过索引有序性），无需额外排序。
优点：排序后匹配效率高，适用于大表连接。
缺点：若表未排序，需要先执行排序操作，成本较高，因此优化器较少选择。</li></ul> <h5 id="_2-排序算法选择-文件排序vs索引排序"><a href="#_2-排序算法选择-文件排序vs索引排序" class="header-anchor">#</a> （2）排序算法选择（文件排序vs索引排序）</h5> <p>针对ORDER BY、GROUP BY等需要排序的操作，优化器有两种选择：</p> <ul><li><strong>索引排序（Using index for order by）</strong>：若排序字段存在索引（且索引有序），直接利用索引的有序性获取数据，无需额外排序。效率极高，是优化器的首选。</li> <li><strong>文件排序（File Sort）</strong>：若排序字段无索引，需要将查询结果加载到内存（或磁盘）中，通过排序算法（如快速排序、归并排序）完成排序。分为两种模式：
<ul><li>内存排序：若排序数据量小于参数<code>sort_buffer_size</code>（默认256KB），直接在内存中完成排序。</li> <li>磁盘排序：若数据量超过sort_buffer_size，会将数据分成多个块，先对每个块进行内存排序，再将排序后的块写入磁盘，最后对所有块进行归并排序（即“外部排序”）。效率较低，应尽量避免。</li></ul></li></ul> <h5 id="_3-聚合算法选择-松散索引扫描vs紧凑索引扫描"><a href="#_3-聚合算法选择-松散索引扫描vs紧凑索引扫描" class="header-anchor">#</a> （3）聚合算法选择（松散索引扫描vs紧凑索引扫描）</h5> <p>针对GROUP BY的聚合操作，若聚合字段存在索引，优化器会选择两种高效的扫描方式：</p> <ul><li><strong>松散索引扫描（Loose Index Scan）</strong>：适用于GROUP BY字段是索引前缀（如联合索引idx_age_gender，GROUP BY age），且无其他过滤条件。优化器会直接扫描索引中不同的age值，无需扫描所有行，效率极高。</li> <li><strong>紧凑索引扫描（Tight Index Scan）</strong>：适用于GROUP BY字段是索引前缀，但存在过滤条件（如“WHERE gender='male' GROUP BY age”）。优化器会扫描索引中符合过滤条件的所有行，再进行聚合，效率低于松散扫描，但高于全表扫描。</li></ul> <h2 id="三、关键支撑-执行计划的成本估算模型"><a href="#三、关键支撑-执行计划的成本估算模型" class="header-anchor">#</a> 三、关键支撑：执行计划的成本估算模型</h2> <p>物理优化阶段会生成多个候选的物理执行计划（如“用idx_age索引扫描用户表+嵌套循环连接订单表”“用全表扫描用户表+哈希连接订单表”等），优化器如何判断哪个计划最优？答案是<strong>成本估算模型</strong>——MySQL为每个执行计划计算一个“成本值”，选择成本值最低的计划作为最终执行计划。</p> <h3 id="_3-1-成本的核心构成-io成本-cpu成本"><a href="#_3-1-成本的核心构成-io成本-cpu成本" class="header-anchor">#</a> 3.1 成本的核心构成：IO成本 + CPU成本</h3> <p>MySQL的成本估算基于“资源消耗”，核心分为两类成本，单位为“成本因子”（1个成本因子约等于1个磁盘页的IO操作成本）：</p> <ul><li><strong>IO成本</strong>：从磁盘读取数据页的成本（是成本的主要构成部分，因为磁盘IO速度远慢于内存操作）。MySQL默认1个数据页的IO成本为1.0（可通过参数<code>innodb_page_size</code>调整页大小，默认16KB）。</li> <li><strong>CPU成本</strong>：在内存中处理数据的成本（如过滤数据、排序、聚合、连接匹配等）。MySQL默认1行数据的CPU处理成本为0.2（可通过参数<code>cpu_cost_per_table</code>、<code>cpu_cost_per_record</code>微调）。</li></ul> <p>总执行成本 = IO成本 + CPU成本</p> <h3 id="_3-2-成本估算的依据-统计信息-statistics"><a href="#_3-2-成本估算的依据-统计信息-statistics" class="header-anchor">#</a> 3.2 成本估算的依据：统计信息（Statistics）</h3> <p>优化器无法直接获取表的真实数据量和数据分布，只能依赖“统计信息”进行估算。统计信息是MySQL通过采样方式收集的表和索引的元数据，存储在系统表<code>mysql.stats</code>中（MySQL 8.0）或<code>information_schema.STATISTICS</code>中。</p> <p>核心统计信息包括：</p> <ul><li><code>table_rows</code>：表的估算行数（非精确值，通过采样计算）。</li> <li><code>data_length</code>：表的数据量大小（单位字节），用于计算全表扫描的IO成本（全表扫描IO成本 = data_length / innodb_page_size * 1.0）。</li> <li><code>index_length</code>：索引的大小（单位字节），用于计算索引扫描的IO成本。</li> <li><code>cardinality</code>：索引的基数（即索引中不同值的数量），用于计算索引的区分度（区分度 = cardinality / table_rows，区分度越高，索引过滤效果越好）。</li> <li><code>avg_row_length</code>：表的平均行大小，用于估算查询结果集的大小。</li></ul> <p>关键注意点：统计信息是“估算值”，若统计信息过时（如表数据大量插入/删除后未更新统计信息），会导致优化器的成本估算偏差，进而选择错误的执行计划（如明明有高效索引却选择全表扫描）。此时需要手动更新统计信息：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 更新指定表的统计信息（MySQL 8.0默认自动更新，5.7及以下可能需要手动执行）</span>
<span class="token keyword">ANALYZE</span> <span class="token keyword">TABLE</span> <span class="token keyword">user</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="_3-3-成本估算示例-全表扫描vs索引扫描"><a href="#_3-3-成本估算示例-全表扫描vs索引扫描" class="header-anchor">#</a> 3.3 成本估算示例：全表扫描vs索引扫描</h3> <p>假设用户表（user）有以下信息：table_rows=10000，data_length=160KB（即10个数据页，innodb_page_size=16KB），avg_row_length=16字节；有二级索引idx_age（age），index_length=32KB（2个数据页），cardinality=100（age的区分度为1%）；查询条件“WHERE age=25”，估算匹配行数=10000*1%=100行。</p> <h4 id="_1-全表扫描的成本估算"><a href="#_1-全表扫描的成本估算" class="header-anchor">#</a> （1）全表扫描的成本估算</h4> <ul><li>IO成本：全表扫描需要读取10个数据页 → 10 * 1.0 = 10.0。</li> <li>CPU成本：扫描10000行数据，过滤出100行 → 10000 * 0.2 = 2000.0。</li> <li>总成本 = 10.0 + 2000.0 = 2010.0。</li></ul> <h4 id="_2-索引扫描-idx-age-的成本估算"><a href="#_2-索引扫描-idx-age-的成本估算" class="header-anchor">#</a> （2）索引扫描（idx_age）的成本估算</h4> <ul><li>IO成本：索引扫描需要读取2个索引页（找到age=25的索引项） + 回表读取100行数据（假设100行分布在10个数据页） → 2<em>1.0 + 10</em>1.0 = 12.0。</li> <li>CPU成本：索引查找100个索引项 + 回表后过滤100行 → (100 + 100) * 0.2 = 40.0。</li> <li>总成本 = 12.0 + 40.0 = 52.0。</li></ul> <h4 id="_3-优化器的选择"><a href="#_3-优化器的选择" class="header-anchor">#</a> （3）优化器的选择</h4> <p>索引扫描的总成本（52.0）远低于全表扫描（2010.0），因此优化器会选择idx_age索引扫描。若查询是“SELECT age FROM user WHERE age=25”（覆盖查询，无需回表），则索引扫描的IO成本仅为2.0，总成本更低，优先级更高。</p> <h2 id="四、如何查看与解读执行计划-实践核心"><a href="#四、如何查看与解读执行计划-实践核心" class="header-anchor">#</a> 四、如何查看与解读执行计划？（实践核心）</h2> <p>理解了查询优化器的工作逻辑后，最核心的实践就是“通过执行计划判断优化器的决策是否合理”，进而优化SQL和索引。MySQL提供<code>EXPLAIN</code>命令（或<code>EXPLAIN ANALYZE</code>，MySQL 8.0+，会执行SQL并返回真实执行计划）查看执行计划。</p> <h3 id="_4-1-执行计划的核心字段解读"><a href="#_4-1-执行计划的核心字段解读" class="header-anchor">#</a> 4.1 执行计划的核心字段解读</h3> <p>执行<code>EXPLAIN SELECT ...</code>后，会返回10个核心字段，每个字段都对应执行计划的关键信息：</p> <h4 id="_1-id-查询的执行顺序标识"><a href="#_1-id-查询的执行顺序标识" class="header-anchor">#</a> （1）id：查询的执行顺序标识</h4> <ul><li>id相同：执行顺序由上到下（如多表连接，先执行驱动表，再执行被驱动表）。</li> <li>id不同：id值越大，执行优先级越高（先执行子查询，再执行外层查询）。</li> <li>示例：<code>EXPLAIN SELECT * FROM user WHERE id IN (SELECT user_id FROM order WHERE order_no='20240501')</code>，子查询的id大于外层查询，先执行子查询获取user_id，再执行外层查询。</li></ul> <h4 id="_2-select-type-查询类型"><a href="#_2-select-type-查询类型" class="header-anchor">#</a> （2）select_type：查询类型</h4> <p>标识查询是简单查询还是复杂查询（子查询、联合查询等），核心类型：</p> <ul><li>SIMPLE：简单查询（无子查询、无UNION）。</li> <li>SUBQUERY：非关联子查询（子查询不依赖外层表字段）。</li> <li>DERIVED：派生表查询（子查询作为临时表，如“SELECT * FROM (SELECT id FROM user) t”）。</li> <li>UNION：UNION查询的第二个及以后的查询。</li> <li>UNION RESULT：UNION查询的结果集合并阶段。</li></ul> <h4 id="_3-table-当前行对应的表名-或临时表标识"><a href="#_3-table-当前行对应的表名-或临时表标识" class="header-anchor">#</a> （3）table：当前行对应的表名（或临时表标识）</h4> <ul><li>直接显示表名（如user、order）：表示操作的是基表。</li> <li>显示<code>&lt;derivedN&gt;</code>：表示操作的是id=N的派生表（临时表）。</li> <li>显示<code>&lt;unionM,N&gt;</code>：表示操作的是id=M和id=N的UNION结果集。</li></ul> <h4 id="_4-type-访问类型-最关键的性能指标"><a href="#_4-type-访问类型-最关键的性能指标" class="header-anchor">#</a> （4）type：访问类型（最关键的性能指标）</h4> <p>表示优化器访问表的方式，从优到差的顺序为：</p> <div class="language-plaintext line-numbers-mode"><pre class="language-plaintext"><code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>核心类型解读（日常优化需关注“是否达到range及以上”）：</p> <ul><li>system：表中只有1行数据（如系统表），最优。</li> <li>const：通过主键或唯一索引查找单一行数据（如“WHERE id=10”），效率极高。</li> <li>eq_ref：多表连接时，被驱动表通过主键或唯一索引匹配（每行驱动表数据对应被驱动表1行数据），如“user.id = order.user_id”（order.user_id是主键）。</li> <li>ref：通过非唯一索引查找数据（如“WHERE age=25”，age是二级索引），可能匹配多行。</li> <li>range：通过索引范围扫描数据（如“WHERE age BETWEEN 20 AND 30”“WHERE id &gt; 100”），效率较好。</li> <li>index：全索引扫描（扫描整个索引树，无需扫描数据页），适用于覆盖查询（如“SELECT age FROM user”，age是索引字段）。</li> <li>ALL：全表扫描（扫描整个数据文件），效率最差，需尽量避免。</li></ul> <h4 id="_5-possible-keys-候选索引列表"><a href="#_5-possible-keys-候选索引列表" class="header-anchor">#</a> （5）possible_keys：候选索引列表</h4> <p>优化器认为可能适用的索引（但不一定会使用）。若该字段为NULL，表示无候选索引，可能需要优化查询或添加索引。</p> <h4 id="_6-key-实际使用的索引"><a href="#_6-key-实际使用的索引" class="header-anchor">#</a> （6）key：实际使用的索引</h4> <p>优化器最终选择的索引（核心关注字段）。若该字段为NULL，表示未使用任何索引（全表扫描）。</p> <p>注意：possible_keys有值但key为NULL，可能是“索引的成本高于全表扫描”（如区分度极低的索引），或“查询需要扫描全表数据，使用索引无意义”（如“SELECT * FROM user”）。</p> <h4 id="_7-key-len-使用的索引长度-单位字节"><a href="#_7-key-len-使用的索引长度-单位字节" class="header-anchor">#</a> （7）key_len：使用的索引长度（单位字节）</h4> <p>表示优化器使用的索引字段的长度，可用于判断“联合索引是否被充分利用”。例如，联合索引idx_age_gender（age int(4)，gender varchar(10)），若key_len=4，表示仅使用了age字段；若key_len=4+10*3+2=36（varchar按utf8编码，1个字符占3字节，加2字节长度标识），表示使用了age和gender两个字段。</p> <h4 id="_8-ref-与索引匹配的列或常量"><a href="#_8-ref-与索引匹配的列或常量" class="header-anchor">#</a> （8）ref：与索引匹配的列或常量</h4> <p>表示索引的匹配条件，如“const”（匹配常量，如“WHERE id=10”）、“user.age”（匹配其他表的字段，如连接条件）。</p> <h4 id="_9-rows-优化器估算的扫描行数"><a href="#_9-rows-优化器估算的扫描行数" class="header-anchor">#</a> （9）rows：优化器估算的扫描行数</h4> <p>表示优化器认为当前操作需要扫描的行数（基于统计信息估算）。行数越少，执行效率越高。若rows远大于表的真实行数，可能是统计信息过时，需执行ANALYZE TABLE更新。</p> <h4 id="_10-extra-额外执行信息-核心优化依据"><a href="#_10-extra-额外执行信息-核心优化依据" class="header-anchor">#</a> （10）Extra：额外执行信息（核心优化依据）</h4> <p>包含优化器的额外执行细节，常见关键值：</p> <ul><li>Using index：使用覆盖索引（无需回表），最优情况，需尽量争取。</li> <li>Using where：使用WHERE子句过滤数据（但未使用索引，或使用索引后仍需过滤）。</li> <li>Using index condition：使用索引条件推送（ICP），将部分过滤条件下推到存储引擎，减少回表数据量（如“WHERE age&gt;20 AND name LIKE '张%'”，idx_age_name索引，先通过age&gt;20过滤索引项，再回表匹配name）。</li> <li>Using filesort：使用文件排序（未利用索引排序），效率低，需优化（如添加排序字段的索引）。</li> <li>Using temporary：使用临时表（如DISTINCT、GROUP BY未使用索引时），效率低，需优化。</li> <li>Using join buffer：使用连接缓冲区（连接时数据量超过buffer大小），需优化（如添加连接字段的索引，或增大join_buffer_size）。</li></ul> <h3 id="_4-2-执行计划解读实例"><a href="#_4-2-执行计划解读实例" class="header-anchor">#</a> 4.2 执行计划解读实例</h3> <p>查询：<code>EXPLAIN SELECT id, name FROM user WHERE age BETWEEN 20 AND 30 ORDER BY age;</code></p> <p>执行计划输出（简化）：</p> <div class="language-plaintext line-numbers-mode"><pre class="language-plaintext"><code>id | select_type | table | type  | possible_keys | key       | key_len | ref  | rows | Extra
1  | SIMPLE      | user  | range | idx_age       | idx_age   | 4       | NULL | 100  | Using index condition; Using index
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解读：</p> <ul><li>type=range：使用索引范围扫描（age BETWEEN 20 AND 30），效率较好。</li> <li>key=idx_age：实际使用idx_age索引。</li> <li>Extra=Using index condition; Using index：使用索引条件推送，且是覆盖索引（idx_age包含age、id字段，name字段若也在索引中则为覆盖，此处假设idx_age是联合索引idx_age_id_name），无需回表，执行效率极高。</li> <li>rows=100：估算扫描100行数据，符合预期。</li></ul> <h2 id="五、影响优化器决策的关键因素与优化建议"><a href="#五、影响优化器决策的关键因素与优化建议" class="header-anchor">#</a> 五、影响优化器决策的关键因素与优化建议</h2> <p>查询优化器的决策并非绝对正确，受多种因素影响。了解这些因素，能帮助我们规避“优化器陷阱”，写出更易被优化器识别的高效SQL。</p> <h3 id="_5-1-影响优化器决策的核心因素"><a href="#_5-1-影响优化器决策的核心因素" class="header-anchor">#</a> 5.1 影响优化器决策的核心因素</h3> <ul><li><strong>统计信息不准确</strong>：如前所述，统计信息是成本估算的基础，若统计信息过时（表数据大量变更后未更新），会导致优化器选择错误的执行计划。</li> <li><strong>索引设计不合理</strong>：如缺少核心过滤/连接/排序字段的索引、联合索引字段顺序错误（应将区分度高的字段放在前面）、索引过多导致优化器选择困难等。</li> <li><strong>SQL语句写法问题</strong>：如使用函数操作索引字段（“WHERE DATE(create_time) = '2024-05-01'”，无法使用create_time索引）、使用隐式类型转换（“WHERE id='10'”，id是int类型，无法使用索引）、子查询写法复杂导致优化器无法扁平化等。</li> <li><strong>参数配置不当</strong>：如sort_buffer_size过小导致频繁文件排序、join_buffer_size过小导致频繁使用连接缓冲区、innodb_stats_on_metadata=OFF导致统计信息无法自动更新等。</li> <li><strong>数据分布不均</strong>：如某些字段存在“热点值”（如性别字段中“male”占90%，“female”占10%），优化器的估算偏差会增大，可能选择低效索引。</li></ul> <h3 id="_5-2-实践优化建议"><a href="#_5-2-实践优化建议" class="header-anchor">#</a> 5.2 实践优化建议</h3> <ul><li><strong>定期更新统计信息</strong>：对于数据变更频繁的表，定期执行ANALYZE TABLE更新统计信息，确保优化器的成本估算准确。</li> <li><strong>合理设计索引</strong>：
<ul><li>遵循“三星索引”原则：索引包含过滤条件的字段（第一星）、包含连接字段（第二星）、包含查询需要的所有字段（第三星，覆盖索引）。</li> <li>联合索引字段顺序：区分度高的字段在前、过滤/连接字段在前、排序/聚合字段在后。</li> <li>避免冗余索引（如已有联合索引idx_age_gender，无需再单独创建idx_age）。</li></ul></li> <li><strong>优化SQL语句写法</strong>：
<ul><li>避免在索引字段上使用函数/运算符（如“WHERE id+1=11”改为“WHERE id=10”）。</li> <li>避免隐式类型转换（如“WHERE id='10'”改为“WHERE id=10”）。</li> <li>复杂子查询改为JOIN查询（如EXISTS子查询改为JOIN）。</li> <li>Limit分页优化：对于大表分页（如“LIMIT 100000, 20”），使用索引定位起始位置（如“WHERE id &gt; 100000 LIMIT 20”），避免全表扫描。</li></ul></li> <li><strong>合理配置参数</strong>：
<ul><li>sort_buffer_size：根据业务调整，避免过小导致文件排序（建议256KB~1MB）。</li> <li>join_buffer_size：多表连接场景调整，避免过小导致使用连接缓冲区（建议256KB~1MB）。</li> <li>innodb_stats_on_metadata=ON（MySQL 5.7默认OFF，8.0默认ON）：确保查询元数据时自动更新统计信息。</li></ul></li> <li><strong>强制索引（谨慎使用）</strong>：若优化器选择错误的索引，可通过FORCE INDEX强制使用指定索引（如“SELECT * FROM user FORCE INDEX (idx_age) WHERE age&gt;20”），但需注意：后续索引变更可能导致该语句失效，尽量优先通过优化索引和SQL让优化器自动选择正确索引。</li></ul> <h2 id="六、总结"><a href="#六、总结" class="header-anchor">#</a> 六、总结</h2> <p>MySQL查询优化器的核心逻辑可总结为“<strong>先优化逻辑，再选择物理执行方式，最后通过成本估算选最优计划</strong>”：</p> <ol><li>逻辑优化通过谓词下推、连接重排等手段，重构查询逻辑，减少后续处理的数据量。</li> <li>物理优化为每个逻辑步骤选择具体的执行算法（如嵌套循环连接、索引扫描）和索引。</li> <li>成本估算模型基于IO成本和CPU成本，结合统计信息，从多个候选计划中选择成本最低的执行计划。</li></ol></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《MySQL》笔记/8.MySQL查询优化.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=MySQL%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96" title="标签">#MySQL查询优化</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/75718e/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL崩溃恢复</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/75718e/" class="prev">MySQL崩溃恢复</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/60.800afb74.js" defer></script>
  </body>
</html>
