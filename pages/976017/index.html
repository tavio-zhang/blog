<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL索引底层 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/55.27ff3cca.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/48.7d4f854a.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/60.800afb74.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/79.486534af.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/83.72b7d6a4.js"><link rel="prefetch" href="/assets/js/84.f5a347be.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/929a6c/" class="sidebar-link">MySQL InnoDB</a></li><li><a href="/pages/4a8639/" class="sidebar-link">MySQL缓冲池与WAL机制</a></li><li><a href="/pages/976017/" aria-current="page" class="active sidebar-link">MySQL索引底层</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/976017/#一、索引的核心价值-为何需要索引" class="sidebar-link">一、索引的核心价值：为何需要索引？</a></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#二、b-树-mysql索引的底层数据结构基石" class="sidebar-link">二、B+树：MySQL索引的底层数据结构基石</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/976017/#_2-1-先懂b树-b-树的-前身-与不足" class="sidebar-link">2.1 先懂B树：B+树的“前身”与不足</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_2-2-b-树的核心设计-针对性优化与优势" class="sidebar-link">2.2 B+树的核心设计：针对性优化与优势</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_2-3-b-树的查询流程-以聚簇索引为例" class="sidebar-link">2.3 B+树的查询流程（以聚簇索引为例）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#三、mysql索引的核心类型-聚簇索引与二级索引" class="sidebar-link">三、MySQL索引的核心类型：聚簇索引与二级索引</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/976017/#_3-1-聚簇索引-索引即数据-数据即索引" class="sidebar-link">3.1 聚簇索引：索引即数据，数据即索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_3-2-二级索引-叶子节点存储主键" class="sidebar-link">3.2 二级索引：叶子节点存储主键</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_3-3-联合索引-有序的多列索引" class="sidebar-link">3.3 联合索引：有序的多列索引</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#四、索引失效的本质-为何索引-失效" class="sidebar-link">四、索引失效的本质：为何索引“失效”？</a></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#五、常见索引失效场景与案例分析" class="sidebar-link">五、常见索引失效场景与案例分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景1-索引列上使用函数或运算" class="sidebar-link">场景1：索引列上使用函数或运算</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景2-模糊查询以-开头" class="sidebar-link">场景2：模糊查询以“%”开头</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景3-联合索引不满足最左匹配原则" class="sidebar-link">场景3：联合索引不满足最左匹配原则</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景4-使用or连接非索引列" class="sidebar-link">场景4：使用OR连接非索引列</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景5-索引列与查询条件的数据类型不匹配" class="sidebar-link">场景5：索引列与查询条件的数据类型不匹配</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景6-查询条件是is-null-is-not-null-视数据分布而定" class="sidebar-link">场景6：查询条件是IS NULL/IS NOT NULL（视数据分布而定）</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景7-数据量过小-优化器选择全表扫描" class="sidebar-link">场景7：数据量过小，优化器选择全表扫描</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#场景8-统计信息过时-优化器判断失误" class="sidebar-link">场景8：统计信息过时，优化器判断失误</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#六、索引优化实战建议" class="sidebar-link">六、索引优化实战建议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/976017/#_1-优先使用聚簇索引-主键索引" class="sidebar-link">1. 优先使用聚簇索引（主键索引）</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_2-合理设计联合索引-遵循-最左匹配-高频列在前" class="sidebar-link">2. 合理设计联合索引：遵循“最左匹配+高频列在前”</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_3-利用覆盖索引-避免回表" class="sidebar-link">3. 利用覆盖索引，避免回表</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_4-避免索引列上的函数-运算-类型转换" class="sidebar-link">4. 避免索引列上的函数/运算/类型转换</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_5-控制索引数量-平衡查询与写入效率" class="sidebar-link">5. 控制索引数量，平衡查询与写入效率</a></li><li class="sidebar-sub-header level3"><a href="/pages/976017/#_6-定期维护索引与统计信息" class="sidebar-link">6. 定期维护索引与统计信息</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/976017/#七、总结" class="sidebar-link">七、总结</a></li></ul></li><li><a href="/pages/778452/" class="sidebar-link">MySQL事务与MVCC</a></li><li><a href="/pages/070a30/" class="sidebar-link">MySQL锁机制</a></li><li><a href="/pages/8b3524/" class="sidebar-link">MySQL Binlog</a></li><li><a href="/pages/75718e/" class="sidebar-link">MySQL崩溃恢复</a></li><li><a href="/pages/b99ebc/" class="sidebar-link">MySQL查询优化</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/mysql/#《MySQL》笔记" data-v-06225672>《MySQL》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-07-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">MySQL索引底层<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="深度解析mysql索引底层-b-树设计精髓与索引失效本质"><a href="#深度解析mysql索引底层-b-树设计精髓与索引失效本质" class="header-anchor">#</a> 深度解析MySQL索引底层：B+树设计精髓与索引失效本质</h1> <p>在MySQL数据库的性能优化中，索引无疑是最核心的手段之一。一句合适的索引设计，能让慢查询从“秒级”提升到“毫秒级”；反之，即便建了索引，也可能因“索引失效”导致全表扫描，性能断崖式下降。而这一切的根源，都要回归到索引的底层数据结构——B+树，以及MySQL优化器的执行逻辑。</p> <h2 id="一、索引的核心价值-为何需要索引"><a href="#一、索引的核心价值-为何需要索引" class="header-anchor">#</a> 一、索引的核心价值：为何需要索引？</h2> <p>在没有索引的情况下，MySQL查询数据时只能进行“全表扫描”——即从表的第一条记录开始，逐行匹配查询条件，直到找到目标数据。这种方式在数据量小时（如几千条）尚可接受，但当数据量达到百万、千万级时，全表扫描的时间成本会呈线性增长（O(n)复杂度），完全无法满足业务需求。</p> <p>索引的核心作用，就是将“全表扫描”的线性查找，转化为“有序结构查找”的对数级查找（O(log n)复杂度），本质是通过预先生成的“有序数据结构”，快速定位数据在磁盘上的物理存储位置，减少磁盘I/O操作（数据库性能瓶颈的核心是磁盘I/O）。</p> <p>举个通俗的例子：全表扫描如同在一本没有目录的字典里找“苹果”，需要逐页翻阅；而索引就像字典的目录，通过目录能直接定位到“苹果”所在的页码，大幅提升查找效率。</p> <h2 id="二、b-树-mysql索引的底层数据结构基石"><a href="#二、b-树-mysql索引的底层数据结构基石" class="header-anchor">#</a> 二、B+树：MySQL索引的底层数据结构基石</h2> <p>MySQL的索引底层默认使用B+树（B-tree的改进版），而非数组、链表、哈希表等结构。这并非偶然，而是B+树的设计完美适配了MySQL的磁盘存储特性（数据以“页”为单位存储，默认16KB，磁盘I/O按页进行）。要理解B+树的优势，我们先从B树的不足入手，再看B+树的优化设计。</p> <h3 id="_2-1-先懂b树-b-树的-前身-与不足"><a href="#_2-1-先懂b树-b-树的-前身-与不足" class="header-anchor">#</a> 2.1 先懂B树：B+树的“前身”与不足</h3> <p>B树（平衡多路搜索树）的核心结构特点：</p> <ul><li>每个节点可以存储多个关键字（索引值）和对应的指针（指向子节点的磁盘地址）；</li> <li>关键字按升序排列，子节点指针穿插在关键字之间，确保左子树的关键字均小于当前关键字，右子树的关键字均大于当前关键字；</li> <li>所有叶子节点在同一层，保证查询效率稳定（平衡树特性）。</li></ul> <p>但B树存在两个致命缺陷，无法适配MySQL的高频查询场景：</p> <ol><li><strong>查询效率不稳定</strong>：非叶子节点和叶子节点都存储数据，若查询的目标数据在非叶子节点，能快速命中；若在叶子节点，则需要遍历到最底层，查询次数差异较大；</li> <li><strong>范围查询低效</strong>：进行范围查询（如id&gt;100 and id&lt;200）时，需要遍历多个分支节点，找到起始值后，再回溯其他分支，操作复杂；</li> <li><strong>磁盘I/O次数多</strong>：非叶子节点存储数据占用空间，导致每个节点能存储的关键字数量减少，树的高度增加（比如百万级数据可能需要4-5层），而每一层的访问都需要一次磁盘I/O，I/O次数越多，查询越慢。</li></ol> <h3 id="_2-2-b-树的核心设计-针对性优化与优势"><a href="#_2-2-b-树的核心设计-针对性优化与优势" class="header-anchor">#</a> 2.2 B+树的核心设计：针对性优化与优势</h3> <p>B+树在B树的基础上进行了三点关键优化，完美解决了B树的不足，成为MySQL索引的最优选择。其核心结构如下：</p> <ul><li><strong>非叶子节点仅存索引，不存数据</strong>：非叶子节点只存储“关键字（索引值）+ 子节点指针”，不存储具体的数据行。这样每个非叶子节点能容纳更多的关键字，树的高度大幅降低（百万级数据通常只需2-3层），减少磁盘I/O次数；</li> <li><strong>所有数据集中在叶子节点</strong>：所有关键字对应的具体数据（或数据的磁盘地址）都存储在叶子节点，且叶子节点按关键字升序排列，保证查询效率稳定（无论查询哪个数据，都需要遍历到叶子节点，查询次数固定）；</li> <li><strong>叶子节点通过双向链表连接</strong>：所有叶子节点之间形成一个双向链表，相邻叶子节点可以快速访问。这使得范围查询时，只需找到起始叶子节点，然后通过链表遍历后续节点即可，效率极高。</li></ul> <p>补充：MySQL中B+树的“节点”对应磁盘上的“数据页”（16KB），非叶子节点的每个关键字+指针约占16字节（8字节关键字+8字节指针），因此一个非叶子节点可存储约16KB/16B=1024个关键字，对应1025个指针（子节点）。若树高为3，则总数据量可达1024<em>1024</em>N（N为每个叶子节点存储的数据行数），足以支撑千万级数据的高效查询。</p> <h3 id="_2-3-b-树的查询流程-以聚簇索引为例"><a href="#_2-3-b-树的查询流程-以聚簇索引为例" class="header-anchor">#</a> 2.3 B+树的查询流程（以聚簇索引为例）</h3> <p>假设我们有一个user表，主键id为聚簇索引，B+树高度为3，查询<code>SELECT * FROM user WHERE id=10086</code>的流程如下：</p> <ol><li>MySQL先访问B+树的根节点（磁盘I/O 1次），根节点存储关键字范围，通过二分查找确定id=10086对应的子节点指针；</li> <li>根据子节点指针访问第二层节点（磁盘I/O 2次），再次通过二分查找确定目标叶子节点的指针；</li> <li>访问叶子节点（磁盘I/O 3次），在叶子节点中找到id=10086对应的data域（存储完整数据行），返回结果。</li></ol> <p>整个过程仅需3次磁盘I/O，而全表扫描可能需要上百次甚至上千次，效率差距悬殊。</p> <h2 id="三、mysql索引的核心类型-聚簇索引与二级索引"><a href="#三、mysql索引的核心类型-聚簇索引与二级索引" class="header-anchor">#</a> 三、MySQL索引的核心类型：聚簇索引与二级索引</h2> <p>基于B+树，MySQL将索引分为两大类——聚簇索引（Clustered Index）和二级索引（Secondary Index，也叫辅助索引），两者的核心区别在于叶子节点存储的内容不同，这也是理解后续索引失效的关键。</p> <h3 id="_3-1-聚簇索引-索引即数据-数据即索引"><a href="#_3-1-聚簇索引-索引即数据-数据即索引" class="header-anchor">#</a> 3.1 聚簇索引：索引即数据，数据即索引</h3> <p>聚簇索引是MySQL的核心索引，其叶子节点直接存储“完整的数据行”，而非数据的地址。MySQL中，<strong>主键索引默认是聚簇索引</strong>；若表没有主键，则会选择唯一非空索引作为聚簇索引；若既没有主键也没有唯一非空索引，MySQL会自动生成一个隐藏的聚簇索引（基于行号的自增ID）。</p> <p>聚簇索引的优势：</p> <ul><li>查询效率最高：通过聚簇索引查询时，找到叶子节点即可获取完整数据，无需额外操作；</li> <li>范围查询高效：借助叶子节点的双向链表，范围查询（如id between 100 and 200）能快速遍历所有符合条件的数据行。</li></ul> <p>聚簇索引的不足：</p> <ul><li>插入效率受影响：聚簇索引是有序的，插入新数据时需要找到对应的位置，若该位置的数据页已满，会触发“页分裂”（拆分数据页并重新排序），增加开销；</li> <li>不适合频繁更新的主键：主键更新会导致数据行在磁盘上的物理位置移动，同时所有二级索引都会失效（后续会讲），需要重新构建。</li></ul> <h3 id="_3-2-二级索引-叶子节点存储主键"><a href="#_3-2-二级索引-叶子节点存储主键" class="header-anchor">#</a> 3.2 二级索引：叶子节点存储主键</h3> <p>二级索引是用户手动创建的索引（如<code>CREATE INDEX idx_name ON user(name)</code>），其叶子节点不存储完整数据行，而是存储“索引列的值 + 聚簇索引的关键字（即主键）”。</p> <p>二级索引的查询流程（回表机制）：
以查询<code>SELECT * FROM user WHERE name='张三'</code>（name列有二级索引）为例：</p> <ol><li>先通过二级索引（idx_name）的B+树查找，找到name='张三'对应的主键值（如id=10086）——这一步叫“索引查找”；</li> <li>再通过聚簇索引（主键索引）的B+树查找id=10086，在叶子节点获取完整的数据行——这一步叫“回表”。</li></ol> <p>补充：若查询的列都在二级索引中（如<code>SELECT id, name FROM user WHERE name='张三'</code>），则无需回表，直接从二级索引的叶子节点获取数据即可，这就是“覆盖索引”（Covering Index），是优化查询的重要手段。</p> <h3 id="_3-3-联合索引-有序的多列索引"><a href="#_3-3-联合索引-有序的多列索引" class="header-anchor">#</a> 3.3 联合索引：有序的多列索引</h3> <p>联合索引是多个列组合而成的二级索引（如<code>CREATE INDEX idx_age_name ON user(age, name)</code>），其B+树的关键字按“第一列→第二列→...→第N列”的顺序排序。联合索引的核心遵循“最左匹配原则”——即查询时必须从第一列开始匹配，否则无法利用索引。</p> <p>例如，联合索引（age, name）的有效查询场景：</p> <ul><li>age=25（匹配第一列，有效）；</li> <li>age=25 and name='张三'（匹配第一列+第二列，有效）；</li> <li>age between 20 and 30 and name='张三'（范围匹配第一列，再匹配第二列，有效）。</li></ul> <p>无效场景：</p> <ul><li>name='张三'（未匹配第一列，无效）；</li> <li>age&gt;25 and name='张三'（范围匹配第一列后，第二列的索引失效，仅第一列有效）。</li></ul> <h2 id="四、索引失效的本质-为何索引-失效"><a href="#四、索引失效的本质-为何索引-失效" class="header-anchor">#</a> 四、索引失效的本质：为何索引“失效”？</h2> <p>很多开发者会遇到“建了索引但查询还是慢”的问题，这本质是“索引失效”——即MySQL的查询优化器判断“走索引的成本高于全表扫描”，因此放弃使用索引，转而进行全表扫描。</p> <p>核心结论：<strong>索引失效的本质，是查询语句的执行计划无法利用B+树的有序性，或优化器认为走索引的效率低于全表扫描</strong>。具体来说，有两个核心原因：</p> <ol><li><strong>破坏B+树的有序性</strong>：B+树的查询依赖于关键字的有序性，若查询条件对索引列进行了“无序化操作”（如函数、运算、类型转换），则优化器无法通过B+树的有序结构快速定位数据，只能放弃索引；</li> <li><strong>走索引的成本过高</strong>：即使查询条件适配索引，但如果符合条件的数据量过大（如占全表数据的30%以上），优化器会认为“走索引需要多次回表（二级索引）+ 磁盘I/O”，成本高于全表扫描，因此选择放弃索引。</li></ol> <p>补充：MySQL的查询优化器是基于“统计信息”（如索引的选择性、数据分布）来判断是否走索引的，若统计信息过时（如数据大量插入/删除后未更新统计信息），也可能导致优化器做出错误判断，出现索引失效。</p> <h2 id="五、常见索引失效场景与案例分析"><a href="#五、常见索引失效场景与案例分析" class="header-anchor">#</a> 五、常见索引失效场景与案例分析</h2> <p>结合上述本质原因，我们梳理出8种最常见的索引失效场景，每个场景都给出具体案例、失效原因和优化方案，让大家能直接落地避坑。</p> <h3 id="场景1-索引列上使用函数或运算"><a href="#场景1-索引列上使用函数或运算" class="header-anchor">#</a> 场景1：索引列上使用函数或运算</h3> <p>案例：user表有二级索引idx_create_time（create_time），查询“2024年1月1日之后创建的用户”：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-- 失效SQL
SELECT * FROM user WHERE DATE(create_time) &gt; '2024-01-01';

-- 有效SQL
SELECT * FROM user WHERE create_time &gt; STR_TO_DATE('2024-01-01', '%Y-%m-%d');
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>失效原因：在索引列create_time上使用了DATE()函数，破坏了B+树的有序性（索引列的原始值是有序的，但函数处理后的值无法保证有序），优化器无法通过索引快速定位数据，只能全表扫描。</p> <p>优化思路：将函数操作从索引列上移到查询条件的右侧，让索引列保持原始的有序性，确保优化器能利用索引。</p> <h3 id="场景2-模糊查询以-开头"><a href="#场景2-模糊查询以-开头" class="header-anchor">#</a> 场景2：模糊查询以“%”开头</h3> <p>案例：user表有二级索引idx_name（name），查询“名字以‘三’结尾的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'%三'</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（以%结尾，有效）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'张%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（覆盖索引，即使以%开头也有效）</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name <span class="token operator">LIKE</span> <span class="token string">'%三'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>失效原因：模糊查询以“%”开头时，查询条件是“后缀匹配”，而B+树的索引是按前缀有序排列的，无法通过前缀快速定位后缀匹配的数据，因此索引失效。若以“%”结尾（前缀匹配），则能利用索引的有序性；若查询的列是覆盖索引（仅id和name），则无需回表，优化器会选择走索引（扫描所有叶子节点，但比全表扫描快）。</p> <p>优化思路：避免以“%”开头的模糊查询；若必须使用，可考虑使用覆盖索引，或通过全文索引（FULLTEXT INDEX）替代（适用于字符串长度较长的场景）。</p> <h3 id="场景3-联合索引不满足最左匹配原则"><a href="#场景3-联合索引不满足最左匹配原则" class="header-anchor">#</a> 场景3：联合索引不满足最左匹配原则</h3> <p>案例：user表有联合索引idx_age_name（age, name），查询“名字为张三的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'张三'</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（匹配最左列age）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（匹配最左列+第二列）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span> <span class="token operator">AND</span> name<span class="token operator">=</span><span class="token string">'张三'</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（最左列范围匹配，第二列仍有效）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">&gt;</span><span class="token number">25</span> <span class="token operator">AND</span> age<span class="token operator">&lt;</span><span class="token number">30</span> <span class="token operator">AND</span> name<span class="token operator">=</span><span class="token string">'张三'</span><span class="token punctuation">;</span>

<span class="token comment">-- 失效SQL（最左列范围匹配后，第二列失效）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">&gt;</span><span class="token number">25</span> <span class="token operator">AND</span> name<span class="token operator">=</span><span class="token string">'张三'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>失效原因：联合索引的B+树是按“age→name”的顺序排序的，查询时必须从最左列（age）开始匹配，否则无法利用索引的有序性。若最左列使用范围查询（&gt;、&lt;、between），则范围后的列无法利用索引（因为范围查询后的结果是无序的，第二列的索引失去意义）。</p> <p>优化思路：创建联合索引时，将查询频率最高的列放在最左；查询时确保从最左列开始匹配；若需要单独查询name，可单独创建idx_name索引（权衡索引数量与查询效率）。</p> <h3 id="场景4-使用or连接非索引列"><a href="#场景4-使用or连接非索引列" class="header-anchor">#</a> 场景4：使用OR连接非索引列</h3> <p>案例：user表有索引idx_age（age），无idx_address（address），查询“年龄25或地址为北京的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span> <span class="token operator">OR</span> address<span class="token operator">=</span><span class="token string">'北京'</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（两个列都有索引）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span> <span class="token operator">OR</span> address<span class="token operator">=</span><span class="token string">'北京'</span><span class="token punctuation">;</span> <span class="token comment">-- 前提：address有索引</span>

<span class="token comment">-- 有效SQL（拆分为UNION）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> address<span class="token operator">=</span><span class="token string">'北京'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>失效原因：OR连接的两个条件中，若有一个列没有索引，优化器无法通过索引快速定位所有符合条件的数据（需要同时扫描索引和全表），因此会选择全表扫描。若两个列都有索引，优化器会分别扫描两个索引，再合并结果；若拆分为UNION，可分别利用索引和全表扫描，效率可能更高。</p> <p>优化思路：避免用OR连接非索引列；若必须使用，可给非索引列添加索引，或拆分为UNION查询。</p> <h3 id="场景5-索引列与查询条件的数据类型不匹配"><a href="#场景5-索引列与查询条件的数据类型不匹配" class="header-anchor">#</a> 场景5：索引列与查询条件的数据类型不匹配</h3> <p>案例：user表有索引idx_phone（phone，varchar类型），查询“手机号为13800138000的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 失效SQL（查询条件是数字，索引列是字符串）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> phone<span class="token operator">=</span><span class="token number">13800138000</span><span class="token punctuation">;</span>

<span class="token comment">-- 有效SQL（查询条件是字符串，与索引列类型一致）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> phone<span class="token operator">=</span><span class="token string">'13800138000'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>失效原因：查询条件的数据类型（数字）与索引列类型（字符串）不匹配时，MySQL会自动进行类型转换（将字符串转为数字），这相当于在索引列上进行了函数操作，破坏了B+树的有序性，导致索引失效。</p> <p>优化思路：确保查询条件的数据类型与索引列类型完全一致，避免自动类型转换。</p> <h3 id="场景6-查询条件是is-null-is-not-null-视数据分布而定"><a href="#场景6-查询条件是is-null-is-not-null-视数据分布而定" class="header-anchor">#</a> 场景6：查询条件是IS NULL/IS NOT NULL（视数据分布而定）</h3> <p>案例：user表有索引idx_email（email），查询“邮箱为空/不为空的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 可能失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> email <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

<span class="token comment">-- 可能失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> email <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>失效原因：B+树的索引会存储NULL值（NULL按最小排序），理论上IS NULL/IS NOT NULL可以走索引，但实际是否失效取决于数据分布：若NULL值占比极低（如1%），优化器会走索引；若NULL值占比极高（如50%以上），走索引需要扫描大量叶子节点，成本高于全表扫描，优化器会选择全表扫描。</p> <p>优化思路：尽量避免查询大量NULL值的数据；若必须查询，可通过统计信息判断是否走索引，或强制使用索引（<code>FORCE INDEX</code>，但不推荐，可能适得其反）。</p> <h3 id="场景7-数据量过小-优化器选择全表扫描"><a href="#场景7-数据量过小-优化器选择全表扫描" class="header-anchor">#</a> 场景7：数据量过小，优化器选择全表扫描</h3> <p>案例：user表有索引idx_age（age），但表中仅100条数据，查询“年龄25的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 可能失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>失效原因：当表中数据量过小时，全表扫描的成本（遍历100条数据）可能低于走索引的成本（3次磁盘I/O+回表），因此优化器会主动放弃索引，选择全表扫描。这是优化器的“智能判断”，并非索引本身的问题。</p> <p>优化思路：无需优化，数据量小时全表扫描效率更高；若需要测试索引是否有效，可通过<code>EXPLAIN</code>查看执行计划，或强制使用索引（<code>FORCE INDEX(idx_age)</code>）。</p> <h3 id="场景8-统计信息过时-优化器判断失误"><a href="#场景8-统计信息过时-优化器判断失误" class="header-anchor">#</a> 场景8：统计信息过时，优化器判断失误</h3> <p>案例：user表有索引idx_age（age），近期批量插入了100万条数据（age=25的占比从1%变为50%），查询“年龄25的用户”：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 可能失效SQL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token keyword">user</span> <span class="token keyword">WHERE</span> age<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>失效原因：MySQL的优化器依赖“统计信息”（如索引的选择性、数据分布）来判断是否走索引。若数据大量插入/删除后，统计信息未及时更新，优化器会基于旧的统计信息（如age=25占比1%）判断走索引有效，但实际数据占比50%，走索引的成本高于全表扫描，导致索引失效。</p> <p>优化思路：手动更新统计信息（<code>ANALYZE TABLE user;</code>），让优化器获取最新的数据分析结果；MySQL 8.0默认会自动更新统计信息，可通过<code>SHOW VARIABLES LIKE 'innodb_stats_auto_recalc';</code>查看配置。</p> <h2 id="六、索引优化实战建议"><a href="#六、索引优化实战建议" class="header-anchor">#</a> 六、索引优化实战建议</h2> <p>结合前面的底层原理和失效场景，给出6条可直接落地的索引优化建议，帮助大家避坑并提升查询效率：</p> <h3 id="_1-优先使用聚簇索引-主键索引"><a href="#_1-优先使用聚簇索引-主键索引" class="header-anchor">#</a> 1. 优先使用聚簇索引（主键索引）</h3> <p>聚簇索引的查询效率最高，尽量基于主键进行查询；设计主键时，选择自增ID（INT/BIGINT），避免使用字符串或频繁更新的字段（减少页分裂和二级索引失效的成本）。</p> <h3 id="_2-合理设计联合索引-遵循-最左匹配-高频列在前"><a href="#_2-合理设计联合索引-遵循-最左匹配-高频列在前" class="header-anchor">#</a> 2. 合理设计联合索引：遵循“最左匹配+高频列在前”</h3> <p>创建联合索引时，将查询频率最高的列放在最左；避免创建冗余的联合索引（如已有(idx_age, name)，则无需再创建(idx_age)）；联合索引的列数不宜过多（一般3-4列即可，列数过多会增加索引维护成本）。</p> <h3 id="_3-利用覆盖索引-避免回表"><a href="#_3-利用覆盖索引-避免回表" class="header-anchor">#</a> 3. 利用覆盖索引，避免回表</h3> <p>查询时，尽量只查询需要的列，若查询的列都在索引中（覆盖索引），则无需回表，大幅提升效率。例如，查询<code>SELECT id, name FROM user WHERE name='张三'</code>（idx_name是二级索引，包含id和name），无需回表。</p> <h3 id="_4-避免索引列上的函数-运算-类型转换"><a href="#_4-避免索引列上的函数-运算-类型转换" class="header-anchor">#</a> 4. 避免索引列上的函数/运算/类型转换</h3> <p>确保查询条件中的索引列是原始值，不进行任何函数操作（如DATE()、UPPER()）、运算（如age+1=26）或类型转换（字符串 vs 数字），避免破坏B+树的有序性。</p> <h3 id="_5-控制索引数量-平衡查询与写入效率"><a href="#_5-控制索引数量-平衡查询与写入效率" class="header-anchor">#</a> 5. 控制索引数量，平衡查询与写入效率</h3> <p>索引能提升查询效率，但会降低插入/更新/删除的效率（每次写入都需要维护索引的B+树）。一般来说，一张表的索引数量不宜超过5个，优先保留高频查询的索引。</p> <h3 id="_6-定期维护索引与统计信息"><a href="#_6-定期维护索引与统计信息" class="header-anchor">#</a> 6. 定期维护索引与统计信息</h3> <p>定期查看慢查询日志（slow_query_log），找出索引失效的查询并优化；定期更新统计信息（ANALYZE TABLE）；对于长期未使用的索引（通过<code>sys.schema_unused_indexes</code>查看），及时删除，减少维护成本。</p> <h2 id="七、总结"><a href="#七、总结" class="header-anchor">#</a> 七、总结</h2> <p>MySQL索引的底层是B+树，其设计精髓在于“非叶子节点存索引、叶子节点存数据+双向链表”，完美适配磁盘I/O特性，实现高效的单点查询和范围查询。索引失效的本质是“查询语句破坏了B+树的有序性，或优化器判断走索引成本高于全表扫描”。</p> <p>要想用好索引，需记住三点核心：一是理解聚簇索引与二级索引的区别，二是避开常见的索引失效场景，三是结合业务场景合理设计索引（如联合索引的最左匹配、覆盖索引的利用）。只有从底层原理出发，才能真正掌握索引优化的精髓，而不是死记硬背失效场景。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《MySQL》笔记/3.MySQL索引底层.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=MySQL%E7%B4%A2%E5%BC%95%E5%BA%95%E5%B1%82" title="标签">#MySQL索引底层</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/4a8639/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MySQL缓冲池与WAL机制</div></a> <a href="/pages/778452/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">MySQL事务与MVCC</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/4a8639/" class="prev">MySQL缓冲池与WAL机制</a></span> <span class="next"><a href="/pages/778452/">MySQL事务与MVCC</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/55.27ff3cca.js" defer></script>
  </body>
</html>
