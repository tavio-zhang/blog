<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring事务传播机制 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/79.486534af.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/48.7d4f854a.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/55.27ff3cca.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/60.800afb74.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/83.72b7d6a4.js"><link rel="prefetch" href="/assets/js/84.f5a347be.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/f19195/" class="sidebar-link">Spring Boot 自动配置</a></li><li><a href="/pages/1c21ce/" class="sidebar-link">Spring Boot Bean 生命周期</a></li><li><a href="/pages/48cf22/" aria-current="page" class="active sidebar-link">Spring事务传播机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#一、核心认知-什么是spring事务传播" class="sidebar-link">一、核心认知：什么是Spring事务传播？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_1-1-定义" class="sidebar-link">1.1 定义</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_1-2-为什么需要事务传播" class="sidebar-link">1.2 为什么需要事务传播？</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#二、基础铺垫-spring事务的核心前提" class="sidebar-link">二、基础铺垫：Spring事务的核心前提</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_2-1-事务的核心特性-acid" class="sidebar-link">2.1 事务的核心特性（ACID）</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_2-2-声明式事务的基础使用" class="sidebar-link">2.2 声明式事务的基础使用</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_2-3-事务的核心边界" class="sidebar-link">2.3 事务的核心边界</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#三、核心解析-7种spring事务传播行为" class="sidebar-link">三、核心解析：7种Spring事务传播行为</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_3-1-第一类-依赖外部事务-默认场景" class="sidebar-link">3.1 第一类：依赖外部事务（默认场景）</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-1-1-required-默认传播行为" class="sidebar-link">3.1.1 REQUIRED（默认传播行为）</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-1-2-supports" class="sidebar-link">3.1.2 SUPPORTS</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_3-2-第二类-不依赖外部事务-强制创建新事务" class="sidebar-link">3.2 第二类：不依赖外部事务（强制创建新事务）</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-2-1-requires-new" class="sidebar-link">3.2.1 REQUIRES_NEW</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-2-2-not-supported" class="sidebar-link">3.2.2 NOT_SUPPORTED</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_3-3-第三类-禁止事务-不允许存在事务" class="sidebar-link">3.3 第三类：禁止事务（不允许存在事务）</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-3-1-mandatory" class="sidebar-link">3.3.1 MANDATORY</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-3-2-never" class="sidebar-link">3.3.2 NEVER</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_3-4-第四类-嵌套事务-依赖外部事务-有独立回滚点" class="sidebar-link">3.4 第四类：嵌套事务（依赖外部事务，有独立回滚点）</a></li><li class="sidebar-sub-header level4"><a href="/pages/48cf22/#_3-4-1-nested" class="sidebar-link">3.4.1 NESTED</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_3-5-7种传播行为核心对比表" class="sidebar-link">3.5 7种传播行为核心对比表</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#四、底层原理-spring事务传播如何实现" class="sidebar-link">四、底层原理：Spring事务传播如何实现？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_4-1-核心组件" class="sidebar-link">4.1 核心组件</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_4-2-核心执行流程-以requires-new为例" class="sidebar-link">4.2 核心执行流程（以REQUIRES_NEW为例）</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_4-3-关键源码片段-事务状态获取" class="sidebar-link">4.3 关键源码片段（事务状态获取）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#五、实战避坑-事务传播常见问题与解决方案" class="sidebar-link">五、实战避坑：事务传播常见问题与解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_5-1-问题1-嵌套事务不生效-传播行为未触发" class="sidebar-link">5.1 问题1：嵌套事务不生效（传播行为未触发）</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_5-2-问题2-回滚范围不符合预期" class="sidebar-link">5.2 问题2：回滚范围不符合预期</a></li><li class="sidebar-sub-header level3"><a href="/pages/48cf22/#_5-3-问题3-事务挂起导致的资源泄漏" class="sidebar-link">5.3 问题3：事务挂起导致的资源泄漏</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/48cf22/#六、总结-事务传播的核心选型原则" class="sidebar-link">六、总结：事务传播的核心选型原则</a></li></ul></li><li><a href="/pages/20d41f/" class="sidebar-link">Spring Cloud Nacos 深度解析</a></li><li><a href="/pages/622399/" class="sidebar-link">Spring Cloud OpenFeign 深度解析</a></li><li><a href="/pages/b6abda/" class="sidebar-link">Spring Cloud Gateway 底层原理</a></li><li><a href="/pages/61e1cc/" class="sidebar-link">Spring Cloud Seata 深度解析</a></li><li><a href="/pages/3f9c50/" class="sidebar-link">Spring Cloud Sentinel 深度解析</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/node/spring/#《Spring》笔记" data-v-06225672>《Spring》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-07-09</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Spring事务传播机制<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="spring事务传播机制深度解析-原理、特性与实战"><a href="#spring事务传播机制深度解析-原理、特性与实战" class="header-anchor">#</a> Spring事务传播机制深度解析：原理、特性与实战</h1> <p>在Spring开发中，事务管理是保障数据一致性的核心手段，而“事务传播机制”则是多事务方法嵌套调用时的核心规则——它决定了嵌套场景下，内部事务如何与外部事务协同工作（是加入外部事务、创建新事务，还是挂起外部事务）。</p> <h2 id="一、核心认知-什么是spring事务传播"><a href="#一、核心认知-什么是spring事务传播" class="header-anchor">#</a> 一、核心认知：什么是Spring事务传播？</h2> <h3 id="_1-1-定义"><a href="#_1-1-定义" class="header-anchor">#</a> 1.1 定义</h3> <p>Spring事务传播机制，指的是<strong>当一个事务方法（被@Transactional注解标记）调用另一个事务方法时，Spring如何管理这两个方法的事务边界</strong>。具体来说，它定义了：</p> <ul><li>内部事务是否需要创建新的事务；</li> <li>内部事务是否需要加入外部事务（即与外部事务共用一个事务）；</li> <li>当外部事务回滚/提交时，对内部事务的影响；</li> <li>当内部事务抛出异常时，对外部事务的影响。</li></ul> <h3 id="_1-2-为什么需要事务传播"><a href="#_1-2-为什么需要事务传播" class="header-anchor">#</a> 1.2 为什么需要事务传播？</h3> <p>实际开发中，事务方法的嵌套调用极为常见，不同业务场景对事务的协同要求不同。例如：</p> <ol><li><strong>场景1：下单流程</strong>：下单方法（外部事务）调用扣库存方法（内部事务）。要求：下单失败则扣库存必须回滚，扣库存失败则下单也必须回滚（两者共用一个事务）；</li> <li><strong>场景2：下单记日志</strong>：下单方法（外部事务）调用记录操作日志方法（内部事务）。要求：下单失败时日志不能回滚（日志需要独立保存），日志记录失败不影响下单流程；</li> <li><strong>场景3：批量数据处理</strong>：批量导入方法（外部事务）调用单条导入方法（内部事务）。要求：单条导入失败时，仅回滚该条数据的导入，不影响其他数据和外部事务。</li></ol> <p>如果没有灵活的事务传播机制，仅靠“单一事务”无法满足这些复杂场景的需求。Spring的7种事务传播行为，正是为了解决不同嵌套场景下的事务协同问题。</p> <h2 id="二、基础铺垫-spring事务的核心前提"><a href="#二、基础铺垫-spring事务的核心前提" class="header-anchor">#</a> 二、基础铺垫：Spring事务的核心前提</h2> <p>在深入传播机制前，需先明确Spring事务的几个核心前提，避免后续理解偏差：</p> <h3 id="_2-1-事务的核心特性-acid"><a href="#_2-1-事务的核心特性-acid" class="header-anchor">#</a> 2.1 事务的核心特性（ACID）</h3> <p>事务的原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）是传播机制的基础——传播机制的本质是在嵌套场景下保障ACID特性的灵活适配。</p> <h3 id="_2-2-声明式事务的基础使用"><a href="#_2-2-声明式事务的基础使用" class="header-anchor">#</a> 2.2 声明式事务的基础使用</h3> <p>Spring事务传播机制基于“声明式事务”（@Transactional注解）生效，核心配置如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>
    propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span> <span class="token comment">// 事务传播行为（默认REQUIRED）</span>
    isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">,</span>      <span class="token comment">// 事务隔离级别</span>
    rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>      <span class="token comment">// 触发回滚的异常类型</span>
    readOnly <span class="token operator">=</span> <span class="token boolean">false</span>                    <span class="token comment">// 是否为只读事务</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">businessMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 业务逻辑</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>其中，<code>propagation</code>属性指定事务传播行为，是本文的核心。</p> <h3 id="_2-3-事务的核心边界"><a href="#_2-3-事务的核心边界" class="header-anchor">#</a> 2.3 事务的核心边界</h3> <p>Spring事务的边界由“事务管理器”（PlatformTransactionManager）控制：</p> <ul><li>事务开始：进入@Transactional标记的方法时，事务管理器创建事务（开启数据库连接，设置自动提交为false）；</li> <li>事务提交：方法正常执行完成后，事务管理器提交事务（执行commit）；</li> <li>事务回滚：方法抛出异常（且异常符合rollbackFor配置）时，事务管理器回滚事务（执行rollback）。</li></ul> <p>事务传播机制的核心，就是修改这一“边界规则”在嵌套场景下的表现。</p> <h2 id="三、核心解析-7种spring事务传播行为"><a href="#三、核心解析-7种spring事务传播行为" class="header-anchor">#</a> 三、核心解析：7种Spring事务传播行为</h2> <p>Spring定义了7种事务传播行为，封装在<code>org.springframework.transaction.annotation.Propagation</code>枚举类中。我们按“是否依赖外部事务”分为3大类，逐一解析每种传播行为的特性、适用场景和执行逻辑。</p> <h3 id="_3-1-第一类-依赖外部事务-默认场景"><a href="#_3-1-第一类-依赖外部事务-默认场景" class="header-anchor">#</a> 3.1 第一类：依赖外部事务（默认场景）</h3> <p>此类传播行为的核心特点是：内部事务优先依赖外部事务，只有当外部事务不存在时，才会创建新事务。包含2种传播行为：REQUIRED、SUPPORTS。</p> <h4 id="_3-1-1-required-默认传播行为"><a href="#_3-1-1-required-默认传播行为" class="header-anchor">#</a> 3.1.1 REQUIRED（默认传播行为）</h4> <ul><li><strong>核心定义</strong>：如果当前存在外部事务，则内部事务加入外部事务（共用一个事务）；如果当前没有外部事务，则创建新的事务。</li> <li><strong>英文释义</strong>：Support a current transaction, create a new one if none exists.</li> <li><strong>执行逻辑</strong>：
<ol><li>外部方法有事务：内部方法与外部方法共用一个事务，事务的提交/回滚由外部方法控制；</li> <li>外部方法无事务：内部方法创建新的独立事务，自己控制提交/回滚。</li></ol></li> <li><strong>回滚规则</strong>：
<ul><li>内部方法抛出异常（符合回滚规则）：无论外部方法是否捕获，都会导致整个事务回滚；</li> <li>外部方法抛出异常：内部方法的操作也会随外部事务一起回滚。</li></ul></li> <li><strong>适用场景</strong>：最常用，适用于“内部事务与外部事务强关联”的场景（如下单扣库存、转账等）。</li> <li><strong>实战示例</strong>：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 外部方法（有事务）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 保存订单</span>
    orderDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2. 调用内部方法（扣库存）</span>
    stockService<span class="token punctuation">.</span><span class="token function">deductStock</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部方法（REQUIRED传播行为）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockDao<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    stock<span class="token punctuation">.</span><span class="token function">setQuantity</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stockDao<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>执行结果分析：</p> <ul><li>扣库存抛出“库存不足”异常：createOrder和deductStock共用一个事务，整个事务回滚，订单不会被保存；</li> <li>保存订单成功，但外部方法后续抛出异常：扣库存操作也会随外部事务回滚，库存恢复原样。</li></ul> <h4 id="_3-1-2-supports"><a href="#_3-1-2-supports" class="header-anchor">#</a> 3.1.2 SUPPORTS</h4> <ul><li><strong>核心定义</strong>：如果当前存在外部事务，则内部事务加入外部事务；如果当前没有外部事务，则内部事务以“非事务方式”执行（不创建新事务）。</li> <li><strong>英文释义</strong>：Support a current transaction, execute non-transactionally if none exists.</li> <li><strong>执行逻辑</strong>：
<ol><li>外部有事务：加入外部事务，遵循外部事务的提交/回滚规则；</li> <li>外部无事务：以普通方法执行，无事务保障（操作直接提交到数据库）。</li></ol></li> <li><strong>回滚规则</strong>：
<ul><li>外部有事务时：内部方法的异常会导致整个事务回滚；</li> <li>外部无事务时：内部方法的异常不会触发回滚（操作已直接提交）。</li></ul></li> <li><strong>适用场景</strong>：适用于“可选事务”的场景（如查询操作，有事务则加入，无则正常执行）。</li> <li><strong>注意</strong>：SUPPORTS是“被动依赖”外部事务，本身不主动创建事务，需谨慎使用（避免非事务场景下的数据一致性问题）。</li></ul> <h3 id="_3-2-第二类-不依赖外部事务-强制创建新事务"><a href="#_3-2-第二类-不依赖外部事务-强制创建新事务" class="header-anchor">#</a> 3.2 第二类：不依赖外部事务（强制创建新事务）</h3> <p>此类传播行为的核心特点是：无论外部是否存在事务，内部事务都会强制创建新的独立事务，与外部事务完全隔离。包含2种传播行为：REQUIRES_NEW、NOT_SUPPORTED。</p> <h4 id="_3-2-1-requires-new"><a href="#_3-2-1-requires-new" class="header-anchor">#</a> 3.2.1 REQUIRES_NEW</h4> <ul><li><strong>核心定义</strong>：无论当前是否存在外部事务，内部事务都会创建一个全新的独立事务；如果外部存在事务，则先将外部事务挂起，待内部事务执行完成后，再恢复外部事务。</li> <li><strong>英文释义</strong>：Create a new transaction, and suspend the current transaction if one exists.</li> <li><strong>执行逻辑</strong>：
<ol><li>外部有事务：挂起外部事务 → 创建内部新事务 → 内部事务执行完成（提交/回滚） → 恢复外部事务继续执行；</li> <li>外部无事务：直接创建新事务，自己控制提交/回滚。</li></ol></li> <li><strong>回滚规则</strong>：
<ul><li>内部事务的提交/回滚与外部事务完全独立：内部事务失败回滚，不影响外部事务；外部事务失败回滚，也不影响内部事务；</li> <li>若内部事务抛出异常，外部事务若未捕获，外部事务会回滚；但内部事务的操作已独立提交/回滚，不受影响。</li></ul></li> <li><strong>适用场景</strong>：适用于“内部事务需要独立存在”的场景（如操作日志、审计记录等，即使主业务失败，日志也需保留）。</li> <li><strong>实战示例</strong>：改造下单记日志场景：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 外部方法（下单，有事务）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 保存订单</span>
        orderDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 调用内部方法（记日志，REQUIRES_NEW）</span>
        logService<span class="token punctuation">.</span><span class="token function">recordOrderLog</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;创建订单&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 模拟下单失败</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;下单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;下单异常：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部方法（记日志，REQUIRES_NEW）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRES_NEW</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordOrderLog</span><span class="token punctuation">(</span><span class="token class-name">Long</span> orderId<span class="token punctuation">,</span> <span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">OrderLog</span> log <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    logDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>执行结果分析：</p> <ul><li>下单方法抛出异常，外部事务回滚，订单不会被保存；</li> <li>记日志方法使用REQUIRES_NEW，创建了独立事务，即使外部事务回滚，日志仍会被成功保存（符合“日志独立保留”的需求）。</li></ul> <h4 id="_3-2-2-not-supported"><a href="#_3-2-2-not-supported" class="header-anchor">#</a> 3.2.2 NOT_SUPPORTED</h4> <ul><li><strong>核心定义</strong>：内部事务以“非事务方式”执行；如果当前存在外部事务，则先将外部事务挂起，待内部方法执行完成后，再恢复外部事务。</li> <li><strong>英文释义</strong>：Execute non-transactionally, suspend the current transaction if one exists.</li> <li><strong>执行逻辑</strong>：
<ol><li>外部有事务：挂起外部事务 → 内部方法以非事务方式执行（操作直接提交） → 恢复外部事务；</li> <li>外部无事务：直接以非事务方式执行。</li></ol></li> <li><strong>回滚规则</strong>：内部方法的操作不会受任何事务回滚影响（因为本身无事务）；外部事务的回滚也不会影响内部方法的已提交操作。</li> <li><strong>适用场景</strong>：适用于“不需要事务”的场景（如查询大量数据、执行耗时的非核心操作，避免事务长时间占用资源）。</li> <li><strong>注意</strong>：NOT_SUPPORTED会主动挂起外部事务，可能导致外部事务的锁资源长时间占用，需谨慎使用。</li></ul> <h3 id="_3-3-第三类-禁止事务-不允许存在事务"><a href="#_3-3-第三类-禁止事务-不允许存在事务" class="header-anchor">#</a> 3.3 第三类：禁止事务（不允许存在事务）</h3> <p>此类传播行为的核心特点是：明确禁止事务环境，若存在外部事务则直接抛出异常。包含2种传播行为：MANDATORY、NEVER。</p> <h4 id="_3-3-1-mandatory"><a href="#_3-3-1-mandatory" class="header-anchor">#</a> 3.3.1 MANDATORY</h4> <ul><li><strong>核心定义</strong>：内部事务必须在外部事务的环境中执行（即当前必须存在外部事务）；如果当前没有外部事务，则直接抛出异常（IllegalTransactionStateException）。</li> <li><strong>英文释义</strong>：Support a current transaction, throw an exception if none exists.</li> <li><strong>执行逻辑</strong>：仅当外部存在事务时，内部事务加入外部事务；否则直接抛异常，不执行任何业务逻辑。</li> <li><strong>适用场景</strong>：适用于“内部方法必须依赖外部事务”的场景（如核心业务的子操作，必须在主事务中执行，不允许独立执行）。</li> <li><strong>实战示例</strong>：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 内部方法（必须依赖外部事务）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">MANDATORY</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token class-name">Integer</span> quantity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 扣库存逻辑</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试：无外部事务调用</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWithoutOuterTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用deductStock，会直接抛出IllegalTransactionStateException</span>
    stockService<span class="token punctuation">.</span><span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_3-3-2-never"><a href="#_3-3-2-never" class="header-anchor">#</a> 3.3.2 NEVER</h4> <ul><li><strong>核心定义</strong>：内部事务必须在“非事务环境”中执行；如果当前存在外部事务，则直接抛出异常（IllegalTransactionStateException）。</li> <li><strong>英文释义</strong>：Execute non-transactionally, throw an exception if a transaction exists.</li> <li><strong>执行逻辑</strong>：仅当外部无事务时，以非事务方式执行；若外部有事务，直接抛异常。</li> <li><strong>适用场景</strong>：适用于“明确禁止事务”的场景（如某些只读操作，不允许在事务中执行，避免事务开销）。</li></ul> <h3 id="_3-4-第四类-嵌套事务-依赖外部事务-有独立回滚点"><a href="#_3-4-第四类-嵌套事务-依赖外部事务-有独立回滚点" class="header-anchor">#</a> 3.4 第四类：嵌套事务（依赖外部事务，有独立回滚点）</h3> <p>此类传播行为是Spring对JDBC保存点（Savepoint）的封装，核心特点是：内部事务嵌套在外部事务中，有独立的回滚点，内部事务回滚时不会影响外部事务的整体提交。仅包含1种传播行为：NESTED。</p> <h4 id="_3-4-1-nested"><a href="#_3-4-1-nested" class="header-anchor">#</a> 3.4.1 NESTED</h4> <ul><li><strong>核心定义</strong>：如果当前存在外部事务，则内部事务作为外部事务的“嵌套事务”执行（创建保存点）；如果当前没有外部事务，则创建新的独立事务（与REQUIRED一致）。</li> <li><strong>英文释义</strong>：Execute within a nested transaction if a current transaction exists, behave like REQUIRED otherwise.</li> <li><strong>执行逻辑</strong>：
<ol><li>外部有事务：在外部事务中创建保存点 → 内部事务执行 → 内部事务失败时，仅回滚到保存点（不影响外部事务之前的操作）；外部事务失败时，会回滚包括嵌套事务在内的所有操作；</li> <li>外部无事务：与REQUIRED一致，创建新事务。</li></ol></li> <li><strong>回滚规则</strong>：
<ul><li>内部事务回滚：仅回滚自身操作，外部事务可继续执行；</li> <li>外部事务回滚：内部事务的操作也会被回滚；</li> <li>内部事务提交：不会立即提交到数据库，需等待外部事务最终提交（嵌套事务依赖外部事务的提交）。</li></ul></li> <li><strong>与REQUIRES_NEW的核心区别</strong>：</li></ul> <table><thead><tr><th>特性</th> <th>NESTED（嵌套事务）</th> <th>REQUIRES_NEW（新事务）</th></tr></thead> <tbody><tr><td>事务独立性</td> <td>依赖外部事务，无独立事务（共用一个事务）</td> <td>完全独立，创建全新事务</td></tr> <tr><td>提交时机</td> <td>依赖外部事务提交（自身提交无效）</td> <td>自身独立提交，不依赖外部</td></tr> <tr><td>回滚范围</td> <td>仅回滚到保存点，不影响外部事务之前操作</td> <td>回滚自身事务，与外部事务无关</td></tr> <tr><td>底层实现</td> <td>基于JDBC保存点（Savepoint）</td> <td>基于事务挂起（Suspend）机制</td></tr></tbody></table> <ul><li><strong>适用场景</strong>：适用于“批量操作”或“部分回滚”的场景（如批量导入数据，单条数据导入失败时，仅回滚该条数据，不影响其他数据和外部事务）。</li> <li><strong>实战示例</strong>：批量导入用户数据：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 外部方法（批量导入，有事务）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchImportUser</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">User</span> user <span class="token operator">:</span> userList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 调用内部方法（嵌套事务，NESTED）</span>
            userService<span class="token punctuation">.</span><span class="token function">importSingleUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 捕获内部异常，仅记录日志，不影响其他用户导入</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;导入用户{}失败：{}&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 内部方法（单条导入，NESTED）</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">NESTED</span><span class="token punctuation">,</span> rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">importSingleUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userDao<span class="token punctuation">.</span><span class="token function">existsByUsername</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;用户名已存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>执行结果分析：</p> <ul><li>若某条用户数据导入失败（用户名已存在），importSingleUser会回滚到保存点，仅该条数据的操作被回滚；</li> <li>外部方法捕获异常后，继续导入其他用户，最终外部事务提交，所有导入成功的用户数据会被保存；</li> <li>若外部方法中途抛出异常（如系统异常），则所有导入操作（包括成功的）都会被回滚。</li></ul> <h3 id="_3-5-7种传播行为核心对比表"><a href="#_3-5-7种传播行为核心对比表" class="header-anchor">#</a> 3.5 7种传播行为核心对比表</h3> <table><thead><tr><th>传播行为</th> <th>外部有事务</th> <th>外部无事务</th> <th>核心特点</th> <th>适用场景</th></tr></thead> <tbody><tr><td>REQUIRED（默认）</td> <td>加入外部事务</td> <td>创建新事务</td> <td>强依赖外部事务，荣辱与共</td> <td>下单扣库存、转账等核心业务</td></tr> <tr><td>SUPPORTS</td> <td>加入外部事务</td> <td>非事务执行</td> <td>可选事务，被动依赖</td> <td>可选事务的查询操作</td></tr> <tr><td>REQUIRES_NEW</td> <td>挂起外部，创建新事务</td> <td>创建新事务</td> <td>完全独立，事务隔离</td> <td>操作日志、审计记录等独立业务</td></tr> <tr><td>NOT_SUPPORTED</td> <td>挂起外部，非事务执行</td> <td>非事务执行</td> <td>禁止事务，主动挂起</td> <td>耗时非核心操作、大量查询</td></tr> <tr><td>MANDATORY</td> <td>加入外部事务</td> <td>抛异常</td> <td>必须依赖外部事务</td> <td>核心业务子操作，不允许独立执行</td></tr> <tr><td>NEVER</td> <td>抛异常</td> <td>非事务执行</td> <td>禁止事务，无事务则执行</td> <td>明确禁止事务的只读操作</td></tr> <tr><td>NESTED</td> <td>嵌套执行（保存点）</td> <td>创建新事务</td> <td>依赖外部，独立回滚点</td> <td>批量操作、部分回滚场景</td></tr></tbody></table> <h2 id="四、底层原理-spring事务传播如何实现"><a href="#四、底层原理-spring事务传播如何实现" class="header-anchor">#</a> 四、底层原理：Spring事务传播如何实现？</h2> <p>Spring事务传播机制的底层依赖“事务管理器”（PlatformTransactionManager）和“事务同步管理器”（TransactionSynchronizationManager），核心是通过“事务状态”（TransactionStatus）的管理实现传播行为的控制。</p> <h3 id="_4-1-核心组件"><a href="#_4-1-核心组件" class="header-anchor">#</a> 4.1 核心组件</h3> <ol><li><strong>PlatformTransactionManager</strong>：事务管理器核心接口，定义了getTransaction（获取事务）、commit（提交）、rollback（回滚）方法，不同数据源（JDBC、JPA、MyBatis）有对应的实现（如DataSourceTransactionManager）；</li> <li><strong>TransactionSynchronizationManager</strong>：线程本地变量（ThreadLocal）的封装，用于存储当前线程的事务状态（是否存在事务、事务保存点等），确保事务传播的线程安全；</li> <li><strong>TransactionStatus</strong>：封装事务的当前状态（是否为新事务、是否有保存点、是否已完成等），是事务传播的核心状态载体；</li> <li><strong>TransactionInterceptor</strong>：AOP拦截器，负责在事务方法执行前后拦截，调用事务管理器实现事务的开启、提交、回滚，是传播行为触发的入口。</li></ol> <h3 id="_4-2-核心执行流程-以requires-new为例"><a href="#_4-2-核心执行流程-以requires-new为例" class="header-anchor">#</a> 4.2 核心执行流程（以REQUIRES_NEW为例）</h3> <div class="language-mermaid line-numbers-mode"><pre class="language-mermaid"><code><span class="token keyword">graph</span> TD
    A<span class="token text string">[外部事务方法执行]</span> <span class="token arrow operator">--</span> 1.开启外部事务 <span class="token arrow operator">--&gt;</span> B<span class="token text string">[调用内部REQUIRES_NEW方法]</span>
    B <span class="token arrow operator">--</span> 2.TransactionInterceptor拦截 <span class="token arrow operator">--&gt;</span> C<span class="token text string">[TransactionSynchronizationManager获取当前事务状态]</span>
    C <span class="token arrow operator">--</span> 3.发现存在外部事务，挂起外部事务 <span class="token arrow operator">--&gt;</span> D<span class="token text string">[4.创建新的事务状态（新事务）]</span>
    D <span class="token arrow operator">--</span> 5.执行内部方法业务逻辑 <span class="token arrow operator">--&gt;</span> E<span class="token text string">{内部方法执行结果}</span>
    E <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span> <span class="token label property">成功</span> <span class="token arrow operator">--&gt;</span></span> F<span class="token text string">[提交新事务]</span>
    E <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span> <span class="token label property">失败</span> <span class="token arrow operator">--&gt;</span></span> G<span class="token text string">[回滚新事务]</span>
    F <span class="token arrow operator">--&gt;</span> H<span class="token text string">[恢复挂起的外部事务]</span>
    G <span class="token arrow operator">--&gt;</span> H
    H <span class="token arrow operator">--</span> 6.继续执行外部事务 <span class="token arrow operator">--&gt;</span> I<span class="token text string">{外部事务执行结果}</span>
    I <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span> <span class="token label property">成功</span> <span class="token arrow operator">--&gt;</span></span> J<span class="token text string">[提交外部事务]</span>
    I <span class="token inter-arrow-label"><span class="token arrow-head arrow operator">--</span> <span class="token label property">失败</span> <span class="token arrow operator">--&gt;</span></span> K<span class="token text string">[回滚外部事务]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-3-关键源码片段-事务状态获取"><a href="#_4-3-关键源码片段-事务状态获取" class="header-anchor">#</a> 4.3 关键源码片段（事务状态获取）</h3> <p>TransactionSynchronizationManager通过ThreadLocal存储事务状态，核心源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TransactionSynchronizationManager</span> <span class="token punctuation">{</span>
    <span class="token comment">// 存储当前线程的事务资源（如数据库连接）</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Transactional resources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 存储当前线程的事务状态</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">&gt;</span></span> transactionStatus <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Transaction status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取当前线程的事务资源</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getResourceMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> resources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableMap</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置事务状态</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTransactionStatus</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        transactionStatus<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...其他方法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>当执行事务方法时，TransactionInterceptor会通过TransactionSynchronizationManager获取当前线程的事务状态，再根据传播行为决定是创建新事务、加入外部事务还是挂起外部事务。</p> <h2 id="五、实战避坑-事务传播常见问题与解决方案"><a href="#五、实战避坑-事务传播常见问题与解决方案" class="header-anchor">#</a> 五、实战避坑：事务传播常见问题与解决方案</h2> <p>实际开发中，事务传播机制的使用容易出现各种问题，以下是最常见的3类问题及解决方案：</p> <h3 id="_5-1-问题1-嵌套事务不生效-传播行为未触发"><a href="#_5-1-问题1-嵌套事务不生效-传播行为未触发" class="header-anchor">#</a> 5.1 问题1：嵌套事务不生效（传播行为未触发）</h3> <p><strong>现象</strong>：内部事务方法的传播行为配置后不生效（如REQUIRES_NEW未创建新事务，NESTED未产生保存点）。</p> <p><strong>常见原因</strong>：</p> <ol><li>内部方法是“自调用”（同一类中方法调用）：A类的a()方法调用本类的b()方法（b()有@Transactional），此时AOP无法拦截，事务注解失效；</li> <li>事务方法不是public修饰：@Transactional仅对public方法生效，private、protected方法的事务注解会被忽略；</li> <li>未配置事务管理器：SpringBoot需引入spring-boot-starter-jdbc/data-jpa等依赖，自动配置事务管理器；若自定义数据源，需手动配置TransactionManager；</li> <li>异常被内部捕获：内部方法抛出的异常被catch捕获，未向上传播，导致事务回滚规则未触发。</li></ol> <p><strong>解决方案</strong>：</p> <ol><li>避免自调用：将内部事务方法抽取到独立的Service类中；</li> <li>确保事务方法是public修饰；</li> <li>检查事务管理器配置：SpringBoot可通过@EnableTransactionManagement开启事务管理（默认已开启）；</li> <li>异常必须向上传播：内部方法抛出的异常不要捕获，或捕获后重新抛出（throw e）。</li></ol> <h3 id="_5-2-问题2-回滚范围不符合预期"><a href="#_5-2-问题2-回滚范围不符合预期" class="header-anchor">#</a> 5.2 问题2：回滚范围不符合预期</h3> <p><strong>现象</strong>：期望内部事务回滚不影响外部事务，但实际外部事务也回滚；或期望外部事务回滚带动内部事务回滚，但实际内部事务未回滚。</p> <p><strong>常见原因</strong>：</p> <ol><li>传播行为选择错误：如需要独立事务却用了REQUIRED，需要嵌套回滚却用了REQUIRES_NEW；</li> <li>rollbackFor配置错误：默认情况下，Spring仅对“未检查异常”（RuntimeException及其子类）回滚，对“已检查异常”（如IOException）不回滚；若内部方法抛出已检查异常，未配置rollbackFor=Exception.class，会导致事务不回滚；</li> <li>NESTED传播行为未生效：NESTED依赖JDBC保存点，需确保数据库支持保存点（如MySQL 5.0+、Oracle均支持），且事务隔离级别不是READ_UNCOMMITTED。</li></ol> <p><strong>解决方案</strong>：</p> <ol><li>根据业务场景选择正确的传播行为（参考3.5节对比表）；</li> <li>显式配置rollbackFor=Exception.class，确保所有异常都能触发回滚；</li> <li>使用NESTED时，检查数据库是否支持保存点，调整事务隔离级别为DEFAULT（Spring默认，即数据库默认隔离级别）。</li></ol> <h3 id="_5-3-问题3-事务挂起导致的资源泄漏"><a href="#_5-3-问题3-事务挂起导致的资源泄漏" class="header-anchor">#</a> 5.3 问题3：事务挂起导致的资源泄漏</h3> <p><strong>现象</strong>：使用REQUIRES_NEW或NOT_SUPPORTED时，出现数据库连接泄漏、锁资源长时间占用。</p> <p><strong>常见原因</strong>：</p> <ol><li>内部事务执行时间过长：挂起外部事务后，内部事务长时间占用数据库连接，导致外部事务的连接资源无法释放；</li> <li>异常未处理导致挂起的事务未恢复：内部事务抛出异常后，未正确处理，导致挂起的外部事务无法恢复，连接资源泄漏。</li></ol> <p><strong>解决方案</strong>：</p> <ol><li>优化内部事务逻辑，缩短执行时间；</li> <li>确保异常正确传播和处理：即使内部事务失败，也要保证挂起的外部事务能正常恢复；</li> <li>避免频繁使用REQUIRES_NEW：仅在必要场景使用，减少事务挂起的开销。</li></ol> <h2 id="六、总结-事务传播的核心选型原则"><a href="#六、总结-事务传播的核心选型原则" class="header-anchor">#</a> 六、总结：事务传播的核心选型原则</h2> <p>Spring事务传播机制的核心是“根据业务场景选择合适的传播行为”，以下是核心选型原则，帮你快速决策：</p> <ol><li><strong>核心业务强关联</strong>：选REQUIRED（默认），确保内部和外部事务荣辱与共；</li> <li><strong>内部业务需独立</strong>：选REQUIRES_NEW，确保内部事务不受外部影响（如日志）；</li> <li><strong>批量操作部分回滚</strong>：选NESTED，通过保存点实现局部回滚；</li> <li><strong>必须依赖外部事务</strong>：选MANDATORY，禁止独立执行；</li> <li><strong>禁止事务执行</strong>：选NEVER或NOT_SUPPORTED，根据是否允许外部事务存在选择；</li> <li><strong>可选事务场景</strong>：选SUPPORTS，被动依赖外部事务。</li></ol> <p>最后需要强调：事务传播机制是Spring事务管理的高级特性，使用时需结合业务场景谨慎选择，避免过度设计。实际开发中，优先使用默认的REQUIRES_NEW，仅在有明确需求时才选择其他传播行为，同时注意规避“自调用”“异常捕获”等常见坑点，确保事务生效且符合预期。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《Spring》笔记/3.Spring事务传播机制.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Spring%E4%BA%8B%E5%8A%A1%E4%BC%A0%E6%92%AD%E6%9C%BA%E5%88%B6" title="标签">#Spring事务传播机制</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1c21ce/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Spring Boot Bean 生命周期</div></a> <a href="/pages/20d41f/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Spring Cloud Nacos 深度解析</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1c21ce/" class="prev">Spring Boot Bean 生命周期</a></span> <span class="next"><a href="/pages/20d41f/">Spring Cloud Nacos 深度解析</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/79.486534af.js" defer></script>
  </body>
</html>
