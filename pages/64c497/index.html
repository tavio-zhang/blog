<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka消息存储 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/48.7d4f854a.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/55.27ff3cca.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/60.800afb74.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/79.486534af.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/83.72b7d6a4.js"><link rel="prefetch" href="/assets/js/84.f5a347be.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/be2b14/" class="sidebar-link">Kafka的深度解析</a></li><li><a href="/pages/64c497/" aria-current="page" class="active sidebar-link">Kafka消息存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/64c497/#一、核心设计原则-支撑高吞吐的底层逻辑" class="sidebar-link">一、核心设计原则：支撑高吞吐的底层逻辑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_1-分区隔离存储" class="sidebar-link">1. 分区隔离存储</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_2-日志分段存储" class="sidebar-link">2. 日志分段存储</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_3-索引辅助查询" class="sidebar-link">3. 索引辅助查询</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/64c497/#二、分区存储结构-三层设计的精细化管理" class="sidebar-link">二、分区存储结构：三层设计的精细化管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_1-目录层-分区的物理隔离单元" class="sidebar-link">1. 目录层：分区的物理隔离单元</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_2-日志分段层-消息存储的基本单元" class="sidebar-link">2. 日志分段层：消息存储的基本单元</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#分段核心特性" class="sidebar-link">分段核心特性：</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_3-消息格式-二进制的高效编码" class="sidebar-link">3. 消息格式：二进制的高效编码</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/64c497/#三、消息全生命周期-从生产到清理的完整流程" class="sidebar-link">三、消息全生命周期：从生产到清理的完整流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_1-消息写入-高效持久化的底层逻辑" class="sidebar-link">1. 消息写入：高效持久化的底层逻辑</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_1-内存缓冲-利用页缓存提升写入速度" class="sidebar-link">（1）内存缓冲：利用页缓存提升写入速度</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_2-刷盘策略-平衡性能与可靠性" class="sidebar-link">（2）刷盘策略：平衡性能与可靠性</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_3-顺序写入-磁盘性能最大化" class="sidebar-link">（3）顺序写入：磁盘性能最大化</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_2-副本同步-可靠性的核心保障" class="sidebar-link">2. 副本同步：可靠性的核心保障</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_1-同步流程" class="sidebar-link">（1）同步流程</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_2-isr机制-定义-有效副本" class="sidebar-link">（2）ISR机制：定义&quot;有效副本&quot;</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_3-acks参数-控制消息可靠性等级" class="sidebar-link">（3）acks参数：控制消息可靠性等级</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_3-消息消费-基于索引的快速定位" class="sidebar-link">3. 消息消费：基于索引的快速定位</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_1-按offset查询-依赖-index文件" class="sidebar-link">（1）按Offset查询（依赖.index文件）</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_2-按时间戳查询-依赖-timeindex文件" class="sidebar-link">（2）按时间戳查询（依赖.timeindex文件）</a></li><li class="sidebar-sub-header level3"><a href="/pages/64c497/#_4-日志清理-可控的存储管理" class="sidebar-link">4. 日志清理：可控的存储管理</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_1-基于时间的清理-默认策略" class="sidebar-link">（1）基于时间的清理（默认策略）</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_2-基于大小的清理" class="sidebar-link">（2）基于大小的清理</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_3-日志压缩-针对key-value消息" class="sidebar-link">（3）日志压缩（针对Key-Value消息）</a></li><li class="sidebar-sub-header level4"><a href="/pages/64c497/#_4-清理触发机制" class="sidebar-link">（4）清理触发机制</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/64c497/#四、总结-设计为何支撑高吞吐与高可靠" class="sidebar-link">四、总结：设计为何支撑高吞吐与高可靠？</a></li></ul></li><li><a href="/pages/fb5f0d/" class="sidebar-link">Kafka的生产消费</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/note/kafka/#《Kafka》笔记" data-v-06225672>《Kafka》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-02-04</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Kafka消息存储<!----></h1>  <div class="theme-vdoing-content content__default"><p>Kafka作为分布式流处理平台，其高吞吐、高可靠的核心特性离不开精心设计的消息存储机制。</p> <h2 id="一、核心设计原则-支撑高吞吐的底层逻辑"><a href="#一、核心设计原则-支撑高吞吐的底层逻辑" class="header-anchor">#</a> 一、核心设计原则：支撑高吞吐的底层逻辑</h2> <p>Kafka的消息存储机制围绕&quot;高效写入、快速查询、可控清理&quot;三大目标设计，核心原则如下：</p> <h3 id="_1-分区隔离存储"><a href="#_1-分区隔离存储" class="header-anchor">#</a> 1. 分区隔离存储</h3> <p>每个Topic的分区（Partition）对应独立的存储目录，物理层面完全隔离。这种设计带来两大优势：</p> <ul><li>避免不同分区的消息读写相互干扰，降低锁竞争；</li> <li>支持分区级别的并行操作（如并行写入、并行清理），提升整体吞吐量。</li></ul> <h3 id="_2-日志分段存储"><a href="#_2-日志分段存储" class="header-anchor">#</a> 2. 日志分段存储</h3> <p>单个分区的消息不会存储在一个大文件中，而是拆分为多个<strong>日志分段（Log Segment）</strong>。这种分段化设计解决了三大问题：</p> <ul><li>避免单文件过大导致的IO性能下降（大文件随机读写效率低）；</li> <li>便于按分段进行过期清理，无需操作整个分区数据；</li> <li>简化日志压缩、数据迁移等运维操作。</li></ul> <h3 id="_3-索引辅助查询"><a href="#_3-索引辅助查询" class="header-anchor">#</a> 3. 索引辅助查询</h3> <p>每个日志分段配套两类索引文件：偏移量索引（.index）和时间戳索引（.timeindex）。通过索引可以快速定位消息位置，避免全文件扫描，大幅提升查询效率。</p> <h2 id="二、分区存储结构-三层设计的精细化管理"><a href="#二、分区存储结构-三层设计的精细化管理" class="header-anchor">#</a> 二、分区存储结构：三层设计的精细化管理</h2> <p>Kafka的分区存储采用&quot;目录-分段-索引&quot;三层结构，每层各司其职，共同实现消息的有序存储与高效访问。</p> <h3 id="_1-目录层-分区的物理隔离单元"><a href="#_1-目录层-分区的物理隔离单元" class="header-anchor">#</a> 1. 目录层：分区的物理隔离单元</h3> <p>Broker启动时，会根据<code>log.dirs</code>配置的根目录，为每个Topic的分区创建独立目录，命名格式为<code>{Topic名称}-{分区序号}</code>。</p> <p><strong>示例目录结构</strong>：
若根目录为<code>/kafka-logs</code>，Topic为<code>order</code>且包含3个分区，则目录结构如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/kafka-logs/                # 根目录（log.dirs配置）
├─ order-0/                 # 分区0的存储目录
├─ order-1/                 # 分区1的存储目录
└─ order-2/                 # 分区2的存储目录
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>每个分区目录下，存放该分区的所有日志分段文件及对应的索引文件。</p> <h3 id="_2-日志分段层-消息存储的基本单元"><a href="#_2-日志分段层-消息存储的基本单元" class="header-anchor">#</a> 2. 日志分段层：消息存储的基本单元</h3> <p>每个分区由多个日志分段组成，单个分段包含三类文件：</p> <table><thead><tr><th>文件类型</th> <th>文件名格式</th> <th>核心作用</th></tr></thead> <tbody><tr><td>消息日志文件</td> <td>{起始Offset}.log</td> <td>存储实际消息数据（二进制格式）</td></tr> <tr><td>偏移量索引文件</td> <td>{起始Offset}.index</td> <td>映射Offset与.log文件内的物理偏移</td></tr> <tr><td>时间戳索引文件</td> <td>{起始Offset}.timeindex</td> <td>映射时间戳与Offset的对应关系</td></tr></tbody></table> <h4 id="分段核心特性"><a href="#分段核心特性" class="header-anchor">#</a> 分段核心特性：</h4> <ul><li><strong>命名规则</strong>：文件名以分段存储的第一条消息的Offset命名（19位数字，不足补0）。例如：
<ul><li>初始分段命名为<code>0000000000000000000.log</code>（存储Offset从0开始的消息）；</li> <li>当该分段写满后，下一个分段以&quot;上一分段最后一条消息Offset+1&quot;命名（如<code>0000000000000012345.log</code>）。</li></ul></li> <li><strong>滚动机制</strong>：单个分段默认大小为1GB（可通过<code>log.segment.bytes</code>配置），当消息写入达到阈值时，自动创建新分段（当前分段变为只读）。</li> <li><strong>活跃分段</strong>：分区中正在写入消息的分段称为&quot;活跃分段&quot;（Active Segment），其余为只读分段（避免随机写，保证顺序IO）。</li></ul> <h3 id="_3-消息格式-二进制的高效编码"><a href="#_3-消息格式-二进制的高效编码" class="header-anchor">#</a> 3. 消息格式：二进制的高效编码</h3> <p><code>.log</code>文件中的消息以固定格式的字节流存储，采用&quot;只追加&quot;（Append-Only）方式写入，保证顺序IO（磁盘顺序写性能接近内存）。</p> <p><strong>V2版本消息格式核心字段</strong>（Kafka 0.11+）：</p> <ul><li>长度字段：记录消息总字节数；</li> <li>属性字段：包含压缩类型、时间戳类型等元数据；</li> <li>时间戳：消息创建时间（可由Producer指定或Broker生成）；</li> <li>键（Key）与值（Value）：实际业务数据（支持压缩，如GZIP、Snappy）；</li> <li>偏移量（Offset）：分区内的唯一序号（由Broker分配）；</li> <li>校验和：用于检测消息完整性。</li></ul> <h2 id="三、消息全生命周期-从生产到清理的完整流程"><a href="#三、消息全生命周期-从生产到清理的完整流程" class="header-anchor">#</a> 三、消息全生命周期：从生产到清理的完整流程</h2> <p>Kafka的消息管理贯穿&quot;生产-同步-消费-清理&quot;四个阶段，每个阶段均有特定机制保障可靠性与效率。</p> <h3 id="_1-消息写入-高效持久化的底层逻辑"><a href="#_1-消息写入-高效持久化的底层逻辑" class="header-anchor">#</a> 1. 消息写入：高效持久化的底层逻辑</h3> <p>Producer发送的消息经分区路由（按Key哈希或轮询）后，投递到目标分区的活跃分段，写入过程分为三步：</p> <h4 id="_1-内存缓冲-利用页缓存提升写入速度"><a href="#_1-内存缓冲-利用页缓存提升写入速度" class="header-anchor">#</a> （1）内存缓冲：利用页缓存提升写入速度</h4> <p>消息并非直接写入磁盘，而是先写入操作系统的<strong>页缓存（Page Cache）</strong>：</p> <ul><li>页缓存是操作系统为磁盘文件分配的内存缓冲区，由OS统一管理；</li> <li>避免频繁磁盘IO，通过批量刷盘（异步）降低性能损耗。</li></ul> <h4 id="_2-刷盘策略-平衡性能与可靠性"><a href="#_2-刷盘策略-平衡性能与可靠性" class="header-anchor">#</a> （2）刷盘策略：平衡性能与可靠性</h4> <p>页缓存中的数据需定期刷入磁盘（持久化），Kafka提供两种配置控制刷盘时机：</p> <ul><li><code>log.flush.interval.messages</code>：累计写入消息数达到阈值时刷盘；</li> <li><code>log.flush.interval.ms</code>：距离上次刷盘时间达到阈值时刷盘。
（默认依赖OS自身的刷盘策略，通常为几秒到几分钟）</li></ul> <h4 id="_3-顺序写入-磁盘性能最大化"><a href="#_3-顺序写入-磁盘性能最大化" class="header-anchor">#</a> （3）顺序写入：磁盘性能最大化</h4> <p>由于消息仅追加到活跃分段的末尾（顺序写），而磁盘的顺序写性能远高于随机写（机械盘顺序写速度可达200MB/s，随机写仅100KB/s），这是Kafka高吞吐的核心原因之一。</p> <h3 id="_2-副本同步-可靠性的核心保障"><a href="#_2-副本同步-可靠性的核心保障" class="header-anchor">#</a> 2. 副本同步：可靠性的核心保障</h3> <p>Kafka通过多副本（Replica）机制防止消息丢失，每个分区包含：</p> <ul><li>1个Leader副本：处理读写请求，是消息的&quot;主副本&quot;；</li> <li>多个Follower副本：从Leader同步消息，作为&quot;备用副本&quot;。</li></ul> <h4 id="_1-同步流程"><a href="#_1-同步流程" class="header-anchor">#</a> （1）同步流程</h4> <p>Follower通过&quot;拉取（Pull）&quot;机制同步消息：</p> <ol><li>Follower定期向Leader发送同步请求（包含已同步的最大Offset）；</li> <li>Leader返回该Offset之后的消息；</li> <li>Follower写入消息并更新本地Offset，完成同步。</li></ol> <h4 id="_2-isr机制-定义-有效副本"><a href="#_2-isr机制-定义-有效副本" class="header-anchor">#</a> （2）ISR机制：定义&quot;有效副本&quot;</h4> <p>只有处于<strong>ISR（In-Sync Replicas，同步副本集）</strong> 中的Follower才被视为有效副本：</p> <ul><li>ISR包含Leader及所有与Leader数据差距在<code>replica.lag.time.max.ms</code>（默认30s）内的Follower；</li> <li>若Follower长时间未同步（超过阈值），会被踢出ISR；</li> <li>当Leader故障时，仅从ISR中选举新Leader，保证数据一致性。</li></ul> <h4 id="_3-acks参数-控制消息可靠性等级"><a href="#_3-acks参数-控制消息可靠性等级" class="header-anchor">#</a> （3）acks参数：控制消息可靠性等级</h4> <p>Producer通过<code>acks</code>参数配置消息确认机制，平衡可靠性与吞吐量：</p> <ul><li><code>acks=0</code>：Producer发送后不等待确认，吞吐量最高但可能丢失消息；</li> <li><code>acks=1</code>：仅等待Leader写入页缓存后确认（无需持久化到磁盘），性能与可靠性平衡；</li> <li><code>acks=all</code>（或<code>acks=-1</code>）：需等待ISR中所有副本写入页缓存后确认，可靠性最高但吞吐量最低。</li></ul> <h3 id="_3-消息消费-基于索引的快速定位"><a href="#_3-消息消费-基于索引的快速定位" class="header-anchor">#</a> 3. 消息消费：基于索引的快速定位</h3> <p>Consumer通过Offset拉取消息时，Kafka利用索引文件快速定位消息位置，流程如下：</p> <h4 id="_1-按offset查询-依赖-index文件"><a href="#_1-按offset查询-依赖-index文件" class="header-anchor">#</a> （1）按Offset查询（依赖.index文件）</h4> <ol><li>遍历分区的所有分段，找到&quot;起始Offset ≤ 目标Offset ≤ 下一分段起始Offset&quot;的目标分段；</li> <li>在目标分段的<code>.index</code>文件中，通过二分查找找到&quot;小于等于目标Offset的最大索引项&quot;；</li> <li>索引项包含该Offset在<code>.log</code>文件中的物理偏移量，从该位置顺序读取即可找到目标消息。</li></ol> <h4 id="_2-按时间戳查询-依赖-timeindex文件"><a href="#_2-按时间戳查询-依赖-timeindex文件" class="header-anchor">#</a> （2）按时间戳查询（依赖.timeindex文件）</h4> <ol><li>遍历所有分段，通过<code>.timeindex</code>找到包含目标时间戳的分段；</li> <li>在该分段内通过时间戳索引定位对应的Offset；</li> <li>后续流程同&quot;按Offset查询&quot;。</li></ol> <h3 id="_4-日志清理-可控的存储管理"><a href="#_4-日志清理-可控的存储管理" class="header-anchor">#</a> 4. 日志清理：可控的存储管理</h3> <p>Kafka不会永久存储消息，通过清理机制释放磁盘空间，主要有两种清理策略：</p> <h4 id="_1-基于时间的清理-默认策略"><a href="#_1-基于时间的清理-默认策略" class="header-anchor">#</a> （1）基于时间的清理（默认策略）</h4> <ul><li>触发条件：分段创建时间超过<code>log.retention.hours</code>（默认168小时，即7天）；</li> <li>执行逻辑：删除整个过期分段（仅删除非活跃分段，避免影响活跃写入）。</li></ul> <h4 id="_2-基于大小的清理"><a href="#_2-基于大小的清理" class="header-anchor">#</a> （2）基于大小的清理</h4> <ul><li>触发条件：分区总大小超过<code>log.retention.bytes</code>（默认-1，即不限制）；</li> <li>执行逻辑：从最旧的分段开始删除，直到总大小低于阈值。</li></ul> <h4 id="_3-日志压缩-针对key-value消息"><a href="#_3-日志压缩-针对key-value消息" class="header-anchor">#</a> （3）日志压缩（针对Key-Value消息）</h4> <ul><li>适用场景：需保留每个Key最新值的场景（如用户配置、状态更新）；</li> <li>执行逻辑：对相同Key的消息，仅保留最新Offset的消息，删除历史版本；</li> <li>配置方式：通过<code>log.cleanup.policy=compact</code>启用，配合<code>log.cleaner.min.compaction.lag.ms</code>控制压缩延迟。</li></ul> <h4 id="_4-清理触发机制"><a href="#_4-清理触发机制" class="header-anchor">#</a> （4）清理触发机制</h4> <p>由Broker后台线程（LogCleaner）定期检查（默认每30秒），符合条件则执行清理，避免阻塞正常读写。</p> <h2 id="四、总结-设计为何支撑高吞吐与高可靠"><a href="#四、总结-设计为何支撑高吞吐与高可靠" class="header-anchor">#</a> 四、总结：设计为何支撑高吞吐与高可靠？</h2> <p>Kafka的消息存储机制通过三层设计与全生命周期管理，完美平衡了性能与可靠性：</p> <ul><li><strong>高吞吐</strong>：分区隔离、顺序写入、页缓存利用，最大化磁盘IO效率；</li> <li><strong>高可靠</strong>：多副本同步、ISR机制、可配置的acks策略，确保消息不丢失；</li> <li><strong>可扩展</strong>：分段化存储与索引优化，支持TB级数据高效管理。</li></ul> <p>这些设计细节共同构成了Kafka作为分布式消息系统的核心竞争力，也是其在大数据场景中广泛应用的底层支撑。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《Kafka》笔记/2.Kafka消息存储.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Kafka%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8" title="标签">#Kafka消息存储</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/be2b14/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Kafka的深度解析</div></a> <a href="/pages/fb5f0d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Kafka的生产消费</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/be2b14/" class="prev">Kafka的深度解析</a></span> <span class="next"><a href="/pages/fb5f0d/">Kafka的生产消费</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/48.7d4f854a.js" defer></script>
  </body>
</html>
