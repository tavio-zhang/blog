<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Cloud Seata 深度解析 | Tavio&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.jpg">
    <meta name="description" content="后端技术博客,别让自己落后于技术的迭代">
    <meta name="keywords" content="鲜衣努码少年郎">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.3d594d45.css" as="style"><link rel="preload" href="/assets/js/app.c6ba13aa.js" as="script"><link rel="preload" href="/assets/js/2.8d9f533d.js" as="script"><link rel="preload" href="/assets/js/83.72b7d6a4.js" as="script"><link rel="prefetch" href="/assets/js/10.3c6e6522.js"><link rel="prefetch" href="/assets/js/11.09bc43b4.js"><link rel="prefetch" href="/assets/js/12.a996a87c.js"><link rel="prefetch" href="/assets/js/13.b02d3acf.js"><link rel="prefetch" href="/assets/js/14.64fd6e84.js"><link rel="prefetch" href="/assets/js/15.089c02a9.js"><link rel="prefetch" href="/assets/js/16.8fa236f4.js"><link rel="prefetch" href="/assets/js/17.a1730b7a.js"><link rel="prefetch" href="/assets/js/18.1335a425.js"><link rel="prefetch" href="/assets/js/19.9293cbc0.js"><link rel="prefetch" href="/assets/js/20.5d0fd1df.js"><link rel="prefetch" href="/assets/js/21.4319dddd.js"><link rel="prefetch" href="/assets/js/22.2d6d1193.js"><link rel="prefetch" href="/assets/js/23.f154e330.js"><link rel="prefetch" href="/assets/js/24.66ba0133.js"><link rel="prefetch" href="/assets/js/25.5979047a.js"><link rel="prefetch" href="/assets/js/26.04889c33.js"><link rel="prefetch" href="/assets/js/27.337928e8.js"><link rel="prefetch" href="/assets/js/28.665066df.js"><link rel="prefetch" href="/assets/js/29.5aa838b8.js"><link rel="prefetch" href="/assets/js/3.1aac6e80.js"><link rel="prefetch" href="/assets/js/30.a8923cf6.js"><link rel="prefetch" href="/assets/js/31.a290d548.js"><link rel="prefetch" href="/assets/js/32.cb2b7fdd.js"><link rel="prefetch" href="/assets/js/33.3286dca2.js"><link rel="prefetch" href="/assets/js/34.9aebb473.js"><link rel="prefetch" href="/assets/js/35.5777ff14.js"><link rel="prefetch" href="/assets/js/36.5c29dd6e.js"><link rel="prefetch" href="/assets/js/37.cbf6fde7.js"><link rel="prefetch" href="/assets/js/38.2a1572ab.js"><link rel="prefetch" href="/assets/js/39.000aacf6.js"><link rel="prefetch" href="/assets/js/4.16da1e3f.js"><link rel="prefetch" href="/assets/js/40.8fbbcfa8.js"><link rel="prefetch" href="/assets/js/41.1b995757.js"><link rel="prefetch" href="/assets/js/42.575e5238.js"><link rel="prefetch" href="/assets/js/43.0a4cb54f.js"><link rel="prefetch" href="/assets/js/44.8d3b4283.js"><link rel="prefetch" href="/assets/js/45.ae001bba.js"><link rel="prefetch" href="/assets/js/46.fc29dcb1.js"><link rel="prefetch" href="/assets/js/47.628ee1ef.js"><link rel="prefetch" href="/assets/js/48.7d4f854a.js"><link rel="prefetch" href="/assets/js/49.e848253a.js"><link rel="prefetch" href="/assets/js/5.20e9c2cf.js"><link rel="prefetch" href="/assets/js/50.045225be.js"><link rel="prefetch" href="/assets/js/51.d05a2035.js"><link rel="prefetch" href="/assets/js/52.35a2519d.js"><link rel="prefetch" href="/assets/js/53.ca8d5bc8.js"><link rel="prefetch" href="/assets/js/54.eb93e6ae.js"><link rel="prefetch" href="/assets/js/55.27ff3cca.js"><link rel="prefetch" href="/assets/js/56.4a98635a.js"><link rel="prefetch" href="/assets/js/57.db243c6d.js"><link rel="prefetch" href="/assets/js/58.650ffef2.js"><link rel="prefetch" href="/assets/js/59.9af578d0.js"><link rel="prefetch" href="/assets/js/6.cf5ce51d.js"><link rel="prefetch" href="/assets/js/60.800afb74.js"><link rel="prefetch" href="/assets/js/61.59b23cca.js"><link rel="prefetch" href="/assets/js/62.35998712.js"><link rel="prefetch" href="/assets/js/63.824df362.js"><link rel="prefetch" href="/assets/js/64.2f51e9d0.js"><link rel="prefetch" href="/assets/js/65.926e2499.js"><link rel="prefetch" href="/assets/js/66.2af85da2.js"><link rel="prefetch" href="/assets/js/67.bbd8d4b3.js"><link rel="prefetch" href="/assets/js/68.163c774f.js"><link rel="prefetch" href="/assets/js/69.deed8d29.js"><link rel="prefetch" href="/assets/js/7.92776da2.js"><link rel="prefetch" href="/assets/js/70.d6a81068.js"><link rel="prefetch" href="/assets/js/71.9adb8c50.js"><link rel="prefetch" href="/assets/js/72.9ba26fc5.js"><link rel="prefetch" href="/assets/js/73.c3ee5d2f.js"><link rel="prefetch" href="/assets/js/74.af7973c7.js"><link rel="prefetch" href="/assets/js/75.ed8e7990.js"><link rel="prefetch" href="/assets/js/76.668519a5.js"><link rel="prefetch" href="/assets/js/77.d6cb2694.js"><link rel="prefetch" href="/assets/js/78.494cff39.js"><link rel="prefetch" href="/assets/js/79.486534af.js"><link rel="prefetch" href="/assets/js/8.d7fc67a9.js"><link rel="prefetch" href="/assets/js/80.c60f84eb.js"><link rel="prefetch" href="/assets/js/81.80ab610c.js"><link rel="prefetch" href="/assets/js/82.38a483d0.js"><link rel="prefetch" href="/assets/js/84.f5a347be.js"><link rel="prefetch" href="/assets/js/85.f3b7b32b.js"><link rel="prefetch" href="/assets/js/86.1d47bd30.js"><link rel="prefetch" href="/assets/js/87.2361eddb.js"><link rel="prefetch" href="/assets/js/88.aef9e475.js"><link rel="prefetch" href="/assets/js/89.0a95e3be.js"><link rel="prefetch" href="/assets/js/9.f6c9df9a.js"><link rel="prefetch" href="/assets/js/90.ddf7b632.js"><link rel="prefetch" href="/assets/js/91.2a96bacf.js"><link rel="prefetch" href="/assets/js/92.f61fc5ec.js"><link rel="prefetch" href="/assets/js/93.40a17799.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3d594d45.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.jpg" alt="Tavio's blog" class="logo"> <span class="site-name can-hide">Tavio's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/logo.jpg"> <div class="blogger-info"><h3>Tavio Zhang</h3> <span>努力学习的小码喽</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/java/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/node/jvm/" class="nav-link">JVM底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/thread/" class="nav-link">邪恶多线程</a></li><li class="dropdown-item"><!----> <a href="/node/mybatis/" class="nav-link">MyBatis底层原理</a></li><li class="dropdown-item"><!----> <a href="/node/spring/" class="nav-link">Spring底层原理</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/db/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/mysql/" class="nav-link">MySQL的优化之路</a></li><li class="dropdown-item"><!----> <a href="/note/clickhouse/" class="nav-link">ClickHouse的高性能</a></li><li class="dropdown-item"><!----> <a href="/note/redis/" class="nav-link">Redis的快速查询</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/middleware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note/rabbitmq/" class="nav-link">RabbitMQ的生产</a></li><li class="dropdown-item"><!----> <a href="/note/kafka/" class="nav-link">Kafka的高吞吐量</a></li><li class="dropdown-item"><!----> <a href="/note/es/" class="nav-link">ES的入门到入坑</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="实践" class="dropdown-title"><a href="/practice/" class="link-title">实践</a> <span class="title" style="display:none;">实践</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/284351/" class="nav-link">MySQL自增ID主键空洞</a></li><li class="dropdown-item"><!----> <a href="/pages/8f1df0/" class="nav-link">前端实现长整型排序</a></li><li class="dropdown-item"><!----> <a href="/pages/13fcc3/" class="nav-link">MySQL无感换表</a></li><li class="dropdown-item"><!----> <a href="/pages/69e163/" class="nav-link">Redis延时双删</a></li><li class="dropdown-item"><!----> <a href="/pages/f43494/" class="nav-link">高并发秒杀优惠卷</a></li><li class="dropdown-item"><!----> <a href="/pages/ab9a49/" class="nav-link">AOP无侵入式告警</a></li><li class="dropdown-item"><!----> <a href="/pages/a3f3fd/" class="nav-link">长短链接跳转</a></li><li class="dropdown-item"><!----> <a href="/pages/942d4b/" class="nav-link">订单超时取消</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/tavio-zhang/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/f19195/" class="sidebar-link">Spring Boot 自动配置</a></li><li><a href="/pages/1c21ce/" class="sidebar-link">Spring Boot Bean 生命周期</a></li><li><a href="/pages/48cf22/" class="sidebar-link">Spring事务传播机制</a></li><li><a href="/pages/20d41f/" class="sidebar-link">Spring Cloud Nacos 深度解析</a></li><li><a href="/pages/622399/" class="sidebar-link">Spring Cloud OpenFeign 深度解析</a></li><li><a href="/pages/b6abda/" class="sidebar-link">Spring Cloud Gateway 底层原理</a></li><li><a href="/pages/61e1cc/" aria-current="page" class="active sidebar-link">Spring Cloud Seata 深度解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#一、核心认知-seata是什么-为什么选择它" class="sidebar-link">一、核心认知：Seata是什么？为什么选择它？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_1-1-分布式事务的核心痛点与传统方案局限" class="sidebar-link">1.1 分布式事务的核心痛点与传统方案局限</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_1-2-seata的定义与核心定位" class="sidebar-link">1.2 Seata的定义与核心定位</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_1-3-为什么选择seata-与主流方案对比" class="sidebar-link">1.3 为什么选择Seata？（与主流方案对比）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#二、架构设计-seata的核心组件与交互流程" class="sidebar-link">二、架构设计：Seata的核心组件与交互流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_2-1-核心组件-三组件模型" class="sidebar-link">2.1 核心组件（三组件模型）</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_2-2-核心交互流程-全局事务生命周期" class="sidebar-link">2.2 核心交互流程（全局事务生命周期）</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_2-3-核心数据模型" class="sidebar-link">2.3 核心数据模型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#三、核心功能深度解析-seata四大事务模式" class="sidebar-link">三、核心功能深度解析：Seata四大事务模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_3-1-at模式-无侵入式最终一致性方案-核心推荐" class="sidebar-link">3.1 AT模式：无侵入式最终一致性方案（核心推荐）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-1-1-核心原理-两阶段提交-回滚日志" class="sidebar-link">3.1.1 核心原理：两阶段提交+回滚日志</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#一阶段-本地事务提交" class="sidebar-link">一阶段（本地事务提交）</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#二阶段-根据全局事务状态执行提交或回滚" class="sidebar-link">二阶段：根据全局事务状态执行提交或回滚</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#情况1-二阶段提交-所有分支成功" class="sidebar-link">情况1：二阶段提交（所有分支成功）</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#情况2-二阶段回滚-存在分支失败" class="sidebar-link">情况2：二阶段回滚（存在分支失败）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-1-2-前置条件与约束" class="sidebar-link">3.1.2 前置条件与约束</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-1-3-实战示例-订单-库存-支付分布式事务" class="sidebar-link">3.1.3 实战示例：订单-库存-支付分布式事务</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#步骤1-环境准备-数据库" class="sidebar-link">步骤1：环境准备（数据库）</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#步骤2-服务端配置-seata-server" class="sidebar-link">步骤2：服务端配置（Seata Server）</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#步骤3-客户端配置-微服务" class="sidebar-link">步骤3：客户端配置（微服务）</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#_1-引入依赖-pom-xml" class="sidebar-link">1. 引入依赖（pom.xml）</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#_2-配置文件-bootstrap-yaml" class="sidebar-link">2. 配置文件（bootstrap.yaml）</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#_3-数据源代理配置-关键-seata需要代理数据源才能拦截sql" class="sidebar-link">3. 数据源代理配置（关键：Seata需要代理数据源才能拦截SQL）</a></li><li class="sidebar-sub-header level6"><a href="/pages/61e1cc/#_4-业务代码实现" class="sidebar-link">4. 业务代码实现</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#步骤4-测试验证" class="sidebar-link">步骤4：测试验证</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-1-4-优缺点总结" class="sidebar-link">3.1.4 优缺点总结</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_3-2-tcc模式-侵入式高性能方案-复杂业务适配" class="sidebar-link">3.2 TCC模式：侵入式高性能方案（复杂业务适配）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-2-1-核心原理-三阶段业务拆分" class="sidebar-link">3.2.1 核心原理：三阶段业务拆分</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-2-2-执行流程" class="sidebar-link">3.2.2 执行流程</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-2-3-实战示例-库存扣减tcc实现" class="sidebar-link">3.2.3 实战示例：库存扣减TCC实现</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#_1-库存表修改-添加冻结库存字段" class="sidebar-link">1. 库存表修改（添加冻结库存字段）</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#_2-tcc接口定义-使用-tcc注解" class="sidebar-link">2. TCC接口定义（使用@Tcc注解）</a></li><li class="sidebar-sub-header level5"><a href="/pages/61e1cc/#_3-全局事务发起-tm" class="sidebar-link">3. 全局事务发起（TM）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-2-4-优缺点总结" class="sidebar-link">3.2.4 优缺点总结</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_3-3-saga模式-长事务解决方案-状态机驱动" class="sidebar-link">3.3 SAGA模式：长事务解决方案（状态机驱动）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-3-1-核心原理-正向事务-补偿事务" class="sidebar-link">3.3.1 核心原理：正向事务+补偿事务</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-3-2-实战示例-注解式saga实现" class="sidebar-link">3.3.2 实战示例：注解式SAGA实现</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-3-3-优缺点总结" class="sidebar-link">3.3.3 优缺点总结</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_3-4-xa模式-强一致性方案-兼容传统2pc" class="sidebar-link">3.4 XA模式：强一致性方案（兼容传统2PC）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-4-1-核心原理" class="sidebar-link">3.4.1 核心原理</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-4-2-实战配置-客户端" class="sidebar-link">3.4.2 实战配置（客户端）</a></li><li class="sidebar-sub-header level4"><a href="/pages/61e1cc/#_3-4-3-优缺点总结" class="sidebar-link">3.4.3 优缺点总结</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#四、底层原理-seata核心机制深度解析" class="sidebar-link">四、底层原理：Seata核心机制深度解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_4-1-at模式核心-undo-log与数据回滚" class="sidebar-link">4.1 AT模式核心：undo_log与数据回滚</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_4-2-分布式锁机制" class="sidebar-link">4.2 分布式锁机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_4-3-事务分组与配置中心" class="sidebar-link">4.3 事务分组与配置中心</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#五、企业级部署-seata集群配置" class="sidebar-link">五、企业级部署：Seata集群配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_5-1-集群部署准备" class="sidebar-link">5.1 集群部署准备</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_5-2-集群配置步骤" class="sidebar-link">5.2 集群配置步骤</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#六、常见问题与解决方案" class="sidebar-link">六、常见问题与解决方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_6-1-问题1-at模式回滚失败" class="sidebar-link">6.1 问题1：AT模式回滚失败</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_6-2-问题2-事务分组配置错误" class="sidebar-link">6.2 问题2：事务分组配置错误</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_6-3-问题3-数据源代理未配置" class="sidebar-link">6.3 问题3：数据源代理未配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_6-4-问题4-tcc模式幂等性问题" class="sidebar-link">6.4 问题4：TCC模式幂等性问题</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/61e1cc/#七、总结-seata最佳实践" class="sidebar-link">七、总结：Seata最佳实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_7-1-模式选择建议" class="sidebar-link">7.1 模式选择建议</a></li><li class="sidebar-sub-header level3"><a href="/pages/61e1cc/#_7-2-性能优化建议" class="sidebar-link">7.2 性能优化建议</a></li></ul></li></ul></li><li><a href="/pages/3f9c50/" class="sidebar-link">Spring Cloud Sentinel 深度解析</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/node/spring/#《Spring》笔记" data-v-06225672>《Spring》笔记</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/tavio-zhang" target="_blank" title="作者" class="beLink" data-v-06225672>Tavio</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-09-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Spring Cloud Seata 深度解析<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="spring-cloud-seata深度解析-分布式事务核心原理、实战配置与企业级最佳实践"><a href="#spring-cloud-seata深度解析-分布式事务核心原理、实战配置与企业级最佳实践" class="header-anchor">#</a> Spring Cloud Seata深度解析：分布式事务核心原理、实战配置与企业级最佳实践</h1> <p>在微服务架构中，随着业务拆分粒度的细化，一个完整的业务流程往往需要跨多个服务调用（如订单创建→库存扣减→支付扣钱→物流创建）。此时，传统的本地事务（如MySQL的ACID）已无法保证跨服务数据的一致性，“分布式事务”问题成为微服务落地的核心痛点之一。</p> <p>Seata（Simple Extensible Autonomous Transaction Architecture，简单可扩展自治事务框架）是Alibaba开源的分布式事务解决方案，致力于提供高性能、低侵入的分布式事务服务，支持AT、TCC、SAGA、XA等多种事务模式，完美适配Spring Cloud微服务生态。</p> <h2 id="一、核心认知-seata是什么-为什么选择它"><a href="#一、核心认知-seata是什么-为什么选择它" class="header-anchor">#</a> 一、核心认知：Seata是什么？为什么选择它？</h2> <h3 id="_1-1-分布式事务的核心痛点与传统方案局限"><a href="#_1-1-分布式事务的核心痛点与传统方案局限" class="header-anchor">#</a> 1.1 分布式事务的核心痛点与传统方案局限</h3> <p>分布式事务的核心目标是保证“跨服务数据的一致性”，即多个服务的操作要么全部成功，要么全部失败。传统分布式事务方案存在诸多局限：</p> <ul><li><strong>2PC（两阶段提交）</strong>：强一致性，但锁资源占用时间长，性能差，协调者单点故障风险高；</li> <li><strong>TCC（Try-Confirm-Cancel）</strong>：性能好，但需业务代码侵入式开发，适配成本高；</li> <li><strong>SAGA</strong>：适用于长事务，但补偿逻辑复杂，一致性保障弱；</li> <li><strong>本地消息表</strong>：低侵入，但需额外设计消息表和补偿逻辑，运维成本高。</li></ul> <p>Seata的出现正是为了解决这些问题，通过封装多种事务模式，实现“低侵入、高性能、多场景适配”的分布式事务解决方案。</p> <h3 id="_1-2-seata的定义与核心定位"><a href="#_1-2-seata的定义与核心定位" class="header-anchor">#</a> 1.2 Seata的定义与核心定位</h3> <p>Seata官方定义：<strong>一款开源的分布式事务解决方案，为微服务架构提供高性能和简单易用的分布式事务服务</strong>。其核心价值在于“简化分布式事务开发”，让开发者无需关注复杂的分布式事务细节，只需通过简单配置或少量注解，即可实现跨服务数据一致性保障。</p> <p>Seata的核心特性可概括为“4个核心优势”：</p> <ul><li><strong>多事务模式支持</strong>：内置AT、TCC、SAGA、XA四种事务模式，适配不同业务场景（如无侵入场景选AT，复杂业务选TCC，长事务选SAGA）；</li> <li><strong>低侵入性</strong>：基于AOP实现事务增强，大部分场景（如AT模式）无需修改业务代码，仅需添加注解；</li> <li><strong>高性能</strong>：通过异步化、锁优化、日志优化等机制，降低分布式事务对性能的影响，支持高并发场景；</li> <li><strong>生态兼容性好</strong>：完美适配Spring Cloud、Dubbo、MyBatis、Sharding-JDBC等主流框架，支持MySQL、Oracle、PostgreSQL等多种数据库。</li></ul> <h3 id="_1-3-为什么选择seata-与主流方案对比"><a href="#_1-3-为什么选择seata-与主流方案对比" class="header-anchor">#</a> 1.3 为什么选择Seata？（与主流方案对比）</h3> <p>下表通过对比清晰展现Seata的优势：</p> <table><thead><tr><th>对比维度</th> <th>传统2PC</th> <th>TCC手动实现</th> <th>本地消息表</th> <th>Seata</th></tr></thead> <tbody><tr><td>侵入性</td> <td>低（数据库层面）</td> <td>高（业务代码侵入）</td> <td>中（需额外消息表）</td> <td>低（AT模式无侵入，TCC模式半侵入）</td></tr> <tr><td>性能</td> <td>差（锁资源占用久）</td> <td>好（无锁等待）</td> <td>中（异步补偿）</td> <td>好（AT模式接近本地事务，异步化优化）</td></tr> <tr><td>一致性保障</td> <td>强一致性</td> <td>最终一致性</td> <td>最终一致性</td> <td>支持强一致性（XA）和最终一致性（AT/TCC/SAGA）</td></tr> <tr><td>开发成本</td> <td>中（需协调者）</td> <td>高（需实现Try/Confirm/Cancel）</td> <td>中（需设计补偿逻辑）</td> <td>低（框架封装，注解式开发）</td></tr> <tr><td>运维成本</td> <td>高（协调者集群部署）</td> <td>中（需监控补偿逻辑）</td> <td>高（消息表运维、补偿监控）</td> <td>低（提供可视化控制台，集群部署简单）</td></tr> <tr><td>适用场景</td> <td>强一致性要求高、低并发</td> <td>高并发、复杂业务</td> <td>异步通知、非核心业务</td> <td>全场景（高并发/低并发、强一致性/最终一致性）</td></tr></tbody></table> <p>总结：Seata的核心优势在于“全场景适配”“低开发成本”“高性能”，既能满足简单场景的无侵入式开发（AT模式），也能适配复杂业务的定制化需求（TCC模式），是微服务架构下分布式事务的首选方案。</p> <h2 id="二、架构设计-seata的核心组件与交互流程"><a href="#二、架构设计-seata的核心组件与交互流程" class="header-anchor">#</a> 二、架构设计：Seata的核心组件与交互流程</h2> <p>Seata采用“三组件架构”（TC、TM、RM），通过统一的事务协调机制，实现跨服务的事务管理。其架构设计遵循“解耦、可扩展”原则，核心分为客户端和服务端两部分。</p> <h3 id="_2-1-核心组件-三组件模型"><a href="#_2-1-核心组件-三组件模型" class="header-anchor">#</a> 2.1 核心组件（三组件模型）</h3> <p>Seata定义了三个核心角色，共同完成分布式事务的生命周期管理：</p> <ol><li><strong>TC（Transaction Coordinator，事务协调者）</strong>：
<ul><li>核心职责：维护全局事务和分支事务的状态，协调全局事务的提交或回滚；</li> <li>部署形式：独立的Seata Server服务，支持集群部署，确保高可用；</li> <li>核心功能：全局事务ID生成、分支事务注册、事务状态协调、回滚指令下发。</li></ul></li> <li><strong>TM（Transaction Manager，事务管理器）</strong>：
<ul><li>核心职责：发起全局事务的开启、提交或回滚请求；</li> <li>部署形式：嵌入在业务微服务中（如订单服务），作为全局事务的发起者；</li> <li>核心功能：向TC申请全局事务ID、触发全局提交/回滚。</li></ul></li> <li><strong>RM（Resource Manager，资源管理器）</strong>：
<ul><li>核心职责：管理本地资源（如数据库连接），执行分支事务的提交或回滚，向TC汇报分支事务状态；</li> <li>部署形式：嵌入在各个业务微服务中（如订单服务、库存服务、支付服务）；</li> <li>核心功能：注册分支事务到TC、执行本地事务、接收TC的回滚/提交指令并执行。</li></ul></li></ol> <h3 id="_2-2-核心交互流程-全局事务生命周期"><a href="#_2-2-核心交互流程-全局事务生命周期" class="header-anchor">#</a> 2.2 核心交互流程（全局事务生命周期）</h3> <p>无论哪种事务模式，Seata的全局事务生命周期都遵循以下核心流程：</p> <ol><li><strong>全局事务开启</strong>：TM向TC申请开启全局事务，TC生成全局唯一的事务ID（XID），并返回给TM；</li> <li><strong>分支事务注册</strong>：TM在调用各个微服务时，将XID传递给RM；RM执行本地事务前，向TC注册分支事务，绑定XID与本地事务；</li> <li><strong>分支事务执行</strong>：RM执行本地事务（如扣减库存、创建订单），并将执行结果（成功/失败）汇报给TC；</li> <li><strong>全局事务协调</strong>：TC汇总所有分支事务的执行结果，若全部成功，则触发全局提交；若存在失败，则触发全局回滚；</li> <li><strong>分支事务提交/回滚</strong>：TC向所有RM下发提交或回滚指令，RM执行对应的操作（提交本地事务或回滚本地事务），并将结果汇报给TC；</li> <li><strong>全局事务结束</strong>：TC收到所有RM的操作结果后，标记全局事务状态为“完成”，全局事务结束。</li></ol> <p>核心交互流程：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>TM（订单服务） → 申请 XID → TC（Seata Server） → 返回 XID
TM 携带 XID 调用 RM1（库存服务） → RM1 注册分支事务 → 执行本地事务 → 汇报结果给 TC
TM 携带 XID 调用 RM2（支付服务） → RM2 注册分支事务 → 执行本地事务 → 汇报结果给 TC
TC 汇总结果 → 下发提交 / 回滚指令 → RM1/RM2 执行 → 汇报结果 → TC 标记事务结束
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-3-核心数据模型"><a href="#_2-3-核心数据模型" class="header-anchor">#</a> 2.3 核心数据模型</h3> <p>Seata通过以下核心数据模型维护事务状态：</p> <ul><li><strong>全局事务（GlobalTransaction）</strong>：由XID唯一标识，包含事务状态（开始、提交中、回滚中、已提交、已回滚）、超时时间等信息；</li> <li><strong>分支事务（BranchTransaction）</strong>：与全局事务绑定（通过XID），由分支事务ID（Branch ID）唯一标识，包含资源ID（如数据库连接池标识）、分支事务状态等信息；</li> <li><strong>资源（Resource）</strong>：指需要被事务管理的本地资源，如数据库、消息队列等，通过资源ID唯一标识；</li> <li><strong>undo_log（回滚日志）</strong>：AT模式的核心数据，用于记录本地事务执行前的数据快照，供回滚时恢复数据（后续详细讲解）。</li></ul> <h2 id="三、核心功能深度解析-seata四大事务模式"><a href="#三、核心功能深度解析-seata四大事务模式" class="header-anchor">#</a> 三、核心功能深度解析：Seata四大事务模式</h2> <p>Seata支持AT、TCC、SAGA、XA四种事务模式，每种模式的实现原理、适用场景各不相同。本节将逐一深度解析每种模式的核心逻辑、执行流程、优缺点及实战示例。</p> <h3 id="_3-1-at模式-无侵入式最终一致性方案-核心推荐"><a href="#_3-1-at模式-无侵入式最终一致性方案-核心推荐" class="header-anchor">#</a> 3.1 AT模式：无侵入式最终一致性方案（核心推荐）</h3> <p>AT模式是Seata的默认模式，也是最常用的模式，其核心目标是“无侵入式实现分布式事务”，即开发者无需修改业务代码，仅需添加@GlobalTransactional注解即可。AT模式基于“两阶段提交”思想，但通过“回滚日志+异步化”优化，解决了传统2PC的性能问题。</p> <h4 id="_3-1-1-核心原理-两阶段提交-回滚日志"><a href="#_3-1-1-核心原理-两阶段提交-回滚日志" class="header-anchor">#</a> 3.1.1 核心原理：两阶段提交+回滚日志</h4> <p>AT模式将分布式事务拆分为“一阶段提交”和“二阶段提交/回滚”两个阶段，核心依赖“回滚日志（undo_log）”实现数据回滚。</p> <h5 id="一阶段-本地事务提交"><a href="#一阶段-本地事务提交" class="header-anchor">#</a> 一阶段（本地事务提交）</h5> <ol><li><strong>拦截SQL</strong>：RM通过数据源代理（DataSourceProxy）拦截业务SQL，解析SQL语义，获取操作的表、字段、条件等信息；</li> <li><strong>生成前置镜像</strong>：执行SQL前，查询数据的原始状态（如扣减库存前的库存数量），生成前置镜像（Before Image）；</li> <li><strong>执行SQL</strong>：执行业务SQL（如扣减库存），更新本地数据；</li> <li><strong>生成后置镜像</strong>：执行SQL后，查询数据的新状态（如扣减后的库存数量），生成后置镜像（After Image）；</li> <li><strong>写入回滚日志</strong>：将前置镜像、后置镜像、XID、Branch ID等信息写入undo_log表；</li> <li><strong>提交本地事务</strong>：将业务SQL的执行结果和undo_log的写入操作一同提交到本地数据库；</li> <li><strong>释放锁资源</strong>：一阶段提交后立即释放数据库锁，提升性能；</li> <li><strong>汇报状态</strong>：RM向TC汇报分支事务执行结果（成功/失败）。</li></ol> <h5 id="二阶段-根据全局事务状态执行提交或回滚"><a href="#二阶段-根据全局事务状态执行提交或回滚" class="header-anchor">#</a> 二阶段：根据全局事务状态执行提交或回滚</h5> <p>二阶段的执行逻辑由TC根据所有分支事务的执行结果决定：若所有分支事务均成功，则执行“二阶段提交”；若存在分支事务失败，则执行“二阶段回滚”。</p> <h6 id="情况1-二阶段提交-所有分支成功"><a href="#情况1-二阶段提交-所有分支成功" class="header-anchor">#</a> 情况1：二阶段提交（所有分支成功）</h6> <ol><li>TC向所有RM下发“提交”指令；</li> <li>RM收到指令后，删除对应的undo_log记录（回滚日志已无需使用）；</li> <li>RM向TC汇报提交结果；</li> <li>TC标记全局事务为“已提交”，事务结束。</li></ol> <p>核心特点：二阶段提交是轻量级操作，仅删除undo_log，无锁资源占用。</p> <h6 id="情况2-二阶段回滚-存在分支失败"><a href="#情况2-二阶段回滚-存在分支失败" class="header-anchor">#</a> 情况2：二阶段回滚（存在分支失败）</h6> <ol><li>TC向所有RM下发“回滚”指令；</li> <li>RM收到指令后，查询对应的undo_log记录，获取前置镜像；</li> <li>根据前置镜像执行回滚SQL，将数据恢复到执行前的状态（如将库存数量恢复为扣减前的值）；</li> <li>删除undo_log记录；</li> <li>RM向TC汇报回滚结果；</li> <li>TC标记全局事务为“已回滚”，事务结束。</li></ol> <h4 id="_3-1-2-前置条件与约束"><a href="#_3-1-2-前置条件与约束" class="header-anchor">#</a> 3.1.2 前置条件与约束</h4> <ul><li>数据库支持：需支持事务和行级锁（如MySQL、Oracle、PostgreSQL）；</li> <li>SQL支持：支持DML（INSERT/UPDATE/DELETE）语句，不支持DDL语句；</li> <li>隔离级别：数据库隔离级别需设置为READ COMMITTED（默认级别，避免脏读）；</li> <li>主键约束：操作的表必须有主键（用于生成镜像时定位数据）。</li></ul> <h4 id="_3-1-3-实战示例-订单-库存-支付分布式事务"><a href="#_3-1-3-实战示例-订单-库存-支付分布式事务" class="header-anchor">#</a> 3.1.3 实战示例：订单-库存-支付分布式事务</h4> <p>以“创建订单→扣减库存→扣减余额”为例，演示AT模式的使用。</p> <h5 id="步骤1-环境准备-数据库"><a href="#步骤1-环境准备-数据库" class="header-anchor">#</a> 步骤1：环境准备（数据库）</h5> <ol><li>新建3个数据库（order_db、stock_db、account_db）；</li> <li>每个数据库创建对应的业务表和undo_log表（undo_log表是AT模式必需的）：</li></ol> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 1. order_db：订单表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>order_tbl<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>commodity_code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>money<span class="token punctuation">`</span></span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 2. stock_db：库存表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>stock_tbl<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>commodity_code<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_commodity_code<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>commodity_code<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 3. account_db：账户表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>account_tbl<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>money<span class="token punctuation">`</span></span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_user_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 4. 每个数据库都需创建undo_log表（Seata AT模式必需）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>ext<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h5 id="步骤2-服务端配置-seata-server"><a href="#步骤2-服务端配置-seata-server" class="header-anchor">#</a> 步骤2：服务端配置（Seata Server）</h5> <ol><li>下载Seata Server：https://github.com/seata/seata/releases，选择稳定版本（如1.6.1）；</li> <li>修改配置文件（conf/application.yml）：</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8091</span> <span class="token comment"># Seata Server端口</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>logback<span class="token punctuation">-</span>spring.xml
  <span class="token key atrule">file</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>user.home<span class="token punctuation">}</span>/logs/seata

<span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos <span class="token comment"># 配置中心类型（使用Nacos存储配置）</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos地址</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名空间</span>
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP <span class="token comment"># 配置分组</span>
      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server.yaml <span class="token comment"># 配置Data ID</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos <span class="token comment"># 注册中心类型（使用Nacos注册Seata Server）</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
  <span class="token key atrule">store</span><span class="token punctuation">:</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> db <span class="token comment"># 存储模式（db：数据库存储，file：文件存储，生产环境推荐db）</span>
    <span class="token key atrule">db</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span> druid
      <span class="token key atrule">db-type</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
      <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/seata_db<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;rewriteBatchedStatements=true</span>
      <span class="token key atrule">user</span><span class="token punctuation">:</span> root
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
      <span class="token key atrule">min-conn</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">max-conn</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">global-table</span><span class="token punctuation">:</span> global_table <span class="token comment"># 全局事务表</span>
      <span class="token key atrule">branch-table</span><span class="token punctuation">:</span> branch_table <span class="token comment"># 分支事务表</span>
      <span class="token key atrule">lock-table</span><span class="token punctuation">:</span> lock_table <span class="token comment"># 锁表</span>
      <span class="token key atrule">distributed-lock-table</span><span class="token punctuation">:</span> distributed_lock <span class="token comment"># 分布式锁表</span>
      <span class="token key atrule">query-limit</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">secretKey</span><span class="token punctuation">:</span> SeataSecretKey0123456789
    <span class="token key atrule">tokenValidityInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">1800000</span>
    <span class="token key atrule">ignore</span><span class="token punctuation">:</span>
      <span class="token key atrule">urls</span><span class="token punctuation">:</span> /<span class="token punctuation">,</span>/<span class="token important">**/*.css</span><span class="token punctuation">,</span>/<span class="token important">**/*.js</span><span class="token punctuation">,</span>/<span class="token important">**/*.html</span><span class="token punctuation">,</span>/<span class="token important">**/*.map</span><span class="token punctuation">,</span>/<span class="token important">**/*.svg</span><span class="token punctuation">,</span>/<span class="token important">**/*.png</span><span class="token punctuation">,</span>/<span class="token important">**/*.ico</span><span class="token punctuation">,</span>/console<span class="token punctuation">-</span>fe/public/<span class="token important">**</span><span class="token punctuation">,</span>/api/v1/auth/login
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><ol start="3"><li>初始化Seata Server数据库：执行Seata提供的SQL脚本（conf/db_store.sql），创建global_table、branch_table、lock_table等表；</li> <li>启动Seata Server：执行bin/startup.sh（Linux）或bin/startup.cmd（Windows）。</li></ol> <h5 id="步骤3-客户端配置-微服务"><a href="#步骤3-客户端配置-微服务" class="header-anchor">#</a> 步骤3：客户端配置（微服务）</h5> <p>创建3个微服务：order-service（订单服务）、stock-service（库存服务）、account-service（账户服务），均引入Seata依赖。</p> <h6 id="_1-引入依赖-pom-xml"><a href="#_1-引入依赖-pom-xml" class="header-anchor">#</a> 1. 引入依赖（pom.xml）</h6> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>### 父工程依赖（统一版本管理）
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2022.0.0.0-RC2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

### 各微服务依赖
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Spring Cloud Alibaba Nacos Discovery（服务注册发现） --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- Spring Cloud Alibaba Seata（分布式事务） --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- MyBatis-Plus（ORM框架） --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- 数据库驱动 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h6 id="_2-配置文件-bootstrap-yaml"><a href="#_2-配置文件-bootstrap-yaml" class="header-anchor">#</a> 2. 配置文件（bootstrap.yaml）</h6> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order<span class="token punctuation">-</span>service <span class="token comment"># 服务名（stock-service/account-service同理修改）</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos地址</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
        <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
    <span class="token key atrule">alibaba</span><span class="token punctuation">:</span>
      <span class="token key atrule">seata</span><span class="token punctuation">:</span>
        <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> order_tx_group <span class="token comment"># 事务分组（所有参与分布式事务的服务需一致）</span>

<span class="token comment"># 数据源配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/order_db<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf8&amp;serverTimezone=UTC</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver

<span class="token comment"># Seata配置（通过Nacos获取，也可本地配置）</span>
<span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP
      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>client.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h6 id="_3-数据源代理配置-关键-seata需要代理数据源才能拦截sql"><a href="#_3-数据源代理配置-关键-seata需要代理数据源才能拦截sql" class="header-anchor">#</a> 3. 数据源代理配置（关键：Seata需要代理数据源才能拦截SQL）</h6> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceProxyConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 或其他数据源（如HikariCP）</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置Seata数据源代理</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSourceProxy</span> <span class="token function">dataSourceProxy</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 替换MyBatis的SqlSessionFactory，使用Seata的数据源代理</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SqlSessionFactory</span> <span class="token function">sqlSessionFactory</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProxy</span> dataSourceProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SqlSessionFactoryBean</span> sqlSessionFactoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSourceProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他MyBatis配置（如mapperLocations）</span>
        sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">setMapperLocations</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PathMatchingResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:mapper/*.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sqlSessionFactoryBean<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h6 id="_4-业务代码实现"><a href="#_4-业务代码实现" class="header-anchor">#</a> 4. 业务代码实现</h6> <p>（1）订单服务（TM，全局事务发起者）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockFeignClient</span> stockFeignClient<span class="token punctuation">;</span> <span class="token comment">// 调用库存服务的Feign客户端</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountFeignClient</span> accountFeignClient<span class="token punctuation">;</span> <span class="token comment">// 调用账户服务的Feign客户端</span>

    <span class="token comment">// 全局事务注解（TM发起全局事务）</span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 计算订单金额（假设商品单价为10元）</span>
        <span class="token class-name">BigDecimal</span> money <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 创建订单（本地事务）</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. 调用库存服务扣减库存（分支事务1）</span>
        stockFeignClient<span class="token punctuation">.</span><span class="token function">deductStock</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 4. 调用账户服务扣减余额（分支事务2）</span>
        accountFeignClient<span class="token punctuation">.</span><span class="token function">deductMoney</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 模拟异常（测试回滚）</span>
        <span class="token comment">// throw new RuntimeException(&quot;订单创建失败，触发回滚&quot;);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Feign客户端</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;stock-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StockFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/stock/deduct&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;commodityCode&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;account-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/account/deduct&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">deductMoney</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">BigDecimal</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><p>（2）库存服务（RM，分支事务参与者）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token comment">// 分支事务（无需额外注解，Seata自动识别）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 扣减库存</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>（3）账户服务（RM，分支事务参与者）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountMapper</span> accountMapper<span class="token punctuation">;</span>

    <span class="token comment">// 分支事务（无需额外注解，Seata自动识别）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductMoney</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">BigDecimal</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> accountMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Account</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>account <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> account<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;余额不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 扣减余额</span>
        account<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h5 id="步骤4-测试验证"><a href="#步骤4-测试验证" class="header-anchor">#</a> 步骤4：测试验证</h5> <ul><li>正常场景：调用订单服务的createOrder方法，订单创建、库存扣减、余额扣减均成功，undo_log记录被删除；</li> <li>异常场景：在createOrder方法中手动抛出异常，全局事务回滚，库存和余额恢复到原始状态，undo_log记录被删除。</li></ul> <h4 id="_3-1-4-优缺点总结"><a href="#_3-1-4-优缺点总结" class="header-anchor">#</a> 3.1.4 优缺点总结</h4> <ul><li><strong>优点</strong>：无侵入式开发，无需修改业务代码；性能优异，一阶段提交后释放锁；最终一致性保障；</li> <li><strong>缺点</strong>：依赖数据库支持；不支持DDL语句；仅支持关系型数据库。</li></ul> <h3 id="_3-2-tcc模式-侵入式高性能方案-复杂业务适配"><a href="#_3-2-tcc模式-侵入式高性能方案-复杂业务适配" class="header-anchor">#</a> 3.2 TCC模式：侵入式高性能方案（复杂业务适配）</h3> <p>TCC模式（Try-Confirm-Cancel）是一种侵入式的分布式事务方案，核心思想是“将业务逻辑拆分为Try、Confirm、Cancel三个阶段”，由开发者手动实现这三个阶段的逻辑，适用于AT模式无法覆盖的复杂业务场景（如非关系型数据库、无主键表、复杂业务逻辑）。</p> <h4 id="_3-2-1-核心原理-三阶段业务拆分"><a href="#_3-2-1-核心原理-三阶段业务拆分" class="header-anchor">#</a> 3.2.1 核心原理：三阶段业务拆分</h4> <ol><li><strong>Try阶段</strong>：
<ul><li>核心目标：检查业务资源是否充足，预留业务资源（如锁定库存、冻结余额）；</li> <li>关键要求：幂等性（多次调用结果一致）、可补偿（预留的资源可释放）。</li></ul></li> <li><strong>Confirm阶段</strong>：
<ul><li>核心目标：确认执行业务操作，释放Try阶段预留的资源（如将锁定的库存扣减、冻结的余额扣减）；</li> <li>触发条件：所有分支事务的Try阶段均成功；</li> <li>关键要求：幂等性、非空补偿（必须执行成功）。</li></ul></li> <li><strong>Cancel阶段</strong>：
<ul><li>核心目标：取消执行业务操作，回滚Try阶段预留的资源（如释放锁定的库存、解冻冻结的余额）；</li> <li>触发条件：存在分支事务的Try阶段失败；</li> <li>关键要求：幂等性、可补偿（必须能回滚预留资源）。</li></ul></li></ol> <h4 id="_3-2-2-执行流程"><a href="#_3-2-2-执行流程" class="header-anchor">#</a> 3.2.2 执行流程</h4> <ol><li>TM向TC申请开启全局事务，获取XID；</li> <li>TM携带XID调用各RM的Try方法，执行资源检查与预留；</li> <li>各RM执行Try方法，向TC汇报结果；</li> <li>TC汇总结果：
<ul><li>所有Try成功：TC向各RM下发Confirm指令，执行确认操作；</li> <li>存在Try失败：TC向各RM下发Cancel指令，执行取消操作；</li></ul></li> <li>各RM执行Confirm/Cancel方法，向TC汇报结果；</li> <li>TC标记全局事务状态，事务结束。</li></ol> <h4 id="_3-2-3-实战示例-库存扣减tcc实现"><a href="#_3-2-3-实战示例-库存扣减tcc实现" class="header-anchor">#</a> 3.2.3 实战示例：库存扣减TCC实现</h4> <p>以库存扣减为例，演示TCC模式的实现（需在库存表中添加“冻结库存”字段）。</p> <h5 id="_1-库存表修改-添加冻结库存字段"><a href="#_1-库存表修改-添加冻结库存字段" class="header-anchor">#</a> 1. 库存表修改（添加冻结库存字段）</h5> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>stock_tbl<span class="token punctuation">`</span></span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token identifier"><span class="token punctuation">`</span>frozen_count<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'冻结库存'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="_2-tcc接口定义-使用-tcc注解"><a href="#_2-tcc接口定义-使用-tcc注解" class="header-anchor">#</a> 2. TCC接口定义（使用@Tcc注解）</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockTccService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token comment">// Try阶段：锁定库存（预留资源）</span>
    <span class="token annotation punctuation">@Tcc</span><span class="token punctuation">(</span>confirmMethod <span class="token operator">=</span> <span class="token string">&quot;confirmDeductStock&quot;</span><span class="token punctuation">,</span> cancelMethod <span class="token operator">=</span> <span class="token string">&quot;cancelDeductStock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryDeductStock</span><span class="token punctuation">(</span><span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取库存信息</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足，Try阶段失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2. 冻结库存（预留资源）</span>
        stock<span class="token punctuation">.</span><span class="token function">setFrozenCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getFrozenCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Confirm阶段：确认扣减库存（释放预留资源）</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">confirmDeductStock</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取参数</span>
        <span class="token class-name">String</span> commodityCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;commodityCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 扣减实际库存，释放冻结库存</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stock<span class="token punctuation">.</span><span class="token function">setFrozenCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getFrozenCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Cancel阶段：取消扣减库存（回滚预留资源）</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">cancelDeductStock</span><span class="token punctuation">(</span><span class="token class-name">BusinessActionContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取参数</span>
        <span class="token class-name">String</span> commodityCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;commodityCode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 释放冻结库存</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stock<span class="token punctuation">.</span><span class="token function">setFrozenCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getFrozenCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h5 id="_3-全局事务发起-tm"><a href="#_3-全局事务发起-tm" class="header-anchor">#</a> 3. 全局事务发起（TM）</h5> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockTccService</span> stockTccService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountTccService</span> accountTccService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建订单（本地事务）</span>
        <span class="token class-name">BigDecimal</span> money <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 调用库存TCC的Try方法</span>
        <span class="token class-name">BusinessActionContext</span> stockContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BusinessActionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockContext<span class="token punctuation">.</span><span class="token function">setActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;commodityCode&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockContext<span class="token punctuation">.</span><span class="token function">setActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockTccService<span class="token punctuation">.</span><span class="token function">tryDeductStock</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">,</span> count<span class="token punctuation">,</span> stockContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 3. 调用账户TCC的Try方法（同理实现）</span>
        <span class="token class-name">BusinessActionContext</span> accountContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BusinessActionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountContext<span class="token punctuation">.</span><span class="token function">setActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountContext<span class="token punctuation">.</span><span class="token function">setActionContext</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountTccService<span class="token punctuation">.</span><span class="token function">tryDeductMoney</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> money<span class="token punctuation">,</span> accountContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="_3-2-4-优缺点总结"><a href="#_3-2-4-优缺点总结" class="header-anchor">#</a> 3.2.4 优缺点总结</h4> <ul><li><strong>优点</strong>：高性能（无锁等待，Try阶段仅预留资源）；适配复杂业务场景（非关系型数据库、无主键表）；一致性保障强；</li> <li><strong>缺点</strong>：侵入式开发，需手动实现Try/Confirm/Cancel；开发成本高；需处理幂等性和补偿逻辑。</li></ul> <h3 id="_3-3-saga模式-长事务解决方案-状态机驱动"><a href="#_3-3-saga模式-长事务解决方案-状态机驱动" class="header-anchor">#</a> 3.3 SAGA模式：长事务解决方案（状态机驱动）</h3> <p>SAGA模式适用于“长事务”场景（如跨多个服务的复杂流程，执行时间长），核心思想是“将分布式事务拆分为多个本地事务，每个本地事务执行后提交，若后续事务失败，则通过补偿事务回滚前面的本地事务”。Seata的SAGA模式支持两种实现方式：注解式（简单场景）和状态机式（复杂场景）。</p> <h4 id="_3-3-1-核心原理-正向事务-补偿事务"><a href="#_3-3-1-核心原理-正向事务-补偿事务" class="header-anchor">#</a> 3.3.1 核心原理：正向事务+补偿事务</h4> <ol><li><strong>正向事务（Forward Transaction）</strong>：将分布式事务拆分为多个本地事务（T1、T2、T3...Tn），依次执行，每个本地事务执行后立即提交；</li> <li><strong>补偿事务（Compensation Transaction）</strong>：为每个正向事务定义对应的补偿事务（C1、C2、C3...Cn），用于回滚正向事务的执行结果；</li> <li><strong>执行逻辑</strong>：
<ul><li>正常场景：T1→T2→T3→...→Tn，所有正向事务执行成功，全局事务结束；</li> <li>异常场景：若Tk执行失败，则触发补偿流程：Ck-1→Ck-2→...→C1，回滚前面所有已执行的正向事务。</li></ul></li></ol> <h4 id="_3-3-2-实战示例-注解式saga实现"><a href="#_3-3-2-实战示例-注解式saga实现" class="header-anchor">#</a> 3.3.2 实战示例：注解式SAGA实现</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSagaService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockFeignClient</span> stockFeignClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountFeignClient</span> accountFeignClient<span class="token punctuation">;</span>

    <span class="token comment">// 全局事务注解（指定SAGA模式）</span>
    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token class-name">GlobalTransactionMode</span><span class="token punctuation">.</span><span class="token constant">SAGA</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 正向事务T1：创建订单</span>
        <span class="token class-name">BigDecimal</span> money <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 2. 正向事务T2：扣减库存（指定补偿方法）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            stockFeignClient<span class="token punctuation">.</span><span class="token function">deductStock</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 触发补偿事务C1：删除订单</span>
            orderMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存扣减失败，触发SAGA补偿&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 3. 正向事务T3：扣减余额（指定补偿方法）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            accountFeignClient<span class="token punctuation">.</span><span class="token function">deductMoney</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 触发补偿事务C2（回滚库存）和C1（删除订单）</span>
            stockFeignClient<span class="token punctuation">.</span><span class="token function">compensateStock</span><span class="token punctuation">(</span>commodityCode<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMapper<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;余额扣减失败，触发SAGA补偿&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 库存服务：补偿方法</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockMapper</span> stockMapper<span class="token punctuation">;</span>

    <span class="token comment">// 正向方法：扣减库存</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deductStock</span><span class="token punctuation">(</span><span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stock <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 补偿方法：恢复库存</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">compensateStock</span><span class="token punctuation">(</span><span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Stock</span> stock <span class="token operator">=</span> stockMapper<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Stock</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;commodity_code&quot;</span><span class="token punctuation">,</span> commodityCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stock<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>stock<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><h4 id="_3-3-3-优缺点总结"><a href="#_3-3-3-优缺点总结" class="header-anchor">#</a> 3.3.3 优缺点总结</h4> <ul><li><strong>优点</strong>：适用于长事务场景；无锁资源占用；支持非关系型数据库；</li> <li><strong>缺点</strong>：一致性保障弱（最终一致性）；补偿逻辑复杂；需处理幂等性和并发问题。</li></ul> <h3 id="_3-4-xa模式-强一致性方案-兼容传统2pc"><a href="#_3-4-xa模式-强一致性方案-兼容传统2pc" class="header-anchor">#</a> 3.4 XA模式：强一致性方案（兼容传统2PC）</h3> <p>XA模式是基于传统2PC（两阶段提交）的分布式事务方案，核心依赖数据库的XA协议（如MySQL的XA事务），实现强一致性。Seata的XA模式封装了传统2PC的细节，降低了开发成本。</p> <h4 id="_3-4-1-核心原理"><a href="#_3-4-1-核心原理" class="header-anchor">#</a> 3.4.1 核心原理</h4> <ol><li><strong>一阶段（准备阶段）</strong>：RM执行本地事务，但不提交，仅将事务状态设置为“准备提交”，并持有数据库锁；</li> <li><strong>二阶段（提交/回滚阶段）</strong>：
<ul><li>所有RM准备成功：TC下发提交指令，所有RM提交本地事务，释放锁；</li> <li>存在RM准备失败：TC下发回滚指令，所有RM回滚本地事务，释放锁。</li></ul></li></ol> <h4 id="_3-4-2-实战配置-客户端"><a href="#_3-4-2-实战配置-客户端" class="header-anchor">#</a> 3.4.2 实战配置（客户端）</h4> <p>只需在AT模式基础上修改事务模式为XA：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> mode <span class="token operator">=</span> <span class="token class-name">GlobalTransactionMode</span><span class="token punctuation">.</span><span class="token constant">XA</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token class-name">String</span> commodityCode<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 业务逻辑与AT模式一致，无需修改</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_3-4-3-优缺点总结"><a href="#_3-4-3-优缺点总结" class="header-anchor">#</a> 3.4.3 优缺点总结</h4> <ul><li><strong>优点</strong>：强一致性保障；兼容传统2PC；无需回滚日志；</li> <li><strong>缺点</strong>：性能差（锁资源占用久）；依赖数据库XA协议支持；高并发场景下不适用。</li></ul> <h2 id="四、底层原理-seata核心机制深度解析"><a href="#四、底层原理-seata核心机制深度解析" class="header-anchor">#</a> 四、底层原理：Seata核心机制深度解析</h2> <h3 id="_4-1-at模式核心-undo-log与数据回滚"><a href="#_4-1-at模式核心-undo-log与数据回滚" class="header-anchor">#</a> 4.1 AT模式核心：undo_log与数据回滚</h3> <p>AT模式的核心是undo_log表，其存储结构包含以下关键字段：</p> <ul><li>xid：全局事务ID；</li> <li>branch_id：分支事务ID；</li> <li>rollback_info：回滚信息（序列化的前置镜像、后置镜像、SQL类型等）；</li> <li>log_status：日志状态（0：正常，1：已删除）。</li></ul> <p><strong>回滚逻辑</strong>：</p> <ol><li>反序列化rollback_info，获取前置镜像；</li> <li>根据前置镜像生成回滚SQL（如UPDATE stock_tbl SET count = 100 WHERE commodity_code = 'C001' AND count = 99）；</li> <li>执行回滚SQL，恢复数据到原始状态；</li> <li>删除undo_log记录。</li></ol> <h3 id="_4-2-分布式锁机制"><a href="#_4-2-分布式锁机制" class="header-anchor">#</a> 4.2 分布式锁机制</h3> <p>Seata通过分布式锁保证并发场景下的数据一致性，核心逻辑：</p> <ol><li><strong>AT模式</strong>：一阶段提交时通过数据库行级锁保证并发安全，二阶段无锁；</li> <li><strong>TCC模式</strong>：Try阶段通过业务逻辑锁定资源（如冻结库存），避免并发修改；</li> <li><strong>XA模式</strong>：一阶段持有数据库锁，二阶段释放。</li></ol> <h3 id="_4-3-事务分组与配置中心"><a href="#_4-3-事务分组与配置中心" class="header-anchor">#</a> 4.3 事务分组与配置中心</h3> <p>Seata的“事务分组（tx-service-group）”是核心配置，用于关联客户端与服务端：</p> <ol><li>客户端配置tx-service-group（如order_tx_group）；</li> <li>通过配置中心（如Nacos）配置分组与Seata Server集群的映射关系：</li></ol> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># Nacos中配置（data-id: service.vgroupMapping.order_tx_group）</span>
<span class="token key attr-name">service.vgroupMapping.order_tx_group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>
<span class="token key attr-name">service.default.grouplist</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8091</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="五、企业级部署-seata集群配置"><a href="#五、企业级部署-seata集群配置" class="header-anchor">#</a> 五、企业级部署：Seata集群配置</h2> <p>单机部署仅适用于开发测试环境，生产环境需采用集群部署，确保高可用。</p> <h3 id="_5-1-集群部署准备"><a href="#_5-1-集群部署准备" class="header-anchor">#</a> 5.1 集群部署准备</h3> <ol><li><strong>环境要求</strong>：3个及以上Seata Server节点，MySQL主从集群（存储事务数据）；</li> <li><strong>数据库初始化</strong>：所有Seata Server节点连接同一个MySQL集群，执行db_store.sql脚本。</li></ol> <h3 id="_5-2-集群配置步骤"><a href="#_5-2-集群配置步骤" class="header-anchor">#</a> 5.2 集群配置步骤</h3> <ol><li><strong>修改cluster.conf文件</strong>（conf/cluster.conf）：</li></ol> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>192.168.1.101:8091
192.168.1.102:8091
192.168.1.103:8091
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li><strong>修改application.yml</strong>：所有节点配置相同的数据库连接和Nacos注册信息；</li> <li><strong>启动集群</strong>：依次启动每个Seata Server节点；</li> <li><strong>客户端配置</strong>：将Seata Server地址配置为集群地址：</li></ol> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment"># Nacos会自动发现Seata集群</span>
      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="六、常见问题与解决方案"><a href="#六、常见问题与解决方案" class="header-anchor">#</a> 六、常见问题与解决方案</h2> <h3 id="_6-1-问题1-at模式回滚失败"><a href="#_6-1-问题1-at模式回滚失败" class="header-anchor">#</a> 6.1 问题1：AT模式回滚失败</h3> <p><strong>现象</strong>：全局事务回滚时，数据未恢复到原始状态。
<strong>解决方案</strong>：</p> <ol><li>检查undo_log表是否存在，字段是否正确；</li> <li>确保操作的表有主键；</li> <li>检查数据库隔离级别是否为READ COMMITTED；</li> <li>确认SQL为DML语句，无DDL语句。</li></ol> <h3 id="_6-2-问题2-事务分组配置错误"><a href="#_6-2-问题2-事务分组配置错误" class="header-anchor">#</a> 6.2 问题2：事务分组配置错误</h3> <p><strong>现象</strong>：客户端提示“no available server to connect”。
<strong>解决方案</strong>：</p> <ol><li>检查tx-service-group配置是否正确；</li> <li>确认Nacos中已配置service.vgroupMapping.${tx-service-group}；</li> <li>检查Seata Server集群地址配置是否正确。</li></ol> <h3 id="_6-3-问题3-数据源代理未配置"><a href="#_6-3-问题3-数据源代理未配置" class="header-anchor">#</a> 6.3 问题3：数据源代理未配置</h3> <p><strong>现象</strong>：AT模式不生效，undo_log无记录。
<strong>解决方案</strong>：</p> <ol><li>确保配置了DataSourceProxy，替换了MyBatis的SqlSessionFactory；</li> <li>检查数据源代理是否覆盖了所有业务数据源。</li></ol> <h3 id="_6-4-问题4-tcc模式幂等性问题"><a href="#_6-4-问题4-tcc模式幂等性问题" class="header-anchor">#</a> 6.4 问题4：TCC模式幂等性问题</h3> <p><strong>现象</strong>：Confirm/Cancel方法多次执行导致数据异常。
<strong>解决方案</strong>：</p> <ol><li>基于XID+Branch ID实现幂等性；</li> <li>在业务表中添加“事务状态”字段，标记是否已执行Confirm/Cancel。</li></ol> <h2 id="七、总结-seata最佳实践"><a href="#七、总结-seata最佳实践" class="header-anchor">#</a> 七、总结：Seata最佳实践</h2> <h3 id="_7-1-模式选择建议"><a href="#_7-1-模式选择建议" class="header-anchor">#</a> 7.1 模式选择建议</h3> <ul><li><strong>简单业务场景</strong>：优先选择AT模式（无侵入、高性能）；</li> <li><strong>复杂业务/非关系型数据库</strong>：选择TCC模式；</li> <li><strong>长事务场景</strong>：选择SAGA模式；</li> <li><strong>强一致性要求场景</strong>：选择XA模式（低并发场景）。</li></ul> <h3 id="_7-2-性能优化建议"><a href="#_7-2-性能优化建议" class="header-anchor">#</a> 7.2 性能优化建议</h3> <ol><li>尽量缩小事务范围，避免分布式事务包含过多分支；</li> <li>AT模式下，使用批量SQL减少undo_log写入次数；</li> <li>生产环境使用数据库存储模式（db），避免文件存储的性能瓶颈；</li> <li>集群部署Seata Server，避免单点故障。</li></ol></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/tavio-zhang/blog/edit/master/docs/《Spring》笔记/7.Spring Cloud Seata.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Spring%20Cloud%20Seata%20%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="标签">#Spring Cloud Seata 深度解析</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2026/01/21, 19:29:14</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/b6abda/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Spring Cloud Gateway 底层原理</div></a> <a href="/pages/3f9c50/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Spring Cloud Sentinel 深度解析</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/b6abda/" class="prev">Spring Cloud Gateway 底层原理</a></span> <span class="next"><a href="/pages/3f9c50/">Spring Cloud Sentinel 深度解析</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/942d4b/"><div>
            订单超时取消
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/87b303/"><div>
            双 Token 登录
            <!----></div></a> <span class="date">01-21</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a3f3fd/"><div>
            长短链接跳转
            <!----></div></a> <span class="date">01-21</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:taviozhang@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/tavio-zhang" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.c6ba13aa.js" defer></script><script src="/assets/js/2.8d9f533d.js" defer></script><script src="/assets/js/83.72b7d6a4.js" defer></script>
  </body>
</html>
